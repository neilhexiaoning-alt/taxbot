---
name: invoice-check
description: "发票查验助手。当用户提到发票查验、发票验真、验证发票、查验发票、发票真伪、发票核验时使用此技能。上传发票图片/PDF/XML文件，自动识别发票信息，调用中税网查验接口验证真伪，输出查验结果和风险分析。"
metadata:
  {
    "openclaw":
      {
        "emoji": "🔍",
        "os": ["win32"]
      }
  }
---

# 发票查验助手

> **全自动执行，各步骤之间不要等待用户确认。**

## 第一步：识别并提取发票信息

根据用户上传的文件类型，提取发票的关键字段：

### 图片文件（jpg/png/bmp/tiff/webp）

如果用户上传了图片，图片内容已经在对话中可见（由视觉模型直接识别）。请从图片中识别以下字段。如果图片不够清晰，用 image 工具重新加载：

```
Tool: image
Image: <图片路径>
Prompt: 请提取发票中的所有文字，包括：发票代码、发票号码、开票日期、校验码、不含税金额、价税合计、销方名称、购方名称、发票类型。保持原始格式。
```

### PDF/XML 文件

PDF和XML文件内容已经以文字形式嵌入在用户消息中（【文件内容】标记内）。直接从文字内容中提取字段。

对于XML电子发票，常见的XML标签名称：
- `<InvoiceCode>` 或 `<Fpdm>` = 发票代码
- `<InvoiceNumber>` 或 `<Fphm>` = 发票号码
- `<BillingDate>` 或 `<Kprq>` = 开票日期
- `<TotalAmount>` 或 `<Hjje>` = 合计金额（不含税）
- `<TotalTaxIncludedAmount>` 或 `<Jshj>` = 价税合计
- `<CheckCode>` 或 `<Jym>` = 校验码
- `<SellerName>` 或 `<Xhfmc>` = 销方名称
- `<BuyerName>` 或 `<Ghdwmc>` = 购方名称

### 需要提取的字段

从文件中提取以下信息，缺失的字段填空。

**⚠️ 关键：先判断发票类型再提取字段，不同类型的字段规则完全不同！**

## 第二步：确定发票种类代码并按规则提取字段

### 发票类型映射表

| 发票类型名称 | 代码 | 类别 |
|---|---|---|
| 增值税专用发票（纸质） | 004 | 传统发票 |
| 增值税普通发票（折叠票） | 007 | 传统发票 |
| 增值税普通发票（卷票） | 025 | 传统发票 |
| 增值税电子普通发票 | 026 | 传统发票 |
| 增值税电子专用发票 | 028 | 传统发票 |
| 机动车销售统一发票 | 005 | 传统发票 |
| 二手车销售统一发票 | 006 | 传统发票 |
| 货物运输业增值税专用发票 | 002 | 传统发票 |
| 通行费发票 | 014 | 传统发票 |
| 全面数字化电子发票（专用） | 021 | **全电发票** |
| 全面数字化电子发票（普通） | 022 | **全电发票** |
| 全电纸质发票（增值税专用发票） | 085 | **全电发票** |
| 全电纸质发票（普通发票） | 086 | **全电发票** |
| 电子发票（航空运输电子客票行程单） | 061 | **全电发票** |
| 电子发票（铁路电子客票） | 083 | **全电发票** |

### 传统发票（004/007/025/026/028/005/006/002/014）字段规则

| 字段 | 说明 |
|------|------|
| invoiceCode | **必填**，发票代码，10或12位数字 |
| invoiceNo | **必填**，发票号码，8位数字 |
| invoiceDate | **必填**，开票日期，YYYYMMDD |
| invoiceAmount | **必填**，不含税金额（005为不含税价，006为车价合计） |
| checkCode | **必填**，校验码后六位 |

### 全电发票（021/022/085/086/061/083）字段规则 —— 与传统发票完全不同！

| 字段 | 说明 |
|------|------|
| invoiceCode | **必须留空**，全电发票没有发票代码，传空值 |
| invoiceNo | **必填**，20位数字发票号码。这是票面上唯一的长数字串，如 25119110010002612998 |
| invoiceDate | **必填**，开票日期，YYYYMMDD |
| invoiceAmount | **必填**，083铁路客票为票价金额，061航空客票为票价金额，其他为不含税金额 |
| checkCode | **必须留空**，全电发票没有校验码，传空值 |

**⚠️ 全电发票常见错误（必须避免）**：
- ❌ 错误：把20位发票号码拆成"发票代码"和"发票号码"两个字段。比如 25119110010002612998 错误拆成 invoiceCode=2511911001 + invoiceNo=0002612998
- ✅ 正确：invoiceCode 留空，invoiceNo=25119110010002612998（完整20位）
- ❌ 错误：在票面上找不到"发票代码"就随便取一个数字填入
- ✅ 正确：全电发票票面本身就没有"发票代码"字段，invoiceCode 必须留空

**如何判断是全电发票**：
- 票面上只有一个20位数字的"发票号码"，没有单独的"发票代码"
- 票面标题含有"电子发票""数字化电子发票""铁路电子客票""航空运输电子客票"等字样
- 全电发票号码格式通常是：前10位为开票方识别号相关，后10位为流水号

如果无法确定发票类型，列出可能的选项让用户选择。

## 第三步：调用查验接口

确认提取的字段无误后，立即用 exec 工具执行以下命令（替换实际值）：

node "$env:TAXBOT_ROOT/skills/invoice-check/scripts/check-invoice.mjs" --invoiceCode=发票代码 --invoiceNo=发票号码 --invoiceDate=开票日期 --invoiceAmount=不含税金额 --checkCode=校验码后六位 --invoiceType=种类代码

$env:TAXBOT_ROOT 是系统环境变量，指向应用根目录，由系统自动设置。

**参数说明**：
- 所有参数值不要加引号
- 日期格式必须为 YYYYMMDD（如 20241215）
- 金额为数字（如 343.93）
- 校验码只取后六位
- 可为空的字段传空值（如 --checkCode= ）

## 第四步：展示查验结果

解析脚本返回的 JSON 结果，以表格形式展示：

### 4.1 查验结果摘要

| 项目 | 结果 |
|------|------|
| 查验状态 | 成功/失败 |
| 发票代码 | |
| 发票号码 | |
| 开票日期 | |
| 发票状态 | 正常/作废/红冲/异常 |
| 销方名称 | |
| 销方纳税人识别号 | |
| 购方名称 | |
| 购方纳税人识别号 | |
| 不含税金额 | |
| 税额 | |
| 价税合计 | |

### 4.2 发票明细

如果返回了货物或服务明细，以表格形式列出每一项的名称、数量、单价、金额、税率、税额。

## 第五步：风险分析

根据查验结果进行风险评估：

### 🔴 高风险（需立即处理）

检查以下情况，如存在则标记为高风险：
- 查验失败（发票不存在或信息不匹配）— 可能为假发票
- 发票状态为"作废"或"失控"
- 发票已被红冲
- 销方纳税人状态异常（非正常户、注销等）
- 上传文件中的金额与查验返回的金额不一致（可能被篡改）
- 销方在税务黑名单中

### 🟡 中风险（建议关注）

- 开票日期距今超过 360 天（影响增值税进项抵扣时效）
- 发票类型与实际业务场景不匹配
- 金额为整数大额（如 10000、50000、100000 等整数），需关注是否存在凑票嫌疑
- 销方经营范围与开票内容不匹配
- 同一销方短期内多次开具相近金额发票

### 🟢 正常

- 查验通过，发票状态正常
- 金额、日期、销购方信息均一致
- 在有效抵扣期限内

### 输出格式

以风险等级分类列出所有发现，并给出具体建议：

**风险评估汇总**

| 序号 | 风险项 | 风险等级 | 说明 | 建议 |
|------|--------|---------|------|------|
| 1 | | 🔴/🟡/🟢 | | |

最后给出总体结论：
- ✅ **发票真实有效**：查验通过，无风险项
- ⚠️ **发票真实但存在风险**：查验通过，但有需要关注的风险点
- ❌ **发票存疑**：查验失败或存在高风险项，建议进一步核实

## 特殊情况处理

- **图片模糊无法识别**：告知用户图片质量不佳，请重新拍照上传（建议正面拍摄、光线充足）
- **缺少关键字段**：列出已识别和缺失的字段，请用户手动补充
- **脚本执行失败**：显示错误信息，建议用户检查网络连接后重试
- **多张发票**：如果上传了多个文件，逐一处理每张发票，分别展示查验结果
- **全电发票**（021/022/085/086/061/083）：invoiceCode 和 checkCode 必须传空值，invoiceNo 必须是完整的20位数字
