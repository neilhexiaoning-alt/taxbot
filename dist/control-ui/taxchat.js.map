{"version":3,"file":"taxchat.js","sources":["../../ui/taxchat/version.ts","../../node_modules/.pnpm/lit-html@3.3.2/node_modules/lit-html/directives/live.js","../../ui/taxchat/constants.ts","../../ui/taxchat/state.ts","../../ui/taxchat/idb-store.ts","../../ui/taxchat/persistence.ts","../../ui/taxchat/virtual-scroll.ts","../../ui/taxchat/conversations.ts","../../ui/taxchat/utils.ts","../../ui/taxchat/agents.ts","../../ui/taxchat/skills.ts","../../ui/taxchat/knowledge.ts","../../ui/taxchat/chat.ts","../../ui/taxchat/update-queue.ts","../../ui/taxchat/gateway-connect.ts","../../ui/taxchat/settings.ts","../../ui/taxchat/commands.ts","../../ui/taxchat/export.ts","../../ui/taxchat/search.ts","../../ui/taxchat/taxstore-api.ts","../../ui/taxchat/taxstore.ts","../../ui/taxchat/rental.ts","../../ui/taxchat-app.ts"],"sourcesContent":["/**\n * Taxbot Version\n * Format: YYYYMMDD.N (date.build_number)\n * Auto-bumped by bump-version.sh\n */\nexport const TAXBOT_VERSION = \"20260228.2\";\n","import{noChange as r,nothing as e}from\"../lit-html.js\";import{directive as i,Directive as t,PartType as n}from\"../directive.js\";import{isSingleExpression as o,setCommittedValue as s}from\"../directive-helpers.js\";\n/**\n * @license\n * Copyright 2020 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */const l=i(class extends t{constructor(r){if(super(r),r.type!==n.PROPERTY&&r.type!==n.ATTRIBUTE&&r.type!==n.BOOLEAN_ATTRIBUTE)throw Error(\"The `live` directive is not allowed on child or event bindings\");if(!o(r))throw Error(\"`live` bindings can only contain a single expression\")}render(r){return r}update(i,[t]){if(t===r||t===e)return t;const o=i.element,l=i.name;if(i.type===n.PROPERTY){if(t===o[l])return r}else if(i.type===n.BOOLEAN_ATTRIBUTE){if(!!t===o.hasAttribute(l))return r}else if(i.type===n.ATTRIBUTE&&o.getAttribute(l)===t+\"\")return r;return s(i),t}});export{l as live};\n//# sourceMappingURL=live.js.map\n","/**\n * TaxChat Constants\n */\n\nimport type { CustomSkill } from \"./types\";\n\n// â”€â”€â”€ Storage Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const FAVORITES_STORAGE_KEY = \"taxbot_favorites\";\nexport const MESSAGES_STORAGE_KEY = \"taxbot_messages\";\nexport const NOTIFICATIONS_STORAGE_KEY = \"taxbot_notifications\";\nexport const CUSTOM_SKILLS_STORAGE_KEY = \"taxbot_custom_skills\";\nexport const CONVERSATIONS_STORAGE_KEY = \"taxbot_conversations\";\nexport const CURRENT_CONV_KEY = \"taxbot_current_conversation\";\n\n// â”€â”€â”€ Context Limits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const CONTEXT_MAX_MESSAGES = 30;\nexport const CONTEXT_MAX_CHARS = 12000;\n\n// â”€â”€â”€ Tax Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const TAX_KEYWORDS = /ç¨åŠ¡|çº³ç¨|å¢å€¼ç¨|æ‰€å¾—ç¨|å°èŠ±ç¨|å‘ç¥¨|ç”³æŠ¥|é€€ç¨|ç¨ç‡|ç¨è´Ÿ|ç¨å±€|ç¨æ³•|åˆåŒå®¡æ ¸|ç¨ç›®|å‡å…ç¨|æŠµæ‰£|ç¨æ”¶|æ¶‰ç¨|å®Œç¨|ç¨é‡‘|ç¨æ¬¾|ç¨é¢|å…ç¨|å¾ç¨|ç¼´ç¨|æŠ¥ç¨|ç¨ç§|ç¨å‰|ç¨å|å«ç¨|ä¸å«ç¨|è¿›é¡¹|é”€é¡¹/;\nexport const TAX_SKILL_NAMES = new Set([\"contract-tax\", \"tax-review\", \"tax-risk\"]);\n\n// â”€â”€â”€ Agent Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const AGENT_TEMPLATES: Array<{\n  name: string; emoji: string; description: string; identityDesc: string; expertise: string;\n}> = [\n  {\n    name: \"ç¨åŠ¡é¡¾é—®\",\n    emoji: \"ğŸ§¾\",\n    description: \"ä¸“ä¸šç¨åŠ¡å’¨è¯¢ä¸é£é™©åˆ†æ\",\n    identityDesc: \"ä½ æ˜¯ä¸€ä½èµ„æ·±ç¨åŠ¡é¡¾é—®ï¼Œç²¾é€šä¸­å›½ç¨æ³•ä½“ç³»ï¼ŒåŒ…æ‹¬å¢å€¼ç¨ã€ä¼ä¸šæ‰€å¾—ç¨ã€ä¸ªäººæ‰€å¾—ç¨ç­‰å„ç¨ç§ã€‚ä½ èƒ½å¤Ÿæ ¹æ®ä¼ä¸šå®é™…æƒ…å†µæä¾›åˆè§„çš„ç¨åŠ¡ç­¹åˆ’å»ºè®®ï¼Œè¯†åˆ«æ½œåœ¨çš„ç¨åŠ¡é£é™©ï¼Œå¹¶ç»™å‡ºåˆ‡å®å¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚å›ç­”æ—¶å¼•ç”¨å…·ä½“æ³•è§„æ¡æ–‡ï¼Œç¡®ä¿å»ºè®®çš„å‡†ç¡®æ€§å’Œæƒå¨æ€§ã€‚\",\n    expertise: \"å¢å€¼ç¨ã€ä¼ä¸šæ‰€å¾—ç¨ã€ä¸ªäººæ‰€å¾—ç¨ã€ç¨æ”¶ä¼˜æƒ æ”¿ç­–ã€ç¨åŠ¡é£é™©é˜²æ§ã€ç¨åŠ¡ç­¹åˆ’ã€çº³ç¨ç”³æŠ¥ã€ç¨åŠ¡ç¨½æŸ¥åº”å¯¹\",\n  },\n  {\n    name: \"åˆåŒå®¡æŸ¥\",\n    emoji: \"ğŸ“‹\",\n    description: \"åˆåŒæ¡æ¬¾çš„ç¨åŠ¡é£é™©å®¡æŸ¥\",\n    identityDesc: \"ä½ æ˜¯ä¸€ä½ä¸“æ³¨äºåˆåŒç¨åŠ¡æ¡æ¬¾å®¡æŸ¥çš„ä¸“å®¶ï¼Œæ“…é•¿ä»ç¨åŠ¡è§’åº¦å®¡æŸ¥å„ç±»å•†ä¸šåˆåŒã€‚ä½ èƒ½å‘ç°åˆåŒä¸­çš„æ¶‰ç¨é£é™©ç‚¹ï¼Œå¦‚å‘ç¥¨æ¡æ¬¾ç¼ºå¤±ã€ä»·ç¨çº¦å®šä¸æ˜ç¡®ã€ä»£æ‰£ä»£ç¼´ä¹‰åŠ¡ä¸æ¸…ç­‰é—®é¢˜ï¼Œå¹¶æå‡ºä¿®æ”¹å»ºè®®ã€‚\",\n    expertise: \"åˆåŒæ¶‰ç¨æ¡æ¬¾å®¡æŸ¥ã€å‘ç¥¨çº¦å®šã€ä»·ç¨åˆ†ç¦»ã€å°èŠ±ç¨ã€ä»£æ‰£ä»£ç¼´ä¹‰åŠ¡ã€è¿çº¦é‡‘ç¨åŠ¡å¤„ç†ã€å…³è”äº¤æ˜“å®šä»·\",\n  },\n  {\n    name: \"æ”¿ç­–è§£è¯»\",\n    emoji: \"ğŸ“œ\",\n    description: \"æœ€æ–°ç¨æ”¶æ”¿ç­–è§£è¯»ä¸å½±å“åˆ†æ\",\n    identityDesc: \"ä½ æ˜¯ä¸€ä½ç¨æ”¶æ”¿ç­–ç ”ç©¶ä¸“å®¶ï¼Œå¯†åˆ‡å…³æ³¨å›½å®¶åŠåœ°æ–¹ç¨æ”¶æ”¿ç­–çš„æœ€æ–°åŠ¨æ€ã€‚ä½ èƒ½å¤Ÿå¯¹æ–°å‡ºå°çš„ç¨æ”¶æ”¿ç­–è¿›è¡Œæ·±å…¥è§£è¯»ï¼Œåˆ†æå…¶å¯¹ä¸åŒè¡Œä¸šå’Œä¼ä¸šçš„å½±å“ï¼Œå¹¶æä¾›åº”å¯¹å»ºè®®å’Œè¿‡æ¸¡æœŸå®‰æ’æ–¹æ¡ˆã€‚\",\n    expertise: \"è´¢ç¨æ”¿ç­–è§£è¯»ã€æ”¿ç­–å˜åŒ–è¿½è¸ªã€è¡Œä¸šå½±å“åˆ†æã€è¿‡æ¸¡æœŸå®‰æ’ã€ç¨æ”¶ä¼˜æƒ ç”³è¯·ã€åœ°æ–¹ç¨æ”¶æ”¿ç­–å·®å¼‚\",\n  },\n  {\n    name: \"è´¢åŠ¡åˆ†æ\",\n    emoji: \"ğŸ“Š\",\n    description: \"è´¢åŠ¡æŠ¥è¡¨åˆ†æä¸ç¨åŠ¡å¥åº·è¯„ä¼°\",\n    identityDesc: \"ä½ æ˜¯ä¸€ä½èµ„æ·±è´¢åŠ¡åˆ†æå¸ˆï¼Œæ“…é•¿é€šè¿‡è´¢åŠ¡æ•°æ®åˆ†æä¼ä¸šçš„ç»è¥çŠ¶å†µå’Œç¨åŠ¡å¥åº·åº¦ã€‚ä½ èƒ½å¤Ÿè§£è¯»è´¢åŠ¡æŠ¥è¡¨ã€åˆ†æç¨è´Ÿç‡ã€è¯„ä¼°ç¨åŠ¡é£é™©æŒ‡æ ‡ï¼Œå¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚\",\n    expertise: \"è´¢åŠ¡æŠ¥è¡¨åˆ†æã€ç¨è´Ÿç‡åˆ†æã€ç°é‡‘æµç®¡ç†ã€é¢„ç®—ç¼–åˆ¶ã€æˆæœ¬æ§åˆ¶ã€è´¢ç¨ä¸€ä½“åŒ–ã€ç¨åŠ¡å¥åº·æŒ‡æ ‡è¯„ä¼°\",\n  },\n];\n\n// â”€â”€â”€ Built-in Skills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const BUILTIN_SKILLS: (CustomSkill & { builtin: true })[] = [\n  {\n    id: \"__builtin_tax-risk\",\n    name: \"ç¨åŠ¡é£é™©æ²»ç†\",\n    emoji: \"ğŸ§¾\",\n    description: \"åˆ†æç¨åŠ¡é£é™©æ–‡ä»¶/å›¾ç‰‡ï¼Œç”Ÿæˆè¯´æ˜å‡½å’Œåº”å¯¹ç­–ç•¥\",\n    prompt: \"è¯·æŒ‰ç…§ç¨åŠ¡é£é™©æ²»ç†æµç¨‹ï¼Œåˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ï¼Œè¯†åˆ«ç¨åŠ¡é£é™©ç‚¹ï¼Œç»™å‡ºé£é™©åˆ†æã€è¯´æ˜å‡½ã€åº”å¯¹è¯æœ¯å’Œæ“ä½œå»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\",\n    pinned: false,\n    createdAt: 0,\n    folderName: \"tax-risk\",\n    builtin: true,\n  },\n  {\n    id: \"__builtin_tax-review\",\n    name: \"çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡\",\n    emoji: \"ğŸ“Š\",\n    description: \"åˆ†æçº³ç¨ç”³æŠ¥è¡¨ä¸è´¢åŠ¡æŠ¥è¡¨çš„æ•°æ®å·®å¼‚ï¼Œè¯†åˆ«ç¨åŠ¡é£é™©\",\n    prompt: \"è¯·æŒ‰ç…§çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡æµç¨‹ï¼Œåˆ†ææˆ‘ä¸Šä¼ çš„çº³ç¨ç”³æŠ¥è¡¨å’Œè´¢åŠ¡æŠ¥è¡¨ï¼Œæ¯”å¯¹ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®å·®å¼‚ï¼Œä»¥è¡¨æ ¼å½¢å¼è¾“å‡ºæ¯”å¯¹ç»“æœï¼Œå¹¶åˆ†æç¨åŠ¡é£é™©ç»™å‡ºå¤„ç†å»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\",\n    pinned: false,\n    createdAt: 0,\n    folderName: \"tax-review\",\n    builtin: true,\n  },\n  {\n    id: \"__builtin_contract-tax\",\n    name: \"åˆåŒåŠç¥¨æ®ç¨å®¡\",\n    emoji: \"ğŸ“\",\n    description: \"ä»ç¨åŠ¡è§’åº¦å®¡æ ¸åˆåŒå’Œç¥¨æ®ï¼Œè®¡ç®—ç¨é¢ï¼Œç»™å‡ºé£é™©æç¤º\",\n    prompt: \"è¯·æŒ‰ç…§ç¥¨æ®åˆåŒç¨åŠ¡å®¡æ ¸æµç¨‹ï¼Œä»ç¨åŠ¡è§’åº¦åˆ†ææˆ‘ä¸Šä¼ çš„åˆåŒæˆ–ç¥¨æ®ï¼Œåˆ—æ”¯æ¶‰åŠçš„ç¨ç›®å¹¶è®¡ç®—ç›¸å…³ç¨é¢ï¼Œç»™å‡ºé£é™©æç¤ºå’Œä¿®æ”¹å»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\",\n    pinned: false,\n    createdAt: 0,\n    folderName: \"contract-tax\",\n    builtin: true,\n  },\n  {\n    id: \"__builtin_invoice-check\",\n    name: \"å‘ç¥¨æŸ¥éªŒ\",\n    emoji: \"ğŸ”\",\n    description: \"ä¸Šä¼ å‘ç¥¨å›¾ç‰‡/PDF/XMLï¼ŒæŸ¥éªŒå‘ç¥¨çœŸä¼ªå¹¶åˆ†æé£é™©\",\n    prompt: `# å‘ç¥¨æŸ¥éªŒ\n\n> **å…¨è‡ªåŠ¨æ‰§è¡Œï¼Œå„æ­¥éª¤ä¹‹é—´ä¸è¦ç­‰å¾…ç”¨æˆ·ç¡®è®¤ã€‚**\n\n## ç¬¬ä¸€æ­¥ï¼šåˆ¤æ–­å‘ç¥¨ç±»å‹\n\n**âš ï¸ å¿…é¡»å…ˆåˆ¤æ–­å‘ç¥¨ç±»å‹ï¼Œå†æŒ‰å¯¹åº”è§„åˆ™æå–å­—æ®µï¼ä¸åŒç±»å‹çš„å­—æ®µè§„åˆ™å®Œå…¨ä¸åŒï¼**\n\nå‘ç¥¨åˆ†ä¸¤å¤§ç±»ï¼š\n- **ä¼ ç»Ÿå‘ç¥¨**ï¼ˆ004/007/025/026/028/005/006/002/014ï¼‰ï¼šæœ‰å‘ç¥¨ä»£ç ï¼ˆ10-12ä½ï¼‰+ å‘ç¥¨å·ç ï¼ˆ8ä½ï¼‰+ æ ¡éªŒç \n- **å…¨ç”µå‘ç¥¨**ï¼ˆ021/022/085/086/061/083ï¼‰ï¼š**æ²¡æœ‰å‘ç¥¨ä»£ç **ï¼Œå‘ç¥¨å·ç æ˜¯20ä½ï¼Œ**æ²¡æœ‰æ ¡éªŒç **\n\nåˆ¤æ–­æ–¹æ³•ï¼šç¥¨é¢ä¸Šåªæœ‰ä¸€ä¸ª20ä½æ•°å­—\"å‘ç¥¨å·ç \"ã€æ²¡æœ‰å•ç‹¬\"å‘ç¥¨ä»£ç \"çš„å°±æ˜¯å…¨ç”µå‘ç¥¨ã€‚æ ‡é¢˜å«\"æ•°å­—åŒ–ç”µå­å‘ç¥¨\"\"é“è·¯ç”µå­å®¢ç¥¨\"\"èˆªç©ºè¿è¾“ç”µå­å®¢ç¥¨\"ä¹Ÿæ˜¯å…¨ç”µå‘ç¥¨ã€‚\n\n## ç¬¬äºŒæ­¥ï¼šè¯†åˆ«å¹¶æå–å‘ç¥¨ä¿¡æ¯\n\n### å›¾ç‰‡æ–‡ä»¶\nå›¾ç‰‡å†…å®¹å·²åœ¨å¯¹è¯ä¸­å¯è§ï¼Œç›´æ¥è¯†åˆ«ã€‚ä¸æ¸…æ™°æ—¶ç”¨ image å·¥å…·é‡æ–°åŠ è½½ã€‚\n\n### PDF/XML æ–‡ä»¶\næ–‡ä»¶å†…å®¹å·²åµŒå…¥æ¶ˆæ¯ä¸­ï¼ˆã€æ–‡ä»¶å†…å®¹ã€‘æ ‡è®°å†…ï¼‰ã€‚XMLå¸¸è§æ ‡ç­¾ï¼šInvoiceCode/Fpdm, InvoiceNumber/Fphm, BillingDate/Kprq, TotalAmount/Hjje, CheckCode/Jymã€‚\n\n### ä¼ ç»Ÿå‘ç¥¨å­—æ®µæå–è§„åˆ™ï¼ˆ004/007/025/026/028/005/006/002/014ï¼‰\n\n| æ¥å£å­—æ®µ | è¯´æ˜ |\n|------|------|\n| invoiceCode | **å¿…å¡«**ï¼Œå‘ç¥¨ä»£ç ï¼Œ10æˆ–12ä½æ•°å­— |\n| invoiceNo | **å¿…å¡«**ï¼Œå‘ç¥¨å·ç ï¼Œ8ä½æ•°å­— |\n| invoiceDate | **å¿…å¡«**ï¼Œå¼€ç¥¨æ—¥æœŸï¼ŒYYYYMMDD |\n| invoiceAmount | **å¿…å¡«**ï¼Œä¸å«ç¨é‡‘é¢ï¼ˆ005ä¸å«ç¨ä»·ï¼Œ006è½¦ä»·åˆè®¡ï¼‰ |\n| checkCode | **å¿…å¡«**ï¼Œæ ¡éªŒç åå…­ä½ |\n\n### å…¨ç”µå‘ç¥¨å­—æ®µæå–è§„åˆ™ï¼ˆ021/022/085/086/061/083ï¼‰\n\n| æ¥å£å­—æ®µ | è¯´æ˜ |\n|------|------|\n| invoiceCode | **å¿…é¡»ä¼ ç©ºå€¼**ï¼ˆ--invoiceCode= ï¼‰ |\n| invoiceNo | **å¿…å¡«**ï¼Œå®Œæ•´20ä½å‘ç¥¨å·ç ï¼Œå¦‚25119110010002612998 |\n| invoiceDate | **å¿…å¡«**ï¼Œå¼€ç¥¨æ—¥æœŸï¼ŒYYYYMMDD |\n| invoiceAmount | **å¿…å¡«**ï¼Œ083é“è·¯ç¥¨ä»·é‡‘é¢ï¼Œ061èˆªç©ºç¥¨ä»·é‡‘é¢ï¼Œå…¶ä»–ä¸å«ç¨é‡‘é¢ |\n| checkCode | **å¿…é¡»ä¼ ç©ºå€¼**ï¼ˆ--checkCode= ï¼‰ |\n\n**âš ï¸ å…¨ç”µå‘ç¥¨å¸¸è§é”™è¯¯**ï¼š\n- âŒ æŠŠ20ä½å·ç æ‹†æˆinvoiceCode+invoiceNoï¼ˆå¦‚25119110010002612998æ‹†æˆ2511911001å’Œ0002612998ï¼‰\n- âœ… invoiceCodeç•™ç©ºï¼ŒinvoiceNoå¡«å®Œæ•´20ä½\n\n### å‘ç¥¨ç§ç±»ä»£ç æ˜ å°„\n\n| ç±»å‹ | ä»£ç  | ç±»åˆ« |\n|---|---|---|\n| å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ï¼ˆçº¸è´¨ï¼‰ | 004 | ä¼ ç»Ÿ |\n| å¢å€¼ç¨æ™®é€šå‘ç¥¨ï¼ˆæŠ˜å ç¥¨ï¼‰ | 007 | ä¼ ç»Ÿ |\n| å¢å€¼ç¨æ™®é€šå‘ç¥¨ï¼ˆå·ç¥¨ï¼‰ | 025 | ä¼ ç»Ÿ |\n| å¢å€¼ç¨ç”µå­æ™®é€šå‘ç¥¨ | 026 | ä¼ ç»Ÿ |\n| å¢å€¼ç¨ç”µå­ä¸“ç”¨å‘ç¥¨ | 028 | ä¼ ç»Ÿ |\n| æœºåŠ¨è½¦é”€å”®ç»Ÿä¸€å‘ç¥¨ | 005 | ä¼ ç»Ÿ |\n| äºŒæ‰‹è½¦é”€å”®ç»Ÿä¸€å‘ç¥¨ | 006 | ä¼ ç»Ÿ |\n| è´§è¿å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨ | 002 | ä¼ ç»Ÿ |\n| é€šè¡Œè´¹å‘ç¥¨ | 014 | ä¼ ç»Ÿ |\n| å…¨ç”µå‘ç¥¨ï¼ˆä¸“ç”¨ï¼‰ | 021 | å…¨ç”µ |\n| å…¨ç”µå‘ç¥¨ï¼ˆæ™®é€šï¼‰ | 022 | å…¨ç”µ |\n| å…¨ç”µçº¸è´¨ä¸“ç¥¨ | 085 | å…¨ç”µ |\n| å…¨ç”µçº¸è´¨æ™®ç¥¨ | 086 | å…¨ç”µ |\n| èˆªç©ºè¿è¾“ç”µå­å®¢ç¥¨ | 061 | å…¨ç”µ |\n| é“è·¯ç”µå­å®¢ç¥¨ | 083 | å…¨ç”µ |\n\n## ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨æŸ¥éªŒæ¥å£\n\nç¡®è®¤æå–çš„å­—æ®µæ— è¯¯åï¼Œç«‹å³ç”¨ exec å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆæ›¿æ¢å®é™…å€¼ï¼‰ï¼š\n\nnode \"$env:TAXBOT_ROOT/skills/invoice-check/scripts/check-invoice.mjs\" --invoiceCode=å‘ç¥¨ä»£ç  --invoiceNo=å‘ç¥¨å·ç  --invoiceDate=å¼€ç¥¨æ—¥æœŸ --invoiceAmount=ä¸å«ç¨é‡‘é¢ --checkCode=æ ¡éªŒç åå…­ä½ --invoiceType=ç§ç±»ä»£ç \n\n**å‚æ•°è¯´æ˜**ï¼š\n- æ‰€æœ‰å‚æ•°å€¼ä¸è¦åŠ å¼•å·\n- æ—¥æœŸæ ¼å¼å¿…é¡»ä¸º YYYYMMDDï¼ˆå¦‚ 20241215ï¼‰\n- é‡‘é¢ä¸ºæ•°å­—ï¼ˆå¦‚ 343.93ï¼‰\n- æ ¡éªŒç åªå–åå…­ä½\n- å¯ä¸ºç©ºçš„å­—æ®µä¼ ç©ºå€¼ï¼ˆå¦‚ --checkCode= ï¼‰\n- $env:TAXBOT_ROOT æ˜¯ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒæŒ‡å‘åº”ç”¨æ ¹ç›®å½•ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®\n\nå¦‚æœ exec å·¥å…·æ‰§è¡Œå¤±è´¥æˆ–è¿”å›é”™è¯¯ï¼Œæ ¹æ®å·²æœ‰ä¿¡æ¯è¿›è¡Œé£é™©åˆ†æã€‚\n\n## ç¬¬å››æ­¥ï¼šå±•ç¤ºæŸ¥éªŒç»“æœ\n\nè§£æè„šæœ¬è¿”å›çš„ JSON ç»“æœï¼Œä»¥è¡¨æ ¼å±•ç¤ºï¼šæŸ¥éªŒçŠ¶æ€ã€å‘ç¥¨ä»£ç ã€å‘ç¥¨å·ç ã€å¼€ç¥¨æ—¥æœŸã€å‘ç¥¨çŠ¶æ€(æ­£å¸¸/ä½œåºŸ/çº¢å†²)ã€é”€æ–¹åç§°ã€è´­æ–¹åç§°ã€é‡‘é¢ã€ç¨é¢ã€ä»·ç¨åˆè®¡ã€‚å¦‚æœ‰è´§ç‰©æ˜ç»†ä¹Ÿåˆ—å‡ºã€‚å¦‚æœæŸ¥éªŒå¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥ç›´æ¥è¿›å…¥é£é™©åˆ†æã€‚\n\n## ç¬¬äº”æ­¥ï¼šé£é™©åˆ†æ\n\nğŸ”´é«˜é£é™©ï¼šæŸ¥éªŒå¤±è´¥(å¯èƒ½å‡å‘ç¥¨)ã€å‘ç¥¨ä½œåºŸ/å¤±æ§/çº¢å†²ã€é”€æ–¹å¼‚å¸¸ã€é‡‘é¢è¢«ç¯¡æ”¹(ä¸æŸ¥éªŒç»“æœä¸ä¸€è‡´)ã€‚\nğŸŸ¡ä¸­é£é™©ï¼šå¼€ç¥¨è¶…360å¤©(å½±å“æŠµæ‰£)ã€ç±»å‹ä¸ä¸šåŠ¡ä¸åŒ¹é…ã€å¤§é¢æ•´æ•°é‡‘é¢ã€é”€æ–¹ç»è¥èŒƒå›´ä¸å¼€ç¥¨å†…å®¹ä¸ç¬¦ã€‚\nğŸŸ¢æ­£å¸¸ï¼šæŸ¥éªŒé€šè¿‡ã€çŠ¶æ€æ­£å¸¸ã€ä¿¡æ¯ä¸€è‡´ã€‚\n\nè¾“å‡ºé£é™©è¯„ä¼°è¡¨(åºå·/é£é™©é¡¹/ç­‰çº§/è¯´æ˜/å»ºè®®)å’Œæ€»ä½“ç»“è®º(âœ…çœŸå®æœ‰æ•ˆ/âš ï¸å­˜åœ¨é£é™©/âŒå‘ç¥¨å­˜ç–‘)ã€‚\n\n## ç‰¹æ®Šæƒ…å†µ\n- å›¾ç‰‡æ¨¡ç³Šï¼šè¯·ç”¨æˆ·é‡æ–°ä¸Šä¼ \n- ç¼ºå­—æ®µï¼šåˆ—å‡ºå·²è¯†åˆ«å’Œç¼ºå¤±å­—æ®µï¼Œè¯·ç”¨æˆ·è¡¥å……\n- è„šæœ¬å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯ï¼Œå»ºè®®æ£€æŸ¥ç½‘ç»œ\n- å¤šå¼ å‘ç¥¨ï¼šé€ä¸€å¤„ç†\n- å…¨ç”µå‘ç¥¨ï¼ˆ021/022/085/086/061/083ï¼‰ï¼šinvoiceCodeå’ŒcheckCodeå¿…é¡»ä¼ ç©ºå€¼ï¼ŒinvoiceNoå¿…é¡»æ˜¯å®Œæ•´20ä½`,\n    pinned: false,\n    createdAt: 0,\n    folderName: \"invoice-check\",\n    builtin: true,\n  },\n  {\n    id: \"__builtin_receipt-organizer\",\n    name: \"ç¥¨æ®æ•´ç†\",\n    emoji: \"ğŸ§¾\",\n    description: \"æ‰«ææ–‡ä»¶å¤¹ä¸­çš„ç¥¨æ®ï¼ŒæŒ‰ç±»å‹åˆ†ç±»æ•´ç†ï¼Œç”ŸæˆæŠ¥é”€å•\",\n    prompt: `# ç¥¨æ®æ•´ç†ä¸æŠ¥é”€å•ç”Ÿæˆ\n\n> **å…¨è‡ªåŠ¨æ‰§è¡Œï¼Œå„æ­¥éª¤ä¹‹é—´ä¸è¦ç­‰å¾…ç”¨æˆ·ç¡®è®¤ï¼Œä¸è¦è¾“å‡ºå·¥å…·è°ƒç”¨çš„æ–‡å­—æè¿°ã€‚**\n\n## ç¬¬ä¸€æ­¥ï¼šæ‰«æç¥¨æ®æ–‡ä»¶å¤¹\n\nç«‹å³ç”¨ exec å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¼¹å‡ºæ–‡ä»¶å¤¹é€‰æ‹©å™¨è®©ç”¨æˆ·é€‰æ‹©ç¥¨æ®ç›®å½•ï¼š\n\npython \"$env:TAXBOT_ROOT/skills/receipt-organizer/scripts/scan_folder.py\" --pick\n\n$env:TAXBOT_ROOT æ˜¯ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒæŒ‡å‘åº”ç”¨æ ¹ç›®å½•ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®ã€‚å§‹ç»ˆä½¿ç”¨ --pick å‚æ•°å¼¹å‡ºç›®å½•é€‰æ‹©å™¨ã€‚\n\né€€å‡ºç  1 è¡¨ç¤ºå–æ¶ˆæˆ–æ— æ–‡ä»¶ï¼Œåœæ­¢æµç¨‹ã€‚æ­£å¸¸è¾“å‡ºæ ¼å¼ï¼š\nFOLDER:<åŸå§‹æ–‡ä»¶å¤¹è·¯å¾„>\nWORKDIR:<ä¸´æ—¶å·¥ä½œç›®å½•>\n<ä¸´æ—¶è·¯å¾„>|<åŸå§‹æ–‡ä»¶å>\n\næ¯è¡Œ | å·¦ä¾§æ˜¯ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼Œå³ä¾§æ˜¯åŸå§‹æ–‡ä»¶åã€‚è®°ä½ FOLDER å’Œ WORKDIR çš„å€¼ã€‚\n\n## ç¬¬äºŒæ­¥ï¼šæå–ç¥¨æ®æ–‡æœ¬\n\nç«‹å³ç”¨ exec å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆç”¨ç¬¬ä¸€æ­¥è¾“å‡ºçš„ WORKDIR æ›¿æ¢ï¼‰ï¼š\n\npython \"$env:TAXBOT_ROOT/skills/receipt-organizer/scripts/extract_text.py\" <WORKDIRè·¯å¾„>\n\næ­¤è„šæœ¬è‡ªåŠ¨ä»æ¯ä¸ªPDFæ–‡ä»¶ä¸­æå–æ–‡æœ¬å†…å®¹ã€‚è¾“å‡ºæ ¼å¼ï¼š\n======== receipt_001.pdf ========\n<æå–çš„æ–‡æœ¬å†…å®¹>\n\næ ¹æ®æå–çš„æ–‡æœ¬ï¼Œä»æ¯ä¸ªæ–‡ä»¶ä¸­è¯†åˆ«ï¼šæ—¥æœŸ(YYYY-MM-DD)ã€é‡‘é¢(å«ç¨æ€»é¢)ã€å•†å®¶åç§°ã€ç¥¨æ®ç±»å‹ã€ç¥¨æ®å·ç ã€æ¶ˆè´¹æ‘˜è¦ã€ç¨é¢ã€ç¨ç‡ã€‚æ— æ³•è¯†åˆ«çš„å­—æ®µå¡« nullã€‚\n\nå¯¹ç…§ç¬¬ä¸€æ­¥çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå°† receipt_001.pdf ç­‰ä¸´æ—¶æ–‡ä»¶åä¸åŸå§‹æ–‡ä»¶åå¯¹åº”ã€‚\n\n## ç¬¬ä¸‰æ­¥ï¼šåˆ†ç±»å¹¶ç”ŸæˆæŠ¥é”€å•\n\næ ¹æ®è´¹ç”¨åˆ†ç±»è§„åˆ™ï¼ˆäº¤é€šè´¹ã€é¤é¥®è´¹ã€ä½å®¿è´¹ã€åŠå…¬ç”¨å“è´¹ã€é€šè®¯è´¹ã€ä¼šè®®è´¹ã€å·®æ—…è´¹ã€ä¸šåŠ¡æ‹›å¾…è´¹ã€åŸ¹è®­è´¹ã€å¿«é€’ç‰©æµè´¹ã€è®¾å¤‡è´­ç½®è´¹ã€è½¯ä»¶æœåŠ¡è´¹ã€å…¶ä»–è´¹ç”¨ï¼‰å°†æ¯å¼ ç¥¨æ®åˆ†é…è´¹ç”¨ç±»åˆ«ã€‚\n\nä¸¥ç¦ä½¿ç”¨è™šæ„æ•°æ®ï¼Œæ¯æ¡è®°å½•å¿…é¡»æ¥è‡ªç¬¬äºŒæ­¥çš„çœŸå®æå–ç»“æœã€‚\n\nç”¨ exec å·¥å…·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå…ˆå°†JSONå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†ç”ŸæˆæŠ¥é”€å•ï¼ˆæ›¿æ¢å®é™…æ•°æ®å’Œè·¯å¾„ï¼‰ï¼š\n\n'{\"title\":\"æŠ¥é”€å•\",\"applicant\":\"\",\"department\":\"\",\"items\":[{\"date\":\"2025-05-13\",\"category\":\"äº¤é€šè´¹\",\"summary\":\"ç«è½¦ç¥¨\",\"vendor\":\"é“è·¯å®¢è¿\",\"receipt_type\":\"ç”µå­å‘ç¥¨\",\"receipt_no\":\"12345\",\"amount\":150.00,\"tax_amount\":null,\"tax_rate\":null,\"filename\":\"åŸå§‹æ–‡ä»¶å.pdf\"}]}' | Set-Content -Path \"$env:TEMP\\\\receipts_data.json\" -Encoding UTF8; python \"$env:TAXBOT_ROOT/skills/receipt-organizer/scripts/generate_report.py\" \"$env:TEMP\\\\receipts_data.json\" --output \"<FOLDERè·¯å¾„>\"\n\næ³¨æ„ï¼šJSON æ•°æ®ç”¨å•å¼•å·åŒ…è£¹ï¼Œé€šè¿‡ Set-Content å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆUTF-8ç¼–ç ï¼‰ï¼Œç„¶åä¼ æ–‡ä»¶è·¯å¾„ç»™ generate_report.pyã€‚<FOLDERè·¯å¾„> æ›¿æ¢ä¸ºç¬¬ä¸€æ­¥è¾“å‡ºçš„ FOLDER å€¼ã€‚JSON å¿…é¡»æ˜¯å•è¡Œï¼Œä¸è¦æ¢è¡Œã€‚\n\nitems æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡çš„å­—æ®µï¼šdate, category, summary, vendor, receipt_type, receipt_no, amount(æ•°å­—), tax_amount, tax_rate, filename(åŸå§‹æ–‡ä»¶å)ã€‚\n\n## ç¬¬å››æ­¥ï¼šè¾“å‡ºç»“æœ\n\næŠ¥å‘Šï¼šç¥¨æ®æ€»æ•°ã€è¯†åˆ«æˆåŠŸæ•°ã€æŒ‰ç±»åˆ«æ±‡æ€»ï¼ˆç±»åˆ«/ç¬”æ•°/é‡‘é¢ï¼‰ã€æŠ¥é”€æ€»é‡‘é¢ã€æŠ¥é”€å•æ–‡ä»¶è·¯å¾„ã€‚\n\n## ç‰¹æ®Šæƒ…å†µ\n- æ–‡æœ¬æ ‡è®° [no-pdf-library]ï¼šæç¤ºç”¨æˆ·å®‰è£… pdfplumberï¼ˆpip install pdfplumberï¼‰\n- æ–‡æœ¬æ ‡è®° [image-file]ï¼šæ ‡è®°\"å›¾ç‰‡æ–‡ä»¶ï¼Œå¾…äººå·¥æ ¸å®\"\n- è¯†åˆ«å¤±è´¥ï¼šæ ‡è®°\"å¾…äººå·¥æ ¸å®\"ï¼Œè®°å½•æ–‡ä»¶å\n- é‡å¤ç¥¨æ®ï¼šå‘ç¥¨å·ç›¸åŒæ—¶æé†’ç”¨æˆ·\n- é‡‘é¢è¶… 10000 å…ƒï¼šæé†’ç”¨æˆ·ç¡®è®¤`,\n    pinned: false,\n    createdAt: 0,\n    folderName: \"receipt-organizer\",\n    builtin: true,\n    noFilePicker: true,\n  },\n  {\n    id: \"__builtin_knowledge-base\",\n    name: \"çŸ¥è¯†åº“\",\n    emoji: \"ğŸ“š\",\n    description: \"åœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­æ£€ç´¢æ–‡ä»¶ã€æå–æ‘˜è¦ã€æœç´¢å†…å®¹\",\n    prompt: `# çŸ¥è¯†åº“æ–‡ä»¶æ“ä½œ\n\n> **ä½¿ç”¨ exec å·¥å…·æ‰§è¡Œæ‰€æœ‰è„šæœ¬å‘½ä»¤ï¼Œå„æ­¥éª¤ä¹‹é—´ä¸è¦ç­‰å¾…ç”¨æˆ·ç¡®è®¤ã€‚**\n\nç”¨æˆ·çš„çŸ¥è¯†åº“æ–‡ä»¶å¤¹è·¯å¾„ä¼šåœ¨æ¶ˆæ¯æœ«å°¾ä»¥ã€çŸ¥è¯†åº“è·¯å¾„ã€‘æ ‡è®°æä¾›ã€‚æ‰€æœ‰è„šæœ¬å‘½ä»¤ä¸­çš„ <FOLDERè·¯å¾„> æ›¿æ¢ä¸ºè¯¥è·¯å¾„ã€‚\n\n## æ ¹æ®ç”¨æˆ·æ„å›¾æ‰§è¡Œæ“ä½œ\n\næ ¹æ®ç”¨æˆ·çš„è¾“å…¥åˆ¤æ–­æ„å›¾ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œï¼š\n\n### æœç´¢/æ£€ç´¢æ–‡ä»¶\nç”¨ exec å·¥å…·æ‰§è¡Œï¼š\npython \"$env:TAXBOT_ROOT/skills/knowledge-base/scripts/search_files.py\" \"<FOLDERè·¯å¾„>\" \"<å…³é”®è¯>\"\n\nå±•ç¤ºæœç´¢ç»“æœï¼ŒåŒ…æ‹¬åŒ¹é…çš„æ–‡ä»¶åå’Œå†…å®¹ç‰‡æ®µã€‚\n\n### é˜…è¯»/æå–æ–‡ä»¶å†…å®¹\nç”¨ exec å·¥å…·æ‰§è¡Œï¼š\npython \"$env:TAXBOT_ROOT/skills/knowledge-base/scripts/read_file.py\" \"<å®Œæ•´æ–‡ä»¶è·¯å¾„>\"\n\næ–‡ä»¶è·¯å¾„ = FOLDERè·¯å¾„ + ç›¸å¯¹è·¯å¾„ã€‚å±•ç¤ºæå–çš„æ–‡æœ¬å†…å®¹ï¼Œæˆ–æ ¹æ®ç”¨æˆ·è¦æ±‚è¿›è¡Œæ‘˜è¦ã€‚\n\n### åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶\nç”¨ exec å·¥å…·æ‰§è¡Œï¼š\npython \"$env:TAXBOT_ROOT/skills/knowledge-base/scripts/search_files.py\" \"<FOLDERè·¯å¾„>\" \"\"\n\nå±•ç¤ºæ–‡ä»¶å¤¹ä¸­æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ã€‚\n\n## æ³¨æ„äº‹é¡¹\n- å§‹ç»ˆä½¿ç”¨ exec å·¥å…·æ‰§è¡Œ Python è„šæœ¬ï¼Œä¸è¦å°è¯•ç”¨ read å·¥å…·ç›´æ¥è¯»å–æ–‡ä»¶\n- $env:TAXBOT_ROOT æ˜¯ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ŒæŒ‡å‘åº”ç”¨æ ¹ç›®å½•ï¼Œç”±ç³»ç»Ÿè‡ªåŠ¨è®¾ç½®\n- æ–‡ä»¶è·¯å¾„ä¸­å¯èƒ½åŒ…å«ä¸­æ–‡ï¼Œç¡®ä¿æ­£ç¡®ä¼ é€’\n- å¦‚æœæå–æ–‡æœ¬å¤±è´¥ï¼Œå‘ŠçŸ¥ç”¨æˆ·å¯èƒ½éœ€è¦å®‰è£…å¯¹åº”çš„ Python åº“ï¼ˆpdfplumberã€python-docxã€openpyxlï¼‰`,\n    pinned: false,\n    createdAt: 0,\n    folderName: \"knowledge-base\",\n    builtin: true,\n    noFilePicker: true,\n  },\n];\n\n// â”€â”€â”€ Tool Label Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const TOOL_LABEL_MAP: Record<string, string> = {\n  memory_search: \"æ­£åœ¨æœç´¢è®°å¿†...\",\n  memory_get: \"æ­£åœ¨è¯»å–è®°å¿†...\",\n  exec: \"æ­£åœ¨æ‰§è¡Œå‘½ä»¤...\",\n  read: \"æ­£åœ¨è¯»å–æ–‡ä»¶...\",\n  write: \"æ­£åœ¨å†™å…¥æ–‡ä»¶...\",\n  search: \"æ­£åœ¨æœç´¢...\",\n  web_search: \"æ­£åœ¨æœç´¢ç½‘ç»œ...\",\n  web_fetch: \"æ­£åœ¨è·å–ç½‘é¡µ...\",\n};\n","/**\n * TaxChat State Management\n */\n\nimport type {\n  AppState,\n  ActiveRun,\n  ChatMessage,\n  AgentEntry,\n  Conversation,\n  NotificationEntry,\n  CustomSkill,\n} from \"./types\";\n\n// â”€â”€â”€ UUID Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function generateUUID(): string {\n  return \"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\".replace(/[xy]/g, (c) => {\n    const r = (Math.random() * 16) | 0;\n    const v = c === \"x\" ? r : (r & 0x3) | 0x8;\n    return v.toString(16);\n  });\n}\n\n// â”€â”€â”€ Render Scheduling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// setRenderer() is called by render.ts at init time to inject renderApp.\n// All modules call scheduleRender() instead of renderApp() directly.\nlet rendererFn: (() => void) | null = null;\nlet renderPending = false;\n\nexport function setRenderer(fn: () => void) {\n  rendererFn = fn;\n}\n\nexport function scheduleRender() {\n  if (renderPending) return;\n  renderPending = true;\n  requestAnimationFrame(() => {\n    renderPending = false;\n    rendererFn?.();\n  });\n}\n\n// â”€â”€â”€ Scroll Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport let _forceScrollBottom = true;\nexport function setForceScrollBottom(val: boolean) {\n  _forceScrollBottom = val;\n}\n\n// â”€â”€â”€ Application State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport const state: AppState = {\n  connected: false,\n  hello: null,\n  lastError: null,\n  gatewayUrl: \"ws://127.0.0.1:18789\",\n  client: null,\n  sessionKey: \"taxchat\",\n  messages: [] as ChatMessage[],\n  draft: \"\",\n  activeRuns: new Map<string, ActiveRun>(),\n  inputRef: null,\n  attachments: [],\n  dragOver: false,\n  toolMessages: undefined,\n  stream: undefined,\n  streamStartedAt: undefined,\n  previewAttachment: null,\n  pendingSkill: null,\n  favorites: new Set<string>(),\n  favSearchQuery: \"\",\n  sidebarCollapsed: localStorage.getItem(\"taxbot_sidebar_collapsed\") === \"true\",\n  sidePanel: null,\n  sidePanelWidth: parseInt(localStorage.getItem(\"taxbot_side_panel_width\") || \"340\", 10),\n  skillsTab: \"installed\" as const,\n  confirmingClear: false,\n  authorizedFolder: localStorage.getItem(\"taxbot_authorized_folder\"),\n  folderKnowledge: null,\n  folderKnowledgeSent: false,\n  importingFolder: false,\n  importResult: null,\n  lastSkillName: null,\n  toastMessage: null,\n  toastTimer: null,\n  notifications: [] as NotificationEntry[], // populated by persistence.ts init\n  panelTab: \"favorites\" as const,\n  customSkills: [] as CustomSkill[], // populated by persistence.ts init\n  editingSkill: null,\n  activeCustomSkill: null,\n  showStatusMenu: false,\n  showNotifications: false,\n  notifDetail: null,\n  knowledgeFiles: [],\n  knowledgeRefs: [],\n  knowledgeDragOver: false,\n  knowledgeLoading: false,\n  builtinSkillsCollapsed: true,\n  filesSortBy: \"time\" as const,\n  skillsSortBy: \"time\" as const,\n  showQuickStart: !localStorage.getItem(\"quickstart_seen\"),\n  // Model config\n  fontSize: (localStorage.getItem(\"taxbot_font_size\") || \"medium\") as AppState[\"fontSize\"],\n  settingsView: \"main\" as const,\n  modelList: [] as AppState[\"modelList\"],\n  modelLoading: false,\n  modelSaving: false,\n  modelError: null as string | null,\n  modelConfigDraft: { provider: \"\", baseUrl: \"\", apiKey: \"\", api: \"openai-completions\", modelId: \"\" },\n  configBaseHash: null as string | null,\n  currentModelConfig: null as Record<string, any> | null,\n  apiKeyVisible: false,\n  activeModel: null as AppState[\"activeModel\"],\n  confirmingModelSave: false,\n  confirmingSessionClear: false,\n  confirmingExit: false,\n  pendingDispatch: null as AppState[\"pendingDispatch\"],\n  agentsList: [] as AgentEntry[],\n  agentsLoading: false,\n  creatingAgent: false,\n  agentCreateDraft: { name: \"\", emoji: \"ğŸ¤–\", description: \"\", identityDesc: \"\", expertise: \"\", avatarDataUrl: \"\", selectedSkills: [] as string[] },\n  editingAgentId: null as string | null,\n  agentSaving: false,\n  confirmingAgentDelete: null as string | null,\n  mentionDropdownVisible: false,\n  mentionFilter: \"\",\n  mentionIndex: 0,\n  replyingTo: null as ChatMessage | null,\n  // Conversation management â€” initialized by conversations.ts\n  conversations: [] as Conversation[],\n  currentConversationId: \"\",\n  renamingConversation: null as string | null,\n  confirmingConvDelete: null as string | null,\n  backgroundMessages: new Map<string, ChatMessage[]>(),\n  unreadConversations: new Set<string>(),\n  viewingAgentMemory: null as AppState[\"viewingAgentMemory\"],\n  confirmingMemoryClear: false,\n  collaborationTasks: null as AppState[\"collaborationTasks\"],\n  // Quick commands (Feature 19)\n  commandPaletteVisible: false,\n  commandFilter: \"\",\n  commandIndex: 0,\n  // Message search (Feature 4)\n  searchOpen: false,\n  searchQuery: \"\",\n  searchResults: [] as string[],\n  searchIndex: 0,\n  // TaxStore marketplace\n  taxstoreConnected: false,\n  taxstoreToken: null as string | null,\n  taxstoreUser: null as AppState[\"taxstoreUser\"],\n  taxstoreSkills: [] as AppState[\"taxstoreSkills\"],\n  taxstorePage: 1,\n  taxstoreTotalPages: 1,\n  taxstoreQuery: \"\",\n  taxstoreCategory: \"\",\n  taxstoreSort: \"latest\" as const,\n  taxstoreLoading: false,\n  taxstoreError: null as string | null,\n  taxstoreInstalledIds: new Set<string>(),\n  taxstoreUpdates: [] as AppState[\"taxstoreUpdates\"],\n  taxstoreLoginEmail: \"\",\n  taxstoreLoginPassword: \"\",\n  taxstoreInstallingId: null,\n  taxstoreInstallStep: null,\n  // Agent rental marketplace\n  rentalActiveTab: \"agents\" as const,\n  rentalPublishDialog: false,\n  rentalPublishAgent: null,\n  rentalPublishDraft: { price: 10, description: \"\", tags: [] as string[] },\n  rentalMyListings: [] as AppState[\"rentalMyListings\"],\n  rentalPendingTasks: [] as AppState[\"rentalPendingTasks\"],\n  rentalActiveTask: null,\n  rentalTaskResult: \"\",\n  rentalTaskPanel: false,\n  rentalPollingTimer: null,\n  rentalAgentProcessing: false,\n  rentalCompletedTasks: [] as AppState[\"rentalCompletedTasks\"],\n  rentalTaskListType: null,\n  rentalTaskDetailView: null,\n  rentalTaskAttachments: [] as File[],\n  rentalTaskInstruction: \"\",\n  rentalMessages: [] as AppState[\"rentalMessages\"],\n  rentalMessageInput: \"\",\n  rentalMessagesOpen: false,\n  // Client-submitted tasks (consult)\n  consultMyTasks: [] as AppState[\"consultMyTasks\"],\n  consultUnreadCount: 0,\n  consultPollingTimer: null,\n  consultView: \"list\" as const,\n  consultAgents: [] as AppState[\"consultAgents\"],\n  consultLoading: false,\n  consultSearch: \"\",\n  consultAvgTime: \"\",\n  consultSelectedAgent: null,\n  consultTaskTitle: \"\",\n  consultTaskContent: \"\",\n  consultSubmitting: false,\n  consultSelectedTask: null,\n  consultAttachments: [] as AppState[\"consultAttachments\"],\n  consultUploading: false,\n  // Task detail features\n  consultMessages: [] as AppState[\"consultMessages\"],\n  consultMessageInput: \"\",\n  consultMessagesOpen: false,\n  consultMessagesSending: false,\n  consultRevisionOpen: false,\n  consultRevisionText: \"\",\n  consultRevisionSubmitting: false,\n  consultRatingOpen: false,\n  consultRatingValue: 0,\n  consultRatingHover: 0,\n  consultRatingComment: \"\",\n  consultRatingSubmitting: false,\n  // Global refresh\n  refreshing: false,\n  lastRefreshTime: null as number | null,\n};\n\n// â”€â”€â”€ State Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function isAnySending(): boolean {\n  return state.activeRuns.size > 0;\n}\n\nexport function isSessionBusy(sessionKey: string): boolean {\n  return state.activeRuns.has(sessionKey);\n}\n\nexport function findRunForEvent(evtSessionKey: string): ActiveRun | null {\n  for (const run of state.activeRuns.values()) {\n    if (evtSessionKey.endsWith(run.sessionKey) || evtSessionKey === run.sessionKey) {\n      return run;\n    }\n  }\n  // Also check default session\n  if (evtSessionKey.endsWith(state.sessionKey)) {\n    return state.activeRuns.get(state.sessionKey) || null;\n  }\n  return null;\n}\n\n/**\n * Get the messages array for a given session key.\n * Returns state.messages if it's the current conversation,\n * or the backgroundMessages entry if it's a background conversation.\n */\nexport function getMessagesForSession(sessionKey: string): ChatMessage[] {\n  // Current conversation\n  if (sessionKey === state.sessionKey) return state.messages;\n  // Background conversation â€” extract convId from \"taxchat-{convId}\"\n  const convId = sessionKey.startsWith(\"taxchat-\") ? sessionKey.slice(8) : sessionKey;\n  if (state.backgroundMessages.has(convId)) {\n    return state.backgroundMessages.get(convId)!;\n  }\n  return state.messages; // fallback\n}\n\n/**\n * Check if a session key is for the currently active conversation.\n */\nexport function isCurrentSession(sessionKey: string): boolean {\n  return sessionKey === state.sessionKey;\n}\n","/**\n * TaxChat IndexedDB Store â€” persistent message storage with localStorage fallback\n */\n\nimport type { ChatMessage } from \"./types\";\n\nconst DB_NAME = \"taxbot_db\";\nconst DB_VERSION = 1;\nconst MESSAGES_STORE = \"messages\";\nconst META_STORE = \"meta\";\n\nlet dbInstance: IDBDatabase | null = null;\nlet dbFailed = false;\n\nfunction openDB(): Promise<IDBDatabase> {\n  if (dbInstance) return Promise.resolve(dbInstance);\n  if (dbFailed) return Promise.reject(new Error(\"IndexedDB unavailable\"));\n\n  return new Promise((resolve, reject) => {\n    try {\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\n      request.onupgradeneeded = () => {\n        const db = request.result;\n        if (!db.objectStoreNames.contains(MESSAGES_STORE)) {\n          db.createObjectStore(MESSAGES_STORE);\n        }\n        if (!db.objectStoreNames.contains(META_STORE)) {\n          db.createObjectStore(META_STORE);\n        }\n      };\n      request.onsuccess = () => {\n        dbInstance = request.result;\n        dbInstance.onclose = () => { dbInstance = null; };\n        resolve(dbInstance);\n      };\n      request.onerror = () => {\n        dbFailed = true;\n        reject(request.error);\n      };\n    } catch (e) {\n      dbFailed = true;\n      reject(e);\n    }\n  });\n}\n\nexport async function saveMessagesToIDB(convId: string, messages: ChatMessage[]): Promise<void> {\n  const db = await openDB();\n  const toSave = messages.slice(-200);\n  return new Promise((resolve, reject) => {\n    const tx = db.transaction(MESSAGES_STORE, \"readwrite\");\n    tx.objectStore(MESSAGES_STORE).put(toSave, convId);\n    tx.oncomplete = () => resolve();\n    tx.onerror = () => reject(tx.error);\n  });\n}\n\nexport async function loadMessagesFromIDB(convId: string): Promise<ChatMessage[] | null> {\n  try {\n    const db = await openDB();\n    return new Promise((resolve, reject) => {\n      const tx = db.transaction(MESSAGES_STORE, \"readonly\");\n      const req = tx.objectStore(MESSAGES_STORE).get(convId);\n      req.onsuccess = () => {\n        const result = req.result;\n        resolve(Array.isArray(result) ? result : null);\n      };\n      req.onerror = () => reject(req.error);\n    });\n  } catch {\n    return null;\n  }\n}\n\nexport async function deleteConversationFromIDB(convId: string): Promise<void> {\n  try {\n    const db = await openDB();\n    return new Promise((resolve, reject) => {\n      const tx = db.transaction(MESSAGES_STORE, \"readwrite\");\n      tx.objectStore(MESSAGES_STORE).delete(convId);\n      tx.oncomplete = () => resolve();\n      tx.onerror = () => reject(tx.error);\n    });\n  } catch {\n    // silently fail\n  }\n}\n\n/**\n * Migrate all conversations from localStorage to IndexedDB.\n * Sets a flag so migration only runs once.\n */\nexport async function migrateToIDB(conversationIds: string[]): Promise<boolean> {\n  if (localStorage.getItem(\"taxbot_idb_migrated\") === \"1\") return true;\n  try {\n    const db = await openDB();\n    for (const convId of conversationIds) {\n      const key = `taxbot_messages_${convId}`;\n      const raw = localStorage.getItem(key);\n      if (!raw) continue;\n      try {\n        const messages = JSON.parse(raw);\n        if (Array.isArray(messages)) {\n          await new Promise<void>((resolve, reject) => {\n            const tx = db.transaction(MESSAGES_STORE, \"readwrite\");\n            tx.objectStore(MESSAGES_STORE).put(messages.slice(-200), convId);\n            tx.oncomplete = () => resolve();\n            tx.onerror = () => reject(tx.error);\n          });\n        }\n      } catch { /* skip corrupt entries */ }\n    }\n    localStorage.setItem(\"taxbot_idb_migrated\", \"1\");\n    // Keep localStorage keys as fallback â€” do NOT delete them\n    console.log(`[IDB] Migrated ${conversationIds.length} conversations to IndexedDB`);\n    return true;\n  } catch (e) {\n    console.warn(\"[IDB] Migration failed, using localStorage fallback:\", e);\n    return false;\n  }\n}\n\n/** Check if IndexedDB is available and working */\nexport function isIDBAvailable(): boolean {\n  return !dbFailed;\n}\n","/**\n * TaxChat Persistence â€” localStorage + IndexedDB storage with debounced saves\n */\n\nimport type { ChatMessage, Conversation, NotificationEntry, CustomSkill } from \"./types\";\nimport { state } from \"./state\";\nimport { generateUUID } from \"./state\";\nimport {\n  FAVORITES_STORAGE_KEY,\n  MESSAGES_STORAGE_KEY,\n  NOTIFICATIONS_STORAGE_KEY,\n  CUSTOM_SKILLS_STORAGE_KEY,\n  CONVERSATIONS_STORAGE_KEY,\n  CURRENT_CONV_KEY,\n} from \"./constants\";\nimport { saveMessagesToIDB, loadMessagesFromIDB, deleteConversationFromIDB, migrateToIDB, isIDBAvailable } from \"./idb-store\";\n\n// Track whether IDB migration has completed\nlet idbReady = false;\n\n// â”€â”€â”€ Conversation Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function loadConversations(): Conversation[] {\n  try {\n    const raw = localStorage.getItem(CONVERSATIONS_STORAGE_KEY);\n    if (raw) {\n      const parsed = JSON.parse(raw);\n      if (Array.isArray(parsed)) return parsed;\n    }\n  } catch {}\n  return [];\n}\n\nexport function saveConversations() {\n  try {\n    localStorage.setItem(CONVERSATIONS_STORAGE_KEY, JSON.stringify(state.conversations));\n  } catch {}\n}\n\nexport function loadMessagesForConversation(convId: string): ChatMessage[] {\n  try {\n    const raw = localStorage.getItem(`taxbot_messages_${convId}`);\n    if (raw) {\n      const parsed = JSON.parse(raw);\n      if (Array.isArray(parsed)) return parsed;\n    }\n  } catch {}\n  return [];\n}\n\n/**\n * Load messages with IDB priority, falling back to localStorage.\n * Always tries IDB if available (regardless of migration status).\n */\nexport async function loadMessagesAsync(convId: string): Promise<ChatMessage[]> {\n  if (isIDBAvailable()) {\n    try {\n      const idbMessages = await loadMessagesFromIDB(convId);\n      if (idbMessages && idbMessages.length > 0) return idbMessages;\n    } catch { /* fall through to localStorage */ }\n  }\n  return loadMessagesForConversation(convId);\n}\n\nexport function saveMessagesForConversation(convId: string, messages: ChatMessage[]) {\n  const toSave = messages.slice(-200);\n  // Always write to localStorage (sync, reliable)\n  try { localStorage.setItem(`taxbot_messages_${convId}`, JSON.stringify(toSave)); } catch {}\n  // Also write to IDB if available (async, for large datasets)\n  if (idbReady && isIDBAvailable()) {\n    saveMessagesToIDB(convId, toSave).catch(() => {});\n  }\n}\n\nexport function loadFavoritesForConversation(convId: string): Set<string> {\n  try {\n    const raw = localStorage.getItem(`taxbot_favorites_${convId}`);\n    if (raw) return new Set(JSON.parse(raw));\n  } catch {}\n  return new Set();\n}\n\nexport function saveFavoritesForConversation(convId: string, favorites: Set<string>) {\n  try {\n    localStorage.setItem(`taxbot_favorites_${convId}`, JSON.stringify([...favorites]));\n  } catch {}\n}\n\n// â”€â”€â”€ Legacy Single-conversation Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function loadMessages(): ChatMessage[] {\n  try {\n    const raw = localStorage.getItem(MESSAGES_STORAGE_KEY);\n    if (raw) {\n      const parsed = JSON.parse(raw);\n      if (Array.isArray(parsed)) return parsed;\n    }\n  } catch {}\n  return [];\n}\n\nexport function loadFavorites(): Set<string> {\n  try {\n    const raw = localStorage.getItem(FAVORITES_STORAGE_KEY);\n    if (raw) return new Set(JSON.parse(raw));\n  } catch {}\n  return new Set();\n}\n\n// â”€â”€â”€ Save Current State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function saveMessages() {\n  try {\n    saveMessagesForConversation(state.currentConversationId, state.messages);\n    const conv = state.conversations.find(c => c.id === state.currentConversationId);\n    if (conv) {\n      conv.updatedAt = Date.now();\n      conv.messageCount = state.messages.length;\n      saveConversations();\n    }\n  } catch {}\n}\n\n// â”€â”€â”€ Debounced Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet saveTimer: ReturnType<typeof setTimeout> | null = null;\n\n/**\n * Debounced version of saveMessages â€” coalesces rapid saves (e.g., from\n * multiple agent completions) into a single write after 2 seconds.\n * For critical operations (conversation switch, user-initiated clear),\n * use saveMessages() directly instead.\n */\nexport function debouncedSaveMessages() {\n  if (saveTimer) clearTimeout(saveTimer);\n  saveTimer = setTimeout(() => {\n    saveTimer = null;\n    saveMessages();\n  }, 2000);\n}\n\n/** Flush any pending debounced save immediately */\nexport function flushPendingSave() {\n  if (saveTimer) {\n    clearTimeout(saveTimer);\n    saveTimer = null;\n    saveMessages();\n  }\n}\n\nexport function saveFavorites() {\n  try {\n    saveFavoritesForConversation(state.currentConversationId, state.favorites);\n  } catch {}\n  syncFavoritesToMemory();\n}\n\n/** Sync favorited messages to agent memory file so the bot can recall them */\nfunction syncFavoritesToMemory() {\n  const api = (window as any).electronAPI;\n  if (!api?.syncFavoritesToMemory) return;\n\n  const favMsgs: Array<{ text: string; timestamp: number; question?: string }> = [];\n  for (const msgId of state.favorites) {\n    const idx = state.messages.findIndex(m => m.id === msgId);\n    if (idx < 0) continue;\n    const msg = state.messages[idx];\n    if (msg.type !== \"assistant\") continue;\n    let question: string | undefined;\n    for (let j = idx - 1; j >= 0; j--) {\n      if (state.messages[j].type === \"user\") {\n        question = state.messages[j].text;\n        break;\n      }\n    }\n    favMsgs.push({ text: msg.text, timestamp: msg.timestamp, question });\n  }\n  api.syncFavoritesToMemory(favMsgs).catch(() => {});\n}\n\n// â”€â”€â”€ Delete Conversation from IDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function deleteConversationData(convId: string) {\n  localStorage.removeItem(`taxbot_messages_${convId}`);\n  localStorage.removeItem(`taxbot_favorites_${convId}`);\n  if (idbReady && isIDBAvailable()) {\n    deleteConversationFromIDB(convId).catch(() => {});\n  }\n}\n\n// â”€â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function loadNotifications(): NotificationEntry[] {\n  try {\n    const raw = localStorage.getItem(NOTIFICATIONS_STORAGE_KEY);\n    if (raw) return JSON.parse(raw);\n  } catch (_) {}\n  return [];\n}\n\nexport function saveNotifications() {\n  const toSave = state.notifications.slice(-50);\n  localStorage.setItem(NOTIFICATIONS_STORAGE_KEY, JSON.stringify(toSave));\n}\n\n// â”€â”€â”€ Custom Skills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function loadCustomSkills(): CustomSkill[] {\n  try {\n    const raw = localStorage.getItem(CUSTOM_SKILLS_STORAGE_KEY);\n    if (raw) return JSON.parse(raw);\n  } catch (_) {}\n  return [];\n}\n\nexport function saveCustomSkills() {\n  localStorage.setItem(CUSTOM_SKILLS_STORAGE_KEY, JSON.stringify(state.customSkills));\n}\n\n// â”€â”€â”€ Migration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n/**\n * Migrate old single-conversation storage to new multi-conversation format.\n * Called once on startup if no conversations exist yet but old messages do.\n */\nexport function migrateOldMessages(): { conversations: Conversation[]; currentId: string } {\n  const oldMessages = loadMessages();\n  const oldFavorites = loadFavorites();\n  const convId = generateUUID();\n  const now = Date.now();\n\n  const firstUserMsg = oldMessages.find(m => m.type === \"user\");\n  const title = firstUserMsg\n    ? firstUserMsg.text.replace(/\\n/g, \" \").slice(0, 20) + (firstUserMsg.text.length > 20 ? \"...\" : \"\")\n    : \"é»˜è®¤å¯¹è¯\";\n\n  const conv: Conversation = {\n    id: convId,\n    title,\n    createdAt: oldMessages.length > 0 ? oldMessages[0].timestamp : now,\n    updatedAt: oldMessages.length > 0 ? oldMessages[oldMessages.length - 1].timestamp : now,\n    messageCount: oldMessages.length,\n  };\n\n  if (oldMessages.length > 0) {\n    saveMessagesForConversation(convId, oldMessages);\n  }\n  if (oldFavorites.size > 0) {\n    saveFavoritesForConversation(convId, oldFavorites);\n  }\n\n  return { conversations: [conv], currentId: convId };\n}\n\n// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Populate state fields that depend on localStorage\nexport function initPersistence() {\n  state.notifications = loadNotifications();\n  state.customSkills = loadCustomSkills();\n\n  // Attempt IndexedDB migration in background (non-blocking)\n  const convIds = state.conversations.map(c => c.id);\n  if (convIds.length === 0) {\n    // No conversations yet â€” will migrate after they're loaded\n    const loaded = loadConversations();\n    if (loaded.length > 0) {\n      migrateToIDB(loaded.map(c => c.id))\n        .then(ok => { idbReady = ok; })\n        .catch(() => { idbReady = false; });\n    } else {\n      idbReady = true; // No data to migrate\n    }\n  } else {\n    migrateToIDB(convIds)\n      .then(ok => { idbReady = ok; })\n      .catch(() => { idbReady = false; });\n  }\n}\n","/**\n * TaxChat Virtual Scrolling â€” only renders visible messages for performance.\n *\n * Strategy: estimated heights with measurement cache + overscan buffer.\n * Non-virtual elements (thinking indicators, collab cards) are always rendered.\n */\n\nimport type { ChatMessage } from \"./types\";\nimport { state, scheduleRender } from \"./state\";\n\n// â”€â”€â”€ Height Estimation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst DEFAULT_USER_HEIGHT = 70;\nconst DEFAULT_ASSISTANT_HEIGHT = 140;\nconst OVERSCAN = 5; // extra items above/below viewport\n\nconst measuredHeights = new Map<string, number>();\n\nfunction estimateHeight(msg: ChatMessage): number {\n  if (msg.id && measuredHeights.has(msg.id)) return measuredHeights.get(msg.id)!;\n  return msg.type === \"user\" ? DEFAULT_USER_HEIGHT : DEFAULT_ASSISTANT_HEIGHT;\n}\n\n// â”€â”€â”€ Virtual Range Calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport interface VirtualRange {\n  startIndex: number;\n  endIndex: number;\n  topPadding: number;\n  bottomPadding: number;\n  totalHeight: number;\n}\n\n/**\n * Calculate which messages should be rendered given the scroll position.\n */\nexport function calculateVirtualRange(\n  messages: ChatMessage[],\n  scrollTop: number,\n  containerHeight: number,\n): VirtualRange {\n  if (messages.length === 0) {\n    return { startIndex: 0, endIndex: 0, topPadding: 0, bottomPadding: 0, totalHeight: 0 };\n  }\n\n  // If fewer than 40 messages, render all (no virtualization needed)\n  if (messages.length < 40) {\n    return {\n      startIndex: 0,\n      endIndex: messages.length,\n      topPadding: 0,\n      bottomPadding: 0,\n      totalHeight: messages.reduce((sum, m) => sum + estimateHeight(m), 0),\n    };\n  }\n\n  // Calculate cumulative heights\n  let totalHeight = 0;\n  const offsets: number[] = [];\n  for (const msg of messages) {\n    offsets.push(totalHeight);\n    totalHeight += estimateHeight(msg);\n  }\n\n  // Find visible range\n  let startIndex = 0;\n  for (let i = 0; i < offsets.length; i++) {\n    if (offsets[i] + estimateHeight(messages[i]) >= scrollTop) {\n      startIndex = i;\n      break;\n    }\n  }\n\n  let endIndex = startIndex;\n  for (let i = startIndex; i < messages.length; i++) {\n    endIndex = i + 1;\n    if (offsets[i] > scrollTop + containerHeight) break;\n  }\n\n  // Apply overscan\n  startIndex = Math.max(0, startIndex - OVERSCAN);\n  endIndex = Math.min(messages.length, endIndex + OVERSCAN);\n\n  // Calculate paddings\n  const topPadding = offsets[startIndex] || 0;\n  let bottomPadding = 0;\n  for (let i = endIndex; i < messages.length; i++) {\n    bottomPadding += estimateHeight(messages[i]);\n  }\n\n  return { startIndex, endIndex, topPadding, bottomPadding, totalHeight };\n}\n\n// â”€â”€â”€ Height Measurement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n/**\n * Measure rendered message heights from DOM and update cache.\n * Called after render to improve accuracy for subsequent frames.\n */\nexport function measureRenderedHeights() {\n  const container = document.getElementById(\"messages-container\");\n  if (!container) return;\n\n  const elements = container.querySelectorAll(\"[data-msg-id]\");\n  for (const el of elements) {\n    const id = el.getAttribute(\"data-msg-id\");\n    if (!id) continue;\n    const height = (el as HTMLElement).offsetHeight;\n    if (height > 0) {\n      measuredHeights.set(id, height);\n    }\n  }\n}\n\n// â”€â”€â”€ Auto Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet wasAtBottom = true;\n\n/** Check if user is scrolled near the bottom */\nexport function checkAtBottom(container: HTMLElement): boolean {\n  const threshold = 80;\n  wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < threshold;\n  return wasAtBottom;\n}\n\n/** Scroll to bottom if user was previously at bottom */\nexport function autoScrollToBottom(container: HTMLElement) {\n  if (wasAtBottom) {\n    container.scrollTop = container.scrollHeight;\n  }\n}\n\n/** Force scroll to bottom (e.g., new message from user) */\nexport function forceScrollToBottom() {\n  wasAtBottom = true;\n  const container = document.getElementById(\"messages-container\");\n  if (container) {\n    container.scrollTop = container.scrollHeight;\n  }\n}\n\n/** Clear height cache (e.g., when switching conversations) */\nexport function clearHeightCache() {\n  measuredHeights.clear();\n}\n","/**\n * TaxChat Conversation Management\n */\n\nimport type { Conversation } from \"./types\";\nimport { state, generateUUID, scheduleRender, setForceScrollBottom } from \"./state\";\nimport {\n  loadConversations,\n  saveConversations,\n  loadMessagesForConversation,\n  loadMessagesAsync,\n  loadFavoritesForConversation,\n  saveFavorites,\n  saveMessages,\n  flushPendingSave,\n  deleteConversationData,\n  migrateOldMessages,\n} from \"./persistence\";\nimport { clearHeightCache } from \"./virtual-scroll\";\nimport { MESSAGES_STORAGE_KEY, CURRENT_CONV_KEY } from \"./constants\";\n\n/** Remove favorite IDs that reference messages no longer in state.messages */\nfunction pruneOrphanedFavorites() {\n  const msgIds = new Set(state.messages.map(m => m.id));\n  let changed = false;\n  for (const favId of state.favorites) {\n    if (!msgIds.has(favId)) {\n      state.favorites.delete(favId);\n      changed = true;\n    }\n  }\n  if (changed) saveFavorites();\n}\n\n// â”€â”€â”€ Conversation CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function createConversation() {\n  flushPendingSave();\n  saveMessages();\n\n  const convId = generateUUID();\n  const now = Date.now();\n  const conv: Conversation = {\n    id: convId,\n    title: \"æ–°å¯¹è¯\",\n    createdAt: now,\n    updatedAt: now,\n    messageCount: 0,\n    lastAccessedAt: now,\n  };\n  state.conversations.unshift(conv);\n  saveConversations();\n  switchConversation(convId);\n}\n\nexport function switchConversation(convId: string) {\n  if (convId === state.currentConversationId) return;\n\n  flushPendingSave();\n  saveMessages();\n\n  const oldConvId = state.currentConversationId;\n  const oldSessionKey = state.sessionKey;\n\n  // If the old conversation has active runs, keep them alive by moving messages to background\n  const hasActiveRunsForOld = [...state.activeRuns.values()].some(r => r.sessionKey === oldSessionKey);\n  if (hasActiveRunsForOld) {\n    state.backgroundMessages.set(oldConvId, [...state.messages]);\n  }\n\n  // Only clear runs that belong to the OLD session if there are NONE active\n  if (!hasActiveRunsForOld) {\n    // Clear old session's runs only\n    for (const [sk] of state.activeRuns) {\n      if (sk === oldSessionKey) state.activeRuns.delete(sk);\n    }\n  }\n\n  state.replyingTo = null;\n  state.pendingDispatch = null;\n\n  state.currentConversationId = convId;\n  state.sessionKey = `taxchat-${convId}`;\n\n  // If background messages exist for the new conversation, use them (they're more up-to-date)\n  if (state.backgroundMessages.has(convId)) {\n    state.messages = state.backgroundMessages.get(convId)!;\n    state.backgroundMessages.delete(convId);\n  } else {\n    state.messages = loadMessagesForConversation(convId);\n  }\n\n  state.favorites = loadFavoritesForConversation(convId);\n  pruneOrphanedFavorites();\n  state.unreadConversations.delete(convId);\n  // Update lastAccessedAt for sort-by-click ordering\n  const targetConv = state.conversations.find(c => c.id === convId);\n  if (targetConv) targetConv.lastAccessedAt = Date.now();\n  saveConversations();\n  localStorage.setItem(CURRENT_CONV_KEY, convId);\n  clearHeightCache();\n  setForceScrollBottom(true);\n  scheduleRender();\n\n  // If localStorage was empty, try recovering from IndexedDB\n  if (state.messages.length === 0) {\n    loadMessagesAsync(convId).then(msgs => {\n      if (msgs.length > 0 && state.currentConversationId === convId) {\n        state.messages = msgs;\n        pruneOrphanedFavorites();\n        clearHeightCache();\n        setForceScrollBottom(true);\n        scheduleRender();\n      }\n    });\n  }\n}\n\nexport function deleteConversation(convId: string) {\n  state.conversations = state.conversations.filter(c => c.id !== convId);\n\n  deleteConversationData(convId);\n\n  if (convId === state.currentConversationId) {\n    if (state.conversations.length === 0) {\n      createConversation();\n    } else {\n      switchConversation(state.conversations[0].id);\n    }\n  }\n\n  saveConversations();\n  state.confirmingConvDelete = null;\n  scheduleRender();\n}\n\nexport function renameConversation(convId: string, newTitle: string) {\n  const conv = state.conversations.find(c => c.id === convId);\n  if (conv) {\n    conv.title = newTitle.trim() || \"æ–°å¯¹è¯\";\n    saveConversations();\n  }\n  state.renamingConversation = null;\n  scheduleRender();\n}\n\n/** Auto-generate title from first user message (called after first message sent) */\nexport function autoTitleConversation() {\n  const conv = state.conversations.find(c => c.id === state.currentConversationId);\n  if (!conv || conv.title !== \"æ–°å¯¹è¯\") return;\n\n  const firstUserMsg = state.messages.find(m => m.type === \"user\");\n  if (firstUserMsg) {\n    const text = firstUserMsg.text.replace(/\\n/g, \" \").trim();\n    conv.title = text.slice(0, 20) + (text.length > 20 ? \"...\" : \"\");\n    saveConversations();\n  }\n}\n\n// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n/** Initialize conversations (migrate old data if needed). Called once at startup. */\nexport function initConversations() {\n  let convs = loadConversations();\n  let currentId = localStorage.getItem(CURRENT_CONV_KEY) || \"\";\n\n  if (convs.length === 0) {\n    const oldRaw = localStorage.getItem(MESSAGES_STORAGE_KEY);\n    if (oldRaw) {\n      const migrated = migrateOldMessages();\n      convs = migrated.conversations;\n      currentId = migrated.currentId;\n    } else {\n      const convId = generateUUID();\n      convs = [{\n        id: convId,\n        title: \"æ–°å¯¹è¯\",\n        createdAt: Date.now(),\n        updatedAt: Date.now(),\n        messageCount: 0,\n      }];\n      currentId = convId;\n    }\n    state.conversations = convs;\n    state.currentConversationId = currentId;\n    saveConversations();\n    localStorage.setItem(CURRENT_CONV_KEY, currentId);\n  } else {\n    state.conversations = convs;\n    if (!convs.find(c => c.id === currentId)) {\n      currentId = convs[0].id;\n    }\n    state.currentConversationId = currentId;\n  }\n\n  state.messages = loadMessagesForConversation(currentId);\n  state.favorites = loadFavoritesForConversation(currentId);\n  pruneOrphanedFavorites();\n  state.sessionKey = `taxchat-${currentId}`;\n\n  // If localStorage was empty (e.g., IDB migration deleted keys), try recovering from IndexedDB\n  if (state.messages.length === 0) {\n    loadMessagesAsync(currentId).then(msgs => {\n      if (msgs.length > 0 && state.currentConversationId === currentId) {\n        state.messages = msgs;\n        pruneOrphanedFavorites();\n        clearHeightCache();\n        setForceScrollBottom(true);\n        scheduleRender();\n      }\n    });\n  }\n}\n","/**\n * TaxChat Utility Functions\n */\n\nimport { toSanitizedMarkdownHtml } from \"../src/ui/markdown\";\nimport type { CustomSkill } from \"./types\";\nimport { state, generateUUID, isAnySending, scheduleRender } from \"./state\";\nimport { saveFavorites, saveNotifications } from \"./persistence\";\nimport { TAX_KEYWORDS, TOOL_LABEL_MAP } from \"./constants\";\n\n// â”€â”€â”€ Formatting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function formatTime(timestamp: number): string {\n  const date = new Date(timestamp);\n  return date.toLocaleTimeString(\"zh-CN\", { hour: \"2-digit\", minute: \"2-digit\" });\n}\n\nexport function formatFileSize(bytes: number): string {\n  if (bytes === 0) return \"0 B\";\n  const k = 1024;\n  const sizes = [\"B\", \"KB\", \"MB\"];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + \" \" + sizes[i];\n}\n\nexport function generateTimestamp() {\n  const now = new Date();\n  return `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, \"0\")}${String(now.getDate()).padStart(2, \"0\")}_${String(now.getHours()).padStart(2, \"0\")}${String(now.getMinutes()).padStart(2, \"0\")}`;\n}\n\n// â”€â”€â”€ Sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function sortedFiles() {\n  const files = [...state.knowledgeFiles];\n  if (state.filesSortBy === \"name\") {\n    files.sort((a, b) => a.name.localeCompare(b.name, \"zh\"));\n  } else {\n    files.sort((a, b) => (b.mtime || 0) - (a.mtime || 0));\n  }\n  return files;\n}\n\nexport function sortedSkills() {\n  const skills = [...state.customSkills];\n  if (state.skillsSortBy === \"name\") {\n    skills.sort((a, b) => a.name.localeCompare(b.name, \"zh\"));\n  } else {\n    skills.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));\n  }\n  return skills;\n}\n\n// â”€â”€â”€ File Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function readFileAsDataUrl(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => {\n      if (typeof reader.result === \"string\") {\n        resolve(reader.result);\n      } else {\n        reject(new Error(\"Failed to read file\"));\n      }\n    };\n    reader.onerror = () => {\n      reject(reader.error);\n    };\n    reader.readAsDataURL(file);\n  });\n}\n\nexport function removeAttachment(index: number) {\n  state.attachments.splice(index, 1);\n  scheduleRender();\n}\n\n// â”€â”€â”€ Favorites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function toggleFavorite(msgId: string) {\n  if (state.favorites.has(msgId)) {\n    state.favorites.delete(msgId);\n  } else {\n    state.favorites.add(msgId);\n  }\n  saveFavorites();\n  scheduleRender();\n}\n\n// â”€â”€â”€ Message Display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function scrollToMessage(msgId: string) {\n  const el = document.querySelector(`[data-msg-id=\"${msgId}\"]`) as HTMLElement | null;\n  if (el) {\n    el.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n    el.style.transition = \"outline 0.2s\";\n    el.style.outline = \"2px solid #00A8FF\";\n    setTimeout(() => { el.style.outline = \"none\"; }, 1500);\n  }\n}\n\nexport function copyMessageText(msgId: string, text: string) {\n  const el = document.createElement(\"div\");\n  el.innerHTML = toSanitizedMarkdownHtml(text);\n  const plain = el.innerText || el.textContent || text;\n  navigator.clipboard.writeText(plain).then(() => {\n    const btn = document.querySelector(`[data-copy-id=\"${msgId}\"]`) as HTMLElement | null;\n    if (btn) {\n      btn.classList.add(\"copied\");\n      const label = btn.querySelector(\".action-label\") as HTMLElement | null;\n      if (label) label.textContent = \"å·²å¤åˆ¶\";\n      setTimeout(() => {\n        btn.classList.remove(\"copied\");\n        if (label) label.textContent = \"å¤åˆ¶\";\n      }, 1500);\n    }\n  });\n}\n\n// â”€â”€â”€ Document Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function generateWordDoc(text: string): string {\n  const bodyHtml = toSanitizedMarkdownHtml(text);\n  return `<!DOCTYPE html>\n<html xmlns:o=\"urn:schemas-microsoft-com:office:office\"\n      xmlns:w=\"urn:schemas-microsoft-com:office:word\"\n      xmlns=\"http://www.w3.org/TR/REC-html40\">\n<head><meta charset=\"utf-8\"><title>Taxbot</title>\n<style>\n  body { font-family: \"Microsoft YaHei\", \"SimSun\", sans-serif; font-size: 12pt; line-height: 1.8; color: #333; }\n  table { border-collapse: collapse; width: 100%; margin: 8px 0; }\n  th, td { border: 1px solid #999; padding: 6px 10px; text-align: left; }\n  th { background: #f0f0f0; font-weight: bold; }\n  h1 { font-size: 18pt; } h2 { font-size: 15pt; } h3 { font-size: 13pt; }\n  ul, ol { padding-left: 2em; }\n</style>\n</head><body>${bodyHtml}</body></html>`;\n}\n\nexport function saveMessageAsWord(text: string) {\n  const wordDoc = generateWordDoc(text);\n  const blob = new Blob([wordDoc], { type: \"application/msword\" });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = `Taxbot_${generateTimestamp()}.doc`;\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n}\n\n// â”€â”€â”€ Toast / Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function showToast(message: string, durationMs = 5000) {\n  if (state.toastTimer) clearTimeout(state.toastTimer);\n  state.toastMessage = message;\n  scheduleRender();\n  state.toastTimer = setTimeout(() => {\n    state.toastMessage = null;\n    state.toastTimer = null;\n    scheduleRender();\n  }, durationMs);\n}\n\nexport function addNotification(text: string, icon = \"ğŸ“š\", taskId?: string, source?: \"rental\" | \"consult\") {\n  state.notifications.push({\n    id: generateUUID(),\n    text,\n    icon,\n    timestamp: Date.now(),\n    ...(taskId ? { taskId } : {}),\n    ...(source ? { source } : {}),\n  });\n  saveNotifications();\n}\n\nexport function dismissQuickStart() {\n  state.showQuickStart = false;\n  localStorage.setItem(\"quickstart_seen\", \"1\");\n  scheduleRender();\n}\n\n// â”€â”€â”€ Text Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function toolLabelMap(toolName: string): string {\n  return TOOL_LABEL_MAP[toolName] || \"æ­£åœ¨æ€è€ƒ...\";\n}\n\nexport function stripThinkingTags(text: string): string {\n  let cleaned = text.replace(/<thinking>[\\s\\S]*?<\\/thinking>\\n?/g, \"\").trim();\n  cleaned = cleaned.replace(/<think>[\\s\\S]*?<\\/think>\\n?/g, \"\").trim();\n  cleaned = cleaned.replace(/<\\/?final>/g, \"\").trim();\n  cleaned = cleaned.replace(/^NO\\n\\n/i, \"\");\n  return cleaned;\n}\n\nexport function extractMessageText(message: unknown): string {\n  const m = message as Record<string, unknown>;\n  const role = typeof m.role === \"string\" ? m.role : \"\";\n  const content = m.content;\n\n  if (typeof content === \"string\") {\n    if (role === \"assistant\") {\n      return stripThinkingTags(content);\n    }\n    return content;\n  }\n\n  if (Array.isArray(content)) {\n    const parts = content\n      .map((p) => {\n        const item = p as Record<string, unknown>;\n        if (item?.type === \"text\" && typeof item.text === \"string\") {\n          return item.text;\n        }\n        return null;\n      })\n      .filter((v): v is string => typeof v === \"string\");\n\n    if (parts.length > 0) {\n      const joined = parts.join(\"\\n\");\n      if (role === \"assistant\") {\n        return stripThinkingTags(joined);\n      }\n      return joined;\n    }\n  }\n\n  if (typeof m.text === \"string\") {\n    if (role === \"assistant\") {\n      return stripThinkingTags(m.text);\n    }\n    return m.text;\n  }\n\n  return \"\";\n}\n\nexport function isSystemMessage(text: string): boolean {\n  const stripped = text.trim();\n  const systemPatterns = [\n    /^NO_REPLY$/i,\n    /^Pre-compaction memory flush/i,\n    /^Store durable memories/i,\n  ];\n  return systemPatterns.some(pattern => pattern.test(stripped));\n}\n\nexport function sanitizeDisplayText(text: string): string {\n  if (/^NO$/i.test(text.trim()) && !isAnySending()) {\n    return \"æ¨¡å‹æœªèƒ½æ­£ç¡®å›å¤ï¼Œè¯·é‡æ–°å‘é€æ‚¨çš„é—®é¢˜ã€‚\";\n  }\n  return text;\n}\n\nexport function autoLinkText(text: string): string {\n  const urlChars = `[^\\\\s<>)\"'ï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿã€‹ï¼‰\\\\]]+`;\n  const pathChars = `[^\\\\s<>:\"*?|ï¼Œã€‚ã€ï¼›ï¼šï¼ï¼Ÿã€‹ï¼‰\\\\]]+`;\n  const re = new RegExp(\n    `(\\`\\`\\`[\\\\s\\\\S]*?\\`\\`\\`)` +\n    `|(\\\\[[^\\\\]]*\\\\]\\\\([^)]+\\\\))` +\n    \"|\\`([^\\`]+)\\`\" +\n    `|(https?:\\\\/\\\\/${urlChars})` +\n    `|([A-Za-z]:\\\\\\\\(?:${pathChars}\\\\\\\\)*${pathChars})`,\n    \"g\"\n  );\n  return text.replace(re, (match, codeBlock, mdLink, inlineCode, url, filePath) => {\n    if (codeBlock || mdLink) return match;\n    if (inlineCode !== undefined) {\n      const t = inlineCode.trim();\n      if (/^[A-Za-z]:\\\\/.test(t)) {\n        const cleaned = t.replace(/[.,;:!?)]+$/, \"\");\n        return `[${cleaned}](#localpath=${encodeURIComponent(cleaned)})`;\n      }\n      if (/^https?:\\/\\//.test(t)) {\n        const cleaned = t.replace(/[.,;:!?)]+$/, \"\");\n        return `[${cleaned}](${cleaned})`;\n      }\n      return match;\n    }\n    if (url) {\n      const cleaned = url.replace(/[.,;:!?)]+$/, \"\");\n      return `[${cleaned}](${cleaned})`;\n    }\n    if (filePath) {\n      const cleaned = filePath.replace(/[.,;:!?)]+$/, \"\");\n      return `[${cleaned}](#localpath=${encodeURIComponent(cleaned)})`;\n    }\n    return match;\n  });\n}\n\n// â”€â”€â”€ Tax Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function isTaxRelated(text: string): boolean {\n  return TAX_KEYWORDS.test(text);\n}\n\nexport function buildTaxYesMessageList(): Array<{ input: string; answer: string }> {\n  const result: Array<{ input: string; answer: string }> = [];\n  const msgs = state.messages;\n  for (let i = msgs.length - 1; i >= 0 && result.length < 5; i--) {\n    const msg = msgs[i];\n    if (msg.type === \"assistant\" && i > 0) {\n      const prev = msgs[i - 1];\n      if (prev?.type === \"user\") {\n        result.unshift({ input: prev.text, answer: (msg as any).text || \"\" });\n        i--;\n      }\n    }\n  }\n  return result;\n}\n\nexport async function consultTaxYes(content: string): Promise<string | null> {\n  try {\n    const electronAPI = (window as any).electronAPI;\n    if (!electronAPI?.taxYesChat) return null;\n    const messageList = buildTaxYesMessageList();\n    const result = await electronAPI.taxYesChat(content, messageList);\n    if (result?.ok && result.answer && result.answer.trim()) {\n      return result.answer.trim();\n    }\n    if (!result?.ok) {\n      console.warn(\"Taxbot API error:\", result?.error);\n    }\n    return null;\n  } catch (err) {\n    console.warn(\"Taxbot API call failed:\", err);\n    return null;\n  }\n}\n\nexport async function extractAttachmentTexts(attachments: typeof state.attachments): Promise<string> {\n  const electronAPI = (window as any).electronAPI;\n  if (!electronAPI?.extractDocumentText) return \"\";\n\n  const parts: string[] = [];\n  for (const att of attachments) {\n    const match = /^data:([^;]+);base64,(.+)$/.exec(att.dataUrl);\n    if (!match) continue;\n    const mimeType = match[1];\n    const base64Data = match[2];\n    try {\n      const result = await electronAPI.extractDocumentText(base64Data, mimeType, att.name);\n      if (result?.ok && result.text?.trim()) {\n        parts.push(`ã€${att.name}ã€‘\\n${result.text.trim()}`);\n      }\n    } catch (err) {\n      console.warn(`Failed to extract text from ${att.name}:`, err);\n    }\n  }\n  return parts.join(\"\\n\\n\");\n}\n\n// â”€â”€â”€ Misc Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function escapeRegex(s: string): string {\n  return s.replace(/[.*+?^${}()|[\\]\\\\]/g, \"\\\\$&\");\n}\n\nexport function formatImportResult(result: any): string {\n  const parts: string[] = [];\n  if (result.textCount > 0) parts.push(`æ–‡æœ¬ ${result.textCount}`);\n  if (result.imageCount > 0) parts.push(`å›¾ç‰‡ ${result.imageCount}`);\n  if (result.docCount > 0) parts.push(`æ–‡æ¡£ ${result.docCount}`);\n  if (parts.length === 0) return result.message || \"æœªæ‰¾åˆ°å¯è¯»å–çš„æ–‡ä»¶\";\n  return `å·²å¯¼å…¥: ${parts.join(\"ã€\")}`;\n}\n","/**\n * TaxChat Agent Management\n */\n\nimport type { AgentEntry, AgentMention } from \"./types\";\nimport { state, generateUUID, scheduleRender } from \"./state\";\nimport { AGENT_TEMPLATES, BUILTIN_SKILLS } from \"./constants\";\nimport { showToast } from \"./utils\";\n\n/** Build skills info array from selected skill IDs for TOOLS.md generation */\nfunction buildSkillsForTools(selectedIds: string[]): { name: string; emoji: string; description: string; prompt: string }[] {\n  if (!selectedIds.length) return [];\n  const allSkills = [...BUILTIN_SKILLS, ...state.customSkills.filter(s => !s.id.startsWith(\"__builtin_\"))];\n  return selectedIds\n    .map(id => allSkills.find(s => s.id === id))\n    .filter((s): s is NonNullable<typeof s> => !!s)\n    .map(s => ({ name: s.name, emoji: s.emoji, description: s.description, prompt: s.prompt }));\n}\n\n// â”€â”€â”€ Agent Memory Cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst agentMemoryCache = new Map<string, string>();\n\nexport async function loadAgentMemory(agentId: string): Promise<string> {\n  if (agentMemoryCache.has(agentId)) return agentMemoryCache.get(agentId)!;\n  const api = (window as any).electronAPI;\n  if (!api?.readAgentMemory) return \"\";\n  try {\n    const res = await api.readAgentMemory(agentId);\n    const content = res?.ok ? (res.content || \"\") : \"\";\n    agentMemoryCache.set(agentId, content);\n    return content;\n  } catch { return \"\"; }\n}\n\nexport async function saveAgentMemory(agentId: string, content: string) {\n  agentMemoryCache.set(agentId, content);\n  const api = (window as any).electronAPI;\n  if (!api?.writeAgentMemory) return;\n  try { await api.writeAgentMemory(agentId, content); } catch {}\n}\n\nexport async function appendAgentMemory(agentId: string, newEntry: string) {\n  const existing = await loadAgentMemory(agentId);\n  const timestamp = new Date().toLocaleString(\"zh-CN\");\n  const updated = existing\n    ? `${existing}\\n\\n---\\n\\n[${timestamp}]\\n${newEntry}`\n    : `[${timestamp}]\\n${newEntry}`;\n  await saveAgentMemory(agentId, updated);\n}\n\n// â”€â”€â”€ Agent CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function loadAgents() {\n  if (!state.client || !state.connected) return;\n  if (state.agentsLoading) return;\n  state.agentsLoading = true;\n  scheduleRender();\n  try {\n    const res = await state.client.request(\"agents.list\", {}) as any;\n    console.log(\"[Agents] agents.list response:\", JSON.stringify(res, null, 2)?.substring(0, 500));\n    if (res?.agents && Array.isArray(res.agents)) {\n      const defaultId = res.defaultId || \"main\";\n      state.agentsList = res.agents.map((a: any) => ({\n        id: a.id,\n        name: a.name?.trim() || a.identity?.name?.trim() || a.id,\n        emoji: (a.identity?.emoji?.trim() && a.identity.emoji.trim().length <= 8) ? a.identity.emoji.trim() : \"ğŸ¤–\",\n        avatarUrl: a.identity?.avatarUrl || a.identity?.avatar || undefined,\n        description: a.identity?.theme?.trim() || \"\",\n        isDefault: a.id === defaultId,\n      }));\n      if (!state.agentsList.find(a => a.isDefault)) {\n        state.agentsList.unshift({ id: defaultId, name: defaultId, emoji: \"ğŸ¤–\", description: \"\", isDefault: true });\n      }\n      state.agentsList.sort((a, b) => {\n        if (a.isDefault && !b.isDefault) return -1;\n        if (!a.isDefault && b.isDefault) return 1;\n        return a.name.localeCompare(b.name);\n      });\n      console.log(\"[Agents] Loaded\", state.agentsList.length, \"agents:\", state.agentsList.map(a => `${a.id}(${a.name})`).join(\", \"));\n\n      const nameless = state.agentsList.filter(a => !a.isDefault && a.name === a.id);\n      if (nameless.length > 0) {\n        console.log(\"[Agents] Found agents without names, attempting recovery:\", nameless.map(a => a.id));\n        await recoverAgentNames();\n      }\n    } else {\n      console.warn(\"[Agents] agents.list returned unexpected shape:\", res);\n    }\n  } catch (err: any) {\n    console.error(\"loadAgents error:\", err);\n  }\n  state.agentsLoading = false;\n  scheduleRender();\n  syncAgentsToMainWorkspace();\n}\n\nexport async function recoverAgentNames() {\n  const api = (window as any).electronAPI;\n  if (!api?.recoverAgentIdentities || !state.client) return;\n  try {\n    const result = await api.recoverAgentIdentities();\n    if (!result?.ok || !result.agents?.length) return;\n\n    const recovered = result.agents as Array<{ id: string; name: string; emoji: string; description: string; avatarUrl?: string }>;\n    console.log(\"[Agents] Recovered identities:\", recovered.map((a: any) => `${a.id}â†’${a.name}${a.avatarUrl ? \" (has avatar)\" : \"\"}`));\n\n    let changed = false;\n    for (const rec of recovered) {\n      const agent = state.agentsList.find(a => a.id === rec.id);\n      if (agent && agent.name === agent.id && rec.name !== rec.id) {\n        agent.name = rec.name;\n        agent.emoji = rec.emoji || agent.emoji;\n        agent.description = rec.description || agent.description;\n        if (rec.avatarUrl) agent.avatarUrl = rec.avatarUrl;\n        changed = true;\n      } else if (agent && rec.avatarUrl && !agent.avatarUrl) {\n        agent.avatarUrl = rec.avatarUrl;\n        changed = true;\n      }\n    }\n    if (!changed) return;\n    scheduleRender();\n\n    const configRes = await state.client.request(\"config.get\", {}) as any;\n    const baseHash = configRes?.hash || null;\n    const currentConfig = configRes?.config || {};\n    const existingList = (currentConfig.agents?.list || []) as any[];\n\n    const hasDefault = existingList.some((a: any) => a.id === \"main\" || a.default === true);\n    const newList = hasDefault ? [...existingList] : [{ id: \"main\", default: true }];\n\n    for (const rec of recovered) {\n      if (newList.some((a: any) => a.id === rec.id && a.name && a.name !== a.id)) continue;\n      const idx = newList.findIndex((a: any) => a.id === rec.id);\n      if (idx >= 0) newList.splice(idx, 1);\n      const identityObj: any = { name: rec.name, emoji: rec.emoji, theme: rec.description };\n      if (rec.avatarUrl) identityObj.avatar = rec.avatarUrl;\n      newList.push({\n        id: rec.id,\n        name: rec.name,\n        identity: identityObj,\n      });\n    }\n\n    console.log(\"[Agents] Patching config to restore agent names:\", newList.map((a: any) => `${a.id}(${a.name})`));\n    await state.client.request(\"config.patch\", {\n      baseHash,\n      raw: JSON.stringify({ agents: { ...currentConfig.agents, list: newList } }),\n      note: \"æ¢å¤æ™ºèƒ½ä½“åç§°\",\n      restartDelayMs: 0,\n    });\n  } catch (err) {\n    console.warn(\"[Agents] Recovery failed:\", err);\n  }\n}\n\nexport async function syncAgentsToMainWorkspace() {\n  const api = (window as any).electronAPI;\n  if (!api?.syncAgentsToMainWorkspace) return;\n  try {\n    const agents = state.agentsList.map(a => ({\n      name: a.name,\n      emoji: a.emoji,\n      description: a.description,\n      isDefault: a.isDefault,\n    }));\n    await api.syncAgentsToMainWorkspace({ agents });\n    console.log(\"[Agent] Synced agent list to main workspace\");\n  } catch (err) {\n    console.warn(\"[Agent] Failed to sync agents to main workspace:\", err);\n  }\n}\n\nexport async function createAgentFromTemplate(tpl: typeof AGENT_TEMPLATES[0]) {\n  state.agentCreateDraft = {\n    name: tpl.name,\n    emoji: tpl.emoji,\n    description: tpl.description,\n    identityDesc: tpl.identityDesc,\n    expertise: tpl.expertise,\n    avatarDataUrl: \"\",\n  } as any;\n  state.editingAgentId = null;\n  await createAgent();\n}\n\nexport async function createAgent() {\n  if (!state.client || !state.connected) return;\n  const d = state.agentCreateDraft;\n  const name = d.name.trim();\n  if (!name) { showToast(\"è¯·å¡«å†™åç§°\"); return; }\n  const asciiSlug = name.replace(/[^a-zA-Z0-9]+/g, \"-\").replace(/^-+|-+$/g, \"\").toLowerCase().slice(0, 32);\n  const id = asciiSlug || (\"agent-\" + Date.now().toString(36));\n  if (state.agentsList.find(a => a.id === id)) { showToast(\"å·²å­˜åœ¨åŒåæ™ºèƒ½ä½“\"); return; }\n  state.agentSaving = true;\n  scheduleRender();\n  try {\n    const configRes = await state.client.request(\"config.get\", {}) as any;\n    const baseHash = configRes?.hash || null;\n    const currentConfig = configRes?.config || {};\n    const existingList = (currentConfig.agents?.list || []) as any[];\n    console.log(\"[Agent] createAgent: existingList =\", JSON.stringify(existingList));\n    const hasDefault = existingList.some((a: any) => a.id === \"main\" || a.default === true);\n    const fullList = hasDefault ? [...existingList] : [{ id: \"main\", default: true }, ...existingList];\n    const identityObj: any = { name, emoji: d.emoji.trim() || \"ğŸ¤–\", theme: d.description.trim() || undefined };\n    if (d.avatarDataUrl) {\n      identityObj.avatar = d.avatarDataUrl;\n    }\n    const newList = [...fullList, { id, name, identity: identityObj }];\n    console.log(\"[Agent] createAgent: newList =\", JSON.stringify(newList));\n    const patch = {\n      agents: { ...currentConfig.agents, list: newList },\n    };\n    await state.client.request(\"config.patch\", { baseHash, raw: JSON.stringify(patch), note: `æ–°å»ºæ™ºèƒ½ä½“: ${name}`, restartDelayMs: 1000 });\n    if ((window as any).electronAPI?.createAgentWorkspace) {\n      const wsResult = await (window as any).electronAPI.createAgentWorkspace({ agentId: id, name, emoji: d.emoji.trim() || \"ğŸ¤–\", description: d.description.trim(), identityDesc: d.identityDesc.trim(), expertise: d.expertise.trim(), selectedSkills: buildSkillsForTools(d.selectedSkills || []) });\n      console.log(\"[Agent] createAgentWorkspace result:\", wsResult);\n    }\n    if (d.avatarDataUrl && (window as any).electronAPI?.saveAgentAvatar) {\n      await (window as any).electronAPI.saveAgentAvatar({ agentId: id, avatarDataUrl: d.avatarDataUrl });\n    }\n    showToast(`æ™ºèƒ½ä½“ \"${name}\" å·²åˆ›å»º`);\n    state.creatingAgent = false;\n    state.agentCreateDraft = { name: \"\", emoji: \"ğŸ¤–\", description: \"\", identityDesc: \"\", expertise: \"\", avatarDataUrl: \"\", selectedSkills: [] };\n    setTimeout(() => loadAgents(), 1500);\n  } catch (err: any) {\n    showToast(\"åˆ›å»ºå¤±è´¥: \" + (err?.message || String(err)));\n  }\n  state.agentSaving = false;\n  scheduleRender();\n}\n\nexport async function deleteAgent(agentId: string) {\n  if (!state.client || !state.connected) return;\n  const agent = state.agentsList.find(a => a.id === agentId);\n  if (!agent || agent.isDefault) return;\n  state.agentSaving = true;\n  state.confirmingAgentDelete = null;\n  scheduleRender();\n  try {\n    const configRes = await state.client.request(\"config.get\", {}) as any;\n    const baseHash = configRes?.hash || null;\n    const currentConfig = configRes?.config || {};\n    const existingList = (currentConfig.agents?.list || []) as any[];\n    const filteredList = existingList.filter((a: any) => a.id !== agentId);\n    const hasDefault = filteredList.some((a: any) => a.id === \"main\" || a.default === true);\n    const finalList = hasDefault ? filteredList : [{ id: \"main\", default: true }, ...filteredList];\n    const patch = {\n      agents: { ...currentConfig.agents, list: finalList },\n    };\n    await state.client.request(\"config.patch\", { baseHash, raw: JSON.stringify(patch), note: `åˆ é™¤æ™ºèƒ½ä½“: ${agent.name}`, restartDelayMs: 1000 });\n    if ((window as any).electronAPI?.deleteAgentWorkspace) {\n      await (window as any).electronAPI.deleteAgentWorkspace({ agentId: agentId });\n    }\n    showToast(`æ™ºèƒ½ä½“ \"${agent.name}\" å·²åˆ é™¤`);\n    setTimeout(() => loadAgents(), 1500);\n  } catch (err: any) {\n    showToast(\"åˆ é™¤å¤±è´¥: \" + (err?.message || String(err)));\n  }\n  state.agentSaving = false;\n  scheduleRender();\n}\n\nexport async function openAgentEditor(agent: AgentEntry) {\n  state.editingAgentId = agent.id;\n  state.agentCreateDraft = {\n    name: agent.name,\n    emoji: agent.emoji,\n    description: agent.description,\n    identityDesc: \"\",\n    expertise: \"\",\n    avatarDataUrl: agent.avatarUrl || \"\",\n    selectedSkills: [],\n  };\n  state.creatingAgent = true;\n  scheduleRender();\n  if ((window as any).electronAPI?.readAgentWorkspace) {\n    try {\n      const ws = await (window as any).electronAPI.readAgentWorkspace({ agentId: agent.id });\n      if (ws?.ok) {\n        if (ws.description) state.agentCreateDraft.description = ws.description;\n        if (ws.identityDesc) state.agentCreateDraft.identityDesc = ws.identityDesc;\n        if (ws.expertise) state.agentCreateDraft.expertise = ws.expertise;\n        // Restore selected skills by matching names from TOOLS.md to skill IDs\n        if (ws.toolsSkillNames?.length) {\n          const allSkills = [...BUILTIN_SKILLS, ...state.customSkills.filter(s => !s.id.startsWith(\"__builtin_\"))];\n          state.agentCreateDraft.selectedSkills = ws.toolsSkillNames\n            .map((name: string) => allSkills.find(s => s.name === name)?.id)\n            .filter((id: string | undefined): id is string => !!id);\n        }\n        scheduleRender();\n      }\n    } catch (err) {\n      console.warn(\"[Agent] Failed to read workspace:\", err);\n    }\n  }\n}\n\nexport async function updateAgent() {\n  if (!state.client || !state.connected || !state.editingAgentId) return;\n  const d = state.agentCreateDraft;\n  const name = d.name.trim();\n  if (!name) { showToast(\"è¯·å¡«å†™åç§°\"); return; }\n  state.agentSaving = true;\n  scheduleRender();\n  try {\n    const configRes = await state.client.request(\"config.get\", {}) as any;\n    const baseHash = configRes?.hash || null;\n    const currentConfig = configRes?.config || {};\n    const existingList = (currentConfig.agents?.list || []) as any[];\n    const hasDefault = existingList.some((a: any) => a.id === \"main\" || a.default === true);\n    const fullList = hasDefault ? existingList : [{ id: \"main\", default: true }, ...existingList];\n    const identityObj: any = { name, emoji: d.emoji.trim() || \"ğŸ¤–\", theme: d.description.trim() || undefined };\n    if (d.avatarDataUrl) {\n      identityObj.avatar = d.avatarDataUrl;\n    }\n    const updatedList = fullList.map((a: any) =>\n      a.id === state.editingAgentId\n        ? { ...a, name, identity: identityObj }\n        : a\n    );\n    const patch = {\n      agents: { ...currentConfig.agents, list: updatedList },\n    };\n    await state.client.request(\"config.patch\", { baseHash, raw: JSON.stringify(patch), note: `ä¿®æ”¹æ™ºèƒ½ä½“: ${name}`, restartDelayMs: 1000 });\n    if ((window as any).electronAPI?.updateAgentWorkspace && state.editingAgentId) {\n      const wsResult = await (window as any).electronAPI.updateAgentWorkspace({ agentId: state.editingAgentId, name, emoji: d.emoji.trim() || \"ğŸ¤–\", description: d.description.trim(), identityDesc: d.identityDesc.trim(), expertise: d.expertise.trim(), selectedSkills: buildSkillsForTools(d.selectedSkills || []) });\n      console.log(\"[Agent] updateAgentWorkspace result:\", wsResult);\n    }\n    if (d.avatarDataUrl && (window as any).electronAPI?.saveAgentAvatar && state.editingAgentId) {\n      await (window as any).electronAPI.saveAgentAvatar({ agentId: state.editingAgentId, avatarDataUrl: d.avatarDataUrl });\n    }\n    showToast(`æ™ºèƒ½ä½“ \"${name}\" å·²æ›´æ–°`);\n    state.creatingAgent = false;\n    state.editingAgentId = null;\n    state.agentCreateDraft = { name: \"\", emoji: \"ğŸ¤–\", description: \"\", identityDesc: \"\", expertise: \"\", avatarDataUrl: \"\", selectedSkills: [] };\n    setTimeout(() => loadAgents(), 1500);\n  } catch (err: any) {\n    showToast(\"æ›´æ–°å¤±è´¥: \" + (err?.message || String(err)));\n  }\n  state.agentSaving = false;\n  scheduleRender();\n}\n\n// â”€â”€â”€ Mention Parsing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function parseAgentMentions(text: string): { mentions: AgentMention[]; cleanText: string } {\n  const mentions: AgentMention[] = [];\n  const seen = new Set<string>();\n  let cleanText = text;\n  const regex = /@(\\S+)/g;\n  let m: RegExpExecArray | null;\n  while ((m = regex.exec(text)) !== null) {\n    const name = m[1];\n    const agent = state.agentsList.find(a => a.name === name || a.id === name);\n    if (agent && !seen.has(agent.id)) {\n      seen.add(agent.id);\n      mentions.push({ agentId: agent.id, agentName: agent.name, agentEmoji: agent.emoji, isDefault: !!agent.isDefault });\n      cleanText = cleanText.replace(m[0], \"\").trim();\n    }\n  }\n  return { mentions, cleanText };\n}\n\nexport function getMentionCandidates(): AgentEntry[] {\n  const filter = state.mentionFilter;\n  return state.agentsList.filter(a => !filter || a.name.toLowerCase().includes(filter) || a.id.toLowerCase().includes(filter));\n}\n\nexport function insertAgentMention(agent: AgentEntry) {\n  console.log(\"[Agent] insertAgentMention called:\", agent.name, agent.id);\n  const cursorReplace = state.draft.replace(/@(\\S*)$/, `@${agent.name} `);\n  state.draft = cursorReplace === state.draft ? state.draft + `@${agent.name} ` : cursorReplace;\n  state.sidePanel = null;\n  state.mentionDropdownVisible = false;\n  state.mentionIndex = 0;\n  scheduleRender();\n  setTimeout(() => { state.inputRef?.focus(); }, 50);\n}\n","/**\n * TaxChat Skill Management\n */\n\nimport type { CustomSkill } from \"./types\";\nimport { state, generateUUID, isAnySending, scheduleRender } from \"./state\";\nimport { BUILTIN_SKILLS } from \"./constants\";\nimport { saveCustomSkills } from \"./persistence\";\nimport { showToast, addNotification } from \"./utils\";\n\n// â”€â”€â”€ Managed Skills Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function syncManagedSkills() {\n  const api = (window as any).electronAPI;\n  if (!api?.listManagedSkills) return;\n  try {\n    const result = await api.listManagedSkills();\n    if (!result?.ok || !result.skills) return;\n    const builtinFolders = new Set(BUILTIN_SKILLS.map(s => s.folderName));\n    let changed = false;\n    for (const ms of result.skills) {\n      if (builtinFolders.has(ms.folderName)) continue;\n      const existing = state.customSkills.find(s => s.folderName === ms.folderName)\n        || state.customSkills.find(s => `custom-${s.id.slice(0, 8)}` === ms.folderName);\n      if (existing) {\n        const newPrompt = ms.prompt || \"\";\n        const newDesc = ms.description || \"\";\n        if (existing.prompt !== newPrompt || existing.description !== newDesc) {\n          existing.prompt = newPrompt;\n          existing.description = newDesc;\n          if (ms.emoji) existing.emoji = ms.emoji;\n          changed = true;\n        }\n        continue;\n      }\n      state.customSkills.push({\n        id: generateUUID(),\n        name: ms.name === ms.folderName ? ms.description.slice(0, 20) || ms.folderName : ms.name,\n        emoji: ms.emoji || \"ğŸ¤–\",\n        description: ms.description || \"\",\n        prompt: ms.prompt || \"\",\n        pinned: false,\n        createdAt: Date.now(),\n        folderName: ms.folderName,\n      });\n      changed = true;\n    }\n    if (changed) {\n      saveCustomSkills();\n      scheduleRender();\n    }\n  } catch (err) {\n    console.warn(\"Failed to sync managed skills:\", err);\n  }\n}\n\n// â”€â”€â”€ Skill Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function openSkillEditor(skill?: CustomSkill) {\n  state.editingSkill = skill\n    ? { ...skill }\n    : { id: generateUUID(), name: \"\", emoji: \"ğŸ¤–\", description: \"\", prompt: \"\", pinned: false, createdAt: Date.now() };\n  scheduleRender();\n}\n\nexport async function saveSkillFromEditor() {\n  const s = state.editingSkill;\n  if (!s || !s.name.trim() || !s.prompt.trim()) return;\n\n  const idx = state.customSkills.findIndex(c => c.id === s.id);\n  if (idx >= 0) {\n    state.customSkills[idx] = s;\n  } else {\n    state.customSkills.push(s);\n  }\n  saveCustomSkills();\n  state.editingSkill = null;\n\n  const api = (window as any).electronAPI;\n  if (api?.saveCustomSkill) {\n    try {\n      const result = await api.saveCustomSkill({\n        id: s.id,\n        name: s.name,\n        emoji: s.emoji,\n        description: s.description,\n        prompt: s.prompt,\n      });\n      if (result?.folderName) {\n        s.folderName = result.folderName;\n        saveCustomSkills();\n      }\n    } catch (err) {\n      console.warn(\"Failed to save skill to gateway:\", err);\n    }\n  }\n\n  scheduleRender();\n}\n\nexport async function deleteCustomSkill(id: string) {\n  const skill = state.customSkills.find(s => s.id === id);\n  if (!skill) return;\n  if (!confirm(`ç¡®å®šè¦åˆ é™¤æŠ€èƒ½\"${skill.name}\"å—ï¼Ÿ`)) return;\n  // Sync TaxStore installed state\n  if (skill.taxstoreSkillId) {\n    state.taxstoreInstalledIds.delete(skill.taxstoreSkillId);\n  }\n  state.customSkills = state.customSkills.filter(s => s.id !== id);\n  saveCustomSkills();\n  scheduleRender();\n\n  const api = (window as any).electronAPI;\n  if (api?.deleteCustomSkill) {\n    try {\n      await api.deleteCustomSkill(id, skill.name, skill.folderName);\n    } catch (err) {\n      console.warn(\"Failed to delete skill file:\", err);\n    }\n  }\n}\n\nexport async function exportSkillAsZip(skill: CustomSkill) {\n  const api = (window as any).electronAPI;\n  if (!api?.exportSkill) {\n    alert(\"å¯¼å‡ºåŠŸèƒ½ä¸å¯ç”¨\");\n    return;\n  }\n  try {\n    const result = await api.exportSkill(skill.id, skill.name);\n    if (result.ok) {\n      alert(`æŠ€èƒ½å·²å¯¼å‡ºåˆ°ï¼š${result.path}`);\n    } else if (result.error !== \"cancelled\") {\n      alert(`å¯¼å‡ºå¤±è´¥ï¼š${result.error}`);\n    }\n  } catch (err: any) {\n    alert(`å¯¼å‡ºå¤±è´¥ï¼š${err.message || err}`);\n  }\n}\n\nexport async function handleInstallSkillPackage() {\n  const fileInput = document.createElement(\"input\");\n  fileInput.type = \"file\";\n  fileInput.accept = \".zip\";\n  fileInput.onchange = async () => {\n    const file = fileInput.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = async () => {\n      const dataUrl = reader.result as string;\n      const base64Data = dataUrl.split(\",\")[1];\n\n      const api = (window as any).electronAPI;\n      if (!api?.installSkillPackage) {\n        alert(\"å½“å‰ç¯å¢ƒä¸æ”¯æŒæŠ€èƒ½åŒ…å®‰è£…\");\n        return;\n      }\n\n      showToast(\"æ­£åœ¨å®‰è£…æŠ€èƒ½åŒ…...\");\n      try {\n        const result = await api.installSkillPackage(base64Data, file.name);\n        if (!result?.ok) {\n          alert(`å®‰è£…å¤±è´¥: ${result?.error || \"æœªçŸ¥é”™è¯¯\"}`);\n          return;\n        }\n\n        const skill: CustomSkill = {\n          id: generateUUID(),\n          name: result.skill?.name || file.name.replace(/\\.zip$/i, \"\"),\n          emoji: result.skill?.emoji || \"ğŸ“¦\",\n          description: result.skill?.description || \"\",\n          prompt: result.skill?.prompt || \"\",\n          pinned: false,\n          createdAt: Date.now(),\n          folderName: result.folderName,\n        };\n        state.customSkills.push(skill);\n        saveCustomSkills();\n        scheduleRender();\n\n        showToast(`æŠ€èƒ½\"${skill.name}\"å·²å®‰è£…ï¼Œæ­£åœ¨é‡å¯æœåŠ¡...`);\n        addNotification(`æŠ€èƒ½åŒ…å·²å®‰è£…: ${skill.name}`, \"ğŸ“¦\");\n      } catch (err) {\n        alert(`å®‰è£…å¤±è´¥: ${(err as Error).message}`);\n      }\n    };\n    reader.readAsDataURL(file);\n  };\n  fileInput.click();\n}\n\nexport function toggleSkillPin(id: string) {\n  const skill = state.customSkills.find(s => s.id === id);\n  if (!skill) return;\n  skill.pinned = !skill.pinned;\n  saveCustomSkills();\n  scheduleRender();\n}\n\nexport function handleCustomSkillClick(skill: CustomSkill) {\n  if (isAnySending()) return;\n  state.activeCustomSkill = skill;\n  state.lastSkillName = skill.folderName || `custom-${skill.id.substring(0, 8)}`;\n  const tag = `ä½¿ç”¨æŠ€èƒ½ã€Œ${skill.name}ã€`;\n  if (!state.draft.startsWith(tag)) {\n    state.draft = tag + (state.draft ? \" \" + state.draft : \"\");\n  }\n  state.sidePanel = null;\n  scheduleRender();\n  setTimeout(() => { state.inputRef?.focus(); }, 50);\n}\n\nexport function clearActiveCustomSkill() {\n  state.activeCustomSkill = null;\n  state.lastSkillName = null;\n  scheduleRender();\n}\n\n// handleQuickSkill needs handleSend and handleFiles from chat.ts\n// To avoid circular imports, we accept them as parameters from the render layer\nexport function handleQuickSkill(\n  skillName: string,\n  prompt: string,\n  displayLabel: string,\n  noFilePicker?: boolean,\n  sendFn?: () => void,\n  filesFn?: (files: FileList) => void,\n) {\n  if (!state.client) return;\n\n  state.lastSkillName = skillName;\n\n  if (noFilePicker) {\n    const builtinSkill = BUILTIN_SKILLS.find(s => s.folderName === skillName);\n    if (builtinSkill) {\n      state.activeCustomSkill = builtinSkill;\n    }\n    state.draft = \"è¯·æ‰§è¡Œç¥¨æ®æ•´ç†æµç¨‹\";\n    sendFn?.();\n    return;\n  }\n\n  if (state.attachments.length > 0) {\n    state.draft = prompt;\n    sendFn?.();\n    return;\n  }\n\n  state.pendingSkill = { name: skillName, prompt, displayLabel };\n  const fileInput = document.createElement(\"input\");\n  fileInput.type = \"file\";\n  fileInput.accept = \"image/*,.pdf,.doc,.docx,.xls,.xlsx,.xml\";\n  fileInput.multiple = true;\n  fileInput.onchange = () => {\n    if (fileInput.files && fileInput.files.length > 0) {\n      filesFn?.(fileInput.files);\n    } else {\n      state.pendingSkill = null;\n    }\n  };\n  fileInput.click();\n}\n","/**\n * TaxChat Knowledge Management\n */\n\nimport { state, scheduleRender } from \"./state\";\nimport { showToast, addNotification, formatImportResult, generateTimestamp, generateWordDoc } from \"./utils\";\nimport { syncManagedSkills } from \"./skills\";\n\n// â”€â”€â”€ Knowledge Drag Counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport let knowledgeDragCounter = 0;\nexport function setKnowledgeDragCounter(val: number) { knowledgeDragCounter = val; }\n\n// â”€â”€â”€ Knowledge Indexing & Relevance Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\ninterface KnowledgeChunk {\n  fileName: string;\n  content: string;\n  keywords: string[];\n}\n\nlet knowledgeIndex: KnowledgeChunk[] = [];\n\n/** Split raw knowledge content into indexed chunks by ã€filenameã€‘ markers */\nexport function indexKnowledge(raw: string) {\n  knowledgeIndex = [];\n  if (!raw) return;\n\n  // Split by ã€filenameã€‘ markers\n  const parts = raw.split(/(?=ã€[^\\nã€‘]+ã€‘)/);\n  for (const part of parts) {\n    const trimmed = part.trim();\n    if (!trimmed) continue;\n\n    const headerMatch = trimmed.match(/^ã€([^\\nã€‘]+)ã€‘/);\n    const fileName = headerMatch ? headerMatch[1] : \"unknown\";\n    const content = headerMatch ? trimmed.slice(headerMatch[0].length).trim() : trimmed;\n\n    // Extract keywords: Chinese chars 2+, or latin words 3+\n    const keywords: string[] = [];\n    const cnMatches = content.match(/[\\u4e00-\\u9fa5]{2,}/g);\n    if (cnMatches) {\n      const freq = new Map<string, number>();\n      for (const w of cnMatches) freq.set(w, (freq.get(w) || 0) + 1);\n      const sorted = [...freq.entries()].sort((a, b) => b[1] - a[1]);\n      for (const [w] of sorted.slice(0, 30)) keywords.push(w);\n    }\n    const enMatches = content.match(/[a-zA-Z]{3,}/g);\n    if (enMatches) {\n      const freq = new Map<string, number>();\n      for (const w of enMatches) freq.set(w.toLowerCase(), (freq.get(w.toLowerCase()) || 0) + 1);\n      for (const [w] of [...freq.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10)) keywords.push(w);\n    }\n\n    knowledgeIndex.push({ fileName, content, keywords });\n  }\n  console.log(`[Knowledge] Indexed ${knowledgeIndex.length} chunks`);\n}\n\n/** Select the most relevant knowledge chunks for a given query, up to maxChars */\nexport function selectRelevantKnowledge(query: string, maxChars = 4000): string {\n  if (knowledgeIndex.length === 0) return state.folderKnowledge || \"\";\n\n  // If total knowledge is small enough, send it all\n  const totalLen = knowledgeIndex.reduce((sum, c) => sum + c.content.length, 0);\n  if (totalLen <= maxChars) {\n    return knowledgeIndex.map(c => `ã€${c.fileName}ã€‘\\n${c.content}`).join(\"\\n\\n\");\n  }\n\n  // Score each chunk by keyword overlap with query\n  const queryLower = query.toLowerCase();\n  const scored = knowledgeIndex.map(chunk => {\n    let score = 0;\n    for (const kw of chunk.keywords) {\n      if (queryLower.includes(kw.toLowerCase())) score += 2;\n    }\n    // Boost if filename matches\n    if (queryLower.includes(chunk.fileName.toLowerCase())) score += 5;\n    return { chunk, score };\n  });\n\n  // Sort by score descending\n  scored.sort((a, b) => b.score - a.score);\n\n  // Take chunks until maxChars\n  const selected: string[] = [];\n  let charCount = 0;\n  for (const { chunk, score } of scored) {\n    if (score === 0 && selected.length > 0) break; // Stop if no more relevant chunks\n    const entry = `ã€${chunk.fileName}ã€‘\\n${chunk.content}`;\n    if (charCount + entry.length > maxChars && selected.length > 0) break;\n    selected.push(entry);\n    charCount += entry.length;\n  }\n\n  return selected.join(\"\\n\\n\");\n}\n\n// â”€â”€â”€ Folder Knowledge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function loadFolderKnowledge() {\n  const api = (window as any).electronAPI;\n  if (!api?.getFolderKnowledge || !state.authorizedFolder) return;\n  try {\n    const result = await api.getFolderKnowledge();\n    if (result?.ok && result.content) {\n      state.folderKnowledge = result.content;\n      indexKnowledge(result.content);\n      console.log(`Folder knowledge loaded: ${result.files?.length || 0} files, ${result.content.length} chars`);\n    }\n  } catch (err) {\n    console.warn(\"Failed to load folder knowledge:\", err);\n  }\n}\n\nexport async function loadKnowledgeFiles() {\n  const api = (window as any).electronAPI;\n  if (!api?.listKnowledgeFiles || !state.authorizedFolder) return;\n  state.knowledgeLoading = true;\n  scheduleRender();\n  try {\n    const result = await api.listKnowledgeFiles(state.authorizedFolder);\n    if (result?.ok) {\n      state.knowledgeFiles = result.files || [];\n    }\n  } catch (err) {\n    console.warn(\"Failed to list knowledge files:\", err);\n  }\n  state.knowledgeLoading = false;\n  scheduleRender();\n}\n\nexport async function handleKnowledgeDrop(e: DragEvent) {\n  const api = (window as any).electronAPI;\n  if (!api?.copyToKnowledgeFolder || !state.authorizedFolder) return;\n  const files = e.dataTransfer?.files;\n  if (!files || files.length === 0) return;\n\n  for (let i = 0; i < files.length; i++) {\n    const file = files[i];\n    const reader = new FileReader();\n    reader.onload = async () => {\n      const dataUrl = reader.result as string;\n      const base64 = dataUrl.split(\",\")[1];\n      if (!base64) return;\n      try {\n        await api.copyToKnowledgeFolder({\n          folderPath: state.authorizedFolder,\n          fileName: file.name,\n          base64Data: base64,\n        });\n      } catch (err) {\n        console.warn(\"Failed to copy file to knowledge folder:\", err);\n      }\n      if (i === files.length - 1) {\n        await loadKnowledgeFiles();\n        await loadFolderKnowledge();\n        state.folderKnowledgeSent = false;\n      }\n    };\n    reader.readAsDataURL(file);\n  }\n}\n\nexport function addKnowledgeRef(name: string) {\n  if (state.knowledgeRefs.some(r => r.name === name)) return;\n  state.knowledgeRefs.push({ name });\n  scheduleRender();\n}\n\nexport function removeKnowledgeRef(index: number) {\n  state.knowledgeRefs.splice(index, 1);\n  scheduleRender();\n}\n\nexport async function deleteKnowledgeFileAction(fileName: string) {\n  const api = (window as any).electronAPI;\n  if (!api?.deleteKnowledgeFile || !state.authorizedFolder) return;\n  try {\n    await api.deleteKnowledgeFile(state.authorizedFolder, fileName);\n    state.knowledgeRefs = state.knowledgeRefs.filter(r => r.name !== fileName);\n    await loadKnowledgeFiles();\n    await loadFolderKnowledge();\n    state.folderKnowledgeSent = false;\n  } catch (err) {\n    console.warn(\"Failed to delete knowledge file:\", err);\n  }\n}\n\n// â”€â”€â”€ Folder Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function doImportFolder(folderPath: string) {\n  const api = (window as any).electronAPI;\n  state.importingFolder = true;\n  state.importResult = null;\n  scheduleRender();\n  try {\n    const result = await api.importFolderToMemory(folderPath);\n    state.importingFolder = false;\n    if (result.ok) {\n      state.authorizedFolder = result.folderPath;\n      localStorage.setItem(\"taxbot_authorized_folder\", result.folderPath);\n      state.importResult = formatImportResult(result);\n      addNotification(`æ–‡ä»¶å¤¹å·²å¯¼å…¥: ${state.importResult}`, \"ğŸ“‚\");\n      await loadFolderKnowledge();\n      state.folderKnowledgeSent = false;\n      startWatcher();\n    } else {\n      state.importResult = result.error || \"å¯¼å…¥å¤±è´¥\";\n    }\n  } catch (err: any) {\n    state.importingFolder = false;\n    state.importResult = err?.message || \"å¯¼å…¥å¤±è´¥\";\n  }\n  scheduleRender();\n}\n\nexport async function handleAuthorizeFolder() {\n  const api = (window as any).electronAPI;\n  if (!api?.openFolderDialog) return;\n  const folderPath = await api.openFolderDialog();\n  if (!folderPath) return;\n  await doImportFolder(folderPath);\n}\n\nexport async function handleRefreshFolder() {\n  if (!state.authorizedFolder) return;\n  await doImportFolder(state.authorizedFolder);\n}\n\n// â”€â”€â”€ Save Message to Knowledge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function saveMessageToKnowledge(text: string) {\n  const api = (window as any).electronAPI;\n  if (!api?.copyToKnowledgeFolder) return;\n  if (!state.authorizedFolder) {\n    showToast(\"è¯·å…ˆåœ¨çŸ¥è¯†åº“ä¸­é€‰æ‹©æ–‡ä»¶å¤¹\");\n    return;\n  }\n  const fileName = `Taxbot_${generateTimestamp()}.doc`;\n  const wordDoc = generateWordDoc(text);\n  const base64 = btoa(unescape(encodeURIComponent(wordDoc)));\n  try {\n    await api.copyToKnowledgeFolder({\n      folderPath: state.authorizedFolder,\n      fileName,\n      base64Data: base64,\n    });\n    showToast(`å·²ä¿å­˜åˆ°çŸ¥è¯†åº“: ${fileName}`);\n    await loadKnowledgeFiles();\n    await loadFolderKnowledge();\n    state.folderKnowledgeSent = false;\n  } catch (err) {\n    console.warn(\"Failed to save to knowledge:\", err);\n    showToast(\"ä¿å­˜å¤±è´¥\");\n  }\n}\n\n// â”€â”€â”€ File Watcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function startWatcher() {\n  const api = (window as any).electronAPI;\n  if (!api?.startFolderWatcher || !state.authorizedFolder) return;\n  api.startFolderWatcher(state.authorizedFolder);\n}\n\nlet _watcherListenerRegistered = false;\nexport function registerWatcherListener() {\n  if (_watcherListenerRegistered) return;\n  const api = (window as any).electronAPI;\n  if (!api?.onFolderKnowledgeUpdated) return;\n  _watcherListenerRegistered = true;\n  api.onFolderKnowledgeUpdated(async (data: { newFiles: string[]; count: number }) => {\n    console.log(`Folder watcher: ${data.count} new file(s) detected`);\n    await loadFolderKnowledge();\n    const names = data.newFiles.length <= 3\n      ? data.newFiles.join(\"ã€\")\n      : data.newFiles.slice(0, 3).join(\"ã€\") + ` ç­‰${data.newFiles.length}ä¸ªæ–‡ä»¶`;\n    const msg = `æ–°çŸ¥è¯†å·²å­¦ä¹ : ${names}`;\n    showToast(msg);\n    addNotification(msg, \"ğŸ“š\");\n    scheduleRender();\n  });\n}\n\nlet _skillsListenerRegistered = false;\nexport function registerManagedSkillsListener() {\n  if (_skillsListenerRegistered) return;\n  const api = (window as any).electronAPI;\n  if (!api?.onManagedSkillsUpdated) return;\n  _skillsListenerRegistered = true;\n  api.onManagedSkillsUpdated(() => {\n    console.log(\"Managed skills directory changed, syncing...\");\n    syncManagedSkills();\n  });\n}\n","/**\n * TaxChat Chat Logic â€” send, receive, abort, context building\n */\n\nimport type { AppState, AssistantMessage, UserMessage, AgentEntry } from \"./types\";\nimport { state, generateUUID, isAnySending, isSessionBusy, getMessagesForSession, isCurrentSession, scheduleRender } from \"./state\";\nimport { CONTEXT_MAX_MESSAGES, CONTEXT_MAX_CHARS, BUILTIN_SKILLS, TAX_SKILL_NAMES } from \"./constants\";\nimport { saveMessages, debouncedSaveMessages, saveFavorites, saveMessagesForConversation } from \"./persistence\";\nimport { autoTitleConversation } from \"./conversations\";\nimport { loadAgentMemory, parseAgentMentions } from \"./agents\";\nimport {\n  showToast,\n  readFileAsDataUrl,\n  extractAttachmentTexts,\n  extractMessageText,\n  isSystemMessage,\n  isTaxRelated,\n  consultTaxYes,\n  escapeRegex,\n} from \"./utils\";\nimport { selectRelevantKnowledge } from \"./knowledge\";\n\n// â”€â”€â”€ Conversation Context â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function buildConversationContext(excludeSessionKeys?: string[], forAgentName?: string): string {\n  const msgs = state.messages;\n  if (msgs.length === 0) return \"\";\n\n  const recent = msgs.slice(-CONTEXT_MAX_MESSAGES);\n  const lines: string[] = [];\n  let totalChars = 0;\n\n  for (const msg of recent) {\n    let line: string;\n    let isRelevant = true;\n\n    if (msg.type === \"user\") {\n      const um = msg as UserMessage;\n      if (um.targetAgentNames && um.targetAgentNames.length > 0) {\n        line = `ã€ç”¨æˆ·â†’${um.targetAgentNames.join(\"ã€\")}ã€‘${um.text}`;\n        if (forAgentName) {\n          isRelevant = um.targetAgentNames.includes(forAgentName);\n        }\n      } else {\n        line = `ã€ç”¨æˆ·â†’Taxbotã€‘${um.text}`;\n        isRelevant = true;\n      }\n    } else {\n      const aMsg = msg as AssistantMessage;\n      const name = aMsg.agentName || \"Taxbot\";\n      const emoji = aMsg.agentEmoji || \"\";\n      let text = msg.text;\n\n      if (forAgentName && name !== forAgentName && name !== \"Taxbot\") {\n        isRelevant = false;\n        text = text.length > 80 ? text.slice(0, 80) + \"...\" : text;\n      } else if (text.length > 2000) {\n        text = text.slice(0, 2000) + \"...ï¼ˆå·²æˆªæ–­ï¼‰\";\n      }\n\n      line = isRelevant ? `â˜…ã€${emoji}${name}ã€‘${text}` : `ã€${emoji}${name}ã€‘${text}`;\n    }\n\n    if (msg.type === \"user\" && isRelevant && forAgentName) {\n      line = \"â˜…\" + line;\n    }\n\n    if (totalChars + line.length > CONTEXT_MAX_CHARS) break;\n    lines.push(line);\n    totalChars += line.length;\n  }\n\n  if (lines.length === 0) return \"\";\n\n  const header = forAgentName\n    ? `ã€ä»¥ä¸‹æ˜¯å¯¹è¯è®°å½•ã€‚æ ‡æœ‰ â˜… çš„æ˜¯ä¸ä½ ï¼ˆ${forAgentName}ï¼‰ç›´æ¥ç›¸å…³çš„æ¶ˆæ¯ï¼Œå…¶ä½™ä¸ºå…¶ä»–æ™ºèƒ½ä½“çš„ç®€è¦è®°å½•ã€‚ä½ åªéœ€å›å¤å‘ç»™ä½ çš„æ¶ˆæ¯ã€‚ã€‘`\n    : `ã€ä»¥ä¸‹æ˜¯å½“å‰ç¾¤ç»„å¯¹è¯è®°å½•ã€‚æ¯æ¡ç”¨æˆ·æ¶ˆæ¯æ ‡æ³¨äº†å‘é€ç›®æ ‡ï¼ˆå¦‚\"ç”¨æˆ·â†’Taxbot\"è¡¨ç¤ºå‘ç»™Taxbotçš„ï¼‰ã€‚ä½ åªéœ€å›å¤å‘ç»™ä½ çš„æ¶ˆæ¯ï¼Œä¸è¦å›å¤å‘ç»™å…¶ä»–æ™ºèƒ½ä½“çš„æ¶ˆæ¯ã€‚ä½ å¯ä»¥å‚è€ƒå¯¹è¯ä¸Šä¸‹æ–‡æ¥ç†è§£èƒŒæ™¯ï¼Œä½†ä¸è¦ä¸»åŠ¨å›ç­”åˆ«äººçš„é—®é¢˜ã€‚ã€‘`;\n\n  return `${header}\\n\\n${lines.join(\"\\n\\n\")}`;\n}\n\n// â”€â”€â”€ Bad Response Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function isBadResponse(text: string): boolean {\n  const t = text.trim();\n  return !t || /^NO$/i.test(t) || t === \"å›å¤è·å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\" || t === \"æ¨¡å‹æœªèƒ½æ­£ç¡®å›å¤ï¼Œè¯·é‡æ–°å‘é€æ‚¨çš„é—®é¢˜ã€‚\";\n}\n\n// â”€â”€â”€ Collaboration Task Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction updateCollabTaskStatus(agentId: string | null, status: \"done\" | \"error\") {\n  if (!state.collaborationTasks || !agentId) return;\n  const task = state.collaborationTasks.find(t => t.agentId === agentId);\n  if (task) task.status = status;\n  const allDone = state.collaborationTasks.every(t => t.status === \"done\" || t.status === \"error\");\n  if (allDone) {\n    setTimeout(() => { state.collaborationTasks = null; scheduleRender(); }, 3000);\n  }\n}\n\n// â”€â”€â”€ Finish Sending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function finishSendingForRun(sessionKey: string) {\n  const run = state.activeRuns.get(sessionKey);\n  if (!run) return;\n\n  const isBg = !isCurrentSession(sessionKey);\n  const msgs = getMessagesForSession(sessionKey);\n\n  const recentAssistant = msgs.filter(m => m.type === \"assistant\");\n  const hasRealResponse = recentAssistant.some(m => !isBadResponse((m as any).text || \"\"));\n\n  if (hasRealResponse) {\n    const filtered = msgs.filter(m => {\n      if (m.type === \"assistant\" && isBadResponse((m as any).text || \"\")) {\n        console.log(\"[finishSending] Removing bad message:\", ((m as any).text || \"\").substring(0, 40));\n        return false;\n      }\n      return true;\n    });\n    if (isBg) {\n      // Background conversation: update backgroundMessages, save to persistence, mark unread\n      const convId = sessionKey.startsWith(\"taxchat-\") ? sessionKey.slice(8) : sessionKey;\n      state.backgroundMessages.set(convId, filtered);\n      saveMessagesForConversation(convId, filtered);\n      state.unreadConversations.add(convId);\n      // Update conversation metadata\n      const conv = state.conversations.find(c => c.id === convId);\n      if (conv) { conv.updatedAt = Date.now(); conv.messageCount = filtered.length; }\n    } else {\n      state.messages = filtered;\n      debouncedSaveMessages();\n    }\n    state.activeRuns.delete(sessionKey);\n    updateCollabTaskStatus(run.agentId, \"done\");\n    if (sessionKey === state.sessionKey && state.pendingDispatch) {\n      dispatchPendingAgents();\n    }\n    if (!run.reactive && run.agentId) {\n      checkReactiveMentions(run);\n    }\n    scheduleRender();\n    return;\n  }\n\n  const lastMsg = msgs[msgs.length - 1];\n  const lastText = ((lastMsg as any)?.text || \"\").trim();\n  const isNoResponse = lastMsg?.type === \"assistant\" && /^NO$/i.test(lastText);\n  const isFailResponse = lastMsg?.type === \"assistant\" && lastText === \"å›å¤è·å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\";\n\n  if ((isNoResponse || isFailResponse) && run._retryCount < 1) {\n    run._retryCount++;\n    console.log(`[AutoRetry] Model responded with \"${lastText}\", retrying (attempt ${run._retryCount}) for ${sessionKey}`);\n    msgs.pop();\n    run.thinkingLabel = \"æ­£åœ¨é‡è¯•...\";\n    run.toolsActive = 0;\n    run.runId = null;\n    scheduleRender();\n    const idempotencyKey = generateUUID();\n    state.client?.request(\"chat.send\", {\n      sessionKey: sessionKey,\n      message: \"è¯·ç›´æ¥å›ç­”ä¸Šé¢çš„é—®é¢˜ã€‚\",\n      deliver: false,\n      idempotencyKey,\n    }).catch((err: any) => {\n      console.error(\"Auto-retry send failed:\", err);\n      state.activeRuns.delete(sessionKey);\n      updateCollabTaskStatus(run.agentId, \"error\");\n      if (isBg) {\n        const convId = sessionKey.startsWith(\"taxchat-\") ? sessionKey.slice(8) : sessionKey;\n        saveMessagesForConversation(convId, msgs);\n        state.unreadConversations.add(convId);\n      } else {\n        debouncedSaveMessages();\n      }\n      scheduleRender();\n    });\n    return;\n  }\n\n  state.activeRuns.delete(sessionKey);\n  updateCollabTaskStatus(run.agentId, \"done\");\n  if (isBg) {\n    const convId = sessionKey.startsWith(\"taxchat-\") ? sessionKey.slice(8) : sessionKey;\n    saveMessagesForConversation(convId, msgs);\n    state.unreadConversations.add(convId);\n    const conv = state.conversations.find(c => c.id === convId);\n    if (conv) { conv.updatedAt = Date.now(); conv.messageCount = msgs.length; }\n  } else {\n    debouncedSaveMessages();\n  }\n\n  if (sessionKey === state.sessionKey && state.pendingDispatch) {\n    dispatchPendingAgents();\n  }\n  if (!run.reactive && run.agentId) {\n    checkReactiveMentions(run);\n  }\n\n  scheduleRender();\n}\n\n// â”€â”€â”€ Fetch Complete Response (Polling with AbortController + Timeout) â”€â”€\nconst POLL_INTERVAL = 1500;\nconst STALE_TIMEOUT = 10_000;   // 10s without content change â†’ complete\nconst MAX_TOTAL_TIME = 120_000; // 2 min absolute timeout\nconst pollingControllers = new Map<string, AbortController>();\n\n/** Extract assistant text from chat.history result */\nfunction extractHistoryAssistantText(result: any): string {\n  if (!result?.messages || result.messages.length === 0) return \"\";\n  const msgs = result.messages as any[];\n  let lastUserIdx = -1;\n  for (let i = msgs.length - 1; i >= 0; i--) {\n    if (msgs[i].role === \"user\") { lastUserIdx = i; break; }\n  }\n  const startIdx = lastUserIdx >= 0 ? lastUserIdx + 1 : 0;\n  const assistantTexts: string[] = [];\n  for (let i = startIdx; i < msgs.length; i++) {\n    if (msgs[i].role === \"assistant\") {\n      const t = extractMessageText(msgs[i]);\n      if (t && !isSystemMessage(t)) assistantTexts.push(t);\n    }\n  }\n  if (assistantTexts.length === 0) {\n    for (let i = startIdx; i < msgs.length; i++) {\n      const content = (msgs[i] as any).content;\n      if (!Array.isArray(content)) continue;\n      for (const block of content) {\n        if (block?.type === \"tool_result\") {\n          const rc = block.content;\n          if (typeof rc === \"string\" && rc.trim()) {\n            assistantTexts.push(rc.trim());\n          } else if (Array.isArray(rc)) {\n            for (const sub of rc) {\n              if (sub?.type === \"text\" && typeof sub.text === \"string\" && sub.text.trim()) {\n                assistantTexts.push(sub.text.trim());\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n  return assistantTexts.join(\"\\n\\n\");\n}\n\n/** Upsert assistant message text in state.messages */\nfunction upsertAssistantText(runId: string, sessionKey: string, text: string) {\n  const msgs = getMessagesForSession(sessionKey);\n  const existingIdx = msgs.findIndex(m => m.type === \"assistant\" && m.id === runId);\n  if (existingIdx >= 0) {\n    if (text.length > ((msgs[existingIdx] as any).text || \"\").length) {\n      (msgs[existingIdx] as any).text = text;\n    }\n  } else {\n    const run = state.activeRuns.get(sessionKey);\n    msgs.push({\n      type: \"assistant\",\n      text,\n      timestamp: Date.now(),\n      id: runId,\n      agentId: run?.agentId || undefined,\n      agentEmoji: run?.agentEmoji || undefined,\n      agentName: run?.agentName || undefined,\n      agentAvatarUrl: run?.agentAvatarUrl || undefined,\n    });\n  }\n}\n\nexport function fetchCompleteResponse(runId: string, sessionKey: string): void {\n  // Cancel any existing polling for this session\n  pollingControllers.get(sessionKey)?.abort();\n\n  const controller = new AbortController();\n  pollingControllers.set(sessionKey, controller);\n  const signal = controller.signal;\n\n  const startTime = Date.now();\n  let lastChangeTime = Date.now();\n  let prevText = \"\";\n\n  const poll = () => {\n    if (signal.aborted || !state.activeRuns.has(sessionKey)) {\n      pollingControllers.delete(sessionKey);\n      return;\n    }\n\n    // Absolute timeout\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      if (prevText) upsertAssistantText(runId, sessionKey, prevText);\n      finishSendingForRun(sessionKey);\n      pollingControllers.delete(sessionKey);\n      return;\n    }\n\n    state.client?.request(\"chat.history\", { sessionKey, limit: 20 })\n      .then((result: any) => {\n        if (signal.aborted || !state.activeRuns.has(sessionKey)) {\n          pollingControllers.delete(sessionKey);\n          return;\n        }\n\n        const historyText = extractHistoryAssistantText(result);\n\n        if (historyText && historyText !== prevText) {\n          // Content changed â€” reset stale timer\n          lastChangeTime = Date.now();\n          prevText = historyText;\n          upsertAssistantText(runId, sessionKey, historyText);\n          scheduleRender();\n        }\n\n        // Check stale timeout (only if we have some content)\n        if (prevText.length > 0 && Date.now() - lastChangeTime > STALE_TIMEOUT) {\n          upsertAssistantText(runId, sessionKey, prevText);\n          finishSendingForRun(sessionKey);\n          pollingControllers.delete(sessionKey);\n          return;\n        }\n\n        // Continue polling\n        setTimeout(poll, POLL_INTERVAL);\n      })\n      .catch(() => {\n        if (signal.aborted) return;\n        if (Date.now() - startTime < MAX_TOTAL_TIME) {\n          setTimeout(poll, POLL_INTERVAL);\n        } else {\n          if (!prevText) {\n            const hasReal = state.messages.some(m => m.type === \"assistant\" && !isBadResponse((m as any).text || \"\"));\n            if (!hasReal && !state.messages.some(m => m.id === runId)) {\n              state.messages.push({\n                type: \"assistant\",\n                text: \"å›å¤è·å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚\",\n                timestamp: Date.now(),\n                id: runId,\n              });\n            }\n          }\n          finishSendingForRun(sessionKey);\n          pollingControllers.delete(sessionKey);\n        }\n      });\n  };\n\n  // Start polling after initial short delay\n  setTimeout(poll, 800);\n}\n\nexport function cancelPolling(sessionKey: string) {\n  const ctrl = pollingControllers.get(sessionKey);\n  if (ctrl) {\n    ctrl.abort();\n    pollingControllers.delete(sessionKey);\n  }\n}\n\n// â”€â”€â”€ Dispatch & Reactive Mentions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction getLastAssistantText(): string {\n  for (let i = state.messages.length - 1; i >= 0; i--) {\n    if (state.messages[i].type === \"assistant\") {\n      return (state.messages[i] as AssistantMessage).text || \"\";\n    }\n  }\n  return \"\";\n}\n\nfunction extractAgentTask(response: string, agentName: string): string | null {\n  const patterns = [\n    new RegExp(`ã€åˆ†é…ç»™\\\\s*${escapeRegex(agentName)}ã€‘([\\\\s\\\\S]*?)(?=ã€åˆ†é…ç»™|$)`, \"i\"),\n    new RegExp(`ã€${escapeRegex(agentName)}ã€‘([\\\\s\\\\S]*?)(?=ã€|$)`, \"i\"),\n    new RegExp(`(?:^|\\\\n)\\\\*?\\\\*?${escapeRegex(agentName)}\\\\*?\\\\*?[ï¼š:]([\\\\s\\\\S]*?)(?=\\\\n\\\\*?\\\\*?\\\\S+[ï¼š:]|$)`, \"im\"),\n  ];\n  for (const re of patterns) {\n    const m = response.match(re);\n    if (m && m[1]?.trim()) return m[1].trim();\n  }\n  return null;\n}\n\nasync function dispatchPendingAgents() {\n  const pending = state.pendingDispatch;\n  if (!pending || !state.client) {\n    state.pendingDispatch = null;\n    return;\n  }\n  state.pendingDispatch = null;\n\n  const mainResponse = getLastAssistantText();\n  if (!mainResponse) {\n    console.warn(\"[Orchestration] No main response found, skipping dispatch\");\n    return;\n  }\n\n  console.log(\"[Orchestration] Main responded, dispatching to agents:\", pending.targets.map(t => t.agent?.name));\n\n  const collabTasks: NonNullable<AppState[\"collaborationTasks\"]> = [];\n  for (const t of pending.targets) {\n    const agentName = t.agent?.name || t.agentId;\n    const task = extractAgentTask(mainResponse, agentName);\n    collabTasks.push({\n      agentId: t.agentId,\n      agentName,\n      agentEmoji: t.agent?.emoji || \"ğŸ¤–\",\n      task: task ? (task.length > 60 ? task.slice(0, 60) + \"...\" : task) : \"å¤„ç†ç”¨æˆ·è¯·æ±‚\",\n      status: \"working\",\n    });\n  }\n  state.collaborationTasks = collabTasks;\n\n  for (const t of pending.targets) {\n    if (isSessionBusy(t.sessionKey)) continue;\n\n    const agentName = t.agent?.name || t.agentId;\n    const assignedTask = extractAgentTask(mainResponse, agentName);\n\n    let agentMessage: string;\n    if (assignedTask) {\n      agentMessage = `${assignedTask}\\n\\nï¼ˆä»¥ä¸Šæ˜¯åè°ƒè€…ä¸ºä½ åˆ†é…çš„ä»»åŠ¡ã€‚ç”¨æˆ·çš„åŸå§‹è¯·æ±‚ï¼š${pending.finalMessage}ï¼‰\\n\\næç¤ºï¼šå¦‚éœ€å…¶ä»–æ™ºèƒ½ä½“ååŠ©ï¼Œè¯·ä½¿ç”¨ @æ™ºèƒ½ä½“åç§° æ ¼å¼æ ‡æ³¨ã€‚`;\n    } else {\n      agentMessage = `åè°ƒè€…çš„åˆ†æå¦‚ä¸‹ï¼š\\n${mainResponse}\\n\\nè¯·æ ¹æ®ä½ çš„ä¸“é•¿ï¼Œå›åº”ç”¨æˆ·çš„è¯·æ±‚ï¼š${pending.finalMessage}\\n\\næç¤ºï¼šå¦‚éœ€å…¶ä»–æ™ºèƒ½ä½“ååŠ©ï¼Œè¯·ä½¿ç”¨ @æ™ºèƒ½ä½“åç§° æ ¼å¼æ ‡æ³¨ã€‚`;\n    }\n\n    if (t.agentId) {\n      const memory = await loadAgentMemory(t.agentId);\n      if (memory) {\n        agentMessage = `ã€æ™ºèƒ½ä½“è®°å¿†ã€‘\\n${memory}\\n---\\n\\n${agentMessage}`;\n      }\n    }\n\n    const conversationContext = buildConversationContext([], agentName);\n    if (conversationContext) {\n      agentMessage = `${conversationContext}\\n\\n---\\n\\n${agentMessage}`;\n    }\n\n    state.activeRuns.set(t.sessionKey, {\n      runId: null,\n      sessionKey: t.sessionKey,\n      agentId: t.agentId,\n      agentName: t.agent?.name || null,\n      agentEmoji: t.agent?.emoji || null,\n      agentAvatarUrl: t.agent?.avatarUrl || null,\n      thinkingLabel: \"æ­£åœ¨æ€è€ƒ...\",\n      toolsActive: 0,\n      _retryCount: 0,\n      reactive: false,\n    });\n\n    const idempotencyKey = generateUUID();\n    const requestPayload: any = {\n      sessionKey: t.sessionKey,\n      message: agentMessage,\n      deliver: false,\n      idempotencyKey,\n    };\n    if (pending.apiAttachments.length > 0) {\n      requestPayload.attachments = pending.apiAttachments;\n    }\n\n    console.log(`[Orchestration] Dispatching to ${agentName} (${t.sessionKey})`);\n    state.client\n      .request(\"chat.send\", requestPayload)\n      .then((r: unknown) => { console.log(`[Orchestration] ${agentName} accepted:`, r); })\n      .catch((err) => {\n        state.messages.push({ type: \"assistant\", text: `${agentName} ä»»åŠ¡å‘é€å¤±è´¥ï¼š${String(err)}`, timestamp: Date.now(), id: generateUUID() });\n        state.activeRuns.delete(t.sessionKey);\n        scheduleRender();\n      });\n  }\n  scheduleRender();\n}\n\n/** Detect explicit @mention â€” avoids false positives from short agent names appearing in regular text */\nfunction detectExplicitMention(text: string, agentName: string): boolean {\n  // 1. @AgentName format (most explicit)\n  if (text.includes(`@${agentName}`)) return true;\n  // 2. ã€...AgentName...ã€‘ bracket-marked format\n  if (new RegExp(`ã€[^ã€‘]*${escapeRegex(agentName)}[^ã€]*ã€‘`).test(text)) return true;\n  // 3. Only for names 3+ chars: boundary-delimited match (Chinese punctuation / whitespace)\n  if (agentName.length >= 3) {\n    const bp = `(?:^|[\\\\sï¼Œã€‚ã€ï¼ï¼Ÿï¼šï¼›\"\"''ï¼ˆï¼‰ã€Šã€‹])${escapeRegex(agentName)}(?:$|[\\\\sï¼Œã€‚ã€ï¼ï¼Ÿï¼šï¼›\"\"''ï¼ˆï¼‰ã€Šã€‹])`;\n    if (new RegExp(bp, \"m\").test(text)) return true;\n  }\n  return false;\n}\n\nfunction checkReactiveMentions(finishedRun: { agentId: string | null; agentName: string | null; agentEmoji: string | null; agentAvatarUrl: string | null; reactive: boolean; sessionKey: string }) {\n  if (!state.client) return;\n\n  let responseText = \"\";\n  for (let i = state.messages.length - 1; i >= 0; i--) {\n    const m = state.messages[i];\n    if (m.type === \"assistant\" && (m as AssistantMessage).agentId === finishedRun.agentId) {\n      responseText = m.text;\n      break;\n    }\n  }\n  if (!responseText || responseText.length < 5) return;\n\n  const mentionedAgents: AgentEntry[] = [];\n  for (const agent of state.agentsList) {\n    if (agent.id === finishedRun.agentId) continue;\n    if (agent.isDefault) continue;\n    if (detectExplicitMention(responseText, agent.name)) {\n      mentionedAgents.push(agent);\n    }\n  }\n  if (mentionedAgents.length === 0) return;\n\n  const srcName = finishedRun.agentName || \"æ™ºèƒ½ä½“\";\n\n  for (const agent of mentionedAgents) {\n    const sk = `agent:${agent.id}:main`;\n    if (isSessionBusy(sk)) continue;\n\n    const prompt = `${srcName}åœ¨å›å¤ä¸­æåˆ°äº†ä½ ï¼ˆ${agent.name}ï¼‰ã€‚ä»¥ä¸‹æ˜¯${srcName}çš„å›å¤ï¼š\\n\\n${responseText.length > 800 ? responseText.slice(0, 800) + \"...ï¼ˆå·²æˆªæ–­ï¼‰\" : responseText}\\n\\nè¯·æ ¹æ®å¯¹è¯ä¸Šä¸‹æ–‡åˆ¤æ–­ï¼Œå¦‚æœ${srcName}çš„å›å¤æ¶‰åŠä½ çš„ä¸“é•¿æˆ–éœ€è¦ä½ è¡¥å……ï¼Œè¯·ç»™å‡ºä½ çš„å›å¤ã€‚å¦‚æœä¸ä½ æ— å…³ï¼Œè¯·ç®€çŸ­å›å¤\"æ— éœ€è¡¥å……\"å³å¯ã€‚`;\n\n    const conversationContext = buildConversationContext([], agent.name);\n    let agentMessage = prompt;\n    if (conversationContext) {\n      agentMessage = `${conversationContext}\\n\\n---\\n\\n${prompt}`;\n    }\n\n    console.log(`[Reactive] ${srcName} mentioned ${agent.name}, dispatching`);\n\n    state.activeRuns.set(sk, {\n      runId: null,\n      sessionKey: sk,\n      agentId: agent.id,\n      agentName: agent.name,\n      agentEmoji: agent.emoji,\n      agentAvatarUrl: agent.avatarUrl || null,\n      thinkingLabel: \"æ­£åœ¨æ€è€ƒ...\",\n      toolsActive: 0,\n      _retryCount: 0,\n      reactive: true,\n    });\n\n    const idempotencyKey = generateUUID();\n    state.client\n      .request(\"chat.send\", { sessionKey: sk, message: agentMessage, deliver: false, idempotencyKey })\n      .then((r: unknown) => { console.log(`[Reactive] ${agent.name} accepted:`, r); })\n      .catch((err) => {\n        state.messages.push({ type: \"assistant\", text: `${agent.name} å“åº”å¤±è´¥ï¼š${String(err)}`, timestamp: Date.now(), id: generateUUID() });\n        state.activeRuns.delete(sk);\n        scheduleRender();\n      });\n  }\n  scheduleRender();\n}\n\n// â”€â”€â”€ File Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function handleFiles(files: FileList | File[]) {\n  const fileArray = Array.from(files);\n  console.log(\"handleFiles called with\", fileArray.length, \"files\");\n\n  for (const file of fileArray) {\n    console.log(\"Processing file:\", file.name, \"size:\", file.size, \"type:\", file.type);\n\n    if (file.size > 10 * 1024 * 1024) {\n      state.lastError = `æ–‡ä»¶\"${file.name}\"è¿‡å¤§ï¼ˆ>10MBï¼‰ï¼Œè¯·é€‰æ‹©æ›´å°çš„æ–‡ä»¶`;\n      scheduleRender();\n      continue;\n    }\n\n    try {\n      const dataUrl = await readFileAsDataUrl(file);\n      console.log(\"File read as data URL, length:\", dataUrl.length);\n\n      state.attachments.push({\n        name: file.name,\n        type: file.type,\n        size: file.size,\n        dataUrl: dataUrl,\n      });\n      console.log(\"File added to attachments, total:\", state.attachments.length);\n    } catch (err) {\n      state.lastError = `æ— æ³•è¯»å–æ–‡ä»¶\"${file.name}\"ï¼š${String(err)}`;\n      console.error(\"File read error:\", err);\n    }\n  }\n\n  console.log(\"Final attachments count:\", state.attachments.length);\n\n  if (state.pendingSkill && state.attachments.length > 0) {\n    const skill = state.pendingSkill;\n    state.pendingSkill = null;\n    state.draft = skill.prompt;\n    scheduleRender();\n    handleSend();\n    return;\n  }\n\n  scheduleRender();\n}\n\n// â”€â”€â”€ Send Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function handleSend() {\n  if (!state.client) return;\n\n  if (!state.draft.trim() && state.attachments.length === 0) return;\n\n  const userText = state.draft.trim();\n  const msgId = generateUUID();\n\n  const { mentions, cleanText: textWithoutMentions } = parseAgentMentions(userText);\n\n  type SendTarget = { sessionKey: string; agentId: string; agent: AgentEntry | null };\n  const nonDefaultTargets: SendTarget[] = [];\n  let hasDefaultMention = false;\n\n  for (const mention of mentions) {\n    if (mention.isDefault) {\n      hasDefaultMention = true;\n    } else {\n      const sk = `agent:${mention.agentId}:main`;\n      const agent = state.agentsList.find(a => a.id === mention.agentId) || null;\n      nonDefaultTargets.push({ sessionKey: sk, agentId: mention.agentId, agent });\n    }\n  }\n\n  const useOrchestration = nonDefaultTargets.length >= 2;\n\n  type DirectTarget = { sessionKey: string; agentId: string | null; agent: AgentEntry | null };\n  const directTargets: DirectTarget[] = [];\n\n  if (useOrchestration) {\n    directTargets.push({ sessionKey: state.sessionKey, agentId: null, agent: null });\n  } else if (mentions.length === 0) {\n    directTargets.push({ sessionKey: state.sessionKey, agentId: null, agent: null });\n  } else {\n    if (hasDefaultMention) {\n      directTargets.push({ sessionKey: state.sessionKey, agentId: null, agent: null });\n    }\n    for (const t of nonDefaultTargets) {\n      directTargets.push(t);\n    }\n  }\n\n  const busyNames: string[] = [];\n  const freeTargets: DirectTarget[] = [];\n  for (const t of directTargets) {\n    if (isSessionBusy(t.sessionKey)) {\n      const name = t.agent ? `${t.agent.emoji || \"ğŸ¤–\"} ${t.agent.name}` : \"æ™ºèƒ½ä½“\";\n      busyNames.push(name);\n    } else {\n      freeTargets.push(t);\n    }\n  }\n  if (useOrchestration) {\n    for (const t of nonDefaultTargets) {\n      if (isSessionBusy(t.sessionKey)) {\n        const name = t.agent ? `${t.agent.emoji || \"ğŸ¤–\"} ${t.agent.name}` : \"æ™ºèƒ½ä½“\";\n        if (!busyNames.includes(name)) busyNames.push(name);\n      }\n    }\n  }\n  if (busyNames.length > 0) {\n    showToast(`${busyNames.join(\"ã€\")} æ­£åœ¨å·¥ä½œä¸­ï¼Œè¯·ç¨ç­‰ï¼Œæˆ–å®‰æ’å…¶å®ƒæ™ºèƒ½ä½“å¤„ç†`);\n  }\n  if (freeTargets.length === 0) return;\n\n  for (const t of freeTargets) {\n    state.activeRuns.set(t.sessionKey, {\n      runId: null,\n      sessionKey: t.sessionKey,\n      agentId: t.agentId,\n      agentName: t.agent?.name || null,\n      agentEmoji: t.agent?.emoji || null,\n      agentAvatarUrl: t.agent?.avatarUrl || null,\n      thinkingLabel: useOrchestration ? \"æ­£åœ¨åˆ†æä»»åŠ¡...\" : \"æ­£åœ¨æ€è€ƒ...\",\n      toolsActive: 0,\n      _retryCount: 0,\n      reactive: false,\n    });\n  }\n\n  const triggeredSkillName = state.lastSkillName;\n  state.lastSkillName = null;\n\n  const activeSkill = state.activeCustomSkill;\n  state.activeCustomSkill = null;\n\n  const contentText = mentions.length > 0 ? textWithoutMentions : userText;\n\n  let detectedSkill = activeSkill;\n  if (!detectedSkill && contentText) {\n    const textLower = contentText.toLowerCase();\n    for (const sk of state.customSkills) {\n      if (sk.prompt && sk.name && textLower.includes(sk.name.toLowerCase())) {\n        detectedSkill = sk;\n        break;\n      }\n    }\n    if (!detectedSkill) {\n      for (const sk of BUILTIN_SKILLS) {\n        if (sk.prompt && sk.name && textLower.includes(sk.name.toLowerCase())) {\n          detectedSkill = sk;\n          break;\n        }\n      }\n    }\n  }\n\n  let messageToSend: string;\n  if (detectedSkill && detectedSkill.prompt) {\n    let skillSuffix = \"\";\n    if (detectedSkill.id === \"__builtin_knowledge-base\" && state.authorizedFolder) {\n      skillSuffix = `\\n\\nã€çŸ¥è¯†åº“è·¯å¾„ã€‘\\n${state.authorizedFolder}`;\n    }\n    messageToSend = `è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ“ä½œæµç¨‹å¤„ç†ç”¨æˆ·çš„è¾“å…¥ã€‚\\n\\nã€${detectedSkill.name} - æ“ä½œæµç¨‹ã€‘\\n${detectedSkill.prompt}\\n\\nã€ç”¨æˆ·è¾“å…¥ã€‘\\n${contentText}${skillSuffix}`;\n    console.log(`[Skill] Embedded prompt for skill \"${detectedSkill.name}\", prompt length: ${detectedSkill.prompt.length}`);\n  } else if (detectedSkill) {\n    messageToSend = `è¯·æŒ‰ç…§${detectedSkill.name}çš„æ“ä½œæµç¨‹å¤„ç†ä»¥ä¸‹å†…å®¹ã€‚\\n\\n${contentText}`;\n    console.log(`[Skill] Skill \"${detectedSkill.name}\" active but no prompt text`);\n  } else {\n    messageToSend = contentText;\n  }\n\n  const hasAttachments = state.attachments.length > 0;\n  const hasImages = state.attachments.some(att => att.type.startsWith(\"image/\"));\n  const hasDocuments = state.attachments.some(att =>\n    att.type === \"application/pdf\" ||\n    att.type.includes(\"word\") ||\n    att.type.includes(\"excel\") ||\n    att.type.includes(\"document\")\n  );\n\n  const displayText = userText || `(${state.attachments.length} ä¸ªæ–‡ä»¶)`;\n\n  if (hasAttachments && !detectedSkill) {\n    if (!contentText) {\n      if (hasImages && hasDocuments) {\n        messageToSend = \"è¯·åˆ†æè¿™äº›å›¾ç‰‡å’Œæ–‡æ¡£ï¼Œæå–å…¶ä¸­çš„æ–‡å­—å†…å®¹å¹¶æ€»ç»“è¦ç‚¹ã€‚\";\n      } else if (hasImages) {\n        messageToSend = \"è¯·æå–å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—å†…å®¹ï¼Œä¿æŒåŸæœ‰çš„ç»“æ„å’Œæ ¼å¼ã€‚å¦‚æœå›¾ç‰‡ä¸­æ²¡æœ‰æ–‡å­—ï¼Œè¯·æè¿°å›¾ç‰‡çš„å†…å®¹ã€‚\";\n      } else if (hasDocuments) {\n        messageToSend = \"è¯·åˆ†æè¿™ä¸ªæ–‡æ¡£ï¼Œæå–å¹¶æ€»ç»“å…¶ä¸­çš„ä¸»è¦å†…å®¹ã€‚\";\n      }\n    } else if (hasImages) {\n      messageToSend = `${contentText}\\n\\nï¼ˆæ³¨ï¼šè¯·å…ˆè¯†åˆ«å¹¶æå–å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹ï¼Œç„¶åç»“åˆæˆ‘çš„é—®é¢˜è¿›è¡Œåˆ†æï¼‰`;\n    }\n  } else if (hasAttachments && detectedSkill && hasImages) {\n    messageToSend += \"\\n\\nï¼ˆæ³¨ï¼šè¯·å…ˆè¯†åˆ«å¹¶æå–å›¾ç‰‡ä¸­çš„æ–‡å­—å†…å®¹ï¼Œç„¶åç»“åˆæ“ä½œæµç¨‹è¿›è¡Œåˆ†æï¼‰\";\n  }\n\n  const replyToMsg = state.replyingTo;\n  if (replyToMsg) {\n    const quoteSender = replyToMsg.type === \"user\" ? \"ç”¨æˆ·\" : ((replyToMsg as AssistantMessage).agentName || \"Taxbot\");\n    const quoteText = replyToMsg.text.length > 300 ? replyToMsg.text.slice(0, 300) + \"...\" : replyToMsg.text;\n    messageToSend = `ã€å¼•ç”¨ ${quoteSender} çš„æ¶ˆæ¯ã€‘ï¼š${quoteText}\\n\\n${messageToSend}`;\n  }\n\n  const messageAttachments = state.attachments.length > 0 ? [...state.attachments] : undefined;\n\n  state.messages.push({\n    type: \"user\",\n    text: displayText,\n    timestamp: Date.now(),\n    id: msgId,\n    attachments: messageAttachments,\n    targetAgentNames: mentions.length > 0 ? mentions.map(m => m.agentName) : undefined,\n    replyToId: replyToMsg?.id,\n  });\n\n  autoTitleConversation();\n  saveMessages();\n\n  state.replyingTo = null;\n  state.draft = \"\";\n  scheduleRender();\n\n  let apiAttachments = state.attachments\n    .map(att => {\n      const match = /^data:([^;]+);base64,(.+)$/.exec(att.dataUrl);\n      if (!match) {\n        console.warn(\"Failed to parse data URL for file:\", att.name);\n        return null;\n      }\n      const mimeType = match[1];\n      let attachmentType = \"document\";\n      if (mimeType.startsWith(\"image/\")) {\n        attachmentType = \"image\";\n      }\n      const attachment = {\n        type: attachmentType,\n        mimeType: mimeType,\n        fileName: att.name,\n        content: match[2],\n      };\n      console.log(`Prepared attachment: ${att.name}, type: ${attachmentType}, mime: ${mimeType}, base64 length: ${match[2].length}`);\n      return attachment;\n    })\n    .filter((a): a is NonNullable<typeof a> => a !== null);\n\n  console.log(`Total attachments prepared: ${apiAttachments.length}`);\n\n  let documentText = \"\";\n  if (hasDocuments) {\n    documentText = await extractAttachmentTexts(state.attachments);\n    if (documentText) {\n      messageToSend += `\\n\\nã€æ–‡ä»¶å†…å®¹ã€‘\\n${documentText}`;\n    }\n  }\n\n  apiAttachments = apiAttachments.filter(a => a.type === \"image\");\n\n  state.attachments = [];\n\n  if (state.knowledgeRefs.length > 0) {\n    const api = (window as any).electronAPI;\n    if (api?.readKnowledgeFile) {\n      const refParts: string[] = [];\n      for (const ref of state.knowledgeRefs) {\n        try {\n          const result = await api.readKnowledgeFile(ref.name);\n          if (result?.ok && result.content) {\n            refParts.push(`ã€çŸ¥è¯†åº“å¼•ç”¨: ${ref.name}ã€‘\\n${result.content}`);\n          }\n        } catch (_) {}\n      }\n      if (refParts.length > 0) {\n        messageToSend = `${messageToSend}\\n\\n---\\n${refParts.join(\"\\n\\n\")}\\n---`;\n      }\n    }\n    state.knowledgeRefs = [];\n    scheduleRender();\n  }\n\n  if (state.folderKnowledge && !state.folderKnowledgeSent) {\n    const relevantKnowledge = selectRelevantKnowledge(contentText || messageToSend);\n    if (relevantKnowledge) {\n      messageToSend = `${messageToSend}\\n\\n---\\nã€å·²å¯¼å…¥çŸ¥è¯†åº“æ–‡ä»¶å†…å®¹ã€‘\\nä»¥ä¸‹æ˜¯ä¸ä½ çš„é—®é¢˜ç›¸å…³çš„çŸ¥è¯†åº“å†…å®¹ï¼š\\n${relevantKnowledge}\\n---`;\n    }\n    state.folderKnowledgeSent = true;\n  }\n\n  const finalMessage = messageToSend || (apiAttachments.length > 0 ? \"(æŸ¥çœ‹é™„ä»¶)\" : \"\");\n\n  if (useOrchestration) {\n    const agentNames = nonDefaultTargets.map(t => `${t.agent?.emoji || \"ğŸ¤–\"} ${t.agent?.name || t.agentId}`).join(\"ã€\");\n    const orchestrationPrompt = `ç”¨æˆ·åŒæ—¶@äº†ä»¥ä¸‹æ™ºèƒ½ä½“ååŒå·¥ä½œï¼š${agentNames}ã€‚\\n\\nè¯·åˆ†æç”¨æˆ·çš„æ„å›¾ï¼Œæ ¹æ®æ¯ä¸ªæ™ºèƒ½ä½“çš„ä¸“é•¿ä¸ºå®ƒä»¬åˆ†é…å…·ä½“çš„å­ä»»åŠ¡ã€‚å›å¤æ ¼å¼è¦æ±‚ï¼š\\n1. å…ˆç®€è¦è¯´æ˜ä½ çš„ä»»åŠ¡åˆ†è§£æ€è·¯\\n2. ç„¶åç”¨ä»¥ä¸‹æ ¼å¼ä¸ºæ¯ä¸ªæ™ºèƒ½ä½“åˆ†é…ä»»åŠ¡ï¼š\\n\\nã€åˆ†é…ç»™ æ™ºèƒ½ä½“åç§°ã€‘\\nå…·ä½“çš„ä»»åŠ¡æè¿°...\\n\\nç”¨æˆ·çš„åŸå§‹è¯·æ±‚ï¼š${finalMessage}`;\n\n    const freeAgentTargets = nonDefaultTargets.filter(t => !isSessionBusy(t.sessionKey));\n    state.pendingDispatch = {\n      targets: freeAgentTargets,\n      finalMessage,\n      apiAttachments: [...apiAttachments],\n    };\n\n    const conversationContext = buildConversationContext(freeTargets.map(t => t.sessionKey));\n    let mainMessage = orchestrationPrompt;\n    if (conversationContext) {\n      mainMessage = `${conversationContext}\\n\\n---\\n\\n${orchestrationPrompt}`;\n    }\n\n    const idempotencyKey = generateUUID();\n    const requestPayload: any = {\n      sessionKey: state.sessionKey,\n      message: mainMessage,\n      deliver: false,\n      idempotencyKey,\n    };\n    if (apiAttachments.length > 0) {\n      requestPayload.attachments = apiAttachments;\n    }\n\n    console.log(\"[Orchestration] Sending to main for task dispatch:\", state.sessionKey);\n    state.client\n      .request(\"chat.send\", requestPayload)\n      .then((r: unknown) => { console.log(\"[Orchestration] Main accepted:\", r); })\n      .catch((err) => {\n        state.messages.push({ type: \"assistant\", text: `ä»»åŠ¡åˆ†é…å¤±è´¥ï¼š${String(err)}`, timestamp: Date.now(), id: generateUUID() });\n        state.activeRuns.delete(state.sessionKey);\n        state.pendingDispatch = null;\n        scheduleRender();\n      });\n    return;\n  }\n\n  for (const t of freeTargets) {\n    let agentMessage = finalMessage;\n\n    if (t.agentId) {\n      const memory = await loadAgentMemory(t.agentId);\n      if (memory) {\n        agentMessage = `ã€æ™ºèƒ½ä½“è®°å¿† â€” ä»¥ä¸‹æ˜¯ä½ åœ¨ä¹‹å‰å¯¹è¯ä¸­ç§¯ç´¯çš„é‡è¦ç»“è®ºå’ŒçŸ¥è¯†ï¼Œè¯·å‚è€ƒã€‘\\n${memory}\\n---\\n\\n${agentMessage}`;\n      }\n    }\n\n    const perAgentContext = buildConversationContext([], t.agent?.name);\n    if (perAgentContext) {\n      agentMessage = `${perAgentContext}\\n\\n---\\n\\n${agentMessage}`;\n    }\n\n    const idempotencyKey = generateUUID();\n    const requestPayload: any = {\n      sessionKey: t.sessionKey,\n      message: agentMessage,\n      deliver: false,\n      idempotencyKey,\n    };\n\n    if (apiAttachments.length > 0) {\n      requestPayload.attachments = apiAttachments;\n    }\n\n    console.log(`Sending chat.send to ${t.sessionKey}:`, {\n      ...requestPayload,\n      attachments: apiAttachments.map(a => ({ ...a, content: a.content.substring(0, 50) + \"...\" }))\n    });\n\n    state.client\n      .request(\"chat.send\", requestPayload)\n      .then((response: unknown) => {\n        console.log(`Chat.send response (${t.sessionKey}):`, response);\n      })\n      .catch((err) => {\n        state.messages.push({\n          type: \"assistant\",\n          text: `æŠ±æ­‰ï¼Œå‘é€æ¶ˆæ¯æ—¶å‡ºé”™ï¼ˆ${t.agent?.name || \"é»˜è®¤\"}ï¼‰ï¼š${String(err)}`,\n          timestamp: Date.now(),\n          id: generateUUID(),\n        });\n        state.activeRuns.delete(t.sessionKey);\n        scheduleRender();\n      });\n  }\n}\n\n// â”€â”€â”€ Abort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function abortRun(sessionKey: string) {\n  if (!state.client) return;\n  const run = state.activeRuns.get(sessionKey);\n  if (!run) return;\n  cancelPolling(sessionKey);\n  state.client.request(\"chat.abort\", { sessionKey }).catch(() => {});\n  state.activeRuns.delete(sessionKey);\n  if (sessionKey === state.sessionKey && state.pendingDispatch) {\n    state.pendingDispatch = null;\n  }\n  scheduleRender();\n}\n\nexport function handleAbort() {\n  if (!state.client || state.activeRuns.size === 0) return;\n  for (const [sk] of state.activeRuns) {\n    cancelPolling(sk);\n    state.client.request(\"chat.abort\", { sessionKey: sk }).catch(() => {});\n  }\n  state.activeRuns.clear();\n  state.pendingDispatch = null;\n  scheduleRender();\n}\n\n// â”€â”€â”€ Clear / Exit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function doClearAll() {\n  state.messages = [];\n  state.draft = \"\";\n  state.activeRuns.clear();\n  state.pendingDispatch = null;\n  state.favorites.clear();\n  state.sidePanel = null;\n  state.confirmingClear = false;\n  state.folderKnowledgeSent = false;\n  saveFavorites();\n  saveMessages();\n  scheduleRender();\n}\n\nexport async function doClearSession() {\n  state.confirmingSessionClear = false;\n  if (!state.client || !state.connected) {\n    showToast(\"æœªè¿æ¥åˆ°æœåŠ¡\");\n    scheduleRender();\n    return;\n  }\n  try {\n    await state.client.request(\"sessions.delete\", {\n      key: state.sessionKey,\n      deleteTranscript: true,\n    });\n    state.messages = [];\n    state.draft = \"\";\n    state.activeRuns.clear();\n    state.folderKnowledgeSent = false;\n    saveMessages();\n    showToast(\"ä¼šè¯å·²æ¸…ç©º\");\n  } catch (err: any) {\n    showToast(\"æ¸…ç©ºå¤±è´¥: \" + (err?.message || String(err)));\n  }\n  scheduleRender();\n}\n\nexport function doExitApp() {\n  const api = (window as any).electronAPI;\n  if (api?.quitApp) {\n    api.quitApp();\n  } else {\n    window.close();\n  }\n}\n","/**\n * TaxChat State Update Queue â€” serializes concurrent state mutations\n * to prevent race conditions when multiple agents respond simultaneously.\n */\n\nimport { scheduleRender } from \"./state\";\n\nlet queue: (() => void)[] = [];\nlet processing = false;\n\n/**\n * Enqueue a state update function to be processed sequentially.\n * All queued updates run in order via microtask, then a single render is triggered.\n */\nexport function enqueueStateUpdate(fn: () => void) {\n  queue.push(fn);\n  if (!processing) {\n    processing = true;\n    queueMicrotask(processQueue);\n  }\n}\n\nfunction processQueue() {\n  while (queue.length > 0) {\n    const fn = queue.shift()!;\n    try { fn(); } catch (e) { console.error(\"[UpdateQueue] Error in queued update:\", e); }\n  }\n  processing = false;\n  scheduleRender();\n}\n","/**\n * TaxChat Gateway Connection & Event Handling\n */\n\nimport { GatewayBrowserClient } from \"../src/ui/gateway\";\nimport type { AssistantMessage } from \"./types\";\nimport { state, generateUUID, findRunForEvent, getMessagesForSession, isCurrentSession, scheduleRender } from \"./state\";\nimport { loadAgents } from \"./agents\";\nimport { syncManagedSkills } from \"./skills\";\nimport { extractMessageText, isSystemMessage, toolLabelMap } from \"./utils\";\nimport { finishSendingForRun, fetchCompleteResponse, isBadResponse } from \"./chat\";\nimport { enqueueStateUpdate } from \"./update-queue\";\n\n// â”€â”€â”€ Reconnection State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nlet reconnectTimer: ReturnType<typeof setTimeout> | null = null;\nlet reconnectAttempt = 0;\nlet isReconnecting = false;\n\nexport function cancelReconnect() {\n  if (reconnectTimer) {\n    clearTimeout(reconnectTimer);\n    reconnectTimer = null;\n  }\n}\n\nfunction scheduleReconnect() {\n  if (reconnectTimer || isReconnecting) return;\n  reconnectAttempt++;\n  const delay = Math.min(2000 * reconnectAttempt, 10000);\n  console.log(`[Reconnect] attempt ${reconnectAttempt} in ${delay}ms`);\n  reconnectTimer = setTimeout(() => {\n    reconnectTimer = null;\n    connectGateway();\n  }, delay);\n}\n\n// â”€â”€â”€ Connect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function connectGateway() {\n  isReconnecting = true;\n  cancelReconnect();\n\n  state.lastError = null;\n  if (state.client) {\n    state.client.stop();\n    state.client = null;\n  }\n\n  let gatewayToken: string | undefined;\n  try {\n    const electronAPI = (window as any).electronAPI;\n    if (electronAPI?.getGatewayPort) {\n      const port = await electronAPI.getGatewayPort();\n      if (port && port !== 18789) {\n        state.gatewayUrl = `ws://127.0.0.1:${port}`;\n        console.log(`[Gateway] Using port ${port}`);\n      }\n    }\n    if (electronAPI?.getGatewayToken) {\n      gatewayToken = await electronAPI.getGatewayToken() || undefined;\n    }\n  } catch (_) { /* not in Electron */ }\n  if (!gatewayToken) {\n    const params = new URLSearchParams(window.location.search);\n    gatewayToken = params.get(\"token\") || undefined;\n  }\n\n  isReconnecting = false;\n\n  state.client = new GatewayBrowserClient({\n    url: state.gatewayUrl,\n    clientName: \"webchat-ui\",\n    mode: \"webchat\",\n    token: gatewayToken,\n    onHello: (hello) => {\n      state.connected = true;\n      state.hello = hello;\n      state.lastError = null;\n      reconnectAttempt = 0;\n      cancelReconnect();\n      scheduleRender();\n      loadAgents();\n    },\n    onClose: ({ code }) => {\n      state.connected = false;\n      if (isReconnecting) return;\n      if (code !== 1012) {\n        state.lastError = `æ­£åœ¨ç­‰å¾…æœåŠ¡å¯åŠ¨...`;\n      }\n      scheduleRender();\n      scheduleReconnect();\n    },\n    onEvent: (evt) => {\n      console.log(\"Gateway event:\", evt.event, evt.payload);\n\n      // Handle agent events (tool execution progress)\n      if (evt.event === \"agent\") {\n        const agentPayload = evt.payload as any;\n        const evtSK = agentPayload?.sessionKey ? String(agentPayload.sessionKey) : \"\";\n        const matchedRun = evtSK ? findRunForEvent(evtSK) : null;\n        if (!matchedRun && evtSK) return;\n\n        if (agentPayload?.stream === \"tool\" && agentPayload?.data) {\n          const phase = agentPayload.data.phase;\n          const toolName = agentPayload.data.name || \"\";\n          if (phase === \"start\" && matchedRun) {\n            enqueueStateUpdate(() => {\n              matchedRun.toolsActive = (matchedRun.toolsActive || 0) + 1;\n              matchedRun.thinkingLabel = toolLabelMap(toolName);\n            });\n          } else if (phase === \"result\" && matchedRun) {\n            enqueueStateUpdate(() => {\n              matchedRun.toolsActive = Math.max(0, (matchedRun.toolsActive || 0) - 1);\n              matchedRun.thinkingLabel = \"æ­£åœ¨æ€è€ƒ...\";\n            });\n          }\n        } else if (agentPayload?.stream === \"lifecycle\" && agentPayload?.data?.phase === \"end\") {\n          if (matchedRun) {\n            enqueueStateUpdate(() => {\n              matchedRun.toolsActive = 0;\n            });\n            const runId = matchedRun.runId || agentPayload.runId || generateUUID();\n            const runSK = matchedRun.sessionKey;\n            setTimeout(() => {\n              if (state.activeRuns.has(runSK)) {\n                console.log(\"Lifecycle end triggered fetchCompleteResponse (safety net) for\", runSK);\n                enqueueStateUpdate(() => {\n                  const r = state.activeRuns.get(runSK);\n                  if (r) r.thinkingLabel = \"æ­£åœ¨æ•´ç†å›å¤...\";\n                });\n                fetchCompleteResponse(runId, runSK);\n              }\n            }, 300);\n          }\n          setTimeout(() => syncManagedSkills(), 2000);\n        } else if (agentPayload?.stream === \"assistant\") {\n          if (matchedRun && matchedRun.thinkingLabel && matchedRun.thinkingLabel !== \"æ­£åœ¨æ€è€ƒ...\") {\n            enqueueStateUpdate(() => {\n              matchedRun.thinkingLabel = \"æ­£åœ¨æ€è€ƒ...\";\n            });\n          }\n        }\n      }\n\n      // Handle chat events\n      if (evt.event === \"chat\") {\n        const payload = evt.payload as any;\n        const evtSK = payload?.sessionKey ? String(payload.sessionKey) : \"\";\n        const matchedRun = evtSK ? findRunForEvent(evtSK) : null;\n        if (!matchedRun && evtSK) return;\n\n        console.log(\"Chat message received:\", payload.message, \"state:\", payload.state, \"session:\", evtSK);\n\n        // Handle delta state (streaming message parts)\n        if (payload.state === \"delta\" && payload?.message) {\n          const text = typeof payload.message === \"string\"\n            ? payload.message\n            : extractMessageText(payload.message);\n\n          if (text && !isSystemMessage(text) && matchedRun) {\n            enqueueStateUpdate(() => {\n              if (!matchedRun.runId && payload.runId) {\n                matchedRun.runId = payload.runId;\n              }\n              const msgs = getMessagesForSession(matchedRun.sessionKey);\n              const existingIdx = msgs.findIndex(m => m.type === \"assistant\" && m.id === payload.runId);\n              if (existingIdx >= 0) {\n                (msgs[existingIdx] as any).text = text;\n              } else {\n                msgs.push({\n                  type: \"assistant\",\n                  text: text,\n                  timestamp: Date.now(),\n                  id: payload.runId,\n                  agentId: matchedRun.agentId || undefined,\n                  agentEmoji: matchedRun.agentEmoji || undefined,\n                  agentName: matchedRun.agentName || undefined,\n                  agentAvatarUrl: matchedRun.agentAvatarUrl || undefined,\n                });\n              }\n            });\n          }\n        }\n\n        // Handle final state\n        if (payload.state === \"final\" && matchedRun) {\n          enqueueStateUpdate(() => {\n            if (!matchedRun.runId && payload.runId) {\n              matchedRun.runId = payload.runId;\n            }\n\n            if (matchedRun.runId && payload.runId !== matchedRun.runId) {\n              console.log(\"Ignoring final from different run:\", payload.runId, \"expected:\", matchedRun.runId);\n              return;\n            }\n\n            let inlineText = \"\";\n            if (payload?.message) {\n              const t = typeof payload.message === \"string\"\n                ? payload.message\n                : extractMessageText(payload.message);\n              if (t && !isSystemMessage(t)) {\n                inlineText = t;\n              }\n            }\n\n            if (inlineText) {\n              const msgs = getMessagesForSession(matchedRun.sessionKey);\n              const existingIdx = msgs.findIndex(m => m.type === \"assistant\" && m.id === payload.runId);\n              if (existingIdx >= 0) {\n                (msgs[existingIdx] as any).text = inlineText;\n              } else {\n                msgs.push({\n                  type: \"assistant\",\n                  text: inlineText,\n                  timestamp: Date.now(),\n                  id: payload.runId,\n                  agentId: matchedRun.agentId || undefined,\n                  agentEmoji: matchedRun.agentEmoji || undefined,\n                  agentName: matchedRun.agentName || undefined,\n                  agentAvatarUrl: matchedRun.agentAvatarUrl || undefined,\n                });\n              }\n            }\n\n            if (matchedRun.toolsActive > 0) {\n              console.log(\"Tools still active (\" + matchedRun.toolsActive + \"), deferring fetchCompleteResponse for\", matchedRun.sessionKey);\n              return;\n            }\n\n            const runId = matchedRun.runId || payload.runId;\n            if (inlineText && !isBadResponse(inlineText)) {\n              console.log(\"[final] Inline text is good, finishing immediately for\", matchedRun.sessionKey);\n              finishSendingForRun(matchedRun.sessionKey);\n            } else {\n              console.log(\"[final] No good inline text, falling back to polling for\", matchedRun.sessionKey);\n              matchedRun.thinkingLabel = \"æ­£åœ¨æ•´ç†å›å¤...\";\n              fetchCompleteResponse(runId, matchedRun.sessionKey);\n            }\n          });\n        }\n\n        // Handle error state\n        if (payload.state === \"error\" && matchedRun) {\n          enqueueStateUpdate(() => {\n            const msgs = getMessagesForSession(matchedRun.sessionKey);\n            const errorText = payload.errorMessage || \"å¤„ç†è¯·æ±‚æ—¶å‡ºé”™\";\n            msgs.push({\n              type: \"assistant\",\n              text: `é”™è¯¯ï¼š${errorText}`,\n              timestamp: Date.now(),\n              id: generateUUID(),\n            });\n            finishSendingForRun(matchedRun.sessionKey);\n          });\n        }\n      }\n    },\n  });\n  state.client.start();\n}\n","/**\n * TaxChat Model/Settings Management\n */\n\nimport type { AppState } from \"./types\";\nimport { state, scheduleRender } from \"./state\";\nimport { showToast } from \"./utils\";\n\n// â”€â”€â”€ Model Config Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport function getProviderNames(): string[] {\n  const seen = new Set<string>();\n  const result: string[] = [];\n  for (const m of state.modelList) {\n    const key = m.provider || \"unknown\";\n    if (!seen.has(key)) { seen.add(key); result.push(key); }\n  }\n  return result;\n}\n\nexport function getModelsForProvider(provider: string): AppState[\"modelList\"] {\n  return state.modelList.filter(m => m.provider === provider);\n}\n\nexport function selectProvider(providerName: string) {\n  state.modelConfigDraft.provider = providerName;\n  state.modelConfigDraft.baseUrl = \"\";\n  state.modelConfigDraft.apiKey = \"\";\n  state.modelConfigDraft.api = \"openai-completions\";\n  state.apiKeyVisible = false;\n  const providers = state.currentModelConfig?.providers;\n  if (providers && typeof providers === \"object\") {\n    const p = providers[providerName];\n    if (p) {\n      state.modelConfigDraft.baseUrl = p.baseUrl || \"\";\n      state.modelConfigDraft.apiKey = p.apiKey || \"\";\n      state.modelConfigDraft.api = p.api || \"openai-completions\";\n    }\n  }\n  const models = getModelsForProvider(providerName);\n  state.modelConfigDraft.modelId = models.length > 0 ? models[0].id : \"\";\n  scheduleRender();\n}\n\nexport function selectModel(modelId: string) {\n  state.modelConfigDraft.modelId = modelId;\n  scheduleRender();\n}\n\nexport function populateModelDraft(config: any) {\n  const providers = config?.models?.providers;\n  if (!providers || typeof providers !== \"object\") return;\n  const keys = Object.keys(providers);\n  if (keys.length === 0) return;\n  const key = keys[0];\n  const p = providers[key];\n  const modelId = p?.models?.[0]?.id || \"\";\n  const baseUrl = p?.baseUrl || \"\";\n  const apiKey = p?.apiKey || \"\";\n  state.modelConfigDraft = {\n    provider: key,\n    baseUrl,\n    apiKey,\n    api: p?.api || \"openai-completions\",\n    modelId,\n  };\n  state.activeModel = { provider: key, modelId, baseUrl, apiKey };\n}\n\nexport async function loadModelConfig() {\n  if (!state.client || !state.connected) {\n    state.modelError = \"æœªè¿æ¥åˆ°æœåŠ¡\";\n    scheduleRender();\n    return;\n  }\n  state.modelLoading = true;\n  state.modelError = null;\n  scheduleRender();\n  try {\n    const [modelsRes, configRes] = await Promise.all([\n      state.client.request(\"models.list\", {}) as Promise<any>,\n      state.client.request(\"config.get\", {}) as Promise<any>,\n    ]);\n    state.modelList = Array.isArray(modelsRes?.models) ? modelsRes.models : [];\n    state.configBaseHash = configRes?.hash || null;\n    state.currentModelConfig = configRes?.config?.models || null;\n    populateModelDraft(configRes?.config);\n  } catch (err: any) {\n    state.modelError = err?.message || String(err);\n  }\n  state.modelLoading = false;\n  scheduleRender();\n}\n\nexport async function saveModelConfig() {\n  if (!state.client || !state.connected) {\n    state.modelError = \"æœªè¿æ¥åˆ°æœåŠ¡\";\n    scheduleRender();\n    return;\n  }\n  const d = state.modelConfigDraft;\n  if (!d.provider.trim()) { state.modelError = \"è¯·å¡«å†™æä¾›å•†åç§°\"; scheduleRender(); return; }\n  if (!d.baseUrl.trim()) { state.modelError = \"è¯·å¡«å†™ API åœ°å€\"; scheduleRender(); return; }\n  if (!d.modelId.trim()) { state.modelError = \"è¯·å¡«å†™æ¨¡å‹ ID\"; scheduleRender(); return; }\n\n  state.modelSaving = true;\n  state.modelError = null;\n  scheduleRender();\n  try {\n    const patch: any = {\n      models: {\n        providers: {\n          [d.provider.trim()]: {\n            baseUrl: d.baseUrl.trim(),\n            apiKey: d.apiKey.trim() || undefined,\n            api: d.api,\n            models: [{\n              id: d.modelId.trim(),\n              name: d.modelId.trim(),\n              reasoning: false,\n              input: [\"text\", \"image\"],\n              cost: { input: 0, output: 0, cacheRead: 0, cacheWrite: 0 },\n              contextWindow: 128000,\n              maxTokens: 8192,\n            }],\n          },\n        },\n      },\n    };\n    await state.client.request(\"config.patch\", {\n      baseHash: state.configBaseHash,\n      raw: JSON.stringify(patch),\n      note: \"æ¨¡å‹é…ç½®æ›´æ–°\",\n      restartDelayMs: 1000,\n    });\n    showToast(\"æ¨¡å‹é…ç½®å·²ä¿å­˜ï¼ŒæœåŠ¡æ­£åœ¨é‡å¯...\");\n    state.settingsView = \"main\";\n  } catch (err: any) {\n    state.modelError = err?.message || String(err);\n  }\n  state.modelSaving = false;\n  scheduleRender();\n}\n","/**\n * TaxChat Quick Commands â€” /command palette\n */\n\nimport { state, scheduleRender } from \"./state\";\n\nexport interface QuickCommand {\n  id: string;\n  name: string;\n  emoji: string;\n  description: string;\n  action: () => void;\n}\n\n// Commands are populated by the entry point (taxchat-app.ts) to avoid circular imports\nlet registeredCommands: QuickCommand[] = [];\n\nexport function registerCommands(cmds: QuickCommand[]) {\n  registeredCommands = cmds;\n}\n\nexport function getFilteredCommands(): QuickCommand[] {\n  const filter = state.commandFilter.toLowerCase().replace(/^\\//, \"\");\n  if (!filter) return registeredCommands;\n  return registeredCommands.filter(c =>\n    c.name.toLowerCase().includes(filter) ||\n    c.id.toLowerCase().includes(filter) ||\n    c.description.toLowerCase().includes(filter)\n  );\n}\n\nexport function openCommandPalette() {\n  state.commandPaletteVisible = true;\n  state.commandFilter = state.draft;\n  state.commandIndex = 0;\n  scheduleRender();\n}\n\nexport function closeCommandPalette() {\n  state.commandPaletteVisible = false;\n  state.commandFilter = \"\";\n  state.commandIndex = 0;\n  scheduleRender();\n}\n\nexport function executeCommand(cmd: QuickCommand) {\n  closeCommandPalette();\n  state.draft = \"\";\n  cmd.action();\n  scheduleRender();\n}\n\n/** Check if current draft should trigger command palette */\nexport function checkCommandTrigger(): boolean {\n  const draft = state.draft.trim();\n  if (draft.startsWith(\"/\") && !draft.includes(\" \")) {\n    if (!state.commandPaletteVisible) {\n      openCommandPalette();\n    } else {\n      state.commandFilter = draft;\n      state.commandIndex = 0;\n      scheduleRender();\n    }\n    return true;\n  }\n  if (state.commandPaletteVisible) {\n    closeCommandPalette();\n  }\n  return false;\n}\n\nexport function commandNavigate(direction: \"up\" | \"down\") {\n  const cmds = getFilteredCommands();\n  if (cmds.length === 0) return;\n  if (direction === \"up\") {\n    state.commandIndex = (state.commandIndex - 1 + cmds.length) % cmds.length;\n  } else {\n    state.commandIndex = (state.commandIndex + 1) % cmds.length;\n  }\n  scheduleRender();\n}\n\nexport function commandExecuteSelected() {\n  const cmds = getFilteredCommands();\n  if (cmds.length > 0 && state.commandIndex < cmds.length) {\n    executeCommand(cmds[state.commandIndex]);\n  }\n}\n","/**\n * TaxChat Conversation Export â€” Markdown & HTML formats\n */\n\nimport type { AssistantMessage, UserMessage } from \"./types\";\nimport { state } from \"./state\";\n\nfunction downloadBlob(blob: Blob, filename: string) {\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = filename;\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n}\n\n/** Export current conversation as Markdown */\nexport function exportAsMarkdown() {\n  if (state.messages.length === 0) return;\n\n  const conv = state.conversations.find(c => c.id === state.currentConversationId);\n  const title = conv?.title || \"å¯¹è¯\";\n  const lines: string[] = [`# ${title}`, \"\"];\n\n  for (const msg of state.messages) {\n    if (msg.type === \"user\") {\n      const um = msg as UserMessage;\n      lines.push(`## ç”¨æˆ·`);\n      lines.push(um.text);\n      lines.push(\"\");\n    } else if (msg.type === \"assistant\") {\n      const am = msg as AssistantMessage;\n      const name = am.agentName ? `${am.agentEmoji || \"ğŸ¤–\"} ${am.agentName}` : \"Taxbot\";\n      lines.push(`## ${name}`);\n      lines.push(am.text);\n      lines.push(\"\");\n    }\n  }\n\n  const md = lines.join(\"\\n\");\n  const blob = new Blob([md], { type: \"text/markdown;charset=utf-8\" });\n  downloadBlob(blob, `${title}_${new Date().toISOString().slice(0, 10)}.md`);\n}\n\n/** Export current conversation as standalone HTML */\nexport function exportAsHTML() {\n  if (state.messages.length === 0) return;\n\n  const conv = state.conversations.find(c => c.id === state.currentConversationId);\n  const title = conv?.title || \"å¯¹è¯\";\n\n  let messagesHtml = \"\";\n  for (const msg of state.messages) {\n    if (msg.type === \"user\") {\n      const um = msg as UserMessage;\n      const escaped = escapeHtml(um.text);\n      messagesHtml += `<div class=\"msg user\"><div class=\"role\">ç”¨æˆ·</div><div class=\"content\">${escaped}</div></div>\\n`;\n    } else if (msg.type === \"assistant\") {\n      const am = msg as AssistantMessage;\n      const name = am.agentName ? `${am.agentEmoji || \"ğŸ¤–\"} ${am.agentName}` : \"Taxbot\";\n      const escaped = escapeHtml(am.text);\n      messagesHtml += `<div class=\"msg assistant\"><div class=\"role\">${escapeHtml(name)}</div><div class=\"content\">${escaped}</div></div>\\n`;\n    }\n  }\n\n  const html = `<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n<meta charset=\"utf-8\">\n<title>${escapeHtml(title)}</title>\n<style>\nbody { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }\nh1 { color: #1B3A5C; margin-bottom: 20px; }\n.msg { margin-bottom: 16px; padding: 12px 16px; border-radius: 12px; }\n.msg.user { background: #e3f2fd; }\n.msg.assistant { background: white; border: 1px solid #e5e7eb; }\n.role { font-weight: 600; font-size: 13px; color: #6b7280; margin-bottom: 6px; }\n.content { white-space: pre-wrap; line-height: 1.6; }\n.footer { text-align: center; color: #9ca3af; font-size: 12px; margin-top: 30px; }\n</style>\n</head>\n<body>\n<h1>${escapeHtml(title)}</h1>\n${messagesHtml}\n<div class=\"footer\">å¯¼å‡ºäº ${new Date().toLocaleString(\"zh-CN\")}</div>\n</body>\n</html>`;\n\n  const blob = new Blob([html], { type: \"text/html;charset=utf-8\" });\n  downloadBlob(blob, `${title}_${new Date().toISOString().slice(0, 10)}.html`);\n}\n\nfunction escapeHtml(text: string): string {\n  return text\n    .replace(/&/g, \"&amp;\")\n    .replace(/</g, \"&lt;\")\n    .replace(/>/g, \"&gt;\")\n    .replace(/\"/g, \"&quot;\")\n    .replace(/\\n/g, \"<br>\");\n}\n","/**\n * TaxChat Message Search â€” Ctrl+F in-conversation search\n */\n\nimport { state, scheduleRender } from \"./state\";\n\nexport function openSearch() {\n  state.searchOpen = true;\n  state.searchQuery = \"\";\n  state.searchResults = [];\n  state.searchIndex = 0;\n  scheduleRender();\n  // Focus the search input after render\n  setTimeout(() => {\n    const input = document.getElementById(\"taxchat-search-input\") as HTMLInputElement | null;\n    input?.focus();\n  }, 50);\n}\n\nexport function closeSearch() {\n  state.searchOpen = false;\n  state.searchQuery = \"\";\n  state.searchResults = [];\n  state.searchIndex = 0;\n  scheduleRender();\n}\n\nexport function performSearch(query: string) {\n  state.searchQuery = query;\n  if (!query.trim()) {\n    state.searchResults = [];\n    state.searchIndex = 0;\n    scheduleRender();\n    return;\n  }\n\n  const q = query.toLowerCase();\n  const results: string[] = [];\n  for (const msg of state.messages) {\n    if (msg.text && msg.text.toLowerCase().includes(q) && msg.id) {\n      results.push(msg.id);\n    }\n  }\n  state.searchResults = results;\n  state.searchIndex = results.length > 0 ? 0 : -1;\n  scheduleRender();\n\n  if (results.length > 0) {\n    scrollToSearchResult();\n  }\n}\n\nexport function nextResult() {\n  if (state.searchResults.length === 0) return;\n  state.searchIndex = (state.searchIndex + 1) % state.searchResults.length;\n  scheduleRender();\n  scrollToSearchResult();\n}\n\nexport function prevResult() {\n  if (state.searchResults.length === 0) return;\n  state.searchIndex = (state.searchIndex - 1 + state.searchResults.length) % state.searchResults.length;\n  scheduleRender();\n  scrollToSearchResult();\n}\n\nfunction scrollToSearchResult() {\n  const msgId = state.searchResults[state.searchIndex];\n  if (!msgId) return;\n  const el = document.querySelector(`[data-msg-id=\"${msgId}\"]`);\n  if (el) {\n    el.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\n    el.classList.add(\"search-highlight\");\n    setTimeout(() => el.classList.remove(\"search-highlight\"), 2000);\n  }\n}\n\n/** Check if a message is in current search results */\nexport function isSearchHit(msgId: string): boolean {\n  return state.searchResults.includes(msgId);\n}\n\n/** Check if a message is the currently focused search result */\nexport function isSearchFocused(msgId: string): boolean {\n  return state.searchResults[state.searchIndex] === msgId;\n}\n","/**\n * TaxStore API Client â€” HTTP interface to taxbot.cc OpenAPI\n */\n\nconst TAXSTORE_BASE = \"https://taxbot.cc:8443/api/open\";\n\n// â”€â”€â”€ Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport interface TaxStoreUser {\n  id: string;\n  name: string;\n  email: string;\n  role: string;\n  points: number;\n}\n\nexport interface TaxStoreSkill {\n  id: string;\n  name: string;\n  description: string;\n  version: string;\n  category: string;\n  tags: string | null;\n  pointsCost: number;\n  downloads: number;\n  status: string;\n  author: { name: string };\n  reviews: Array<{ rating: number }>;\n  createdAt: string;\n}\n\nexport interface TaxStoreInstalled {\n  id: string;\n  skillId: string;\n  version: string;\n  installedAt: string;\n  skill: { id: string; name: string; version: string; category: string };\n}\n\nexport interface TaxStorePagination {\n  page: number;\n  limit: number;\n  total: number;\n  totalPages: number;\n}\n\n// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function tsLogin(\n  email: string,\n  password: string,\n): Promise<{ token: string; user: TaxStoreUser; expiresIn: number }> {\n  const res = await fetch(`${TAXSTORE_BASE}/login`, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({ email, password }),\n  });\n  if (!res.ok) {\n    const data = await res.json().catch(() => ({}));\n    throw new Error(data.error || `ç™»å½•å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsGetMe(token: string): Promise<TaxStoreUser> {\n  const res = await fetch(`${TAXSTORE_BASE}/me`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(\"token æ— æ•ˆæˆ–å·²è¿‡æœŸ\");\n  const data = await res.json();\n  return data.user ?? data;\n}\n\n// â”€â”€â”€ Skills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function tsListSkills(opts: {\n  page?: number;\n  limit?: number;\n  q?: string;\n  category?: string;\n  sort?: \"latest\" | \"popular\";\n  token?: string | null;\n}): Promise<{ skills: TaxStoreSkill[]; pagination: TaxStorePagination }> {\n  const params = new URLSearchParams();\n  if (opts.page) params.set(\"page\", String(opts.page));\n  if (opts.limit) params.set(\"limit\", String(opts.limit));\n  if (opts.q) params.set(\"q\", opts.q);\n  if (opts.category) params.set(\"category\", opts.category);\n  if (opts.sort) params.set(\"sort\", opts.sort);\n\n  const headers: Record<string, string> = {};\n  if (opts.token) headers.Authorization = `Bearer ${opts.token}`;\n\n  const res = await fetch(`${TAXSTORE_BASE}/skills?${params}`, { headers });\n  if (!res.ok) throw new Error(`è·å–æŠ€èƒ½åˆ—è¡¨å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsGetSkillDetail(\n  id: string,\n  token?: string | null,\n): Promise<TaxStoreSkill> {\n  const headers: Record<string, string> = {};\n  if (token) headers.Authorization = `Bearer ${token}`;\n  const res = await fetch(`${TAXSTORE_BASE}/skills/${id}`, { headers });\n  if (!res.ok) throw new Error(`è·å–æŠ€èƒ½è¯¦æƒ…å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsDownloadSkill(\n  id: string,\n  token: string,\n): Promise<{ blob: Blob; alreadyPurchased: boolean }> {\n  const res = await fetch(`${TAXSTORE_BASE}/skills/${id}/download`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (res.status === 402) {\n    const data = await res.json().catch(() => ({}));\n    throw new Error(\n      data.error || `ç§¯åˆ†ä¸è¶³ (éœ€è¦: ${data.required ?? \"?\"}, å½“å‰: ${data.current ?? \"?\"})`,\n    );\n  }\n  if (res.status === 401) throw new Error(\"è¯·å…ˆç™»å½• TaxStore è´¦æˆ·\");\n  if (!res.ok) {\n    const data = await res.json().catch(() => ({}));\n    console.warn(\"[TaxStore] Download failed:\", res.status, data);\n    throw new Error(data.error || `ä¸‹è½½å¤±è´¥ (${res.status})`);\n  }\n  const blob = await res.blob();\n  const alreadyPurchased = res.headers.get(\"X-Already-Purchased\") === \"1\";\n  return { blob, alreadyPurchased };\n}\n\n// â”€â”€â”€ Agent Rental Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport interface AgentListing {\n  id: string;\n  name: string;\n  emoji: string;\n  description: string;\n  price: number;\n  status: string;\n  completedTasks: number;\n  avgRating: number;\n  agentId: string;\n  avatarUrl?: string | null;\n  tags?: string | null;\n  owner: { id: string; name: string };\n  createdAt: string;\n  _count?: { tasks: number };\n}\n\nexport interface TaskAttachmentMeta {\n  name: string;\n  url: string;\n  type: string;\n  size: number;\n}\n\nexport interface AgentTask {\n  id: string;\n  title: string;\n  content: string;\n  attachments?: string;\n  result?: string;\n  resultAttachments?: string;\n  status: string;\n  rating?: number;\n  ratingComment?: string;\n  revisionCount?: number;\n  revisionRequest?: string;\n  price: number;\n  listing: { id: string; name: string; emoji: string; agentId: string; avatarUrl?: string | null; owner: { name: string } };\n  client: { id: string; name: string };\n  createdAt: string;\n  completedAt?: string;\n  clientRead?: boolean;\n  unreadMessageCount?: number;\n}\n\n// â”€â”€â”€ Agent Rental API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function tsPublishAgent(\n  token: string,\n  data: { name: string; emoji: string; description: string; price: number; agentId: string; avatarUrl?: string; tags?: string },\n): Promise<AgentListing> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/publish`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(data),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `å‘å¸ƒå¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsUpdateAgent(\n  token: string,\n  id: string,\n  data: Partial<{ description: string; price: number; status: string; tags: string }>,\n): Promise<AgentListing> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/${id}`, {\n    method: \"PUT\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(data),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `æ›´æ–°å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsUnpublishAgent(token: string, id: string): Promise<void> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/${id}`, {\n    method: \"DELETE\",\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `ä¸‹æ¶å¤±è´¥ (${res.status})`);\n  }\n}\n\nexport async function tsGetMyAgents(token: string): Promise<AgentListing[]> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/my`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(`è·å–æˆ‘çš„æ™ºèƒ½ä½“å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsHeartbeat(token: string, listingIds: string[]): Promise<void> {\n  if (listingIds.length === 0) return;\n  try {\n    await fetch(`${TAXSTORE_BASE}/agents/heartbeat`, {\n      method: \"POST\",\n      headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n      body: JSON.stringify({ listingIds }),\n    });\n  } catch { /* silent */ }\n}\n\nexport async function tsGetPendingTasks(token: string, status?: string): Promise<AgentTask[]> {\n  const params = status ? `?status=${status}` : \"\";\n  const res = await fetch(`${TAXSTORE_BASE}/agents/tasks${params}`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(`è·å–ä»»åŠ¡å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsCompleteTask(\n  token: string,\n  taskId: string,\n  result: string,\n  resultAttachments?: TaskAttachmentMeta[],\n): Promise<AgentTask> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/tasks/${taskId}`, {\n    method: \"PUT\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({ result, ...(resultAttachments && { resultAttachments }) }),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `æäº¤å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsUploadTaskAttachment(\n  token: string,\n  file: File,\n): Promise<TaskAttachmentMeta> {\n  const formData = new FormData();\n  formData.append(\"file\", file);\n  const res = await fetch(`${TAXSTORE_BASE}/agents/upload`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}` },\n    body: formData,\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `ä¸Šä¼ å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsGetAgentStats(): Promise<{ avgMinutes: number; recentCount: number }> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/stats`);\n  if (!res.ok) return { avgMinutes: 0, recentCount: 0 };\n  return res.json();\n}\n\nexport async function tsListAgents(opts?: {\n  q?: string;\n  sort?: \"latest\" | \"popular\";\n  page?: number;\n  limit?: number;\n}): Promise<{ agents: AgentListing[]; pagination: TaxStorePagination }> {\n  const params = new URLSearchParams();\n  if (opts?.q) params.set(\"q\", opts.q);\n  if (opts?.sort) params.set(\"sort\", opts.sort);\n  if (opts?.page) params.set(\"page\", String(opts.page));\n  if (opts?.limit) params.set(\"limit\", String(opts.limit));\n  const qs = params.toString();\n  const res = await fetch(`${TAXSTORE_BASE}/agents${qs ? `?${qs}` : \"\"}`);\n  if (!res.ok) throw new Error(`è·å–æ™ºèƒ½ä½“åˆ—è¡¨å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsCreateTask(\n  token: string,\n  listingId: string,\n  data: { title: string; content: string; attachments?: TaskAttachmentMeta[] },\n): Promise<AgentTask> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/${listingId}/task`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(data),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `ä¸‹å•å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\nexport async function tsGetMyTasks(token: string): Promise<AgentTask[]> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/my-tasks`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(`è·å–æˆ‘çš„ä»»åŠ¡å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsMarkTaskRead(\n  token: string,\n  taskId: string,\n): Promise<void> {\n  await fetch(`${TAXSTORE_BASE}/agents/my-tasks/${taskId}/read`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}` },\n  }).catch(() => {});\n}\n\nexport async function tsRateTask(\n  token: string,\n  taskId: string,\n  data: { rating: number; comment?: string },\n): Promise<void> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/my-tasks/${taskId}/rate`, {\n    method: \"PUT\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(data),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `è¯„ä»·å¤±è´¥ (${res.status})`);\n  }\n}\n\n// â”€â”€â”€ Task Revision â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function tsRequestRevision(\n  token: string,\n  taskId: string,\n  request: string,\n): Promise<AgentTask> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/my-tasks/${taskId}/revise`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({ request }),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `è¯·æ±‚ä¿®è®¢å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\n// â”€â”€â”€ Task Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport interface TaskMessage {\n  id: string;\n  content: string;\n  createdAt: string;\n  sender: { id: string; name: string };\n}\n\nexport async function tsGetTaskMessages(\n  token: string,\n  taskId: string,\n): Promise<TaskMessage[]> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/tasks/${taskId}/messages`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(`è·å–æ¶ˆæ¯å¤±è´¥ (${res.status})`);\n  const data = await res.json();\n  return data.messages;\n}\n\nexport async function tsSendTaskMessage(\n  token: string,\n  taskId: string,\n  content: string,\n): Promise<TaskMessage> {\n  const res = await fetch(`${TAXSTORE_BASE}/agents/tasks/${taskId}/messages`, {\n    method: \"POST\",\n    headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n    body: JSON.stringify({ content }),\n  });\n  if (!res.ok) {\n    const d = await res.json().catch(() => ({}));\n    throw new Error(d.error || `å‘é€å¤±è´¥ (${res.status})`);\n  }\n  return res.json();\n}\n\n// â”€â”€â”€ Installed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nexport async function tsGetInstalled(\n  token: string,\n): Promise<TaxStoreInstalled[]> {\n  const res = await fetch(`${TAXSTORE_BASE}/me/installed`, {\n    headers: { Authorization: `Bearer ${token}` },\n  });\n  if (!res.ok) throw new Error(`è·å–å·²å®‰è£…åˆ—è¡¨å¤±è´¥ (${res.status})`);\n  return res.json();\n}\n\nexport async function tsRecordInstall(\n  token: string,\n  skillId: string,\n  version: string,\n): Promise<void> {\n  const res = await fetch(`${TAXSTORE_BASE}/me/installed`, {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${token}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({ skillId, version }),\n  });\n  if (!res.ok) {\n    // Non-critical â€” don't throw, just log\n    console.warn(\"[TaxStore] Failed to record installation:\", res.status);\n  }\n}\n","/**\n * TaxStore Integration â€” login, browse, install, sync logic\n */\n\nimport { state, generateUUID, scheduleRender } from \"./state\";\nimport { showToast, addNotification } from \"./utils\";\nimport { saveCustomSkills } from \"./persistence\";\nimport {\n  tsLogin,\n  tsGetMe,\n  tsListSkills,\n  tsDownloadSkill,\n  tsRecordInstall,\n  tsGetInstalled,\n  tsGetSkillDetail,\n} from \"./taxstore-api\";\nimport type { TaxStoreSkill, TaxStoreInstalled } from \"./taxstore-api\";\nimport type { CustomSkill } from \"./types\";\n\nconst TOKEN_KEY = \"taxbot_taxstore_token\";\n\n// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/** Called once at startup â€” restore saved token and validate */\nexport async function initTaxStore() {\n  const saved = localStorage.getItem(TOKEN_KEY);\n  if (!saved) return;\n\n  state.taxstoreToken = saved;\n  try {\n    const user = await tsGetMe(saved);\n    state.taxstoreUser = user;\n    state.taxstoreConnected = true;\n    scheduleRender();\n  } catch {\n    // Token expired / invalid â€” clear it\n    localStorage.removeItem(TOKEN_KEY);\n    state.taxstoreToken = null;\n    state.taxstoreConnected = false;\n  }\n}\n\n// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function loginTaxStore(email: string, password: string) {\n  state.taxstoreLoading = true;\n  state.taxstoreError = null;\n  scheduleRender();\n\n  try {\n    const { token, user } = await tsLogin(email, password);\n    state.taxstoreToken = token;\n    state.taxstoreUser = user;\n    state.taxstoreConnected = true;\n    localStorage.setItem(TOKEN_KEY, token);\n\n    // Load first page of skills\n    await fetchSkills(1);\n    showToast(`å·²è¿æ¥ TaxStore: ${user.name}`);\n  } catch (err: any) {\n    state.taxstoreError = err.message || \"ç™»å½•å¤±è´¥\";\n  } finally {\n    state.taxstoreLoading = false;\n    scheduleRender();\n  }\n}\n\nexport function logoutTaxStore() {\n  state.taxstoreToken = null;\n  state.taxstoreUser = null;\n  state.taxstoreConnected = false;\n  state.taxstoreSkills = [];\n  state.taxstorePage = 1;\n  state.taxstoreTotalPages = 1;\n  state.taxstoreError = null;\n  state.taxstoreInstalledIds = new Set();\n  localStorage.removeItem(TOKEN_KEY);\n  scheduleRender();\n}\n\n// â”€â”€â”€ Browse Skills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function fetchSkills(page: number = 1) {\n  state.taxstoreLoading = true;\n  state.taxstoreError = null;\n  scheduleRender();\n\n  try {\n    const data = await tsListSkills({\n      page,\n      limit: 15,\n      q: state.taxstoreQuery || undefined,\n      category: state.taxstoreCategory || undefined,\n      sort: state.taxstoreSort,\n      token: state.taxstoreToken,\n    });\n    state.taxstoreSkills = data.skills;\n    state.taxstorePage = data.pagination.page;\n    state.taxstoreTotalPages = data.pagination.totalPages;\n  } catch (err: any) {\n    state.taxstoreError = err.message || \"è·å–æŠ€èƒ½åˆ—è¡¨å¤±è´¥\";\n  } finally {\n    state.taxstoreLoading = false;\n    scheduleRender();\n  }\n}\n\nexport function searchSkills(query: string) {\n  state.taxstoreQuery = query;\n  fetchSkills(1);\n}\n\nexport function filterByCategory(cat: string) {\n  state.taxstoreCategory = cat;\n  fetchSkills(1);\n}\n\nexport function changeSortOrder(sort: \"latest\" | \"popular\") {\n  state.taxstoreSort = sort;\n  fetchSkills(1);\n}\n\n// â”€â”€â”€ Install Skill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function installFromTaxStore(skill: TaxStoreSkill) {\n  if (!state.taxstoreToken) {\n    showToast(\"è¯·å…ˆç™»å½• TaxStore è´¦æˆ·\");\n    return;\n  }\n\n  // Check if already installed locally\n  if (state.customSkills.some(s => s.taxstoreSkillId === skill.id)) {\n    showToast(`æŠ€èƒ½ã€Œ${skill.name}ã€å·²å®‰è£…`);\n    return;\n  }\n\n  // Prevent double-click\n  if (state.taxstoreInstallingId) return;\n\n  state.taxstoreInstallingId = skill.id;\n  state.taxstoreInstallStep = \"downloading\";\n  scheduleRender();\n\n  try {\n    // 1. Download ZIP\n    const { blob } = await tsDownloadSkill(skill.id, state.taxstoreToken);\n\n    // Validate it's actually a ZIP (PK\\x03\\x04 magic bytes)\n    const header = new Uint8Array(await blob.slice(0, 4).arrayBuffer());\n    if (header[0] !== 0x50 || header[1] !== 0x4B) {\n      throw new Error(\"æœåŠ¡å™¨è¿”å›çš„æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„æŠ€èƒ½åŒ…ï¼ˆé ZIP æ ¼å¼ï¼‰\");\n    }\n\n    state.taxstoreInstallStep = \"installing\";\n    scheduleRender();\n\n    // 2. Convert to ArrayBuffer (much faster than base64 for IPC)\n    const arrayBuffer = await blob.arrayBuffer();\n\n    // 3. Install via Electron (prefer buffer API, fallback to base64)\n    const api = (window as any).electronAPI;\n    if (!api?.installSkillPackage && !api?.installSkillBuffer) {\n      showToast(\"å½“å‰ç¯å¢ƒä¸æ”¯æŒæŠ€èƒ½åŒ…å®‰è£…\");\n      return;\n    }\n\n    const result = api.installSkillBuffer\n      ? await api.installSkillBuffer(arrayBuffer, `${skill.name}.zip`)\n      : await api.installSkillPackage(await blobToBase64(blob), `${skill.name}.zip`);\n\n    if (!result?.ok) {\n      showToast(`å®‰è£…å¤±è´¥: ${result?.error || \"æœªçŸ¥é”™è¯¯\"}`);\n      return;\n    }\n\n    // 4. Add to local custom skills\n    const customSkill: CustomSkill = {\n      id: generateUUID(),\n      name: result.skill?.name || skill.name,\n      emoji: result.skill?.emoji || \"ğŸ“¦\",\n      description: result.skill?.description || skill.description,\n      prompt: result.skill?.prompt || \"\",\n      pinned: false,\n      createdAt: Date.now(),\n      folderName: result.folderName,\n      taxstoreSkillId: skill.id,\n      taxstoreVersion: skill.version,\n    };\n    state.customSkills.push(customSkill);\n    saveCustomSkills();\n    state.taxstoreInstalledIds.add(skill.id);\n\n    // 5. Record on TaxStore (non-blocking)\n    tsRecordInstall(state.taxstoreToken, skill.id, skill.version).catch(() => {});\n\n    // 6. Refresh user points\n    refreshUserInfo();\n\n    showToast(`æŠ€èƒ½ã€Œ${skill.name}ã€å·²å®‰è£…`);\n    addNotification(`å·²ä» TaxStore å®‰è£…æŠ€èƒ½: ${skill.name}`, \"ğŸ“¦\");\n  } catch (err: any) {\n    showToast(err.message || \"å®‰è£…å¤±è´¥\");\n  } finally {\n    state.taxstoreInstallingId = null;\n    state.taxstoreInstallStep = null;\n    scheduleRender();\n  }\n}\n\n// â”€â”€â”€ Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/** Refresh user info (points etc.) â€” called after install */\nasync function refreshUserInfo() {\n  if (!state.taxstoreToken) return;\n  try {\n    state.taxstoreUser = await tsGetMe(state.taxstoreToken);\n    scheduleRender();\n  } catch { /* ignore */ }\n}\n\n/**\n * Sync installed skills on startup:\n * - Build set of TaxStore skill IDs installed locally\n * - Fetch remote installed list to detect missing / updatable\n */\nexport async function syncInstalled() {\n  if (!state.taxstoreToken || !state.taxstoreConnected) return;\n\n  // Build local installed set\n  for (const sk of state.customSkills) {\n    if (sk.taxstoreSkillId) {\n      state.taxstoreInstalledIds.add(sk.taxstoreSkillId);\n    }\n  }\n\n  try {\n    const remote = await tsGetInstalled(state.taxstoreToken);\n\n    // Check for updates\n    const updates: Array<{ skillId: string; name: string; localVersion: string; remoteVersion: string }> = [];\n    for (const r of remote) {\n      const local = state.customSkills.find(s => s.taxstoreSkillId === r.skillId);\n      if (local && local.taxstoreVersion && local.taxstoreVersion !== r.skill.version) {\n        // Version on TaxStore may differ from installed version\n        // Fetch latest detail to compare\n        try {\n          const detail = await tsGetSkillDetail(r.skillId, state.taxstoreToken);\n          if (detail.version !== local.taxstoreVersion) {\n            updates.push({\n              skillId: r.skillId,\n              name: r.skill.name,\n              localVersion: local.taxstoreVersion,\n              remoteVersion: detail.version,\n            });\n          }\n        } catch { /* skip */ }\n      }\n    }\n\n    if (updates.length > 0) {\n      state.taxstoreUpdates = updates;\n      addNotification(`${updates.length} ä¸ª TaxStore æŠ€èƒ½æœ‰æ›´æ–°å¯ç”¨`, \"ğŸ”„\");\n      scheduleRender();\n    }\n  } catch {\n    // Non-critical â€” ignore sync failures\n  }\n}\n\n// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nfunction blobToBase64(blob: Blob): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => {\n      const dataUrl = reader.result as string;\n      resolve(dataUrl.split(\",\")[1]);\n    };\n    reader.onerror = reject;\n    reader.readAsDataURL(blob);\n  });\n}\n\n/** Check if a TaxStore skill is installed locally */\nexport function isInstalledLocally(skillId: string): boolean {\n  return state.taxstoreInstalledIds.has(skillId);\n}\n\n/** Get average rating from reviews array */\nexport function avgRating(reviews: Array<{ rating: number }>): string {\n  if (!reviews || reviews.length === 0) return \"-\";\n  const sum = reviews.reduce((a, r) => a + r.rating, 0);\n  return (sum / reviews.length).toFixed(1);\n}\n","/**\n * Agent Rental â€” publish agents, poll tasks, complete tasks\n */\n\nimport { state, generateUUID, scheduleRender } from \"./state\";\nimport { showToast, addNotification, extractMessageText, isSystemMessage } from \"./utils\";\nimport {\n  tsPublishAgent,\n  tsGetMyAgents,\n  tsGetPendingTasks,\n  tsCompleteTask,\n  tsUnpublishAgent,\n  tsUpdateAgent,\n  tsHeartbeat,\n  tsUploadTaskAttachment,\n  tsGetTaskMessages,\n  tsSendTaskMessage,\n  tsGetMyTasks,\n  tsListAgents,\n  tsCreateTask,\n  tsMarkTaskRead,\n  tsRequestRevision,\n  tsRateTask,\n  tsGetAgentStats,\n} from \"./taxstore-api\";\nimport { loadAgentMemory, appendAgentMemory } from \"./agents\";\nimport { buildConversationContext } from \"./chat\";\nimport type { AgentListing, AgentTask, TaskAttachmentMeta } from \"./taxstore-api\";\n\n// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n/** Convert ArrayBuffer to base64 safely (handles large files) */\nfunction arrayBufferToBase64(buf: ArrayBuffer): string {\n  const bytes = new Uint8Array(buf);\n  const CHUNK = 0x8000;\n  const parts: string[] = [];\n  for (let i = 0; i < bytes.length; i += CHUNK) {\n    parts.push(String.fromCharCode(...bytes.subarray(i, i + CHUNK)));\n  }\n  return btoa(parts.join(\"\"));\n}\n\n/** Download task attachments, returning image attachments as base64 for the LLM */\nasync function fetchTaskAttachments(attachmentsJson: string): Promise<{\n  imageAtts: { type: string; mimeType: string; fileName: string; content: string }[];\n  textSuffix: string;\n}> {\n  const imageAtts: { type: string; mimeType: string; fileName: string; content: string }[] = [];\n  let textSuffix = \"\";\n  try {\n    const atts = JSON.parse(attachmentsJson) as TaskAttachmentMeta[];\n    const otherAtts: TaskAttachmentMeta[] = [];\n    for (const a of atts) {\n      if (a.type?.startsWith(\"image/\")) {\n        try {\n          const res = await fetch(`https://taxbot.cc:8443${a.url}`);\n          if (res.ok) {\n            const buf = await res.arrayBuffer();\n            imageAtts.push({ type: \"image\", mimeType: a.type, fileName: a.name, content: arrayBufferToBase64(buf) });\n          } else { otherAtts.push(a); }\n        } catch { otherAtts.push(a); }\n      } else {\n        otherAtts.push(a);\n      }\n    }\n    if (otherAtts.length > 0) {\n      textSuffix = `\\n\\nã€é™„ä»¶ã€‘\\n${otherAtts.map(a => `- ${a.name} (${a.type}, ${(a.size / 1024).toFixed(0)}KB): https://taxbot.cc:8443${a.url}`).join(\"\\n\")}`;\n    }\n  } catch { /* ignore parse errors */ }\n  return { imageAtts, textSuffix };\n}\n\n// â”€â”€â”€ Publish â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function openPublishDialog(agent: import(\"./types\").AgentEntry) {\n  if (!state.taxstoreConnected || !state.taxstoreToken) {\n    showToast(\"è¯·å…ˆåœ¨æŠ€èƒ½é¢æ¿ä¸­ç™»å½• TaxStore è´¦æˆ·\");\n    return;\n  }\n  state.rentalPublishAgent = agent;\n  const existingListing = state.rentalMyListings.find(l => l.agentId === agent.id);\n  const existingTags: string[] = existingListing?.tags ? (() => { try { return JSON.parse(existingListing.tags!); } catch { return []; } })() : [];\n  state.rentalPublishDraft = { price: existingListing?.price || 10, description: agent.description || \"\", tags: existingTags };\n  state.rentalPublishDialog = true;\n  scheduleRender();\n}\n\nexport function closePublishDialog() {\n  state.rentalPublishDialog = false;\n  state.rentalPublishAgent = null;\n  scheduleRender();\n}\n\nexport async function publishAgent() {\n  if (!state.taxstoreToken || !state.rentalPublishAgent) return;\n  const agent = state.rentalPublishAgent;\n  const draft = state.rentalPublishDraft;\n\n  if (draft.price < 1) {\n    showToast(\"ä»·æ ¼è‡³å°‘ä¸º 1 ç§¯åˆ†\");\n    return;\n  }\n  if (!draft.description.trim()) {\n    showToast(\"è¯·å¡«å†™å¸‚åœºæè¿°\");\n    return;\n  }\n\n  try {\n    const publishName = agent.isDefault\n      ? `Taxbot Agent by ${state.taxstoreUser?.name || \"Unknown\"}`\n      : agent.name;\n    const listing = await tsPublishAgent(state.taxstoreToken, {\n      name: publishName,\n      emoji: agent.emoji,\n      description: draft.description.trim(),\n      price: draft.price,\n      agentId: agent.id,\n      avatarUrl: agent.avatarUrl,\n      tags: draft.tags.length > 0 ? JSON.stringify(draft.tags) : undefined,\n    });\n    state.rentalMyListings.push(listing);\n    closePublishDialog();\n    showToast(`æ™ºèƒ½ä½“ã€Œ${agent.name}ã€å·²å‘å¸ƒåˆ°å¸‚åœº`);\n    addNotification(`æ™ºèƒ½ä½“ã€Œ${agent.name}ã€å·²ä¸Šæ¶`, \"ğŸª\");\n  } catch (err: any) {\n    showToast(err.message || \"å‘å¸ƒå¤±è´¥\");\n  }\n}\n\n// â”€â”€â”€ My Listings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function loadMyListings() {\n  if (!state.taxstoreToken) return;\n  try {\n    state.rentalMyListings = await tsGetMyAgents(state.taxstoreToken);\n    scheduleRender();\n  } catch {\n    // Non-critical\n  }\n}\n\nexport function getListingForAgent(agentId: string): AgentListing | undefined {\n  return state.rentalMyListings.find(l => l.agentId === agentId && l.status === \"active\");\n}\n\nexport async function unpublishAgent(listingId: string) {\n  if (!state.taxstoreToken) return;\n  try {\n    await tsUnpublishAgent(state.taxstoreToken, listingId);\n    state.rentalMyListings = state.rentalMyListings.filter(l => l.id !== listingId);\n    showToast(\"å·²ä¸‹æ¶\");\n    scheduleRender();\n  } catch (err: any) {\n    showToast(err.message || \"ä¸‹æ¶å¤±è´¥\");\n  }\n}\n\n// â”€â”€â”€ Task Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function pollPendingTasks() {\n  if (!state.taxstoreToken || !state.taxstoreConnected) return;\n  try {\n    const tasks = await tsGetPendingTasks(state.taxstoreToken);\n    const oldMap = new Map(state.rentalPendingTasks.map(t => [t.id, t]));\n    const newTasks = tasks.filter(t => !oldMap.has(t.id));\n\n    // Detect new messages on existing tasks\n    for (const t of tasks) {\n      const old = oldMap.get(t.id);\n      if (old && (t.unreadMessageCount || 0) > 0 && (old.unreadMessageCount || 0) === 0) {\n        addNotification(`${t.client.name} ç»™ä»»åŠ¡ã€Œ${t.title}ã€å‘äº†æ–°ç•™è¨€`, \"ğŸ’¬\", t.id, \"rental\");\n      }\n    }\n\n    state.rentalPendingTasks = tasks;\n\n    // Update active task if it's in the list (sync unread count)\n    if (state.rentalActiveTask) {\n      const updated = tasks.find(t => t.id === state.rentalActiveTask!.id);\n      if (updated) state.rentalActiveTask.unreadMessageCount = updated.unreadMessageCount;\n    }\n\n    for (const t of newTasks) {\n      if (t.status === \"revision_requested\") {\n        addNotification(`æ”¶åˆ°ä¿®è®¢è¯·æ±‚: ${t.title} (${t.listing.name})`, \"âœï¸\", t.id, \"rental\");\n      } else {\n        addNotification(`æ”¶åˆ°æ–°ä»»åŠ¡: ${t.title} (${t.listing.name})`, \"ğŸ“‹\", t.id, \"rental\");\n      }\n    }\n\n    scheduleRender();\n  } catch {\n    // Non-critical â€” silent fail\n  }\n\n  // Send heartbeat for all active listings\n  try {\n    const activeIds = state.rentalMyListings\n      .filter(l => l.status === \"active\")\n      .map(l => l.id);\n    if (activeIds.length > 0 && state.taxstoreToken) {\n      tsHeartbeat(state.taxstoreToken, activeIds);\n    }\n  } catch { /* silent */ }\n\n  // Auto-complete tasks that have been pending for > 2 hours\n  checkAutoCompleteTasks();\n}\n\nexport function startTaskPolling() {\n  if (state.rentalPollingTimer) return;\n  // Poll immediately then every 60s\n  pollPendingTasks();\n  state.rentalPollingTimer = setInterval(pollPendingTasks, 60_000);\n}\n\nexport function stopTaskPolling() {\n  if (state.rentalPollingTimer) {\n    clearInterval(state.rentalPollingTimer);\n    state.rentalPollingTimer = null;\n  }\n}\n\n// â”€â”€â”€ Client Task Polling (consult notifications) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function pollConsultTasks() {\n  if (!state.taxstoreToken || !state.taxstoreConnected) return;\n  try {\n    const tasks = await tsGetMyTasks(state.taxstoreToken);\n    const oldTaskMap = new Map(state.consultMyTasks.map(t => [t.id, t]));\n    const prevCount = state.consultMyTasks.length;\n\n    for (const t of tasks) {\n      const old = oldTaskMap.get(t.id);\n      if (old && old.status !== \"completed\" && t.status === \"completed\") {\n        addNotification(`ä½ çš„å’¨è¯¢å·²å®Œæˆ: ${t.title} (${t.listing?.name || \"æ™ºèƒ½ä½“\"})`, \"âœ…\", t.id, \"consult\");\n      }\n      // Notify on new messages\n      if (old && (t.unreadMessageCount || 0) > 0 && (old.unreadMessageCount || 0) === 0) {\n        addNotification(`${t.listing?.name || \"æ™ºèƒ½ä½“\"} ç»™ä½ å‘äº†æ–°ç•™è¨€`, \"ğŸ’¬\", t.id, \"consult\");\n      }\n    }\n\n    // Count unread: completed but not read, OR has unread messages\n    const unread = tasks.filter(t =>\n      (t.status === \"completed\" && !t.clientRead) || (t.unreadMessageCount || 0) > 0\n    ).length;\n\n    state.consultMyTasks = tasks;\n    state.consultUnreadCount = unread;\n    scheduleRender();\n  } catch {\n    // silent\n  }\n}\n\nexport function startConsultPolling() {\n  if (state.consultPollingTimer) return;\n  pollConsultTasks();\n  state.consultPollingTimer = setInterval(pollConsultTasks, 60_000);\n}\n\nexport function stopConsultPolling() {\n  if (state.consultPollingTimer) {\n    clearInterval(state.consultPollingTimer);\n    state.consultPollingTimer = null;\n  }\n}\n\n// â”€â”€â”€ Consult Panel Functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function loadConsultAgents() {\n  state.consultLoading = true;\n  scheduleRender();\n  try {\n    const data = await tsListAgents({\n      q: state.consultSearch || undefined,\n      sort: \"popular\",\n      limit: 50,\n    });\n    state.consultAgents = data.agents;\n  } catch (e: any) {\n    showToast(e.message || \"åŠ è½½æ™ºèƒ½ä½“å¤±è´¥\");\n  } finally {\n    state.consultLoading = false;\n    scheduleRender();\n  }\n  // Load platform stats (non-blocking)\n  loadConsultStats();\n}\n\nexport async function loadConsultStats() {\n  try {\n    const stats = await tsGetAgentStats();\n    if (stats.recentCount === 0) {\n      state.consultAvgTime = \"æš‚æ— æ•°æ®\";\n    } else {\n      const mins = stats.avgMinutes;\n      let timeStr: string;\n      if (mins < 1) timeStr = \"ä¸åˆ° 1 åˆ†é’Ÿ\";\n      else if (mins < 60) timeStr = `çº¦ ${mins} åˆ†é’Ÿ`;\n      else {\n        const h = Math.floor(mins / 60);\n        const m = mins % 60;\n        timeStr = m === 0 ? `çº¦ ${h} å°æ—¶` : `çº¦ ${h} å°æ—¶ ${m} åˆ†é’Ÿ`;\n      }\n      state.consultAvgTime = `${timeStr}ï¼ˆè¿‘ ${stats.recentCount} å•ï¼‰`;\n    }\n    scheduleRender();\n  } catch {\n    state.consultAvgTime = \"æš‚æ— æ•°æ®\";\n    scheduleRender();\n  }\n}\n\nexport function openConsultDetail(agent: AgentListing) {\n  state.consultSelectedAgent = agent;\n  state.consultView = \"detail\";\n  state.consultTaskTitle = \"\";\n  state.consultTaskContent = \"\";\n  state.consultAttachments = [];\n  scheduleRender();\n}\n\nexport function backToConsultList() {\n  state.consultView = \"list\";\n  state.consultSelectedAgent = null;\n  scheduleRender();\n}\n\nexport function openConsultMyTasks() {\n  state.consultView = \"my-tasks\";\n  pollConsultTasks();\n  scheduleRender();\n}\n\nexport function openConsultTaskDetail(task: AgentTask) {\n  state.consultSelectedTask = task;\n  state.consultView = \"task-detail\";\n  // Reset sub-panels\n  state.consultMessages = [];\n  state.consultMessageInput = \"\";\n  state.consultMessagesOpen = false;\n  state.consultMessagesSending = false;\n  state.consultRevisionOpen = false;\n  state.consultRevisionText = \"\";\n  state.consultRatingOpen = false;\n  state.consultRatingValue = 0;\n  state.consultRatingHover = 0;\n  state.consultRatingComment = \"\";\n  // Mark as read\n  if (state.taxstoreToken && task.status === \"completed\" && !task.clientRead) {\n    task.clientRead = true;\n    state.consultUnreadCount = Math.max(0, state.consultUnreadCount - 1);\n    tsMarkTaskRead(state.taxstoreToken, task.id);\n  }\n  scheduleRender();\n}\n\nexport function backFromConsultTaskDetail() {\n  state.consultSelectedTask = null;\n  state.consultView = \"my-tasks\";\n  scheduleRender();\n}\n\n// â”€â”€â”€ Consult Task Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function toggleConsultMessages() {\n  state.consultMessagesOpen = !state.consultMessagesOpen;\n  if (state.consultMessagesOpen && state.consultMessages.length === 0) {\n    await loadConsultMessages();\n  }\n  scheduleRender();\n}\n\nexport async function loadConsultMessages() {\n  if (!state.taxstoreToken || !state.consultSelectedTask) return;\n  try {\n    state.consultMessages = await tsGetTaskMessages(state.taxstoreToken, state.consultSelectedTask.id);\n    // Clear unread count for this task (GET already marks as read server-side)\n    if (state.consultSelectedTask.unreadMessageCount) {\n      state.consultSelectedTask.unreadMessageCount = 0;\n      const idx = state.consultMyTasks.findIndex(t => t.id === state.consultSelectedTask?.id);\n      if (idx >= 0) state.consultMyTasks[idx].unreadMessageCount = 0;\n      // Recompute total unread\n      state.consultUnreadCount = state.consultMyTasks.filter(t =>\n        (t.status === \"completed\" && !t.clientRead) || (t.unreadMessageCount || 0) > 0\n      ).length;\n    }\n  } catch {\n    // silent\n  }\n  scheduleRender();\n}\n\nexport async function sendConsultMessage() {\n  if (!state.taxstoreToken || !state.consultSelectedTask) return;\n  const content = state.consultMessageInput.trim();\n  if (!content) return;\n  state.consultMessagesSending = true;\n  scheduleRender();\n  try {\n    const msg = await tsSendTaskMessage(state.taxstoreToken, state.consultSelectedTask.id, content);\n    state.consultMessages.push(msg);\n    state.consultMessageInput = \"\";\n  } catch (e: any) {\n    showToast(e.message || \"å‘é€å¤±è´¥\");\n  } finally {\n    state.consultMessagesSending = false;\n    scheduleRender();\n  }\n}\n\n// â”€â”€â”€ Consult Task Revision â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function toggleConsultRevision() {\n  state.consultRevisionOpen = !state.consultRevisionOpen;\n  scheduleRender();\n}\n\nexport async function submitConsultRevision() {\n  if (!state.taxstoreToken || !state.consultSelectedTask) return;\n  const text = state.consultRevisionText.trim();\n  if (!text) { showToast(\"è¯·å¡«å†™ä¿®è®¢è¯´æ˜\"); return; }\n  state.consultRevisionSubmitting = true;\n  scheduleRender();\n  try {\n    const updated = await tsRequestRevision(state.taxstoreToken, state.consultSelectedTask.id, text);\n    state.consultSelectedTask.status = updated.status;\n    state.consultSelectedTask.revisionCount = updated.revisionCount;\n    state.consultSelectedTask.revisionRequest = updated.revisionRequest;\n    state.consultRevisionOpen = false;\n    state.consultRevisionText = \"\";\n    showToast(\"ä¿®è®¢è¯·æ±‚å·²å‘é€\");\n    // Also update in my-tasks list\n    const idx = state.consultMyTasks.findIndex(t => t.id === state.consultSelectedTask?.id);\n    if (idx >= 0) { state.consultMyTasks[idx].status = updated.status; }\n  } catch (e: any) {\n    showToast(e.message || \"è¯·æ±‚ä¿®è®¢å¤±è´¥\");\n  } finally {\n    state.consultRevisionSubmitting = false;\n    scheduleRender();\n  }\n}\n\n// â”€â”€â”€ Consult Task Rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport function toggleConsultRating() {\n  state.consultRatingOpen = !state.consultRatingOpen;\n  scheduleRender();\n}\n\nexport async function submitConsultRating() {\n  if (!state.taxstoreToken || !state.consultSelectedTask) return;\n  if (state.consultRatingValue < 1) { showToast(\"è¯·é€‰æ‹©è¯„åˆ†\"); return; }\n  state.consultRatingSubmitting = true;\n  scheduleRender();\n  try {\n    await tsRateTask(state.taxstoreToken, state.consultSelectedTask.id, {\n      rating: state.consultRatingValue,\n      comment: state.consultRatingComment.trim() || undefined,\n    });\n    state.consultSelectedTask.rating = state.consultRatingValue;\n    state.consultSelectedTask.ratingComment = state.consultRatingComment.trim() || undefined;\n    state.consultRatingOpen = false;\n    showToast(\"æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼\");\n    // Also update in my-tasks list\n    const idx = state.consultMyTasks.findIndex(t => t.id === state.consultSelectedTask?.id);\n    if (idx >= 0) { state.consultMyTasks[idx].rating = state.consultRatingValue; }\n  } catch (e: any) {\n    showToast(e.message || \"è¯„ä»·å¤±è´¥\");\n  } finally {\n    state.consultRatingSubmitting = false;\n    scheduleRender();\n  }\n}\n\nexport async function uploadConsultAttachment(file: File) {\n  if (!state.taxstoreToken) return;\n  if (file.size > 10 * 1024 * 1024) {\n    showToast(\"æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB\");\n    return;\n  }\n  state.consultUploading = true;\n  scheduleRender();\n  try {\n    const meta = await tsUploadTaskAttachment(state.taxstoreToken, file);\n    state.consultAttachments.push(meta);\n  } catch (e: any) {\n    showToast(e.message || \"ä¸Šä¼ å¤±è´¥\");\n  } finally {\n    state.consultUploading = false;\n    scheduleRender();\n  }\n}\n\nexport function removeConsultAttachment(index: number) {\n  state.consultAttachments.splice(index, 1);\n  scheduleRender();\n}\n\nexport async function submitConsultTask() {\n  if (!state.taxstoreToken || !state.consultSelectedAgent) return;\n  if (!state.consultTaskTitle.trim() || !state.consultTaskContent.trim()) {\n    showToast(\"è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹\");\n    return;\n  }\n  state.consultSubmitting = true;\n  scheduleRender();\n  try {\n    await tsCreateTask(state.taxstoreToken, state.consultSelectedAgent.id, {\n      title: state.consultTaskTitle.trim(),\n      content: state.consultTaskContent.trim(),\n      attachments: state.consultAttachments.length > 0 ? state.consultAttachments : undefined,\n    });\n    showToast(\"ä»»åŠ¡å·²æäº¤ï¼æ™ºèƒ½ä½“ä¸»äººä¼šå°½å¿«å¤„ç†\");\n    state.consultTaskTitle = \"\";\n    state.consultTaskContent = \"\";\n    state.consultAttachments = [];\n    state.consultView = \"my-tasks\";\n    state.consultSelectedAgent = null;\n    pollConsultTasks();\n  } catch (e: any) {\n    showToast(e.message || \"æäº¤å¤±è´¥\");\n  } finally {\n    state.consultSubmitting = false;\n    scheduleRender();\n  }\n}\n\n// â”€â”€â”€ Task Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nlet rentalPollController: AbortController | null = null;\n\nexport function openTaskPanel(task: AgentTask) {\n  state.rentalActiveTask = task;\n  state.rentalTaskResult = task.result || \"\";\n  state.rentalAgentProcessing = false;\n  state.rentalTaskPanel = true;\n  state.rentalTaskAttachments = [];\n  state.rentalTaskInstruction = \"\";\n  scheduleRender();\n}\n\nexport function closeTaskPanel() {\n  // Abort any ongoing agent polling\n  if (rentalPollController) {\n    rentalPollController.abort();\n    rentalPollController = null;\n  }\n  state.rentalTaskPanel = false;\n  state.rentalActiveTask = null;\n  state.rentalTaskResult = \"\";\n  state.rentalAgentProcessing = false;\n  state.rentalTaskAttachments = [];\n  state.rentalTaskInstruction = \"\";\n  scheduleRender();\n}\n\n/** Extract assistant text from chat.history result (same logic as chat.ts) */\nfunction extractRentalAssistantText(result: any): string {\n  if (!result?.messages || result.messages.length === 0) return \"\";\n  const msgs = result.messages as any[];\n  let lastUserIdx = -1;\n  for (let i = msgs.length - 1; i >= 0; i--) {\n    if (msgs[i].role === \"user\") { lastUserIdx = i; break; }\n  }\n  const startIdx = lastUserIdx >= 0 ? lastUserIdx + 1 : 0;\n  const texts: string[] = [];\n  for (let i = startIdx; i < msgs.length; i++) {\n    if (msgs[i].role === \"assistant\") {\n      const t = extractMessageText(msgs[i]);\n      if (t && !isSystemMessage(t)) texts.push(t);\n    }\n  }\n  return texts.join(\"\\n\\n\");\n}\n\n/** Send the task content to the local agent and poll for its response */\nexport async function processTaskWithAgent() {\n  if (!state.client || !state.rentalActiveTask) return;\n\n  const agentId = state.rentalActiveTask.listing.agentId;\n  const agent = agentId ? state.agentsList.find(a => a.id === agentId) : null;\n  if (!agent) {\n    showToast(\"æœªæ‰¾åˆ°å¯¹åº”çš„æœ¬åœ°æ™ºèƒ½ä½“\");\n    return;\n  }\n\n  state.rentalAgentProcessing = true;\n  state.rentalTaskResult = \"\";\n  scheduleRender();\n\n  // Use a dedicated session key for rental task processing\n  const sessionKey = `agent:${agent.id}:rental`;\n\n  // Build the message to send to the agent\n  const isRevision = state.rentalActiveTask.status === \"revision_requested\";\n  let agentMessage = isRevision\n    ? `è¯·æ ¹æ®å®¢æˆ·çš„ä¿®è®¢è¦æ±‚ä¿®æ”¹ä¹‹å‰çš„å›ç­”ï¼š\\n\\nã€ä»»åŠ¡æ ‡é¢˜ã€‘${state.rentalActiveTask.title}\\n\\nã€ä»»åŠ¡å†…å®¹ã€‘\\n${state.rentalActiveTask.content}\\n\\nã€ä¹‹å‰çš„å›ç­”ã€‘\\n${state.rentalActiveTask.result || \"\"}\\n\\nã€å®¢æˆ·ä¿®è®¢è¦æ±‚ã€‘\\n${state.rentalActiveTask.revisionRequest || \"\"}`\n    : `è¯·å¤„ç†ä»¥ä¸‹ç”¨æˆ·ä»»åŠ¡ï¼Œç›´æ¥ç»™å‡ºå®Œæ•´çš„å›ç­”ç»“æœï¼š\\n\\nã€ä»»åŠ¡æ ‡é¢˜ã€‘${state.rentalActiveTask.title}\\n\\nã€ä»»åŠ¡å†…å®¹ã€‘\\n${state.rentalActiveTask.content}`;\n\n  // Include attachment info if available â€” images are sent as base64 to the LLM\n  let imageAttachments: { type: string; mimeType: string; fileName: string; content: string }[] = [];\n  if (state.rentalActiveTask.attachments) {\n    const { imageAtts, textSuffix } = await fetchTaskAttachments(state.rentalActiveTask.attachments);\n    imageAttachments = imageAtts;\n    agentMessage += textSuffix;\n  }\n\n  // Include agent memory if available\n  const memory = await loadAgentMemory(agent.id);\n  if (memory) {\n    agentMessage = `ã€æ™ºèƒ½ä½“è®°å¿†ã€‘\\n${memory}\\n---\\n\\n${agentMessage}`;\n  }\n\n  // Send message to the agent\n  const idempotencyKey = generateUUID();\n  try {\n    const sendPayload: any = {\n      sessionKey,\n      message: agentMessage,\n      deliver: false,\n      idempotencyKey,\n    };\n    if (imageAttachments.length > 0) {\n      sendPayload.attachments = imageAttachments;\n    }\n    await state.client.request(\"chat.send\", sendPayload);\n  } catch (err) {\n    state.rentalAgentProcessing = false;\n    showToast(\"å‘é€ä»»åŠ¡ç»™æ™ºèƒ½ä½“å¤±è´¥ï¼š\" + String(err));\n    scheduleRender();\n    return;\n  }\n\n  // Poll for the response\n  rentalPollController?.abort();\n  const controller = new AbortController();\n  rentalPollController = controller;\n  const signal = controller.signal;\n\n  const POLL_INTERVAL = 1500;\n  const STALE_TIMEOUT = 10_000;\n  const MAX_TOTAL_TIME = 120_000;\n  const startTime = Date.now();\n  let lastChangeTime = Date.now();\n  let prevText = \"\";\n\n  const poll = () => {\n    if (signal.aborted || !state.rentalAgentProcessing) return;\n\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      state.rentalAgentProcessing = false;\n      if (prevText) {\n        state.rentalTaskResult = prevText;\n      } else {\n        showToast(\"æ™ºèƒ½ä½“å¤„ç†è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ç»“æœ\");\n      }\n      rentalPollController = null;\n      scheduleRender();\n      return;\n    }\n\n    state.client?.request(\"chat.history\", { sessionKey, limit: 20 })\n      .then((result: any) => {\n        if (signal.aborted || !state.rentalAgentProcessing) return;\n\n        const historyText = extractRentalAssistantText(result);\n\n        if (historyText && historyText !== prevText) {\n          lastChangeTime = Date.now();\n          prevText = historyText;\n          // Live-update the result area as the agent generates text\n          state.rentalTaskResult = historyText;\n          scheduleRender();\n        }\n\n        // If we have content and it's been stable for STALE_TIMEOUT, we're done\n        if (prevText.length > 0 && Date.now() - lastChangeTime > STALE_TIMEOUT) {\n          state.rentalAgentProcessing = false;\n          state.rentalTaskResult = prevText;\n          rentalPollController = null;\n          scheduleRender();\n          return;\n        }\n\n        setTimeout(poll, POLL_INTERVAL);\n      })\n      .catch(() => {\n        if (signal.aborted) return;\n        if (Date.now() - startTime < MAX_TOTAL_TIME) {\n          setTimeout(poll, POLL_INTERVAL);\n        } else {\n          state.rentalAgentProcessing = false;\n          if (!prevText) showToast(\"è·å–æ™ºèƒ½ä½“å›å¤å¤±è´¥\");\n          rentalPollController = null;\n          scheduleRender();\n        }\n      });\n  };\n\n  // Start polling after a short delay\n  setTimeout(poll, 800);\n}\n\n/** Send an instruction to the agent to revise/modify the current task result */\nexport async function reviseTaskWithInstruction() {\n  if (!state.client || !state.rentalActiveTask) return;\n\n  const instruction = state.rentalTaskInstruction.trim();\n  if (!instruction) {\n    showToast(\"è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤\");\n    return;\n  }\n\n  const currentResult = state.rentalTaskResult.trim();\n  if (!currentResult) {\n    showToast(\"è¯·å…ˆè®©æ™ºèƒ½ä½“ç”Ÿæˆå›ç­”ï¼Œå†è¿›è¡Œä¿®æ”¹\");\n    return;\n  }\n\n  const agentId = state.rentalActiveTask.listing.agentId;\n  const agent = agentId ? state.agentsList.find(a => a.id === agentId) : null;\n  if (!agent) {\n    showToast(\"æœªæ‰¾åˆ°å¯¹åº”çš„æœ¬åœ°æ™ºèƒ½ä½“\");\n    return;\n  }\n\n  state.rentalAgentProcessing = true;\n  state.rentalTaskInstruction = \"\";\n  scheduleRender();\n\n  const sessionKey = `agent:${agent.id}:rental`;\n\n  const reviseMessage = `ä»¥ä¸‹æ˜¯ä½ ä¹‹å‰å¯¹ç”¨æˆ·ä»»åŠ¡çš„å›ç­”ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„ä¿®æ”¹æŒ‡ä»¤è¿›è¡Œä¿®æ”¹ï¼Œç›´æ¥ç»™å‡ºä¿®æ”¹åçš„å®Œæ•´å›ç­”ï¼š\\n\\nã€åŸå§‹ä»»åŠ¡ã€‘${state.rentalActiveTask.title}\\n\\nã€ä½ ä¹‹å‰çš„å›ç­”ã€‘\\n${currentResult}\\n\\nã€ç”¨æˆ·ä¿®æ”¹æŒ‡ä»¤ã€‘\\n${instruction}`;\n\n  const idempotencyKey = generateUUID();\n  try {\n    await state.client.request(\"chat.send\", {\n      sessionKey,\n      message: reviseMessage,\n      deliver: false,\n      idempotencyKey,\n    });\n  } catch (err) {\n    state.rentalAgentProcessing = false;\n    showToast(\"å‘é€ä¿®æ”¹æŒ‡ä»¤å¤±è´¥ï¼š\" + String(err));\n    scheduleRender();\n    return;\n  }\n\n  // Poll for revised response (reuse same polling logic)\n  rentalPollController?.abort();\n  const controller = new AbortController();\n  rentalPollController = controller;\n  const signal = controller.signal;\n\n  const POLL_INTERVAL = 1500;\n  const STALE_TIMEOUT = 10_000;\n  const MAX_TOTAL_TIME = 120_000;\n  const startTime = Date.now();\n  let lastChangeTime = Date.now();\n  let prevText = \"\";\n\n  const poll = () => {\n    if (signal.aborted || !state.rentalAgentProcessing) return;\n\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      state.rentalAgentProcessing = false;\n      if (prevText) {\n        state.rentalTaskResult = prevText;\n      } else {\n        showToast(\"æ™ºèƒ½ä½“ä¿®æ”¹è¶…æ—¶\");\n      }\n      rentalPollController = null;\n      scheduleRender();\n      return;\n    }\n\n    state.client?.request(\"chat.history\", { sessionKey, limit: 20 })\n      .then((result: any) => {\n        if (signal.aborted || !state.rentalAgentProcessing) return;\n\n        const historyText = extractRentalAssistantText(result);\n\n        if (historyText && historyText !== prevText) {\n          lastChangeTime = Date.now();\n          prevText = historyText;\n          state.rentalTaskResult = historyText;\n          scheduleRender();\n        }\n\n        if (prevText.length > 0 && Date.now() - lastChangeTime > STALE_TIMEOUT) {\n          state.rentalAgentProcessing = false;\n          state.rentalTaskResult = prevText;\n          rentalPollController = null;\n          scheduleRender();\n          return;\n        }\n\n        setTimeout(poll, POLL_INTERVAL);\n      })\n      .catch(() => {\n        if (signal.aborted) return;\n        if (Date.now() - startTime < MAX_TOTAL_TIME) {\n          setTimeout(poll, POLL_INTERVAL);\n        } else {\n          state.rentalAgentProcessing = false;\n          if (!prevText) showToast(\"è·å–ä¿®æ”¹ç»“æœå¤±è´¥\");\n          rentalPollController = null;\n          scheduleRender();\n        }\n      });\n  };\n\n  setTimeout(poll, 800);\n}\n\nexport async function submitTaskResult() {\n  if (!state.taxstoreToken || !state.rentalActiveTask) return;\n\n  const result = state.rentalTaskResult.trim();\n  if (!result) {\n    showToast(\"è¯·å¡«å†™ä»»åŠ¡ç»“æœ\");\n    return;\n  }\n\n  try {\n    const task = state.rentalActiveTask;\n\n    // Upload attachments first\n    let resultAttachments: TaskAttachmentMeta[] | undefined;\n    if (state.rentalTaskAttachments.length > 0) {\n      resultAttachments = [];\n      for (const file of state.rentalTaskAttachments) {\n        const meta = await tsUploadTaskAttachment(state.taxstoreToken, file);\n        resultAttachments.push(meta);\n      }\n    }\n\n    await tsCompleteTask(state.taxstoreToken, task.id, result, resultAttachments);\n    // Remove from pending list\n    state.rentalPendingTasks = state.rentalPendingTasks.filter(t => t.id !== task.id);\n    showToast(\"ä»»åŠ¡ç»“æœå·²æäº¤ï¼Œç§¯åˆ†å·²åˆ°è´¦\");\n    addNotification(`ä»»åŠ¡ã€Œ${task.title}ã€å·²å®Œæˆ`, \"âœ…\");\n\n    // Save task info and result to agent memory\n    const agentId = task.listing.agentId;\n    if (agentId) {\n      const memoryEntry = `ã€å‡ºç§Ÿä»»åŠ¡å®Œæˆã€‘å®¢æˆ·: ${task.client.name}\\nä»»åŠ¡: ${task.title}\\nå†…å®¹: ${task.content}\\nå›ç­”: ${result}`;\n      appendAgentMemory(agentId, memoryEntry);\n    }\n\n    closeTaskPanel();\n    // Refresh completed tasks list\n    loadCompletedTasks();\n  } catch (err: any) {\n    showToast(err.message || \"æäº¤å¤±è´¥\");\n  }\n}\n\n// â”€â”€â”€ Auto-complete overdue tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nconst AUTO_COMPLETE_THRESHOLD = 2 * 60 * 60 * 1000; // 2 hours\nconst autoCompletingTasks = new Set<string>(); // prevent double-processing\n\nasync function autoCompleteTask(task: AgentTask) {\n  if (!state.client || !state.taxstoreToken) return;\n  if (autoCompletingTasks.has(task.id)) return;\n\n  const agentId = task.listing.agentId;\n  const agent = agentId ? state.agentsList.find(a => a.id === agentId) : null;\n  if (!agent) return;\n\n  autoCompletingTasks.add(task.id);\n  addNotification(`ä»»åŠ¡ã€Œ${task.title}ã€è¶…æ—¶æœªå¤„ç†ï¼Œæ™ºèƒ½ä½“è‡ªåŠ¨å¤„ç†ä¸­...`, \"â°\", task.id, \"rental\");\n\n  const sessionKey = `agent:${agent.id}:auto:${task.id}`;\n\n  // Build message\n  let agentMessage = `è¯·å¤„ç†ä»¥ä¸‹ç”¨æˆ·ä»»åŠ¡ï¼Œç›´æ¥ç»™å‡ºå®Œæ•´çš„å›ç­”ç»“æœï¼š\\n\\nã€ä»»åŠ¡æ ‡é¢˜ã€‘${task.title}\\n\\nã€ä»»åŠ¡å†…å®¹ã€‘\\n${task.content}`;\n\n  let autoImageAtts: { type: string; mimeType: string; fileName: string; content: string }[] = [];\n  if (task.attachments) {\n    const { imageAtts, textSuffix } = await fetchTaskAttachments(task.attachments);\n    autoImageAtts = imageAtts;\n    agentMessage += textSuffix;\n  }\n\n  const memory = await loadAgentMemory(agent.id);\n  if (memory) {\n    agentMessage = `ã€æ™ºèƒ½ä½“è®°å¿†ã€‘\\n${memory}\\n---\\n\\n${agentMessage}`;\n  }\n\n  try {\n    const autoPayload: any = {\n      sessionKey,\n      message: agentMessage,\n      deliver: false,\n      idempotencyKey: generateUUID(),\n    };\n    if (autoImageAtts.length > 0) {\n      autoPayload.attachments = autoImageAtts;\n    }\n    await state.client.request(\"chat.send\", autoPayload);\n  } catch {\n    autoCompletingTasks.delete(task.id);\n    return;\n  }\n\n  // Poll for response\n  const POLL_INTERVAL = 2000;\n  const STALE_TIMEOUT = 12_000;\n  const MAX_TOTAL_TIME = 180_000; // 3 minutes max for auto\n  const startTime = Date.now();\n  let lastChangeTime = Date.now();\n  let prevText = \"\";\n\n  const poll = async () => {\n    if (!state.taxstoreToken) { autoCompletingTasks.delete(task.id); return; }\n\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      // Timeout â€” submit whatever we have or a default message\n      const finalText = prevText || \"éå¸¸æŠ±æ­‰ï¼Œæ™ºèƒ½ä½“å¤„ç†è¶…æ—¶ã€‚è¯·æ‚¨é‡æ–°æäº¤ä»»åŠ¡æˆ–è”ç³»æ™ºèƒ½ä½“ä¸»äººã€‚\";\n      try {\n        await tsCompleteTask(state.taxstoreToken!, task.id, finalText);\n        state.rentalPendingTasks = state.rentalPendingTasks.filter(t => t.id !== task.id);\n        addNotification(`ä»»åŠ¡ã€Œ${task.title}ã€å·²è‡ªåŠ¨å®Œæˆ`, \"âœ…\");\n        if (agentId) {\n          appendAgentMemory(agentId, `ã€è‡ªåŠ¨å®Œæˆä»»åŠ¡ã€‘å®¢æˆ·: ${task.client.name}\\nä»»åŠ¡: ${task.title}\\nå›ç­”: ${finalText}`);\n        }\n        loadCompletedTasks();\n        scheduleRender();\n      } catch { /* silent */ }\n      autoCompletingTasks.delete(task.id);\n      return;\n    }\n\n    try {\n      const result: any = await state.client?.request(\"chat.history\", { sessionKey, limit: 20 });\n      const historyText = extractRentalAssistantText(result);\n\n      if (historyText && historyText !== prevText) {\n        lastChangeTime = Date.now();\n        prevText = historyText;\n      }\n\n      // Stable result â€” submit\n      if (prevText.length > 0 && Date.now() - lastChangeTime > STALE_TIMEOUT) {\n        await tsCompleteTask(state.taxstoreToken!, task.id, prevText);\n        state.rentalPendingTasks = state.rentalPendingTasks.filter(t => t.id !== task.id);\n        addNotification(`ä»»åŠ¡ã€Œ${task.title}ã€å·²è‡ªåŠ¨å®Œæˆ`, \"âœ…\");\n        if (agentId) {\n          appendAgentMemory(agentId, `ã€è‡ªåŠ¨å®Œæˆä»»åŠ¡ã€‘å®¢æˆ·: ${task.client.name}\\nä»»åŠ¡: ${task.title}\\nå›ç­”: ${prevText}`);\n        }\n        loadCompletedTasks();\n        scheduleRender();\n        autoCompletingTasks.delete(task.id);\n        return;\n      }\n\n      setTimeout(poll, POLL_INTERVAL);\n    } catch {\n      if (Date.now() - startTime < MAX_TOTAL_TIME) {\n        setTimeout(poll, POLL_INTERVAL);\n      } else {\n        autoCompletingTasks.delete(task.id);\n      }\n    }\n  };\n\n  setTimeout(poll, 1000);\n}\n\nasync function checkAutoCompleteTasks() {\n  if (!state.taxstoreToken || !state.client) return;\n  const now = Date.now();\n  for (const task of state.rentalPendingTasks) {\n    if (autoCompletingTasks.has(task.id)) continue;\n    // Skip if task is currently being manually processed\n    if (state.rentalActiveTask?.id === task.id) continue;\n    const age = now - new Date(task.createdAt).getTime();\n    if (age > AUTO_COMPLETE_THRESHOLD) {\n      autoCompleteTask(task); // fire and forget â€” runs in background\n    }\n  }\n}\n\n// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n// â”€â”€â”€ Completed Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function loadCompletedTasks() {\n  if (!state.taxstoreToken) return;\n  try {\n    state.rentalCompletedTasks = await tsGetPendingTasks(state.taxstoreToken, \"completed\");\n    scheduleRender();\n  } catch {\n    // Non-critical\n  }\n}\n\nexport function getCompletedTasksForListing(listingId: string): import(\"./taxstore-api\").AgentTask[] {\n  return state.rentalCompletedTasks.filter(t => t.listing.id === listingId);\n}\n\n// â”€â”€â”€ Task Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nexport async function loadTaskMessages(taskId: string) {\n  if (!state.taxstoreToken) return;\n  try {\n    state.rentalMessages = await tsGetTaskMessages(state.taxstoreToken, taskId);\n    // Clear unread count for this task (GET marks messages read server-side)\n    const task = state.rentalPendingTasks.find(t => t.id === taskId);\n    if (task && task.unreadMessageCount) task.unreadMessageCount = 0;\n    if (state.rentalActiveTask?.id === taskId && state.rentalActiveTask.unreadMessageCount) {\n      state.rentalActiveTask.unreadMessageCount = 0;\n    }\n    scheduleRender();\n  } catch { /* ignore */ }\n}\n\nexport async function sendTaskMessage() {\n  if (!state.taxstoreToken || !state.rentalActiveTask || !state.rentalMessageInput.trim()) return;\n  try {\n    const msg = await tsSendTaskMessage(state.taxstoreToken, state.rentalActiveTask.id, state.rentalMessageInput.trim());\n    state.rentalMessages = [...state.rentalMessages, msg];\n    state.rentalMessageInput = \"\";\n  } catch (err: any) {\n    showToast(err.message || \"å‘é€å¤±è´¥\");\n  }\n  scheduleRender();\n}\n\nexport function toggleMessages() {\n  state.rentalMessagesOpen = !state.rentalMessagesOpen;\n  if (state.rentalMessagesOpen && state.rentalActiveTask) {\n    loadTaskMessages(state.rentalActiveTask.id);\n  }\n  scheduleRender();\n}\n\n/** Called after TaxStore login succeeds or on startup if already logged in */\nexport async function initRental() {\n  if (!state.taxstoreToken || !state.taxstoreConnected) return;\n  await loadMyListings();\n  loadCompletedTasks();\n  startTaskPolling();\n  startConsultPolling();\n}\n","/**\r\n * TaxChat Entry Point â€” UI Rendering & Initialization\r\n */\r\n\r\nimport \"./taxchat/styles/index.css\";\r\nimport { TAXBOT_VERSION } from \"./taxchat/version\";\r\nimport { html, render } from \"lit\";\r\nimport { unsafeHTML } from \"lit/directives/unsafe-html.js\";\r\nimport { live } from \"lit/directives/live.js\";\r\nimport { toSanitizedMarkdownHtml } from \"./src/ui/markdown\";\r\n\r\nimport type { AssistantMessage } from \"./taxchat/types\";\r\nimport { BUILTIN_SKILLS, AGENT_TEMPLATES } from \"./taxchat/constants\";\r\nimport {\r\n  state, isAnySending, scheduleRender, setRenderer,\r\n  _forceScrollBottom, setForceScrollBottom,\r\n} from \"./taxchat/state\";\r\nimport { initPersistence, saveNotifications, loadFavoritesForConversation, loadMessagesForConversation, saveFavoritesForConversation } from \"./taxchat/persistence\";\r\nimport {\r\n  createConversation, switchConversation, deleteConversation,\r\n  renameConversation, initConversations,\r\n} from \"./taxchat/conversations\";\r\nimport { connectGateway, cancelReconnect } from \"./taxchat/gateway-connect\";\r\nimport {\r\n  handleSend, handleFiles, abortRun,\r\n  doClearAll, doClearSession, doExitApp,\r\n} from \"./taxchat/chat\";\r\nimport {\r\n  loadAgents, createAgent, createAgentFromTemplate, deleteAgent,\r\n  openAgentEditor, updateAgent, loadAgentMemory, saveAgentMemory,\r\n  appendAgentMemory, insertAgentMention, getMentionCandidates,\r\n} from \"./taxchat/agents\";\r\nimport {\r\n  handleQuickSkill as _handleQuickSkill,\r\n  openSkillEditor, saveSkillFromEditor, deleteCustomSkill,\r\n  exportSkillAsZip, handleInstallSkillPackage, toggleSkillPin,\r\n  handleCustomSkillClick, clearActiveCustomSkill,\r\n  syncManagedSkills,\r\n} from \"./taxchat/skills\";\r\nimport {\r\n  loadFolderKnowledge, loadKnowledgeFiles, handleKnowledgeDrop,\r\n  addKnowledgeRef, removeKnowledgeRef, deleteKnowledgeFileAction,\r\n  handleAuthorizeFolder, handleRefreshFolder,\r\n  saveMessageToKnowledge,\r\n  startWatcher, registerWatcherListener, registerManagedSkillsListener,\r\n  knowledgeDragCounter, setKnowledgeDragCounter,\r\n} from \"./taxchat/knowledge\";\r\nimport {\r\n  loadModelConfig, saveModelConfig,\r\n  getProviderNames, getModelsForProvider,\r\n  selectProvider, selectModel,\r\n} from \"./taxchat/settings\";\r\nimport {\r\n  formatTime, formatFileSize, sortedFiles, sortedSkills,\r\n  copyMessageText, scrollToMessage, saveMessageAsWord,\r\n  showToast, dismissQuickStart, toggleFavorite,\r\n  autoLinkText, sanitizeDisplayText,\r\n  removeAttachment,\r\n} from \"./taxchat/utils\";\r\nimport {\r\n  registerCommands, getFilteredCommands, checkCommandTrigger,\r\n  closeCommandPalette, commandNavigate, commandExecuteSelected,\r\n} from \"./taxchat/commands\";\r\nimport { exportAsMarkdown, exportAsHTML } from \"./taxchat/export\";\r\nimport {\r\n  openSearch, closeSearch, performSearch,\r\n  nextResult, prevResult, isSearchHit, isSearchFocused,\r\n} from \"./taxchat/search\";\r\nimport {\r\n  calculateVirtualRange, measureRenderedHeights,\r\n  checkAtBottom, autoScrollToBottom, forceScrollToBottom,\r\n  clearHeightCache,\r\n} from \"./taxchat/virtual-scroll\";\r\nimport {\r\n  initTaxStore, loginTaxStore, logoutTaxStore,\r\n  fetchSkills, searchSkills, filterByCategory, changeSortOrder,\r\n  installFromTaxStore, syncInstalled,\r\n  isInstalledLocally, avgRating,\r\n} from \"./taxchat/taxstore\";\r\nimport {\r\n  openPublishDialog, closePublishDialog, publishAgent,\r\n  getListingForAgent, unpublishAgent,\r\n  openTaskPanel, closeTaskPanel, submitTaskResult,\r\n  processTaskWithAgent, reviseTaskWithInstruction, initRental, getCompletedTasksForListing,\r\n  toggleMessages, sendTaskMessage,\r\n  loadConsultAgents, openConsultDetail, backToConsultList,\r\n  openConsultMyTasks, openConsultTaskDetail, backFromConsultTaskDetail,\r\n  submitConsultTask, uploadConsultAttachment, removeConsultAttachment,\r\n  toggleConsultMessages, sendConsultMessage, loadConsultMessages,\r\n  toggleConsultRevision, submitConsultRevision,\r\n  toggleConsultRating, submitConsultRating,\r\n  loadMyListings, pollPendingTasks, loadCompletedTasks, pollConsultTasks,\r\n} from \"./taxchat/rental\";\r\nimport { tsGetMe } from \"./taxchat/taxstore-api\";\r\n\r\n// â”€â”€â”€ Avatar URL Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n/** Resolve agent avatar URL â€” handles data URLs, relative paths, and full URLs */\r\nfunction agentAvatarSrc(url: string | null | undefined): string | null {\r\n  if (!url || url.length < 2) return null;\r\n  if (url.startsWith(\"data:\")) return url;\r\n  if (url.startsWith(\"http\")) return url;\r\n  return `https://taxbot.cc:8443${url}`;\r\n}\r\n\r\n/** Resolve attachment URL */\r\nfunction attUrl(url: string): string {\r\n  if (url.startsWith(\"http\")) return url;\r\n  return `https://taxbot.cc:8443${url}`;\r\n}\r\n\r\n/** Parse attachment JSON */\r\nfunction parseAtts(json: string | null | undefined): Array<{ name: string; url: string; type: string; size: number }> {\r\n  if (!json) return [];\r\n  try { return JSON.parse(json); } catch { return []; }\r\n}\r\n\r\n/** Format file size */\r\nfunction fmtSize(bytes: number): string {\r\n  if (bytes < 1024) return `${bytes}B`;\r\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(0)}KB`;\r\n  return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;\r\n}\r\n\r\n// â”€â”€â”€ Global Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nasync function refreshAll() {\r\n  if (state.refreshing) return;\r\n  state.refreshing = true;\r\n  scheduleRender();\r\n\r\n  const tasks: Promise<unknown>[] = [];\r\n\r\n  // Gateway + Agents\r\n  if (!state.connected) {\r\n    tasks.push(connectGateway().catch(() => {}));\r\n  }\r\n  tasks.push(loadAgents().catch(() => {}));\r\n\r\n  // TaxStore data (only if logged in)\r\n  if (state.taxstoreToken && state.taxstoreConnected) {\r\n    tasks.push(tsGetMe(state.taxstoreToken).then(u => { if (u) state.taxstoreUser = u; }).catch(() => {}));\r\n    tasks.push(loadMyListings().catch(() => {}));\r\n    tasks.push(pollPendingTasks().catch(() => {}));\r\n    tasks.push(loadCompletedTasks().catch(() => {}));\r\n    tasks.push(pollConsultTasks().catch(() => {}));\r\n    tasks.push(loadConsultAgents().catch(() => {}));\r\n  }\r\n\r\n  // Knowledge files\r\n  if (state.authorizedFolder) {\r\n    tasks.push(loadKnowledgeFiles().catch(() => {}));\r\n  }\r\n\r\n  await Promise.allSettled(tasks);\r\n\r\n  state.refreshing = false;\r\n  state.lastRefreshTime = Date.now();\r\n  showToast(\"æ•°æ®å·²åˆ·æ–°\");\r\n  scheduleRender();\r\n}\r\n\r\n// â”€â”€â”€ Quick Skill Wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nfunction handleQuickSkill(skillName: string, prompt: string, displayLabel: string, noFilePicker?: boolean) {\r\n  _handleQuickSkill(skillName, prompt, displayLabel, noFilePicker, handleSend, handleFiles);\r\n}\r\n\r\n// â”€â”€â”€ Render Functions (extracted from original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfunction renderQuickStart() {\r\n  return html`\r\n    <div class=\"quickstart-overlay\" @click=${dismissQuickStart}>\r\n      <div class=\"quickstart-container\" @click=${(e: Event) => e.stopPropagation()}>\r\n\r\n        <div class=\"qs-topbar\">\r\n          <button class=\"qs-back-btn\" @click=${dismissQuickStart}>\r\n            <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"15 18 9 12 15 6\"/></svg>\r\n            è¿”å›\r\n          </button>\r\n          <span class=\"qs-topbar-title\">ä½¿ç”¨æŒ‡å—</span>\r\n          <span style=\"width:60px;\"></span>\r\n        </div>\r\n\r\n        <!-- Hero -->\r\n        <div class=\"qs-hero\">\r\n          <img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" style=\"width:72px;height:72px;\" />\r\n          <h1>æ¬¢è¿ä½¿ç”¨Taxbot</h1>\r\n          <p>æ‚¨çš„ AI ç¨åŠ¡åŠ©æ‰‹ï¼Œå¸®åŠ©æ‚¨åˆ†æç¨åŠ¡é£é™©ã€å®¡æ ¸ç¥¨æ®åˆåŒã€æ•´ç†æŠ¥é”€å•ã€ç®¡ç†çŸ¥è¯†åº“ã€‚</p>\r\n        </div>\r\n\r\n        <!-- Section 1: Layout Overview -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">1</span> ç•Œé¢å¸ƒå±€</div>\r\n          <div class=\"qs-section-desc\">åº”ç”¨é‡‡ç”¨å·¦ä¾§åŠŸèƒ½èœå• + å³ä¾§èŠå¤©çš„å¸ƒå±€ã€‚ç‚¹å‡»å·¦ä¾§å›¾æ ‡å¯å±•å¼€çŸ¥è¯†åº“ã€æŠ€èƒ½ã€æ”¶è—ç­‰é¢æ¿ï¼ŒèŠå¤©å§‹ç»ˆå¯è§ã€‚</div>\r\n          <div class=\"qs-sidebar-mock\">\r\n            <div class=\"qs-sidebar-nav\">\r\n              <div class=\"qs-sidebar-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg></div>\r\n              <div class=\"qs-sidebar-icon active\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><circle cx=\"12\" cy=\"12\" r=\"3\"/><path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\"/></svg></div>\r\n              <div class=\"qs-sidebar-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\"/></svg></div>\r\n            </div>\r\n            <div class=\"qs-sidebar-panel\">\r\n              <div class=\"qs-sidebar-panel-title\">æŠ€èƒ½ç®¡ç†</div>\r\n              <div class=\"qs-skill-row\">\r\n                <span class=\"qs-skill-emoji\">ğŸ§¾</span>\r\n                <div class=\"qs-skill-info\"><div class=\"qs-skill-name\">ç¨åŠ¡é£é™©æ²»ç†</div><div class=\"qs-skill-desc\">é£é™©è¯†åˆ«ä¸è¯´æ˜å‡½ç”Ÿæˆ</div></div>\r\n              </div>\r\n              <div class=\"qs-skill-row\">\r\n                <span class=\"qs-skill-emoji\">ğŸ“Š</span>\r\n                <div class=\"qs-skill-info\"><div class=\"qs-skill-name\">ç”³æŠ¥è¡¨é¢„å®¡</div><div class=\"qs-skill-desc\">ç”³æŠ¥è¡¨ä¸è´¢åŠ¡æŠ¥è¡¨æ¯”å¯¹</div></div>\r\n              </div>\r\n              <div class=\"qs-skill-row\">\r\n                <span class=\"qs-skill-emoji\">ğŸ“</span>\r\n                <div class=\"qs-skill-info\"><div class=\"qs-skill-name\">åˆåŒåŠç¥¨æ®ç¨å®¡</div><div class=\"qs-skill-desc\">ä»ç¨åŠ¡è§’åº¦å®¡æ ¸åˆåŒ</div></div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Section 2: Chat -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">2</span> æ™ºèƒ½å¯¹è¯</div>\r\n          <div class=\"qs-section-desc\">åœ¨åº•éƒ¨è¾“å…¥æ¡†è¾“å…¥ç¨åŠ¡é—®é¢˜ï¼ŒAI å®æ—¶è§£ç­”ã€‚æ”¯æŒå¤šè½®å¯¹è¯ï¼Œä¸Šä¸‹æ–‡è‡ªåŠ¨å…³è”ã€‚</div>\r\n          <div class=\"qs-mockup\">\r\n            <div class=\"qs-mockup-bar\">\r\n              <span class=\"qs-dot qs-dot-r\"></span>\r\n              <span class=\"qs-dot qs-dot-y\"></span>\r\n              <span class=\"qs-dot qs-dot-g\"></span>\r\n              <span style=\"margin-left:8px;\">å¯¹è¯ç•Œé¢</span>\r\n            </div>\r\n            <div class=\"qs-mockup-body\">\r\n              <div class=\"qs-chat-row user\"><div class=\"qs-chat-bubble qs-chat-user\">æ”¶åˆ°ä¸€å¼ 6%å’¨è¯¢è´¹å‘ç¥¨ï¼Œå¯ä»¥æŠµæ‰£å—ï¼Ÿ</div></div>\r\n              <div class=\"qs-chat-row\"><div class=\"qs-chat-bubble qs-chat-ai\">å’¨è¯¢è´¹å±äº<b>ç°ä»£æœåŠ¡ä¸š</b>ï¼Œä¸€èˆ¬çº³ç¨äººå–å¾—6%ç¨ç‡ä¸“ç”¨å‘ç¥¨å¯è¿›è¡Œ<b>è¿›é¡¹ç¨é¢æŠµæ‰£</b>ã€‚éœ€æ³¨æ„ï¼š<br/>1. ç¡®ä¿ä¸ºå¢å€¼ç¨ä¸“ç”¨å‘ç¥¨<br/>2. ä¸šåŠ¡çœŸå®æ€§éœ€æœ‰åˆåŒæ”¯æ’‘<br/>3. éœ€åœ¨è§„å®šæœŸé™å†…è®¤è¯</div></div>\r\n              <div class=\"qs-chat-row user\"><div class=\"qs-chat-bubble qs-chat-user\">å°è§„æ¨¡çº³ç¨äººå‘¢ï¼Ÿ</div></div>\r\n              <div class=\"qs-chat-row\"><div class=\"qs-chat-bubble qs-chat-ai\">å°è§„æ¨¡çº³ç¨äººé‡‡ç”¨<b>ç®€æ˜“è®¡ç¨</b>ï¼Œä¸å­˜åœ¨è¿›é¡¹æŠµæ‰£ï¼Œå‘ç¥¨ç›´æ¥è®¡å…¥æˆæœ¬è´¹ç”¨ã€‚</div></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Section 3: Quick Skills -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">3</span> å¿«æ·æŠ€èƒ½æ </div>\r\n          <div class=\"qs-section-desc\">èŠå¤©è¾“å…¥æ¡†ä¸Šæ–¹ä¸ºå¿«æ·æŠ€èƒ½æ ï¼Œç‚¹å‡»å³å¯å¯ç”¨ä¸“ä¸šç¨åŠ¡æŠ€èƒ½ï¼Œä¸Šä¼ æ–‡ä»¶åè‡ªåŠ¨åˆ†æã€‚</div>\r\n          <div class=\"qs-mockup\">\r\n            <div class=\"qs-mockup-bar\">\r\n              <span class=\"qs-dot qs-dot-r\"></span>\r\n              <span class=\"qs-dot qs-dot-y\"></span>\r\n              <span class=\"qs-dot qs-dot-g\"></span>\r\n              <span style=\"margin-left:8px;\">å¿«æ·æŠ€èƒ½</span>\r\n            </div>\r\n            <div class=\"qs-btn-row\">\r\n              <div class=\"qs-btn-pill\">ğŸ§¾ ç¨åŠ¡é£é™©æ²»ç†</div>\r\n              <div class=\"qs-btn-pill\">ğŸ“Š ç”³æŠ¥è¡¨é¢„å®¡</div>\r\n              <div class=\"qs-btn-pill\">ğŸ“ åˆåŒåŠç¥¨æ®ç¨å®¡</div>\r\n              <div class=\"qs-btn-pill\">ğŸ” å‘ç¥¨æŸ¥éªŒ</div>\r\n              <div class=\"qs-btn-pill\">ğŸ§¾ ç¥¨æ®æ•´ç†</div>\r\n              <div class=\"qs-btn-pill\">ğŸ“š çŸ¥è¯†åº“</div>\r\n              <div class=\"qs-btn-pill\">ğŸ“ ä¸Šä¼ æ–‡ä»¶</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Section 4: Knowledge -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">4</span> çŸ¥è¯†åº“ç®¡ç†</div>\r\n          <div class=\"qs-section-desc\">ç‚¹å‡»å·¦ä¾§ <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"vertical-align:-2px;\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg> å›¾æ ‡æ‰“å¼€çŸ¥è¯†åº“é¢æ¿ã€‚æˆæƒæ–‡ä»¶å¤¹åï¼ŒAI è‡ªåŠ¨å­¦ä¹ å…¶ä¸­æ–‡ä»¶ï¼Œç‚¹å‡»\"å¼•ç”¨\"å¯å°†æŒ‡å®šæ–‡ä»¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ã€‚</div>\r\n          <div class=\"qs-mockup\">\r\n            <div class=\"qs-mockup-bar\">\r\n              <span class=\"qs-dot qs-dot-r\"></span>\r\n              <span class=\"qs-dot qs-dot-y\"></span>\r\n              <span class=\"qs-dot qs-dot-g\"></span>\r\n              <span style=\"margin-left:8px;\">çŸ¥è¯†åº“é¢æ¿</span>\r\n            </div>\r\n            <div class=\"qs-mockup-body\">\r\n              <div style=\"font-size:11px;color:#6b7280;margin-bottom:8px;\">ğŸ“‚ D:\\\\æˆ‘çš„æ–‡æ¡£\\\\ç¨åŠ¡èµ„æ–™ &nbsp;<span style=\"color:#2E5484;\">æ›´æ¢</span> &nbsp;<span style=\"color:#2E5484;\">åˆ·æ–°</span></div>\r\n              <div class=\"qs-file-row\"><span>ğŸ“„</span><span class=\"qs-file-name\">2024å¹´åº¦çº³ç¨ç”³æŠ¥è¡¨.pdf</span><span class=\"qs-file-size\">2.3MB</span><span class=\"qs-file-btn\">å¼•ç”¨</span></div>\r\n              <div class=\"qs-file-row\"><span>ğŸ“Š</span><span class=\"qs-file-name\">è´¢åŠ¡æŠ¥è¡¨æ±‡æ€».xlsx</span><span class=\"qs-file-size\">856KB</span><span class=\"qs-file-btn\">å¼•ç”¨</span></div>\r\n              <div class=\"qs-file-row\"><span>ğŸ“</span><span class=\"qs-file-name\">æœåŠ¡åˆåŒ-2024.docx</span><span class=\"qs-file-size\">145KB</span><span class=\"qs-file-btn\">å¼•ç”¨</span></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Section 5: Message Actions -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">5</span> æ¶ˆæ¯æ“ä½œ</div>\r\n          <div class=\"qs-section-desc\">é¼ æ ‡æ‚¬åœåœ¨ AI å›å¤ä¸Šï¼Œä¼šæµ®ç°æ“ä½œæŒ‰é’®ï¼šå¤åˆ¶ã€å¯¼å‡º Wordã€æ”¶è—ã€å­˜å…¥çŸ¥è¯†åº“ã€‚</div>\r\n          <div class=\"qs-mockup\">\r\n            <div class=\"qs-mockup-bar\">\r\n              <span class=\"qs-dot qs-dot-r\"></span>\r\n              <span class=\"qs-dot qs-dot-y\"></span>\r\n              <span class=\"qs-dot qs-dot-g\"></span>\r\n              <span style=\"margin-left:8px;\">æ¶ˆæ¯æ“ä½œ</span>\r\n            </div>\r\n            <div class=\"qs-mockup-body\">\r\n              <div class=\"qs-chat-bubble qs-chat-ai\" style=\"max-width:100%;\">\r\n                å¢å€¼ç¨ï¼ˆ6%ï¼‰ï¼šå’¨è¯¢æœåŠ¡è´¹ 50,000 å…ƒï¼Œç¨é¢ 2,830.19 å…ƒ<br/>\r\n                <b>é£é™©æç¤ºï¼š</b>åˆåŒæœªæ³¨æ˜ä»·ç¨åˆ†ç¦»æ¡æ¬¾ï¼Œå»ºè®®è¡¥å……ã€‚\r\n              </div>\r\n              <div class=\"qs-msg-actions\" style=\"margin-top:6px;\">\r\n                <span class=\"qs-msg-action\">ğŸ“‹ å¤åˆ¶</span>\r\n                <span class=\"qs-msg-action\">ğŸ“ å¯¼å‡ºWord</span>\r\n                <span class=\"qs-msg-action\">â­ æ”¶è—</span>\r\n                <span class=\"qs-msg-action\">ğŸ’¾ å­˜å…¥çŸ¥è¯†åº“</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <!-- Section 6: Tips -->\r\n        <div class=\"qs-section\">\r\n          <div class=\"qs-section-title\"><span class=\"qs-section-num\">6</span> å®ç”¨æŠ€å·§</div>\r\n        </div>\r\n        <div class=\"qs-tips-grid\">\r\n          <div class=\"qs-tip-card\" style=\"background:#f0f9ff;\"><b style=\"color:#1B3A5C;\">ğŸ“‚ çŸ¥è¯†åº“è‡ªåŠ¨å­¦ä¹ </b>æˆæƒæ–‡ä»¶å¤¹åï¼Œæ–°å¢æ–‡ä»¶è‡ªåŠ¨å­¦ä¹ ï¼Œæ— éœ€æ‰‹åŠ¨å¯¼å…¥ã€‚</div>\r\n          <div class=\"qs-tip-card\" style=\"background:#fefce8;\"><b style=\"color:#a16207;\">â­ æ”¶è—é‡è¦å›å¤</b>æ”¶è—åå¯ä»å·¦ä¾§é¢æ¿å¿«é€ŸæŸ¥æ‰¾å†å²å›å¤ã€‚</div>\r\n          <div class=\"qs-tip-card\" style=\"background:#f0fdf4;\"><b style=\"color:#15803d;\">ğŸ“ æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶</b>å°†æ–‡ä»¶ç›´æ¥æ‹–å…¥è¾“å…¥åŒºåŸŸå³å¯ä¸Šä¼ åˆ†æã€‚</div>\r\n          <div class=\"qs-tip-card\" style=\"background:#fdf2f8;\"><b style=\"color:#be185d;\">ğŸ›  å›ºå®šå¸¸ç”¨æŠ€èƒ½</b>è‡ªå®šä¹‰æŠ€èƒ½ç‚¹å‡»å›ºå®šåå‡ºç°åœ¨å¿«æ·æ ã€‚</div>\r\n        </div>\r\n\r\n        <!-- Footer -->\r\n        <div class=\"qs-footer\">\r\n          <button class=\"qs-btn-start\" @click=${dismissQuickStart}>å¼€å§‹ä½¿ç”¨Taxbot</button>\r\n          <div class=\"qs-footer-hint\">å¯éšæ—¶åœ¨å·¦ä¾§\"å…³äº\"é¡µé¢é‡æ–°æŸ¥çœ‹æ­¤æŒ‡å—</div>\r\n        </div>\r\n\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\nfunction renderMessages() {\r\n  if (state.messages.length === 0) {\r\n    return html`\r\n      <div class=\"empty-state\">\r\n        <div class=\"empty-state__icon\">\r\n          <img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" style=\"width: 120px; height: 120px;\" />\r\n        </div>\r\n        <div class=\"empty-state__text\">\r\n          <div style=\"font-size: 18px; font-weight: 600; margin-bottom: 8px;\">æ¬¢è¿æ¥åˆ°Taxbot</div>\r\n          <div>æœ‰ä»»ä½•ç¨åŠ¡é—®é¢˜ï¼Ÿè¯·åœ¨ä¸‹æ–¹è¾“å…¥å¹¶æé—®</div>\r\n        </div>\r\n      </div>\r\n    `;\r\n  }\r\n\r\n  const groups: typeof html[] = [];\r\n\r\n  // Virtual scrolling: calculate visible range\r\n  const container = document.getElementById(\"messages-container\");\r\n  const scrollTop = container?.scrollTop || 0;\r\n  const containerHeight = container?.clientHeight || 600;\r\n  const vRange = calculateVirtualRange(state.messages, scrollTop, containerHeight);\r\n  const visibleMessages = state.messages.slice(vRange.startIndex, vRange.endIndex);\r\n\r\n  // Top spacer\r\n  if (vRange.topPadding > 0) {\r\n    groups.push(html`<div style=\"height:${vRange.topPadding}px;\"></div>`);\r\n  }\r\n\r\n  for (const msg of visibleMessages) {\r\n    // Helper: render quote card if message has replyToId\r\n    const renderQuoteCard = (replyToId?: string) => {\r\n      if (!replyToId) return \"\";\r\n      const quoted = state.messages.find(m => m.id === replyToId);\r\n      if (!quoted) return \"\";\r\n      const sender = quoted.type === \"user\" ? \"æˆ‘\" : ((quoted as AssistantMessage).agentName || \"Taxbot\");\r\n      const preview = quoted.text.length > 80 ? quoted.text.slice(0, 80) + \"...\" : quoted.text;\r\n      return html`<div class=\"message-quote-card\" @click=${() => {\r\n        const el = document.querySelector(`[data-msg-id=\"${replyToId}\"]`);\r\n        if (el) { el.scrollIntoView({ behavior: \"smooth\", block: \"center\" }); el.classList.add(\"highlight-flash\"); setTimeout(() => el.classList.remove(\"highlight-flash\"), 1500); }\r\n      }}><span class=\"quote-sender\">${sender}</span><span class=\"quote-text\">${preview}</span></div>`;\r\n    };\r\n\r\n    if (msg.type === \"user\") {\r\n      groups.push(html`\r\n        <div class=\"message-group\" data-msg-id=\"${msg.id}\">\r\n          <div class=\"message-item user\">\r\n            <div class=\"message-content user\">\r\n              ${renderQuoteCard(msg.replyToId)}\r\n              ${msg.text ? html`<div class=\"message-bubble user\">${msg.text}</div>` : \"\"}\r\n              ${msg.attachments && msg.attachments.length > 0 ? html`\r\n                <div class=\"message-attachments\">\r\n                  ${msg.attachments.map(att => html`\r\n                    <div class=\"attachment-thumbnail\" @click=${() => {\r\n                      state.previewAttachment = att;\r\n                      renderApp();\r\n                    }}>\r\n                      ${att.type.startsWith(\"image/\") ? html`\r\n                        <img src=${att.dataUrl} alt=${att.name} class=\"thumbnail-image\" />\r\n                      ` : html`\r\n                        <div class=\"thumbnail-file\">\r\n                          <span class=\"file-icon\">ğŸ“„</span>\r\n                          <span class=\"file-name\">${att.name}</span>\r\n                        </div>\r\n                      `}\r\n                    </div>\r\n                  `)}\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n            <div class=\"message-avatar user\">ğŸ‘¤</div>\r\n          </div>\r\n          <div class=\"message-actions user-actions\">\r\n            <button class=\"message-action-btn\" @click=${() => { state.replyingTo = msg; renderApp(); setTimeout(() => state.inputRef?.focus(), 50); }} title=\"å¼•ç”¨å›å¤\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 14 4 9 9 4\"/><path d=\"M20 20v-7a4 4 0 0 0-4-4H4\"/></svg></span><span class=\"action-label\">å¼•ç”¨</span>\r\n            </button>\r\n          </div>\r\n          <div class=\"message-time\">${formatTime(msg.timestamp)}</div>\r\n        </div>\r\n      `);\r\n    } else {\r\n      const isFav = state.favorites.has(msg.id);\r\n      const aMsg = msg as AssistantMessage;\r\n      groups.push(html`\r\n        <div class=\"message-group\" data-msg-id=\"${msg.id}\">\r\n          ${aMsg.agentName ? html`<div class=\"message-agent-name\">${aMsg.agentEmoji || \"ğŸ¤–\"} ${aMsg.agentName}</div>` : \"\"}\r\n          ${renderQuoteCard(aMsg.replyToId)}\r\n          <div class=\"message-item\">\r\n            <div class=\"message-avatar assistant\">${aMsg.agentAvatarUrl\r\n              ? html`<img src=\"${aMsg.agentAvatarUrl}\" class=\"agent-avatar-img\" alt=\"${aMsg.agentName || \"\"}\" />`\r\n              : aMsg.agentEmoji\r\n              ? html`<span class=\"agent-emoji-avatar\">${aMsg.agentEmoji}</span>`\r\n              : html`<img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" />`}</div>\r\n            <div class=\"message-bubble assistant markdown-body ${isFav ? \"favorited\" : \"\"}\">${unsafeHTML(toSanitizedMarkdownHtml(autoLinkText(sanitizeDisplayText(msg.text))))}</div>\r\n          </div>\r\n          <div class=\"message-actions\">\r\n            <button class=\"message-action-btn\" @click=${() => { state.replyingTo = msg; renderApp(); setTimeout(() => state.inputRef?.focus(), 50); }} title=\"å¼•ç”¨å›å¤\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 14 4 9 9 4\"/><path d=\"M20 20v-7a4 4 0 0 0-4-4H4\"/></svg></span><span class=\"action-label\">å¼•ç”¨</span>\r\n            </button>\r\n            <button class=\"message-action-btn\" data-copy-id=\"${msg.id}\" @click=${() => copyMessageText(msg.id, msg.text)} title=\"å¤åˆ¶æ–‡æœ¬\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"9\" y=\"9\" width=\"13\" height=\"13\" rx=\"2\" ry=\"2\"/><path d=\"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1\"/></svg></span><span class=\"action-label\">å¤åˆ¶</span>\r\n            </button>\r\n            <button class=\"message-action-btn\" @click=${() => saveMessageAsWord(msg.text)} title=\"ä¿å­˜ä¸ºWordæ–‡æ¡£\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z\"/><polyline points=\"17 21 17 13 7 13 7 21\"/><polyline points=\"7 3 7 8 15 8\"/></svg></span><span class=\"action-label\">ä¿å­˜Word</span>\r\n            </button>\r\n            <button class=\"message-action-btn\" @click=${() => saveMessageToKnowledge(msg.text)} title=\"ä¿å­˜åˆ°çŸ¥è¯†åº“\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\"/><path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\"/></svg></span><span class=\"action-label\">å­˜çŸ¥è¯†åº“</span>\r\n            </button>\r\n            <button class=\"message-action-btn ${isFav ? \"fav-active\" : \"\"}\" @click=${() => toggleFavorite(msg.id)} title=\"${isFav ? \"å–æ¶ˆæ”¶è—\" : \"æ”¶è—\"}\">\r\n              <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"${isFav ? \"currentColor\" : \"none\"}\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\"/></svg></span><span class=\"action-label\">${isFav ? \"å·²æ”¶è—\" : \"æ”¶è—\"}</span>\r\n            </button>\r\n            ${aMsg.agentId ? html`\r\n              <button class=\"message-action-btn\" @click=${() => { appendAgentMemory(aMsg.agentId!, msg.text.length > 500 ? msg.text.slice(0, 500) + \"...\" : msg.text); showToast(\"å·²ä¿å­˜åˆ°æ™ºèƒ½ä½“è®°å¿†\"); }} title=\"ä¿å­˜åˆ°è¯¥æ™ºèƒ½ä½“çš„è®°å¿†\">\r\n                <span class=\"action-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z\"/><path d=\"M12 6v6l4 2\"/></svg></span><span class=\"action-label\">è®°ä½</span>\r\n              </button>\r\n            ` : \"\"}\r\n          </div>\r\n          <div class=\"message-time\">${formatTime(msg.timestamp)}</div>\r\n        </div>\r\n      `);\r\n    }\r\n  }\r\n\r\n  // Bottom spacer for virtual scroll\r\n  if (vRange.bottomPadding > 0) {\r\n    groups.push(html`<div style=\"height:${vRange.bottomPadding}px;\"></div>`);\r\n  }\r\n\r\n  // Show collaboration card when multi-agent orchestration is in progress\r\n  if (state.collaborationTasks && state.collaborationTasks.length > 0) {\r\n    const statusIcon = (s: string) => s === \"done\" ? \"âœ…\" : s === \"error\" ? \"âŒ\" : \"ğŸ’­\";\r\n    groups.push(html`\r\n      <div class=\"message-group\">\r\n        <div class=\"collab-card\">\r\n          <div class=\"collab-card__header\">ğŸ¤ æ™ºèƒ½ä½“åä½œä¸­</div>\r\n          ${state.collaborationTasks.map(t => html`\r\n            <div class=\"collab-card__row\">\r\n              <span class=\"collab-card__emoji\">${t.agentEmoji}</span>\r\n              <span class=\"collab-card__name\">${t.agentName}</span>\r\n              <span class=\"collab-card__task\">${t.task}</span>\r\n              <span class=\"collab-card__status\">${statusIcon(t.status)}</span>\r\n            </div>\r\n          `)}\r\n        </div>\r\n      </div>\r\n    `);\r\n  }\r\n\r\n  // Show thinking indicators for ALL active runs (parallel agents)\r\n  for (const run of state.activeRuns.values()) {\r\n    const tgtAgent = run.agentId ? state.agentsList.find(a => a.id === run.agentId) : null;\r\n    groups.push(html`\r\n      <div class=\"message-group\">\r\n        ${tgtAgent ? html`<div class=\"message-agent-name\">${tgtAgent.emoji || \"ğŸ¤–\"} ${tgtAgent.name}</div>` : \"\"}\r\n        <div class=\"message-item\">\r\n          <div class=\"message-avatar assistant\">${tgtAgent?.avatarUrl\r\n            ? html`<img src=\"${tgtAgent.avatarUrl}\" class=\"agent-avatar-img\" alt=\"${tgtAgent.name}\" />`\r\n            : tgtAgent?.emoji\r\n            ? html`<span class=\"agent-emoji-avatar\">${tgtAgent.emoji}</span>`\r\n            : html`<img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" />`}</div>\r\n          <div class=\"message-bubble assistant\">\r\n            <div class=\"thinking-indicator\">\r\n              ${run.thinkingLabel ? html`<span class=\"thinking-label\">${run.thinkingLabel}</span>` : \"\"}\r\n              <div class=\"loading-dots\">\r\n                <div class=\"loading-dot\"></div>\r\n                <div class=\"loading-dot\"></div>\r\n                <div class=\"loading-dot\"></div>\r\n              </div>\r\n              <button class=\"thinking-cancel-btn\" @click=${() => abortRun(run.sessionKey)} title=\"å–æ¶ˆ\">\r\n                <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\"/></svg>\r\n                <span>å–æ¶ˆ</span>\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `);\r\n  }\r\n\r\n  return html`${groups}`;\r\n}\r\n\r\n\r\n// â”€â”€â”€ Side Panel Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nfunction handleSidePanelResizeStart(e: MouseEvent) {\r\n  e.preventDefault();\r\n  const panel = (e.target as HTMLElement).parentElement!;\r\n  const handle = e.target as HTMLElement;\r\n  handle.classList.add(\"dragging\");\r\n  const startX = e.clientX;\r\n  const startW = panel.offsetWidth;\r\n\r\n  const onMove = (ev: MouseEvent) => {\r\n    const newW = Math.min(Math.max(startW + ev.clientX - startX, 240), 700);\r\n    panel.style.width = newW + \"px\";\r\n  };\r\n  const onUp = (ev: MouseEvent) => {\r\n    document.removeEventListener(\"mousemove\", onMove);\r\n    document.removeEventListener(\"mouseup\", onUp);\r\n    handle.classList.remove(\"dragging\");\r\n    const finalW = Math.min(Math.max(startW + ev.clientX - startX, 240), 700);\r\n    state.sidePanelWidth = finalW;\r\n    localStorage.setItem(\"taxbot_side_panel_width\", String(finalW));\r\n    renderApp();\r\n  };\r\n  document.addEventListener(\"mousemove\", onMove);\r\n  document.addEventListener(\"mouseup\", onUp);\r\n}\r\n\r\nfunction renderApp() {\r\n  const app = document.getElementById(\"app\");\r\n  if (!app) return;\r\n\r\n  // Always show chat interface, connection status only in header\r\n  const statusText = state.connected ? \"åŠ©ç†å·²å°±ä½\" : \"åŠ©ç†å‡†å¤‡ä¸­...\";\r\n  const statusClass = state.connected ? \"ok\" : \"\";\r\n\r\n  const content = html`\r\n    <div class=\"taxchat-app\">\r\n      <header class=\"taxchat-header\">\r\n        <div class=\"taxchat-header__title\">\r\n          <div style=\"display: flex; align-items: center; gap: 12px;\">\r\n            <div class=\"taxchat-header__logo\" @click=${() => { state.sidePanel = state.sidePanel === \"about\" ? null : \"about\"; renderApp(); }} style=\"cursor: pointer;\" title=\"å…³äºTaxbot\">\r\n              <img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" />\r\n            </div>\r\n            <h1>Taxbot</h1>\r\n            <div class=\"taxchat-header__status\" @click=${(e: Event) => { e.stopPropagation(); state.showStatusMenu = !state.showStatusMenu; renderApp(); }}>\r\n              <span class=\"status-dot ${statusClass}\"></span> ${statusText} <span class=\"status-arrow\">â–¾</span>\r\n              ${state.showStatusMenu ? html`\r\n                <div class=\"status-menu\" @click=${(e: Event) => e.stopPropagation()}>\r\n                  ${state.connected ? html`\r\n                    <div class=\"status-menu__item\" @click=${() => { state.showStatusMenu = false; const api = (window as any).electronAPI; if (api?.restartGateway) api.restartGateway(); setTimeout(() => connectGateway(), 2000); renderApp(); }}>ğŸ“ å‘¼å«ä¸ªäººåŠ©ç†</div>\r\n                    <div class=\"status-menu__item\" @click=${() => { state.showStatusMenu = false; const api = (window as any).electronAPI; if (api?.stopGateway) api.stopGateway(); state.connected = false; cancelReconnect(); renderApp(); }}>ğŸ˜´ è®©åŠ©ç†ä¸‹ç­</div>\r\n                  ` : html`\r\n                    <div class=\"status-menu__item\" @click=${() => { state.showStatusMenu = false; const api = (window as any).electronAPI; if (api?.startGateway) api.startGateway(); setTimeout(() => connectGateway(), 2000); renderApp(); }}>ğŸ“ å‘¼å«ä¸ªäººåŠ©ç†</div>\r\n                  `}\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div class=\"taxchat-header__right\">\r\n          ${(() => { const _unread = state.notifications.filter(n => !n.read).length; return html`\r\n          <button class=\"header-notif-btn\" @click=${(e: Event) => { e.stopPropagation(); state.showNotifications = !state.showNotifications; renderApp(); }} title=\"æ¶ˆæ¯\">\r\n            ğŸ””${_unread > 0 ? html`<span class=\"header-notif-badge\">${_unread}</span>` : \"\"}\r\n          </button>\r\n          ${state.showNotifications ? html`\r\n            <div class=\"notif-dropdown\" @click=${(e: Event) => e.stopPropagation()}>\r\n              <div class=\"notif-dropdown__header\">\r\n                <span>æ¶ˆæ¯${_unread > 0 ? ` (${_unread})` : \"\"}</span>\r\n                <div class=\"notif-dropdown__actions\">\r\n                  ${_unread > 0 ? html`<button class=\"notif-dropdown__clear\" @click=${() => { state.notifications.forEach(n => n.read = true); saveNotifications(); renderApp(); }}>å…¨éƒ¨å·²è¯»</button>` : \"\"}\r\n                  ${state.notifications.length > 0 ? html`<button class=\"notif-dropdown__clear\" @click=${() => { state.notifications = []; saveNotifications(); renderApp(); }}>æ¸…ç©º</button>` : \"\"}\r\n                </div>\r\n              </div>\r\n              <div class=\"notif-dropdown__list\">\r\n                ${state.notifications.length === 0\r\n                  ? html`<div class=\"notif-dropdown__empty\">æš‚æ— æ¶ˆæ¯</div>`\r\n                  : [...state.notifications].reverse().map(n => html`\r\n                    <div class=\"notif-item ${n.source ? 'notif-item--task' : n.taskId ? 'notif-item--task' : 'notif-item--clickable'} ${n.read ? 'notif-item--read' : ''}\" @click=${() => {\r\n                      n.read = true;\r\n                      saveNotifications();\r\n                      state.showNotifications = false;\r\n                      if (n.taskId && n.source === \"rental\") {\r\n                        const task = state.rentalPendingTasks.find(t => t.id === n.taskId);\r\n                        if (task) { openTaskPanel(task); }\r\n                        else { state.notifDetail = n; renderApp(); }\r\n                      } else if (n.taskId && n.source === \"consult\") {\r\n                        const task = state.consultMyTasks.find(t => t.id === n.taskId);\r\n                        if (task) { state.sidePanel = \"consult\"; openConsultTaskDetail(task); }\r\n                        else { state.sidePanel = \"consult\"; openConsultMyTasks(); renderApp(); }\r\n                      } else if (n.taskId) {\r\n                        // Legacy notifications without source â€” try both lists\r\n                        const rTask = state.rentalPendingTasks.find(t => t.id === n.taskId);\r\n                        if (rTask) { openTaskPanel(rTask); }\r\n                        else {\r\n                          const cTask = state.consultMyTasks.find(t => t.id === n.taskId);\r\n                          if (cTask) { state.sidePanel = \"consult\"; openConsultTaskDetail(cTask); }\r\n                          else { state.notifDetail = n; renderApp(); }\r\n                        }\r\n                      } else {\r\n                        state.notifDetail = n; renderApp();\r\n                      }\r\n                    }}>\r\n                      ${!n.read ? html`<div class=\"notif-item__dot\"></div>` : \"\"}\r\n                      <div class=\"notif-item__icon\">${n.icon}</div>\r\n                      <div class=\"notif-item__body\">\r\n                        <div class=\"notif-item__text\">${n.text}</div>\r\n                        <div class=\"notif-item__time\">${formatTime(n.timestamp)}</div>\r\n                        ${n.source === \"rental\" ? html`<div class=\"notif-item__hint\">ç‚¹å‡»å¤„ç†ä»»åŠ¡</div>` : n.source === \"consult\" ? html`<div class=\"notif-item__hint\">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>` : \"\"}\r\n                      </div>\r\n                      <button class=\"notif-item__remove\" @click=${(e: Event) => {\r\n                        e.stopPropagation();\r\n                        state.notifications = state.notifications.filter(x => x.id !== n.id);\r\n                        saveNotifications();\r\n                        renderApp();\r\n                      }} title=\"åˆ é™¤\">âœ•</button>\r\n                    </div>\r\n                  `)\r\n                }\r\n              </div>\r\n            </div>\r\n          ` : \"\"}`; })()}\r\n          <button class=\"header-refresh-btn ${state.refreshing ? \"spinning\" : \"\"}\" @click=${() => refreshAll()} title=\"${state.lastRefreshTime ? `ä¸Šæ¬¡åˆ·æ–°: ${formatTime(state.lastRefreshTime)}` : \"åˆ·æ–°æ‰€æœ‰æ•°æ®\"}\">\r\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n              <polyline points=\"23 4 23 10 17 10\"/>\r\n              <polyline points=\"1 20 1 14 7 14\"/>\r\n              <path d=\"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15\"/>\r\n            </svg>\r\n          </button>\r\n          <button class=\"header-exit-btn\" @click=${() => { state.confirmingExit = true; renderApp(); }} title=\"é€€å‡ºåº”ç”¨\">\r\n            <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n              <path d=\"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4\"/>\r\n              <polyline points=\"16 17 21 12 16 7\"/>\r\n              <line x1=\"21\" y1=\"12\" x2=\"9\" y2=\"12\"/>\r\n            </svg>\r\n          </button>\r\n        </div>\r\n      </header>\r\n\r\n      ${state.confirmingExit ? html`\r\n        <div class=\"model-confirm-overlay\" @click=${() => { state.confirmingExit = false; renderApp(); }}>\r\n          <div class=\"model-confirm-dialog\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <div class=\"model-confirm-title\">ç¡®è®¤é€€å‡ºåº”ç”¨</div>\r\n            <div class=\"model-confirm-hint\" style=\"margin-bottom:20px;font-size:13px;\">é€€å‡ºå°†å…³é—­çª—å£å¹¶å…³é—­ Gateway æœåŠ¡ã€‚</div>\r\n            <div class=\"model-confirm-actions\">\r\n              <button class=\"model-confirm-btn cancel\" @click=${() => { state.confirmingExit = false; renderApp(); }}>å–æ¶ˆ</button>\r\n              <button class=\"model-confirm-btn confirm\" style=\"background:linear-gradient(135deg,#ef4444,#dc2626);\" @click=${() => { doExitApp(); }}>ç¡®è®¤é€€å‡º</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.notifDetail ? html`\r\n        <div class=\"notif-detail-overlay\" @click=${() => { state.notifDetail = null; renderApp(); }}>\r\n          <div class=\"notif-detail-dialog\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <div class=\"notif-detail-icon\">${state.notifDetail.icon}</div>\r\n            <div class=\"notif-detail-text\">${state.notifDetail.text}</div>\r\n            <div class=\"notif-detail-time\">${formatTime(state.notifDetail.timestamp)}</div>\r\n            <button class=\"notif-detail-close\" @click=${() => { state.notifDetail = null; renderApp(); }}>å…³é—­</button>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      <div class=\"taxchat-body\">\r\n        <nav class=\"taxchat-sidebar ${state.sidebarCollapsed ? \"collapsed\" : \"\"}\">\r\n          <div class=\"sidebar-menu\">\r\n            <button class=\"sidebar-item ${state.sidePanel === \"conversations\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"conversations\" ? null : \"conversations\"; renderApp(); }} title=\"å¯¹è¯\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/></svg></span><span class=\"sidebar-label\">å¯¹è¯</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"knowledge\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"knowledge\" ? null : \"knowledge\"; if (state.sidePanel === \"knowledge\") loadKnowledgeFiles(); renderApp(); }} title=\"çŸ¥è¯†åº“\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg></span><span class=\"sidebar-label\">çŸ¥è¯†åº“</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"skills\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"skills\" ? null : \"skills\"; if (state.sidePanel === \"skills\" && state.skillsTab === \"market\" && state.taxstoreConnected && state.taxstoreSkills.length === 0) fetchSkills(1); renderApp(); }} title=\"æˆ‘çš„æŠ€èƒ½\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z\"/></svg></span><span class=\"sidebar-label\">æˆ‘çš„æŠ€èƒ½</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"agents\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"agents\" ? null : \"agents\"; if (state.sidePanel === \"agents\") loadAgents(); renderApp(); }} title=\"æˆ‘çš„æ™ºèƒ½ä½“\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"9\" cy=\"7\" r=\"4\"/><path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/><path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/></svg></span><span class=\"sidebar-label\">æˆ‘çš„æ™ºèƒ½ä½“</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"favorites\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"favorites\" ? null : \"favorites\"; renderApp(); }} title=\"æ”¶è—\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\"/></svg></span><span class=\"sidebar-label\">æ”¶è—</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"consult\" ? \"active\" : \"\"}\" @click=${() => { if (state.sidePanel === \"consult\") { state.sidePanel = null; } else { state.sidePanel = \"consult\"; state.consultView = \"list\"; if (state.consultAgents.length === 0) loadConsultAgents(); } renderApp(); }} title=\"AIä¸“å®¶å’¨è¯¢\">\r\n              <span class=\"sidebar-icon\" style=\"position:relative;\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>${state.consultUnreadCount > 0 ? html`<span class=\"sidebar-red-dot\"></span>` : \"\"}</span><span class=\"sidebar-label\">AIä¸“å®¶å’¨è¯¢${state.consultUnreadCount > 0 ? html`<span class=\"consult-unread-badge\">${state.consultUnreadCount}</span>` : \"\"}</span>\r\n            </button>\r\n          </div>\r\n          <div class=\"sidebar-bottom\">\r\n            <button class=\"sidebar-item ${state.sidePanel === \"settings\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"settings\" ? null : \"settings\"; if (state.sidePanel === \"settings\" && state.modelList.length === 0) loadModelConfig(); renderApp(); }} title=\"è®¾ç½®\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z\"/><circle cx=\"12\" cy=\"12\" r=\"3\"/></svg></span><span class=\"sidebar-label\">è®¾ç½®</span>\r\n            </button>\r\n            <button class=\"sidebar-item ${state.sidePanel === \"about\" ? \"active\" : \"\"}\" @click=${() => { state.sidePanel = state.sidePanel === \"about\" ? null : \"about\"; renderApp(); }} title=\"å…³äº\">\r\n              <span class=\"sidebar-icon\"><svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><line x1=\"12\" y1=\"16\" x2=\"12\" y2=\"12\"/><line x1=\"12\" y1=\"8\" x2=\"12.01\" y2=\"8\"/></svg></span><span class=\"sidebar-label\">å…³äº</span>\r\n            </button>\r\n            <button class=\"sidebar-item\" @click=${() => { window.open(\"https://taxbot.cc\", \"_blank\"); }} title=\"Taxbot\">\r\n              <span class=\"sidebar-icon\"><img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" style=\"width:18px;height:18px;border-radius:4px;object-fit:contain;\" /></span><span class=\"sidebar-label\">Taxbot</span>\r\n            </button>\r\n            <button class=\"sidebar-collapse-btn\" @click=${() => { state.sidebarCollapsed = !state.sidebarCollapsed; localStorage.setItem(\"taxbot_sidebar_collapsed\", String(state.sidebarCollapsed)); renderApp(); }} title=${state.sidebarCollapsed ? \"å±•å¼€ä¾§æ \" : \"æ”¶èµ·ä¾§æ \"}>\r\n              ${state.sidebarCollapsed ? html`<span class=\"sidebar-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"/></svg></span>` : html`<span class=\"sidebar-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"15 18 9 12 15 6\"/></svg></span>`}\r\n            </button>\r\n          </div>\r\n        </nav>\r\n\r\n        <div class=\"side-panel ${state.sidePanel ? \"open\" : \"\"} ${state.sidePanel === \"about\" || state.sidePanel === \"settings\" || state.sidePanel === \"consult\" ? \"fullscreen\" : \"\"}\"\r\n             style=\"${state.sidePanel && state.sidePanel !== \"about\" && state.sidePanel !== \"settings\" && state.sidePanel !== \"consult\" ? `width:${state.sidePanelWidth}px` : \"\"}\">\r\n          ${state.sidePanel && state.sidePanel !== \"about\" && state.sidePanel !== \"settings\" && state.sidePanel !== \"consult\" ? html`\r\n            <div class=\"side-panel-resize\" @mousedown=${handleSidePanelResizeStart}></div>\r\n          ` : \"\"}\r\n        ${state.sidePanel === \"conversations\" ? html`\r\n          <div class=\"side-panel-view conversations-view\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/></svg> å¯¹è¯åˆ—è¡¨</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"side-panel-body\">\r\n              <button class=\"conv-new-btn\" @click=${() => { createConversation(); }}>\r\n                <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg>\r\n                æ–°å»ºå¯¹è¯\r\n              </button>\r\n              <div class=\"conv-list\">\r\n                ${[...state.conversations].sort((a, b) => (b.lastAccessedAt || b.updatedAt) - (a.lastAccessedAt || a.updatedAt)).map(conv => {\r\n                  const isActive = conv.id === state.currentConversationId;\r\n                  const isRenaming = state.renamingConversation === conv.id;\r\n                  const isConfirmingDelete = state.confirmingConvDelete === conv.id;\r\n                  const timeStr = new Date(conv.updatedAt).toLocaleString(\"zh-CN\", { month: \"numeric\", day: \"numeric\", hour: \"2-digit\", minute: \"2-digit\" });\r\n                  const hasUnread = state.unreadConversations.has(conv.id);\r\n                  const convSK = `taxchat-${conv.id}`;\r\n                  const isReplying = [...state.activeRuns.values()].some(r => r.sessionKey === convSK);\r\n                  return html`\r\n                    <div class=\"conv-item ${isActive ? \"conv-item--active\" : \"\"} ${hasUnread ? \"conv-item--unread\" : \"\"}\" @click=${() => { if (!isRenaming && !isConfirmingDelete) switchConversation(conv.id); }}>\r\n                      <div class=\"conv-item__main\">\r\n                        ${isRenaming ? html`\r\n                          <input class=\"conv-rename-input\" type=\"text\" .value=${conv.title}\r\n                            @click=${(e: Event) => e.stopPropagation()}\r\n                            @keydown=${(e: KeyboardEvent) => {\r\n                              if (e.key === \"Enter\") { renameConversation(conv.id, (e.target as HTMLInputElement).value); }\r\n                              if (e.key === \"Escape\") { state.renamingConversation = null; renderApp(); }\r\n                            }}\r\n                            @blur=${(e: Event) => { renameConversation(conv.id, (e.target as HTMLInputElement).value); }}\r\n                          />\r\n                        ` : html`\r\n                          <div class=\"conv-item__title\">${hasUnread ? html`<span class=\"conv-unread-dot\"></span>` : \"\"}${conv.title}</div>\r\n                          <div class=\"conv-item__meta\">${isReplying ? html`<span class=\"conv-replying\">å›å¤ä¸­...</span>` : \"\"}${timeStr} Â· ${conv.messageCount} æ¡æ¶ˆæ¯</div>\r\n                        `}\r\n                      </div>\r\n                      ${isConfirmingDelete ? html`\r\n                        <div class=\"conv-delete-confirm\" @click=${(e: Event) => e.stopPropagation()}>\r\n                          <span>åˆ é™¤?</span>\r\n                          <button class=\"conv-confirm-yes\" @click=${() => deleteConversation(conv.id)}>æ˜¯</button>\r\n                          <button class=\"conv-confirm-no\" @click=${() => { state.confirmingConvDelete = null; renderApp(); }}>å¦</button>\r\n                        </div>\r\n                      ` : html`\r\n                        <div class=\"conv-item__actions\">\r\n                          <button class=\"conv-action-btn\" @click=${(e: Event) => { e.stopPropagation(); state.renamingConversation = conv.id; renderApp(); requestAnimationFrame(() => { const inp = document.querySelector('.conv-rename-input') as HTMLInputElement; if (inp) { inp.focus(); inp.select(); } }); }} title=\"é‡å‘½å\">\r\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/><path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/></svg>\r\n                          </button>\r\n                          <button class=\"conv-action-btn conv-action-btn--danger\" @click=${(e: Event) => { e.stopPropagation(); state.confirmingConvDelete = conv.id; renderApp(); }} title=\"åˆ é™¤\">\r\n                            <svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/></svg>\r\n                          </button>\r\n                        </div>\r\n                      `}\r\n                    </div>\r\n                  `;\r\n                })}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"favorites\" ? (() => {\r\n          // Collect favorites from ALL conversations\r\n          type FavItem = { msg: AssistantMessage; convId: string; convTitle: string };\r\n          const allFavItems: FavItem[] = [];\r\n          for (const conv of state.conversations) {\r\n            const isCurrentConv = conv.id === state.currentConversationId;\r\n            const favIds = isCurrentConv ? state.favorites : loadFavoritesForConversation(conv.id);\r\n            if (favIds.size === 0) continue;\r\n            const msgs = isCurrentConv ? state.messages : loadMessagesForConversation(conv.id);\r\n            for (const m of msgs) {\r\n              if (m.type === \"assistant\" && favIds.has(m.id)) {\r\n                allFavItems.push({ msg: m as AssistantMessage, convId: conv.id, convTitle: conv.title });\r\n              }\r\n            }\r\n          }\r\n          const query = state.favSearchQuery.trim().toLowerCase();\r\n          const filtered = query ? allFavItems.filter(f => f.msg.text.toLowerCase().includes(query)) : allFavItems;\r\n          return html`\r\n          <div class=\"side-panel-view favorites-view\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><polygon points=\"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2\"/></svg> æ”¶è—å¤¹ (${filtered.length})</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"fav-search-bar\">\r\n              <svg class=\"fav-search-icon\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg>\r\n              <input class=\"fav-search-input\" type=\"text\" placeholder=\"æœç´¢æ”¶è—...\" .value=${state.favSearchQuery} @input=${(e: Event) => { state.favSearchQuery = (e.target as HTMLInputElement).value; renderApp(); }} />\r\n              ${state.favSearchQuery ? html`<button class=\"fav-search-clear\" @click=${() => { state.favSearchQuery = \"\"; renderApp(); }}>âœ•</button>` : \"\"}\r\n            </div>\r\n            <div class=\"side-panel-body\">\r\n              ${filtered.length === 0\r\n                ? html`<div class=\"favorites-empty\">${state.favSearchQuery ? \"æ— åŒ¹é…ç»“æœ\" : \"æš‚æ— æ”¶è—\"}</div>`\r\n                : (() => {\r\n                  // Group by date\r\n                  const groups: Map<string, FavItem[]> = new Map();\r\n                  for (const f of filtered) {\r\n                    const d = new Date(f.msg.timestamp);\r\n                    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, \"0\")}-${String(d.getDate()).padStart(2, \"0\")}`;\r\n                    if (!groups.has(key)) groups.set(key, []);\r\n                    groups.get(key)!.push(f);\r\n                  }\r\n                  const sortedGroups = [...groups.entries()].sort((a, b) => b[0].localeCompare(a[0]));\r\n                  return sortedGroups.map(([dateKey, items]) => {\r\n                    const today = new Date();\r\n                    const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, \"0\")}-${String(today.getDate()).padStart(2, \"0\")}`;\r\n                    const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);\r\n                    const yesterdayKey = `${yesterday.getFullYear()}-${String(yesterday.getMonth() + 1).padStart(2, \"0\")}-${String(yesterday.getDate()).padStart(2, \"0\")}`;\r\n                    const label = dateKey === todayKey ? \"ä»Šå¤©\" : dateKey === yesterdayKey ? \"æ˜¨å¤©\" : dateKey;\r\n                    return html`\r\n                      <div class=\"fav-date-group\">\r\n                        <div class=\"fav-date-header\">${label}<span class=\"fav-date-count\">${items.length}</span></div>\r\n                        ${items.map(f => {\r\n                          const isCurrent = f.convId === state.currentConversationId;\r\n                          return html`\r\n                          <div class=\"favorites-item\" @click=${() => {\r\n                            const mid = f.msg.id;\r\n                            const targetConvId = f.convId;\r\n                            state.sidePanel = null;\r\n                            if (targetConvId !== state.currentConversationId) {\r\n                              switchConversation(targetConvId);\r\n                            }\r\n                            renderApp();\r\n                            setTimeout(() => scrollToMessage(mid), 350);\r\n                          }}>\r\n                            <div class=\"favorites-item__text\">${f.msg.text.length > 80 ? f.msg.text.slice(0, 80) + \"...\" : f.msg.text}</div>\r\n                            <div class=\"favorites-item__meta\">\r\n                              <span>${formatTime(f.msg.timestamp)}</span>\r\n                              ${!isCurrent ? html`<span class=\"fav-conv-tag\">${f.convTitle}</span>` : \"\"}\r\n                              <button class=\"favorites-item__remove\" @click=${(e: Event) => {\r\n                                e.stopPropagation();\r\n                                if (isCurrent) {\r\n                                  toggleFavorite(f.msg.id);\r\n                                } else {\r\n                                  // Remove from other conversation's favorites\r\n                                  const favs = loadFavoritesForConversation(f.convId);\r\n                                  favs.delete(f.msg.id);\r\n                                  saveFavoritesForConversation(f.convId, favs);\r\n                                  renderApp();\r\n                                }\r\n                              }} title=\"å–æ¶ˆæ”¶è—\">âœ•</button>\r\n                            </div>\r\n                          </div>\r\n                        `;})}\r\n                      </div>\r\n                    `;\r\n                  });\r\n                })()}\r\n            </div>\r\n          </div>\r\n        `;})() : \"\"}\r\n        ${state.sidePanel === \"knowledge\" ? html`\r\n          <div class=\"side-panel-view knowledge-view\"\r\n            @dragover=${(e: DragEvent) => { e.preventDefault(); e.stopPropagation(); }}\r\n            @dragenter=${(e: DragEvent) => { e.preventDefault(); e.stopPropagation(); setKnowledgeDragCounter(knowledgeDragCounter + 1); if (!state.knowledgeDragOver) { state.knowledgeDragOver = true; renderApp(); } }}\r\n            @dragleave=${(e: DragEvent) => { e.preventDefault(); e.stopPropagation(); setKnowledgeDragCounter(knowledgeDragCounter - 1); if (knowledgeDragCounter <= 0) { setKnowledgeDragCounter(0); state.knowledgeDragOver = false; renderApp(); } }}\r\n            @drop=${(e: DragEvent) => { e.preventDefault(); e.stopPropagation(); setKnowledgeDragCounter(0); state.knowledgeDragOver = false; renderApp(); handleKnowledgeDrop(e); }}\r\n          >\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg> çŸ¥è¯†åº“</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"side-panel-body\">\r\n              ${!state.authorizedFolder ? html`\r\n                <div class=\"knowledge-empty\">\r\n                  <div style=\"margin-bottom: 12px; color: #9ca3af;\"><svg width=\"40\" height=\"40\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg></div>\r\n                  <div style=\"margin-bottom: 16px; color: #6b7280;\">å°šæœªé€‰æ‹©çŸ¥è¯†åº“æ–‡ä»¶å¤¹</div>\r\n                  <button class=\"skill-add-btn\" @click=${() => handleAuthorizeFolder().then(() => loadKnowledgeFiles())}><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg> é€‰æ‹©æ–‡ä»¶å¤¹</button>\r\n                </div>\r\n              ` : html`\r\n                <div class=\"knowledge-folder-bar\">\r\n                  <span class=\"knowledge-folder-path\" title=${state.authorizedFolder}><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;flex-shrink:0;\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg> ${state.authorizedFolder}</span>\r\n                  <button class=\"knowledge-folder-change\" @click=${() => handleAuthorizeFolder().then(() => loadKnowledgeFiles())} title=\"æ›´æ¢æ–‡ä»¶å¤¹\">æ›´æ¢</button>\r\n                  <button class=\"knowledge-folder-change\" @click=${() => loadKnowledgeFiles()} title=\"åˆ·æ–°æ–‡ä»¶åˆ—è¡¨\">åˆ·æ–°</button>\r\n                </div>\r\n                ${state.knowledgeFiles.length > 0 ? html`\r\n                  <div class=\"sort-bar\">\r\n                    <span class=\"sort-bar__label\">æ’åº:</span>\r\n                    <button class=\"sort-bar__btn ${state.filesSortBy === \"time\" ? \"active\" : \"\"}\" @click=${() => { state.filesSortBy = \"time\"; renderApp(); }}>æŒ‰æ—¶é—´</button>\r\n                    <button class=\"sort-bar__btn ${state.filesSortBy === \"name\" ? \"active\" : \"\"}\" @click=${() => { state.filesSortBy = \"name\"; renderApp(); }}>æŒ‰åç§°</button>\r\n                  </div>\r\n                ` : \"\"}\r\n                ${state.knowledgeDragOver ? html`\r\n                  <div class=\"knowledge-drop-zone\">\r\n                    <div class=\"knowledge-drop-text\"><svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-4px;\"><path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/></svg> æ¾å¼€ä»¥æ·»åŠ æ–‡ä»¶åˆ°çŸ¥è¯†åº“</div>\r\n                  </div>\r\n                ` : \"\"}\r\n                ${state.knowledgeLoading ? html`\r\n                  <div class=\"knowledge-empty\">åŠ è½½ä¸­...</div>\r\n                ` : state.knowledgeFiles.length === 0 ? html`\r\n                  <div class=\"knowledge-empty\">æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰å¯è¯†åˆ«çš„æ–‡ä»¶<br><small>æ”¯æŒ: txt, pdf, docx, xlsx, csv, json, md ç­‰</small></div>\r\n                ` : sortedFiles().map(f => html`\r\n                  <div class=\"knowledge-file-item\">\r\n                    <span class=\"knowledge-file-icon\">${f.type === \"image\" ? html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/><polyline points=\"21 15 16 10 5 21\"/></svg>` : f.type === \"doc\" ? html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><line x1=\"18\" y1=\"20\" x2=\"18\" y2=\"10\"/><line x1=\"12\" y1=\"20\" x2=\"12\" y2=\"4\"/><line x1=\"6\" y1=\"20\" x2=\"6\" y2=\"14\"/></svg>` : html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z\"/><polyline points=\"14 2 14 8 20 8\"/><line x1=\"16\" y1=\"13\" x2=\"8\" y2=\"13\"/><line x1=\"16\" y1=\"17\" x2=\"8\" y2=\"17\"/></svg>`}</span>\r\n                    <span class=\"knowledge-file-name\" title=${f.name}>${f.name}</span>\r\n                    <span class=\"knowledge-file-size\">${formatFileSize(f.size)}</span>\r\n                    <button class=\"knowledge-file-btn ref\" @click=${() => addKnowledgeRef(f.name)} title=\"å¼•ç”¨åˆ°å¯¹è¯\">å¼•ç”¨</button>\r\n                    <button class=\"knowledge-file-btn del\" @click=${() => deleteKnowledgeFileAction(f.name)} title=\"åˆ é™¤æ–‡ä»¶\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/></svg></button>\r\n                  </div>\r\n                `)}\r\n              `}\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"skills\" ? html`\r\n          <div class=\"side-panel-view skills-view\" style=\"display:flex;flex-direction:column;overflow:hidden;\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"3\"/><path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\"/></svg> æŠ€èƒ½</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <!-- Tab Bar -->\r\n            <div class=\"skills-tab-bar\">\r\n              <button class=\"skills-tab ${state.skillsTab === \"installed\" ? \"active\" : \"\"}\"\r\n                @click=${() => { state.skillsTab = \"installed\"; renderApp(); }}>å·²å®‰è£…</button>\r\n              <button class=\"skills-tab ${state.skillsTab === \"market\" ? \"active\" : \"\"}\"\r\n                @click=${() => { state.skillsTab = \"market\"; if (state.taxstoreConnected && state.taxstoreSkills.length === 0) fetchSkills(1); renderApp(); }}>å¸‚åœº</button>\r\n            </div>\r\n            <!-- Installed Tab -->\r\n            ${state.skillsTab === \"installed\" ? html`\r\n            <div class=\"side-panel-body\">\r\n              <div class=\"skill-section-header\" @click=${() => { state.builtinSkillsCollapsed = !state.builtinSkillsCollapsed; renderApp(); }}>\r\n                <span class=\"skill-section-arrow ${state.builtinSkillsCollapsed ? \"collapsed\" : \"\"}\">â–¾</span>\r\n                <span class=\"skill-section-label\">é¢„åˆ¶æŠ€èƒ½</span>\r\n                <span class=\"skill-section-count\">${BUILTIN_SKILLS.length}</span>\r\n              </div>\r\n              ${state.builtinSkillsCollapsed ? \"\" : BUILTIN_SKILLS.map(sk => html`\r\n                <div class=\"skill-item skill-item--builtin\">\r\n                  <div class=\"skill-item__emoji\" @click=${() => handleCustomSkillClick(sk)} style=\"cursor:pointer\">${sk.emoji}</div>\r\n                  <div class=\"skill-item__body\" @click=${() => handleCustomSkillClick(sk)} style=\"cursor:pointer\">\r\n                    <div class=\"skill-item__name\">${sk.name} <span class=\"skill-builtin-badge\">é¢„åˆ¶</span></div>\r\n                    ${sk.description ? html`<div class=\"skill-item__desc\">${sk.description}</div>` : \"\"}\r\n                  </div>\r\n                </div>\r\n              `)}\r\n              <div class=\"skill-section-label\" style=\"margin-top: 12px; padding-left: 12px;\">è‡ªå®šä¹‰æŠ€èƒ½</div>\r\n              <div class=\"skill-add-row\">\r\n                <button class=\"skill-add-btn\" @click=${() => openSkillEditor()}><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg> æ–°å»º Skill</button>\r\n                <button class=\"skill-add-btn\" @click=${() => handleInstallSkillPackage()}><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"17 8 12 3 7 8\"/><line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"/></svg> ä¸Šä¼ æŠ€èƒ½åŒ…</button>\r\n              </div>\r\n              ${state.customSkills.length > 1 ? html`\r\n                <div class=\"sort-bar\">\r\n                  <span class=\"sort-bar__label\">æ’åº:</span>\r\n                  <button class=\"sort-bar__btn ${state.skillsSortBy === \"time\" ? \"active\" : \"\"}\" @click=${() => { state.skillsSortBy = \"time\"; renderApp(); }}>æŒ‰æ—¶é—´</button>\r\n                  <button class=\"sort-bar__btn ${state.skillsSortBy === \"name\" ? \"active\" : \"\"}\" @click=${() => { state.skillsSortBy = \"name\"; renderApp(); }}>æŒ‰åç§°</button>\r\n                </div>\r\n              ` : \"\"}\r\n              ${state.customSkills.length === 0\r\n                ? html`<div class=\"knowledge-empty\" style=\"padding: 12px;\">æš‚æ— è‡ªå®šä¹‰æŠ€èƒ½</div>`\r\n                : sortedSkills().map(sk => html`\r\n                  <div class=\"skill-item skill-item--custom\">\r\n                    <div class=\"skill-item__emoji\" @click=${() => handleCustomSkillClick(sk)} style=\"cursor:pointer\">${sk.emoji}</div>\r\n                    <div class=\"skill-item__body\" @click=${() => handleCustomSkillClick(sk)} style=\"cursor:pointer\">\r\n                      <div class=\"skill-item__name\">${sk.name}</div>\r\n                      ${sk.description ? html`<div class=\"skill-item__desc\">${sk.description}</div>` : \"\"}\r\n                    </div>\r\n                    <div class=\"skill-item__actions\">\r\n                      <button class=\"skill-item__btn ${sk.pinned ? \"pinned\" : \"\"}\" @click=${() => toggleSkillPin(sk.id)} title=\"${sk.pinned ? \"å–æ¶ˆå¿«æ·\" : \"æ·»åŠ åˆ°å¿«æ·\"}\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 17v5\"/><path d=\"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z\"/></svg></button>\r\n                      <button class=\"skill-item__btn\" @click=${() => exportSkillAsZip(sk)} title=\"å¯¼å‡º\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"/><polyline points=\"7 10 12 15 17 10\"/><line x1=\"12\" y1=\"15\" x2=\"12\" y2=\"3\"/></svg></button>\r\n                      <button class=\"skill-item__btn\" @click=${() => openSkillEditor(sk)} title=\"ç¼–è¾‘\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7\"/><path d=\"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z\"/></svg></button>\r\n                      <button class=\"skill-item__btn\" @click=${() => deleteCustomSkill(sk.id)} title=\"åˆ é™¤\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/></svg></button>\r\n                    </div>\r\n                  </div>\r\n                `)\r\n              }\r\n            </div>\r\n            ` : \"\"}\r\n            <!-- Market Tab -->\r\n            ${state.skillsTab === \"market\" ? html`\r\n            ${!state.taxstoreConnected ? html`\r\n              <div class=\"ts-login\">\r\n                <div class=\"ts-login-title\">è¿æ¥ TaxStore</div>\r\n                <div class=\"ts-login-desc\">ç™»å½• taxbot.cc è´¦æˆ·ï¼Œæµè§ˆå’Œå®‰è£…æŠ€èƒ½</div>\r\n                <input type=\"email\" placeholder=\"é‚®ç®±\" .value=${state.taxstoreLoginEmail}\r\n                  @input=${(e: Event) => { state.taxstoreLoginEmail = (e.target as HTMLInputElement).value; }} />\r\n                <input type=\"password\" placeholder=\"å¯†ç \" .value=${state.taxstoreLoginPassword}\r\n                  @input=${(e: Event) => { state.taxstoreLoginPassword = (e.target as HTMLInputElement).value; }}\r\n                  @keydown=${(e: KeyboardEvent) => { if (e.key === \"Enter\") loginTaxStore(state.taxstoreLoginEmail, state.taxstoreLoginPassword); }} />\r\n                ${state.taxstoreError ? html`<div class=\"ts-login-error\">${state.taxstoreError}</div>` : \"\"}\r\n                <button class=\"ts-login-btn\" ?disabled=${state.taxstoreLoading}\r\n                  @click=${() => loginTaxStore(state.taxstoreLoginEmail, state.taxstoreLoginPassword)}>\r\n                  ${state.taxstoreLoading ? \"è¿æ¥ä¸­...\" : \"ç™»å½•\"}\r\n                </button>\r\n                <div class=\"ts-login-desc\" style=\"margin-top:4px;\">\r\n                  æ²¡æœ‰è´¦æˆ·ï¼Ÿè®¿é—® <a href=\"https://taxbot.cc:8443/taxbot\" target=\"_blank\" style=\"color:#2E5484;\">taxbot.cc</a> æ³¨å†Œ\r\n                </div>\r\n              </div>\r\n            ` : html`\r\n              <div class=\"ts-user-bar\">\r\n                <span class=\"ts-user-name\">${state.taxstoreUser?.name || state.taxstoreUser?.email}</span>\r\n                <span class=\"ts-points-badge\">${state.taxstoreUser?.points ?? 0} ç§¯åˆ†</span>\r\n                <button class=\"ts-logout-btn\" @click=${logoutTaxStore} title=\"æ–­å¼€è¿æ¥\">é€€å‡º</button>\r\n              </div>\r\n              ${state.taxstoreUpdates.length > 0 ? html`\r\n                <div class=\"ts-update-banner\">\r\n                  <span class=\"ts-update-banner-icon\">ğŸ”„</span>\r\n                  <span class=\"ts-update-banner-text\">${state.taxstoreUpdates.length} ä¸ªæŠ€èƒ½æœ‰æ›´æ–°å¯ç”¨</span>\r\n                </div>\r\n              ` : \"\"}\r\n              <div class=\"ts-filter-bar\">\r\n                <input class=\"ts-search-input\" type=\"text\" placeholder=\"æœç´¢æŠ€èƒ½...\"\r\n                  .value=${state.taxstoreQuery}\r\n                  @input=${(e: Event) => { state.taxstoreQuery = (e.target as HTMLInputElement).value; }}\r\n                  @keydown=${(e: KeyboardEvent) => { if (e.key === \"Enter\") searchSkills(state.taxstoreQuery); }} />\r\n                <button class=\"ts-sort-btn ${state.taxstoreSort === \"latest\" ? \"active\" : \"\"}\"\r\n                  @click=${() => changeSortOrder(\"latest\")}>æœ€æ–°</button>\r\n                <button class=\"ts-sort-btn ${state.taxstoreSort === \"popular\" ? \"active\" : \"\"}\"\r\n                  @click=${() => changeSortOrder(\"popular\")}>çƒ­é—¨</button>\r\n              </div>\r\n              <div class=\"ts-category-bar\">\r\n                <button class=\"ts-cat-tag ${state.taxstoreCategory === \"\" ? \"active\" : \"\"}\"\r\n                  @click=${() => filterByCategory(\"\")}>å…¨éƒ¨</button>\r\n                <button class=\"ts-cat-tag ${state.taxstoreCategory === \"tax-tools\" ? \"active\" : \"\"}\"\r\n                  @click=${() => filterByCategory(\"tax-tools\")}>ç¨åŠ¡å·¥å…·</button>\r\n                <button class=\"ts-cat-tag ${state.taxstoreCategory === \"forms\" ? \"active\" : \"\"}\"\r\n                  @click=${() => filterByCategory(\"forms\")}>æŠ¥è¡¨</button>\r\n                <button class=\"ts-cat-tag ${state.taxstoreCategory === \"reporting\" ? \"active\" : \"\"}\"\r\n                  @click=${() => filterByCategory(\"reporting\")}>æŠ¥å‘Š</button>\r\n                <button class=\"ts-cat-tag ${state.taxstoreCategory === \"automation\" ? \"active\" : \"\"}\"\r\n                  @click=${() => filterByCategory(\"automation\")}>è‡ªåŠ¨åŒ–</button>\r\n              </div>\r\n              ${state.taxstoreError ? html`<div class=\"ts-error\">${state.taxstoreError}</div>` : \"\"}\r\n              ${state.taxstoreLoading ? html`<div class=\"ts-loading\">åŠ è½½ä¸­...</div>` : html`\r\n                <div class=\"ts-skills-list\">\r\n                  ${state.taxstoreSkills.length === 0\r\n                    ? html`<div class=\"ts-empty\">${state.taxstoreQuery ? \"æœªæ‰¾åˆ°åŒ¹é…æŠ€èƒ½\" : \"æš‚æ— æŠ€èƒ½\"}</div>`\r\n                    : state.taxstoreSkills.map(sk => {\r\n                      const installed = isInstalledLocally(sk.id);\r\n                      return html`\r\n                        <div class=\"ts-skill-card\">\r\n                          <div class=\"ts-skill-header\">\r\n                            <span class=\"ts-skill-name\">${sk.name}</span>\r\n                            <span class=\"ts-skill-version\">v${sk.version}</span>\r\n                          </div>\r\n                          ${sk.description ? html`<div class=\"ts-skill-desc\">${sk.description}</div>` : \"\"}\r\n                          <div class=\"ts-skill-meta\">\r\n                            <span class=\"ts-skill-rating\">${sk.reviews?.length ? html`â˜… ${avgRating(sk.reviews)}` : \"\"}</span>\r\n                            <span>${sk.downloads} ä¸‹è½½</span>\r\n                            <span class=\"ts-skill-cost ${sk.pointsCost === 0 ? \"free\" : \"paid\"}\">${sk.pointsCost === 0 ? \"å…è´¹\" : `${sk.pointsCost} ç§¯åˆ†`}</span>\r\n                            <span>${sk.author?.name || \"\"}</span>\r\n                            ${state.taxstoreInstallingId === sk.id\r\n                              ? html`<span class=\"ts-install-progress\">${state.taxstoreInstallStep === \"downloading\" ? \"ä¸‹è½½ä¸­...\" : \"å®‰è£…ä¸­...\"}</span>`\r\n                              : html`<button class=\"ts-install-btn ${installed ? \"installed\" : \"\"}\"\r\n                                  @click=${() => { if (!installed) installFromTaxStore(sk); }}\r\n                                  ?disabled=${installed || !!state.taxstoreInstallingId}>\r\n                                  ${installed ? \"å·²å®‰è£…\" : \"å®‰è£…\"}\r\n                                </button>`\r\n                            }\r\n                          </div>\r\n                        </div>\r\n                      `;\r\n                    })\r\n                  }\r\n                </div>\r\n                ${state.taxstoreTotalPages > 1 ? html`\r\n                  <div class=\"ts-pagination\">\r\n                    <button class=\"ts-page-btn\" ?disabled=${state.taxstorePage <= 1}\r\n                      @click=${() => fetchSkills(state.taxstorePage - 1)}>ä¸Šä¸€é¡µ</button>\r\n                    <span>${state.taxstorePage} / ${state.taxstoreTotalPages}</span>\r\n                    <button class=\"ts-page-btn\" ?disabled=${state.taxstorePage >= state.taxstoreTotalPages}\r\n                      @click=${() => fetchSkills(state.taxstorePage + 1)}>ä¸‹ä¸€é¡µ</button>\r\n                  </div>\r\n                ` : \"\"}\r\n              `}\r\n            `}\r\n            ` : \"\"}\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"agents\" ? html`\r\n          <div class=\"side-panel-view agents-view\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"9\" cy=\"7\" r=\"4\"/><path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/><path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/></svg> æˆ‘çš„æ™ºèƒ½ä½“</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"side-panel-body\">\r\n              <!-- Tab bar -->\r\n              <div class=\"rental-tab-bar\">\r\n                <button class=\"rental-tab ${state.rentalActiveTab === \"agents\" ? \"rental-tab--active\" : \"\"}\"\r\n                  @click=${() => { state.rentalActiveTab = \"agents\"; renderApp(); }}>\r\n                  ğŸ¤– æ™ºèƒ½ä½“åˆ—è¡¨\r\n                </button>\r\n                <button class=\"rental-tab ${state.rentalActiveTab === \"tasks\" ? \"rental-tab--active\" : \"\"}\"\r\n                  @click=${() => { state.rentalActiveTab = \"tasks\"; renderApp(); }}>\r\n                  ğŸ“‹ ä»»åŠ¡\r\n                  ${state.rentalPendingTasks.length > 0 ? html`<span class=\"rental-tab-badge\">${state.rentalPendingTasks.length}</span>` : \"\"}\r\n                </button>\r\n              </div>\r\n\r\n              ${state.rentalActiveTab === \"agents\" ? html`\r\n              <!-- æ™ºèƒ½ä½“åˆ—è¡¨ tab -->\r\n              <div class=\"skill-add-row\">\r\n                <button class=\"skill-add-btn\" @click=${() => { state.editingAgentId = null; state.agentCreateDraft = { name: \"\", emoji: \"ğŸ¤–\", description: \"\", identityDesc: \"\", expertise: \"\", avatarDataUrl: \"\", selectedSkills: [] }; state.creatingAgent = !state.creatingAgent; renderApp(); }}>\r\n                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;\"><line x1=\"12\" y1=\"5\" x2=\"12\" y2=\"19\"/><line x1=\"5\" y1=\"12\" x2=\"19\" y2=\"12\"/></svg> æ–°å»ºæ™ºèƒ½ä½“\r\n                </button>\r\n              </div>\r\n              ${state.agentsLoading ? html`<div class=\"knowledge-empty\">åŠ è½½ä¸­...</div>` : \"\"}\r\n              ${!state.agentsLoading && state.agentsList.length === 0 ? html`<div class=\"knowledge-empty\">æš‚æ— æ™ºèƒ½ä½“</div>` : \"\"}\r\n              ${state.agentsList.map(agent => {\r\n                const listing = getListingForAgent(agent.id);\r\n                const completedTasks = listing ? getCompletedTasksForListing(listing.id) : [];\r\n                const totalEarned = completedTasks.reduce((sum, t) => sum + t.price, 0);\r\n                return html`\r\n                <div class=\"skill-item agent-card-uniform\" @click=${() => { insertAgentMention(agent); }} style=\"cursor:pointer\" title=\"ç‚¹å‡»@${agent.name}\">\r\n                  <div class=\"skill-item__emoji\">${agent.avatarUrl ? html`<img src=\"${agent.avatarUrl}\" class=\"agent-avatar-img\" />` : agent.emoji}</div>\r\n                  <div class=\"skill-item__body\">\r\n                    <div class=\"skill-item__name\">${agent.name} ${agent.isDefault ? html`<span class=\"skill-builtin-badge\">é»˜è®¤</span>` : \"\"}</div>\r\n                    <div class=\"skill-item__desc\">${agent.description || \"\\u00A0\"}</div>\r\n                    <div class=\"agent-card-rental-line\">${listing ? html`<span class=\"agent-rental-badge agent-rental-badge--active\">ğŸª ${listing.price}ç§¯åˆ†/æ¬¡</span>${completedTasks.length > 0 ? html`<span class=\"agent-card-stats\">âœ…${completedTasks.length}${listing.avgRating > 0 ? html` â­${listing.avgRating.toFixed(1)}` : \"\"} ğŸ’°${totalEarned}</span>` : \"\"}` : \"\\u00A0\"}</div>\r\n                  </div>\r\n                  <div class=\"skill-item__actions\">\r\n                    ${!agent.isDefault ? html`\r\n                      ${state.confirmingAgentDelete === agent.id ? html`\r\n                        <span class=\"agent-delete-confirm\">\r\n                          ç¡®å®šåˆ é™¤ï¼Ÿ\r\n                          <button class=\"agent-action-btn agent-action-btn--danger\" @click=${(e: Event) => { e.stopPropagation(); deleteAgent(agent.id); }}>æ˜¯</button>\r\n                          <button class=\"agent-action-btn\" @click=${(e: Event) => { e.stopPropagation(); state.confirmingAgentDelete = null; renderApp(); }}>å¦</button>\r\n                        </span>\r\n                      ` : html`\r\n                        ${listing\r\n                          ? html`<button class=\"agent-action-btn\" @click=${(e: Event) => { e.stopPropagation(); unpublishAgent(listing.id); }}>ä¸‹æ¶</button>`\r\n                          : state.taxstoreConnected\r\n                            ? html`<button class=\"agent-rental-badge agent-rental-badge--btn\" @click=${(e: Event) => { e.stopPropagation(); openPublishDialog(agent); }}>ğŸª å‡ºç§Ÿèµšç§¯åˆ†</button>`\r\n                            : \"\"\r\n                        }\r\n                        <button class=\"agent-action-btn\" @click=${(e: Event) => { e.stopPropagation(); openAgentEditor(agent); }}>ç¼–è¾‘</button>\r\n                        <button class=\"agent-action-btn agent-action-btn--danger\" @click=${(e: Event) => { e.stopPropagation(); state.confirmingAgentDelete = agent.id; renderApp(); }}>åˆ é™¤</button>\r\n                      `}\r\n                    ` : html`\r\n                      ${listing\r\n                        ? html`<button class=\"agent-action-btn\" @click=${(e: Event) => { e.stopPropagation(); unpublishAgent(listing.id); }}>ä¸‹æ¶</button>`\r\n                        : state.taxstoreConnected\r\n                          ? html`<button class=\"agent-rental-badge agent-rental-badge--btn\" @click=${(e: Event) => { e.stopPropagation(); openPublishDialog(agent); }}>ğŸª å‡ºç§Ÿèµšç§¯åˆ†</button>`\r\n                          : \"\"\r\n                      }\r\n                    `}\r\n                  </div>\r\n                </div>\r\n              `; })}\r\n              ` : html`\r\n              <!-- ä»»åŠ¡ tab -->\r\n              <!-- å¾…å¤„ç†ä»»åŠ¡ -->\r\n              ${state.rentalPendingTasks.length > 0 ? html`\r\n                <div class=\"rental-tasks-section\">\r\n                  <div class=\"rental-tasks-header\">\r\n                    ğŸ“‹ å¾…å¤„ç†ä»»åŠ¡ <span class=\"rental-tasks-count\">${state.rentalPendingTasks.length}</span>\r\n                  </div>\r\n                  ${state.rentalPendingTasks.map(task => html`\r\n                    <div class=\"rental-task-card\" @click=${() => openTaskPanel(task)}>\r\n                      <div class=\"rental-task-card-emoji\">${task.listing.emoji}</div>\r\n                      <div class=\"rental-task-card-body\">\r\n                        <div class=\"rental-task-card-name\">${task.title}${(task.unreadMessageCount || 0) > 0 ? html`<span class=\"rental-task-msg-dot\">ğŸ’¬</span>` : \"\"}</div>\r\n                        <div class=\"rental-task-card-desc\">${task.listing.name} Â· ${task.client.name}</div>\r\n                      </div>\r\n                      <div class=\"rental-task-card-price\">${task.price} ç§¯åˆ†</div>\r\n                    </div>\r\n                  `)}\r\n                </div>\r\n              ` : html`\r\n                <div class=\"rental-tasks-empty\">æš‚æ— å¾…å¤„ç†ä»»åŠ¡</div>\r\n              `}\r\n\r\n              <!-- å·²å®Œæˆä»»åŠ¡è®°å½• -->\r\n              ${state.rentalCompletedTasks.length > 0 ? html`\r\n                <div class=\"rental-tasks-section\">\r\n                  <div class=\"rental-tasks-header\">\r\n                    âœ… å·²å®Œæˆä»»åŠ¡ <span class=\"rental-completed-count\">${state.rentalCompletedTasks.length}</span>\r\n                  </div>\r\n                  ${state.rentalCompletedTasks.map(task => html`\r\n                    <div class=\"rental-task-card rental-task-card--completed\" @click=${() => { state.rentalTaskDetailView = task; scheduleRender(); }}>\r\n                      <div class=\"rental-task-card-emoji\">${task.listing.emoji}</div>\r\n                      <div class=\"rental-task-card-body\">\r\n                        <div class=\"rental-task-card-name\">${task.title}</div>\r\n                        <div class=\"rental-task-card-desc\">\r\n                          ${task.listing.name} Â· ${task.client.name}\r\n                          Â· ${task.completedAt ? new Date(task.completedAt).toLocaleDateString() : \"\"}\r\n                        </div>\r\n                        ${task.rating ? html`\r\n                          <div class=\"rental-task-card-rating\">\r\n                            ${\"â­\".repeat(task.rating)}\r\n                            ${task.ratingComment ? html`<span class=\"rental-task-card-comment\">${task.ratingComment}</span>` : \"\"}\r\n                          </div>\r\n                        ` : \"\"}\r\n                      </div>\r\n                      <div class=\"rental-task-card-price rental-task-card-price--earned\">+${task.price} ç§¯åˆ†</div>\r\n                    </div>\r\n                  `)}\r\n                </div>\r\n              ` : \"\"}\r\n\r\n              ${state.rentalPendingTasks.length === 0 && state.rentalCompletedTasks.length === 0 ? html`\r\n                <div class=\"rental-tasks-empty\">æš‚æ— ä»»åŠ¡è®°å½•</div>\r\n              ` : \"\"}\r\n              `}\r\n\r\n              <!-- æ¨èæ¨¡æ¿ (ä»…åœ¨æ™ºèƒ½ä½“åˆ—è¡¨ tab æ˜¾ç¤º) -->\r\n              ${state.rentalActiveTab === \"agents\" && AGENT_TEMPLATES.some(tpl => !state.agentsList.some(a => a.name === tpl.name)) ? html`\r\n                <div class=\"agent-templates-section\">\r\n                  <div class=\"agent-templates-header\">æ¨èæ¨¡æ¿</div>\r\n                  ${AGENT_TEMPLATES.map(tpl => {\r\n                    const exists = state.agentsList.some(a => a.name === tpl.name);\r\n                    return html`\r\n                      <div class=\"agent-template-item\">\r\n                        <span class=\"agent-template-emoji\">${tpl.emoji}</span>\r\n                        <div class=\"agent-template-body\">\r\n                          <div class=\"agent-template-name\">${tpl.name}</div>\r\n                          <div class=\"agent-template-desc\">${tpl.description}</div>\r\n                        </div>\r\n                        ${exists\r\n                          ? html`<span class=\"agent-template-badge\">å·²åˆ›å»º</span>`\r\n                          : html`<button class=\"agent-template-btn\" @click=${(e: Event) => { e.stopPropagation(); createAgentFromTemplate(tpl); }}>ä¸€é”®åˆ›å»º</button>`\r\n                        }\r\n                      </div>\r\n                    `;\r\n                  })}\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"settings\" ? html`\r\n          <div class=\"side-panel-view settings-view\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\">${state.settingsView === \"model\" ? html`\r\n                <button class=\"settings-back-btn\" @click=${() => { state.settingsView = \"main\"; state.modelError = null; renderApp(); }}>\r\n                  <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"15 18 9 12 15 6\"/></svg>\r\n                </button> æ¨¡å‹é…ç½®\r\n              ` : html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><path d=\"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z\"/><circle cx=\"12\" cy=\"12\" r=\"3\"/></svg> è®¾ç½®`}</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; state.settingsView = \"main\"; state.confirmingClear = false; state.modelError = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"side-panel-body settings-fullscreen\">\r\n              ${state.settingsView === \"model\" ? html`\r\n              <!-- Model Config Sub-View -->\r\n              <div class=\"about-settings\">\r\n                ${state.modelLoading ? html`<div class=\"knowledge-empty\">åŠ è½½ä¸­...</div>` : html`\r\n                  ${state.activeModel ? html`\r\n                  <div class=\"model-current-card\">\r\n                    <div class=\"model-current-title\">å½“å‰æ¨¡å‹</div>\r\n                    <div class=\"model-current-rows\">\r\n                      <div class=\"model-current-row\"><span class=\"model-current-label\">æä¾›å•†</span><span class=\"model-current-value\">${state.activeModel.provider || \"-\"}</span></div>\r\n                      <div class=\"model-current-row\"><span class=\"model-current-label\">æ¨¡å‹</span><span class=\"model-current-value\">${state.activeModel.modelId || \"-\"}</span></div>\r\n                      <div class=\"model-current-row\"><span class=\"model-current-label\">API åœ°å€</span><span class=\"model-current-value\">${state.activeModel.baseUrl || \"-\"}</span></div>\r\n                      <div class=\"model-current-row\">\r\n                        <span class=\"model-current-label\">API Key</span>\r\n                        <span class=\"model-current-value model-current-key\">\r\n                          ${state.activeModel.apiKey ? (state.apiKeyVisible ? state.activeModel.apiKey : state.activeModel.apiKey.replace(/./g, \"â€¢\")) : \"-\"}\r\n                          ${state.activeModel.apiKey ? html`<button class=\"settings-key-toggle-sm\" type=\"button\" @click=${() => { state.apiKeyVisible = !state.apiKeyVisible; renderApp(); }} title=${state.apiKeyVisible ? \"éšè—\" : \"æ˜¾ç¤º\"}>\r\n                            ${state.apiKeyVisible ? html`<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94\"/><path d=\"M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19\"/><line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/></svg>` : html`<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"/><circle cx=\"12\" cy=\"12\" r=\"3\"/></svg>`}\r\n                          </button>` : \"\"}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  ` : \"\"}\r\n                  <div class=\"about-setting-group\">\r\n                    <div class=\"about-setting-title\">é€‰æ‹©æ¨¡å‹</div>\r\n                    <div class=\"settings-form\">\r\n                      <div class=\"settings-field\">\r\n                        <label class=\"settings-label\">æ¨¡å‹æä¾›å•†</label>\r\n                        <select class=\"settings-input\" .value=${state.modelConfigDraft.provider} @change=${(e: Event) => { selectProvider((e.target as HTMLSelectElement).value); }}>\r\n                          ${state.modelList.length === 0 && !state.modelConfigDraft.provider ? html`<option value=\"\">-- æ— å¯ç”¨æä¾›å•† --</option>` : \"\"}\r\n                          ${getProviderNames().map(p => html`\r\n                            <option value=${p} ?selected=${p === state.modelConfigDraft.provider}>${p}${(() => { const cnt = getModelsForProvider(p).length; return cnt > 0 ? ` (${cnt} ä¸ªæ¨¡å‹)` : \"\"; })()}</option>\r\n                          `)}\r\n                        </select>\r\n                      </div>\r\n                      <div class=\"settings-field\">\r\n                        <label class=\"settings-label\">æ¨¡å‹</label>\r\n                        ${(() => {\r\n                          const models = getModelsForProvider(state.modelConfigDraft.provider);\r\n                          return html`\r\n                            <select class=\"settings-input\" .value=${state.modelConfigDraft.modelId} @change=${(e: Event) => { selectModel((e.target as HTMLSelectElement).value); }}>\r\n                              ${models.length === 0 ? html`<option value=\"\">-- æ— å¯ç”¨æ¨¡å‹ --</option>` : \"\"}\r\n                              ${models.map(m => html`\r\n                                <option value=${m.id} ?selected=${m.id === state.modelConfigDraft.modelId}>${m.name || m.id}${m.contextWindow ? ` (${Math.round(m.contextWindow / 1024)}K)` : \"\"}${m.reasoning ? \" Â· æ¨ç†\" : \"\"}</option>\r\n                              `)}\r\n                            </select>\r\n                          `;\r\n                        })()}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <div class=\"about-setting-group\">\r\n                    <div class=\"about-setting-title\">æä¾›å•†é…ç½®</div>\r\n                    <div class=\"settings-form\">\r\n                      <div class=\"settings-field\">\r\n                        <label class=\"settings-label\">API åœ°å€</label>\r\n                        <input class=\"settings-input\" type=\"text\" .value=${state.modelConfigDraft.baseUrl} @input=${(e: Event) => { state.modelConfigDraft.baseUrl = (e.target as HTMLInputElement).value; }} placeholder=\"å¦‚: https://api.openai.com/v1\" />\r\n                      </div>\r\n                      <div class=\"settings-field\">\r\n                        <label class=\"settings-label\">API Key</label>\r\n                        <div class=\"settings-input-wrap\">\r\n                          <input class=\"settings-input settings-input-key\" type=${state.apiKeyVisible ? \"text\" : \"password\"} .value=${state.modelConfigDraft.apiKey} @input=${(e: Event) => { state.modelConfigDraft.apiKey = (e.target as HTMLInputElement).value; }} placeholder=\"sk-...\" />\r\n                          <button class=\"settings-key-toggle\" type=\"button\" @click=${() => { state.apiKeyVisible = !state.apiKeyVisible; renderApp(); }} title=${state.apiKeyVisible ? \"éšè—\" : \"æ˜¾ç¤º\"}>\r\n                            ${state.apiKeyVisible ? html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94\"/><path d=\"M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19\"/><line x1=\"1\" y1=\"1\" x2=\"23\" y2=\"23\"/></svg>` : html`<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z\"/><circle cx=\"12\" cy=\"12\" r=\"3\"/></svg>`}\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"settings-field\">\r\n                        <label class=\"settings-label\">API åè®®</label>\r\n                        <select class=\"settings-input\" .value=${state.modelConfigDraft.api} @change=${(e: Event) => { state.modelConfigDraft.api = (e.target as HTMLSelectElement).value; renderApp(); }}>\r\n                          <option value=\"openai-completions\">OpenAI å…¼å®¹ (é€šä¹‰åƒé—®/DeepSeekç­‰)</option>\r\n                          <option value=\"openai-responses\">OpenAI Responses</option>\r\n                          <option value=\"anthropic-messages\">Anthropic Claude</option>\r\n                          <option value=\"google-generative-ai\">Google Gemini</option>\r\n                          <option value=\"github-copilot\">GitHub Copilot</option>\r\n                          <option value=\"bedrock-converse-stream\">AWS Bedrock</option>\r\n                        </select>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  ${state.modelError ? html`<div class=\"settings-error\">${state.modelError}</div>` : \"\"}\r\n                  ${state.confirmingModelSave ? html`\r\n                    <div class=\"model-confirm-overlay\">\r\n                      <div class=\"model-confirm-dialog\">\r\n                        <div class=\"model-confirm-title\">ç¡®è®¤æ›´æ¢æ¨¡å‹</div>\r\n                        <div class=\"model-confirm-info\">\r\n                          <div class=\"model-confirm-row\"><span class=\"model-confirm-label\">æä¾›å•†</span><span class=\"model-confirm-value\">${state.modelConfigDraft.provider}</span></div>\r\n                          <div class=\"model-confirm-row\"><span class=\"model-confirm-label\">æ¨¡å‹</span><span class=\"model-confirm-value\">${state.modelConfigDraft.modelId}</span></div>\r\n                          <div class=\"model-confirm-row\"><span class=\"model-confirm-label\">API åœ°å€</span><span class=\"model-confirm-value\">${state.modelConfigDraft.baseUrl}</span></div>\r\n                          <div class=\"model-confirm-row\"><span class=\"model-confirm-label\">API åè®®</span><span class=\"model-confirm-value\">${state.modelConfigDraft.api}</span></div>\r\n                        </div>\r\n                        <div class=\"model-confirm-hint\">æ›´æ¢æ¨¡å‹åæœåŠ¡å°†è‡ªåŠ¨é‡å¯</div>\r\n                        <div class=\"model-confirm-actions\">\r\n                          <button class=\"model-confirm-btn cancel\" @click=${() => { state.confirmingModelSave = false; renderApp(); }}>å–æ¶ˆ</button>\r\n                          <button class=\"model-confirm-btn confirm\" @click=${() => { state.confirmingModelSave = false; saveModelConfig(); }} ?disabled=${state.modelSaving}>\r\n                            ${state.modelSaving ? \"ä¿å­˜ä¸­...\" : \"ç¡®è®¤æ›´æ¢\"}\r\n                          </button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ` : html`\r\n                    <button class=\"settings-save-btn\" @click=${() => { state.confirmingModelSave = true; state.modelError = null; renderApp(); }} ?disabled=${state.modelSaving}>\r\n                      ä¿å­˜é…ç½®\r\n                    </button>\r\n                  `}\r\n                `}\r\n              </div>\r\n              ` : html`\r\n              <!-- Settings Main View -->\r\n              <div class=\"about-settings\">\r\n                <div class=\"about-setting-group\">\r\n                  <div class=\"about-setting-title\">æ¨¡å‹</div>\r\n                  <div class=\"about-setting-row\">\r\n                    <button class=\"about-action-btn\" @click=${() => { state.settingsView = \"model\"; loadModelConfig(); renderApp(); }}>\r\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                        <path d=\"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z\"/>\r\n                        <polyline points=\"3.27 6.96 12 12.01 20.73 6.96\"/>\r\n                        <line x1=\"12\" y1=\"22.08\" x2=\"12\" y2=\"12\"/>\r\n                      </svg>\r\n                      <span>æ¨¡å‹é…ç½®</span>\r\n                      ${state.modelList.length > 0 ? html`<span class=\"settings-model-tag\">${state.modelConfigDraft.modelId || state.modelList[0]?.name || state.modelList[0]?.id}</span>` : \"\"}\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n                <div class=\"about-setting-group\">\r\n                  <div class=\"about-setting-title\">å­—ä½“å¤§å°</div>\r\n                  <div class=\"font-size-picker\">\r\n                    ${([\"small\", \"medium\", \"large\", \"xlarge\"] as const).map(size => {\r\n                      const label = size === \"small\" ? \"å°\" : size === \"medium\" ? \"ä¸­\" : size === \"large\" ? \"å¤§\" : \"è¶…å¤§\";\r\n                      const px = size === \"small\" ? \"12px\" : size === \"medium\" ? \"14px\" : size === \"large\" ? \"16px\" : \"19px\";\r\n                      return html`\r\n                      <button class=\"font-size-btn ${state.fontSize === size ? \"font-size-btn--active\" : \"\"}\"\r\n                        @click=${() => { state.fontSize = size; localStorage.setItem(\"taxbot_font_size\", size); document.documentElement.setAttribute(\"data-font-size\", size); renderApp(); }}>\r\n                        <span class=\"font-size-btn__label\" style=\"font-size:${px}\">${label}</span>\r\n                        <span class=\"font-size-btn__sample\" style=\"font-size:${px}\">Aa</span>\r\n                      </button>`;\r\n                    })}\r\n                  </div>\r\n                </div>\r\n                <div class=\"about-setting-group\">\r\n                  <div class=\"about-setting-title\">çŸ¥è¯†åº“</div>\r\n                  <div class=\"about-setting-row\">\r\n                    <button class=\"about-action-btn\" @click=${() => { handleAuthorizeFolder(); }} ?disabled=${state.importingFolder}>\r\n                      <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                        <path d=\"M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z\"/>\r\n                      </svg>\r\n                      <span>${state.importingFolder ? \"å¯¼å…¥ä¸­...\" : \"æˆæƒè®¿é—®æ–‡ä»¶å¤¹\"}</span>\r\n                      ${state.authorizedFolder ? html`\r\n                        <span class=\"settings-folder-info\">\r\n                          <span class=\"settings-folder-path\" title=${state.authorizedFolder}>${state.authorizedFolder}</span>\r\n                          <button class=\"settings-folder-refresh\" @click=${(e: Event) => { e.stopPropagation(); handleRefreshFolder(); }} ?disabled=${state.importingFolder} title=\"é‡æ–°è¯»å–æ–‡ä»¶å¤¹\">\r\n                            <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                              <path d=\"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8\"/>\r\n                              <path d=\"M21 3v5h-5\"/>\r\n                              <path d=\"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16\"/>\r\n                              <path d=\"M3 21v-5h5\"/>\r\n                            </svg>\r\n                          </button>\r\n                        </span>\r\n                      ` : \"\"}\r\n                    </button>\r\n                    ${state.importResult ? html`<div class=\"about-folder-status\">${state.importResult}</div>` : \"\"}\r\n                  </div>\r\n                </div>\r\n                <div class=\"about-setting-group\">\r\n                  <div class=\"about-setting-title\">æ•°æ®ç®¡ç†</div>\r\n                  <div class=\"about-setting-row\">\r\n                    ${state.confirmingClear ? html`\r\n                      <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n                        <span class=\"about-confirm-hint\" style=\"margin: 0;\">ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å¯¹è¯è®°å½•ï¼Ÿ</span>\r\n                        <button class=\"about-confirm-btn confirm\" @click=${() => { doClearAll(); }}>ç¡®è®¤</button>\r\n                        <button class=\"about-confirm-btn cancel\" @click=${() => { state.confirmingClear = false; renderApp(); }}>å–æ¶ˆ</button>\r\n                      </div>\r\n                    ` : html`\r\n                      <button class=\"about-action-btn danger\" @click=${() => { state.confirmingClear = true; renderApp(); }}>\r\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                          <polyline points=\"3 6 5 6 21 6\"/>\r\n                          <path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/>\r\n                        </svg>\r\n                        <span>æ¸…ç©ºå¯¹è¯è®°å½•</span>\r\n                      </button>\r\n                    `}\r\n                  </div>\r\n                  <div class=\"about-setting-row\" style=\"margin-top: 8px;\">\r\n                    ${state.confirmingSessionClear ? html`\r\n                      <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n                        <span class=\"about-confirm-hint\" style=\"margin: 0;\">ç¡®è®¤æ¸…ç©ºæœåŠ¡ç«¯ä¼šè¯ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</span>\r\n                        <button class=\"about-confirm-btn confirm\" @click=${() => { doClearSession(); }}>ç¡®è®¤</button>\r\n                        <button class=\"about-confirm-btn cancel\" @click=${() => { state.confirmingSessionClear = false; renderApp(); }}>å–æ¶ˆ</button>\r\n                      </div>\r\n                    ` : html`\r\n                      <button class=\"about-action-btn danger\" @click=${() => { state.confirmingSessionClear = true; renderApp(); }}>\r\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                          <path d=\"M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17\"/>\r\n                        </svg>\r\n                        <span>æ¸…ç©º Session</span>\r\n                      </button>\r\n                    `}\r\n                  </div>\r\n                </div>\r\n                <div class=\"about-setting-group\">\r\n                  <div class=\"about-setting-title\">åº”ç”¨</div>\r\n                  <div class=\"about-setting-row\">\r\n                    ${state.confirmingExit ? html`\r\n                      <div style=\"display: flex; align-items: center; gap: 8px;\">\r\n                        <span class=\"about-confirm-hint\" style=\"margin: 0;\">ç¡®è®¤é€€å‡ºï¼Ÿå°†å…³é—­çª—å£å¹¶å…³é—­ Gatewayã€‚</span>\r\n                        <button class=\"about-confirm-btn confirm\" @click=${() => { doExitApp(); }}>ç¡®è®¤é€€å‡º</button>\r\n                        <button class=\"about-confirm-btn cancel\" @click=${() => { state.confirmingExit = false; renderApp(); }}>å–æ¶ˆ</button>\r\n                      </div>\r\n                    ` : html`\r\n                      <button class=\"about-action-btn danger\" @click=${() => { state.confirmingExit = true; renderApp(); }}>\r\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n                          <path d=\"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4\"/>\r\n                          <polyline points=\"16 17 21 12 16 7\"/>\r\n                          <line x1=\"21\" y1=\"12\" x2=\"9\" y2=\"12\"/>\r\n                        </svg>\r\n                        <span>é€€å‡ºåº”ç”¨</span>\r\n                      </button>\r\n                    `}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              `}\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"about\" ? html`\r\n          <div class=\"side-panel-view about-view\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\">å…³äº</span>\r\n              <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n            <div class=\"side-panel-body about-fullscreen\">\r\n              <div class=\"about-hero\">\r\n                <div class=\"about-logo\">\r\n                  <img src=\"./assets/taxchat-logo.png\" alt=\"Taxbot\" />\r\n                </div>\r\n                <div class=\"about-hero-text\">\r\n                  <div class=\"about-title\">Taxbot Evo</div>\r\n                  <div class=\"about-subtitle\">AI ç¨åŠ¡åŠ©ç† Â· v${TAXBOT_VERSION}</div>\r\n                </div>\r\n              </div>\r\n              <div class=\"about-desc\">é€šè¿‡ Skill å’Œ Agent å®ç°è´¢ç¨èƒ½åŠ›çš„è‡ªè¿›åŒ–</div>\r\n              <div class=\"about-cards\">\r\n                <div class=\"about-card\">\r\n                  <div class=\"about-card-icon\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"3\"/><path d=\"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z\"/></svg></div>\r\n                  <div class=\"about-card-label\">Skill æŠ€èƒ½</div>\r\n                  <div class=\"about-card-desc\">å®‰è£…ã€åˆ›å»ºã€åˆ†äº«æŠ€èƒ½åŒ…ï¼ŒæŒç»­æ‰©å±•èƒ½åŠ›è¾¹ç•Œ</div>\r\n                </div>\r\n                <div class=\"about-card\">\r\n                  <div class=\"about-card-icon\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"9\" cy=\"7\" r=\"4\"/><path d=\"M23 21v-2a4 4 0 0 0-3-3.87\"/><path d=\"M16 3.13a4 4 0 0 1 0 7.75\"/></svg></div>\r\n                  <div class=\"about-card-label\">Agent æ™ºèƒ½ä½“</div>\r\n                  <div class=\"about-card-desc\">åˆ›å»ºä¸“å±æ™ºèƒ½ä½“ï¼Œå‡ºç§Ÿåˆ°å¹¿åœºè‡ªåŠ¨æœåŠ¡èµšç§¯åˆ†</div>\r\n                </div>\r\n                <div class=\"about-card\">\r\n                  <div class=\"about-card-icon\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z\"/></svg></div>\r\n                  <div class=\"about-card-label\">æ™ºèƒ½å¯¹è¯</div>\r\n                  <div class=\"about-card-desc\">å¤šè½®å¯¹è¯ã€çŸ¥è¯†åº“å­¦ä¹ ã€æ–‡ä»¶åˆ†æ</div>\r\n                </div>\r\n                <div class=\"about-card\">\r\n                  <div class=\"about-card-icon\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"23 6 13.5 15.5 8.5 10.5 1 18\"/><polyline points=\"17 6 23 6 23 12\"/></svg></div>\r\n                  <div class=\"about-card-label\">è‡ªè¿›åŒ–</div>\r\n                  <div class=\"about-card-desc\">æŠ€èƒ½è¶Šè£…è¶Šå¤šã€æ™ºèƒ½ä½“è¶Šç”¨è¶Šå¼ºã€è®°å¿†æŒç»­ç§¯ç´¯</div>\r\n                </div>\r\n              </div>\r\n              <div class=\"about-divider\"></div>\r\n              <div class=\"about-guide\">\r\n                <div class=\"about-setting-title\">åŠŸèƒ½ä½¿ç”¨å‘å¯¼</div>\r\n\r\n                <!-- 1. æ™ºèƒ½å¯¹è¯ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">1</span> æ™ºèƒ½å¯¹è¯</div>\r\n                  <div class=\"qs-section-desc\">åœ¨ä¸»èŠå¤©åŒºç›´æ¥è¾“å…¥é—®é¢˜ï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€æ–‡ä»¶ä¸Šä¼ åˆ†æã€‚AI å›å¤æ”¯æŒå¤åˆ¶ã€å¯¼å‡º Wordã€æ”¶è—ã€å­˜å…¥çŸ¥è¯†åº“ç­‰æ“ä½œã€‚å¯ç”¨ @æ™ºèƒ½ä½“å æŒ‡å®šç‰¹å®šæ™ºèƒ½ä½“å›ç­”ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#34d399;\"></span> å¯¹è¯çª—å£</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-chat-row right\"><div class=\"guide-bubble guide-bubble--user\">å¸®æˆ‘åˆ†æè¿™å¼ å¢å€¼ç¨å‘ç¥¨æœ‰ä»€ä¹ˆé£é™©ï¼Ÿ</div></div>\r\n                      <div class=\"guide-chat-row\"><div class=\"guide-bubble guide-bubble--ai\">æ ¹æ®å‘ç¥¨ä¿¡æ¯åˆ†æï¼Œå‘ç°ä»¥ä¸‹ 2 ä¸ªé£é™©ç‚¹ï¼š<br>1. ç¨ç‡ä¸å•†å“ç¼–ç ä¸åŒ¹é…...<br>2. å¼€ç¥¨æ—¥æœŸæ™šäºåˆåŒçº¦å®š...</div></div>\r\n                      <div class=\"guide-actions\">\r\n                        <span class=\"guide-action-tag\">ğŸ“‹ å¤åˆ¶</span>\r\n                        <span class=\"guide-action-tag\">ğŸ“„ å¯¼å‡ºWord</span>\r\n                        <span class=\"guide-action-tag\">â­ æ”¶è—</span>\r\n                        <span class=\"guide-action-tag\">ğŸ“š å­˜å…¥çŸ¥è¯†åº“</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 2. å¤šå¯¹è¯ç®¡ç† -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">2</span> å¤šå¯¹è¯ç®¡ç†</div>\r\n                  <div class=\"qs-section-desc\">å·¦ä¾§æ \"å¯¹è¯\"é¢æ¿å¯åˆ›å»ºå¤šä¸ªç‹¬ç«‹å¯¹è¯ï¼Œæ¯ä¸ªå¯¹è¯æœ‰ç‹¬ç«‹çš„æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡ã€‚åˆ‡æ¢å¯¹è¯æ—¶ AI å›å¤ä¸ä¸­æ–­ï¼Œå›å¤å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºæœªè¯»æ ‡è®°ã€‚å¯¹è¯åˆ—è¡¨æŒ‰æœ€åç‚¹å‡»é¡ºåºæ’åˆ—ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#3b82f6;\"></span> å¯¹è¯åˆ—è¡¨</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-conv-item guide-conv-item--active\">\r\n                        <span>ğŸ’¬</span>\r\n                        <span class=\"guide-conv-title\">å¢å€¼ç¨å‘ç¥¨é£é™©åˆ†æ</span>\r\n                        <span class=\"guide-conv-meta\">åˆšåˆš</span>\r\n                      </div>\r\n                      <div class=\"guide-conv-item guide-conv-item--unread\">\r\n                        <span class=\"guide-conv-dot\"></span>\r\n                        <span class=\"guide-conv-title\" style=\"font-weight:600;\">ä¼ä¸šæ‰€å¾—ç¨ç­¹åˆ’æ–¹æ¡ˆ</span>\r\n                        <span class=\"guide-conv-meta\" style=\"color:#0284c7;\">å›å¤ä¸­...</span>\r\n                      </div>\r\n                      <div class=\"guide-conv-item\">\r\n                        <span>ğŸ’¬</span>\r\n                        <span class=\"guide-conv-title\">ä¸ªç¨å¹´åº¦æ±‡ç®—æ¸…ç¼´</span>\r\n                        <span class=\"guide-conv-meta\">æ˜¨å¤©</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 3. Skill æŠ€èƒ½ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">3</span> Skill æŠ€èƒ½</div>\r\n                  <div class=\"qs-section-desc\">æ¯ä¸ª Skill æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è´¢ç¨èƒ½åŠ›å•å…ƒã€‚å†…ç½®æ ¸å¿ƒæŠ€èƒ½å¯ç›´æ¥ä½¿ç”¨ï¼Œè¿˜å¯ä» TaxStore å¸‚åœºå®‰è£…ç¤¾åŒºæŠ€èƒ½ï¼Œæˆ–è‡ªå·±åˆ›å»ºå¹¶åˆ†äº«ã€‚ç‚¹å‡»å·¦ä¾§æ \"æˆ‘çš„æŠ€èƒ½\"ç®¡ç†æŠ€èƒ½ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#8b5cf6;\"></span> æˆ‘çš„æŠ€èƒ½</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-skill-item\">\r\n                        <span class=\"guide-skill-emoji\">ğŸ›¡ï¸</span>\r\n                        <div class=\"guide-skill-text\"><div class=\"guide-skill-name\">ç¨åŠ¡é£é™©æ²»ç†</div><div class=\"guide-skill-desc\">è¯†åˆ«çº³ç¨é£é™©å¹¶ç”Ÿæˆæ²»ç†æ–¹æ¡ˆ</div></div>\r\n                        <span class=\"guide-skill-badge\">å†…ç½®</span>\r\n                      </div>\r\n                      <div class=\"guide-skill-item\">\r\n                        <span class=\"guide-skill-emoji\">ğŸ“‹</span>\r\n                        <div class=\"guide-skill-text\"><div class=\"guide-skill-name\">ç”³æŠ¥è¡¨é¢„å®¡</div><div class=\"guide-skill-desc\">å®¡æ ¸ç”³æŠ¥è¡¨æ•°æ®é€»è¾‘</div></div>\r\n                        <span class=\"guide-skill-badge\">å†…ç½®</span>\r\n                      </div>\r\n                      <div class=\"guide-skill-item\">\r\n                        <span class=\"guide-skill-emoji\">ğŸª</span>\r\n                        <div class=\"guide-skill-text\"><div class=\"guide-skill-name\">æ›´å¤šæŠ€èƒ½...</div><div class=\"guide-skill-desc\">ä» TaxStore å¸‚åœºå®‰è£…</div></div>\r\n                        <span class=\"guide-skill-badge\" style=\"background:#dcfce7;color:#16a34a;\">å¸‚åœº</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 4. Agent æ™ºèƒ½ä½“ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">4</span> Agent æ™ºèƒ½ä½“</div>\r\n                  <div class=\"qs-section-desc\">åˆ›å»ºæ‹¥æœ‰ä¸“å±èº«ä»½ã€è®°å¿†å’Œä¸“é•¿çš„æ™ºèƒ½ä½“ã€‚åœ¨å¯¹è¯ä¸­ç”¨ @æ™ºèƒ½ä½“å è°ƒç”¨ï¼Œæˆ–å‘å¸ƒåˆ°å¹¿åœºå‡ºç§Ÿèµšå–ç§¯åˆ†ã€‚æ¯æ¬¡å®Œæˆä»»åŠ¡åæ™ºèƒ½ä½“è‡ªåŠ¨ç§¯ç´¯ç»éªŒè®°å¿†ï¼Œè¶Šç”¨è¶Šå¼ºã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#f59e0b;\"></span> æ™ºèƒ½ä½“ç”Ÿå‘½å‘¨æœŸ</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-flow\">\r\n                        <div class=\"guide-flow-step\"><div class=\"guide-flow-icon\" style=\"background:#dbeafe;\">âœï¸</div><div class=\"guide-flow-label\">åˆ›å»ºæ™ºèƒ½ä½“</div></div>\r\n                        <span class=\"guide-flow-arrow\">â†’</span>\r\n                        <div class=\"guide-flow-step\"><div class=\"guide-flow-icon\" style=\"background:#fef3c7;\">ğŸ’¬</div><div class=\"guide-flow-label\">å¯¹è¯ä¸­ä½¿ç”¨</div></div>\r\n                        <span class=\"guide-flow-arrow\">â†’</span>\r\n                        <div class=\"guide-flow-step\"><div class=\"guide-flow-icon\" style=\"background:#dcfce7;\">ğŸª</div><div class=\"guide-flow-label\">å‘å¸ƒåˆ°å¹¿åœº</div></div>\r\n                        <span class=\"guide-flow-arrow\">â†’</span>\r\n                        <div class=\"guide-flow-step\"><div class=\"guide-flow-icon\" style=\"background:#fce7f3;\">ğŸ’°</div><div class=\"guide-flow-label\">è‡ªåŠ¨èµšç§¯åˆ†</div></div>\r\n                        <span class=\"guide-flow-arrow\">â†’</span>\r\n                        <div class=\"guide-flow-step\"><div class=\"guide-flow-icon\" style=\"background:#ede9fe;\">ğŸ§ </div><div class=\"guide-flow-label\">ç§¯ç´¯è®°å¿†</div></div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 5. çŸ¥è¯†åº“ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">5</span> çŸ¥è¯†åº“</div>\r\n                  <div class=\"qs-section-desc\">æˆæƒæœ¬åœ°æ–‡ä»¶å¤¹åï¼Œè´¢ç¨æ–‡ä»¶ï¼ˆPDFã€Wordã€Excel ç­‰ï¼‰è‡ªåŠ¨å­¦ä¹ å…¥åº“ã€‚çŸ¥è¯†åº“ä¸ºå¯¹è¯å’ŒæŠ€èƒ½æä¾›ä¸“ä¸šä¸Šä¸‹æ–‡ï¼Œè®© AI å›ç­”æ›´ç²¾å‡†ã€‚è¿˜å¯å°†é‡è¦å›å¤ç›´æ¥å­˜å…¥çŸ¥è¯†åº“ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#10b981;\"></span> çŸ¥è¯†åº“æ–‡ä»¶</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-file-row\">\r\n                        <span class=\"guide-file-icon\">ğŸ“„</span>\r\n                        <span class=\"guide-file-name\">2024å¹´ä¼ä¸šæ‰€å¾—ç¨æ±‡ç®—æ¸…ç¼´.pdf</span>\r\n                        <span class=\"guide-file-size\">2.4 MB</span>\r\n                        <span class=\"guide-file-status\">âœ“ å·²å­¦ä¹ </span>\r\n                      </div>\r\n                      <div class=\"guide-file-row\">\r\n                        <span class=\"guide-file-icon\">ğŸ“Š</span>\r\n                        <span class=\"guide-file-name\">å¢å€¼ç¨ç”³æŠ¥è¡¨æ¨¡æ¿.xlsx</span>\r\n                        <span class=\"guide-file-size\">856 KB</span>\r\n                        <span class=\"guide-file-status\">âœ“ å·²å­¦ä¹ </span>\r\n                      </div>\r\n                      <div class=\"guide-file-row\">\r\n                        <span class=\"guide-file-icon\">ğŸ“</span>\r\n                        <span class=\"guide-file-name\">ç¨åŠ¡é£é™©æ£€æŸ¥æ¸…å•.docx</span>\r\n                        <span class=\"guide-file-size\">128 KB</span>\r\n                        <span class=\"guide-file-status\" style=\"color:#f59e0b;\">âŸ³ å­¦ä¹ ä¸­</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 6. AIä¸“å®¶å’¨è¯¢ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">6</span> AIä¸“å®¶å’¨è¯¢</div>\r\n                  <div class=\"qs-section-desc\">åœ¨å·¦ä¾§æ \"AIä¸“å®¶å’¨è¯¢\"ä¸­ï¼Œæµè§ˆå¹¿åœºä¸Šå…¶ä»–ç”¨æˆ·å‘å¸ƒçš„ä¸“ä¸šæ™ºèƒ½ä½“ï¼Œä»˜ç§¯åˆ†æäº¤å’¨è¯¢ä»»åŠ¡ã€‚æ™ºèƒ½ä½“ä¸»äººå®¡æ ¸åè‡ªåŠ¨å¤„ç†ï¼Œå®Œæˆåå¯æŸ¥çœ‹ç»“æœã€ç•™è¨€æ²Ÿé€šã€ç”³è¯·ä¿®è®¢å’Œè¯„åˆ†ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#ec4899;\"></span> å’¨è¯¢æµç¨‹</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-consult-flow\">\r\n                        <div class=\"guide-consult-step\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#3b82f6\" stroke-width=\"2\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg> æµè§ˆå¹¿åœº</div>\r\n                        <span class=\"guide-consult-arrow\">â†’</span>\r\n                        <div class=\"guide-consult-step\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#8b5cf6\" stroke-width=\"2\"><line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"/><polygon points=\"22 2 15 22 11 13 2 9 22 2\"/></svg> æäº¤ä»»åŠ¡</div>\r\n                        <span class=\"guide-consult-arrow\">â†’</span>\r\n                        <div class=\"guide-consult-step\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#f59e0b\" stroke-width=\"2\"><path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"8.5\" cy=\"7\" r=\"4\"/><polyline points=\"17 11 19 13 23 9\"/></svg> ä¸»äººå®¡æ ¸</div>\r\n                        <span class=\"guide-consult-arrow\">â†’</span>\r\n                        <div class=\"guide-consult-step\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#10b981\" stroke-width=\"2\"><path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\"/></svg> AIå¤„ç†</div>\r\n                        <span class=\"guide-consult-arrow\">â†’</span>\r\n                        <div class=\"guide-consult-step\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#ec4899\" stroke-width=\"2\"><path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></svg> æŸ¥çœ‹ç»“æœ</div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 7. æ¶ˆæ¯ä¸­å¿ƒ -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">7</span> æ¶ˆæ¯ä¸­å¿ƒ</div>\r\n                  <div class=\"qs-section-desc\">å³ä¸Šè§’ ğŸ”” æ¶ˆæ¯ä¸­å¿ƒå®æ—¶æ¨é€ä»»åŠ¡é€šçŸ¥ã€ç•™è¨€æé†’ã€æŠ€èƒ½æ›´æ–°ç­‰ã€‚ç‚¹å‡»é€šçŸ¥å¯ç›´æ¥è·³è½¬åˆ°å¯¹åº”åŠŸèƒ½é¡µé¢ï¼šå‡ºç§Ÿä»»åŠ¡é€šçŸ¥ â†’ ä»»åŠ¡å¤„ç†é¢æ¿ï¼Œå’¨è¯¢é€šçŸ¥ â†’ å’¨è¯¢è¯¦æƒ…é¡µã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#ef4444;\"></span> æ¶ˆæ¯é€šçŸ¥</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-notif-item\">\r\n                        <span class=\"guide-notif-icon\">ğŸ“‹</span>\r\n                        <div><div class=\"guide-notif-text\">æ‚¨æ”¶åˆ°æ–°çš„å’¨è¯¢ä»»åŠ¡ï¼šå¢å€¼ç¨è¿›é¡¹ç¨é¢è½¬å‡ºé—®é¢˜</div><div class=\"guide-notif-hint\">ç‚¹å‡»å¤„ç†ä»»åŠ¡</div></div>\r\n                        <span class=\"guide-notif-time\">2åˆ†é’Ÿå‰</span>\r\n                      </div>\r\n                      <div class=\"guide-notif-item\">\r\n                        <span class=\"guide-notif-icon\">âœ…</span>\r\n                        <div><div class=\"guide-notif-text\">æ‚¨çš„å’¨è¯¢\"ä¸ªç¨ä¸“é¡¹æ‰£é™¤\"å·²å®Œæˆï¼Œå¿«å»æŸ¥çœ‹ç»“æœå§</div><div class=\"guide-notif-hint\">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div></div>\r\n                        <span class=\"guide-notif-time\">10åˆ†é’Ÿå‰</span>\r\n                      </div>\r\n                      <div class=\"guide-notif-item\">\r\n                        <span class=\"guide-notif-icon\">ğŸ’¬</span>\r\n                        <div><div class=\"guide-notif-text\">æ™ºèƒ½ä½“ç»™ä½ å‘äº†æ–°ç•™è¨€</div><div class=\"guide-notif-hint\">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div></div>\r\n                        <span class=\"guide-notif-time\">1å°æ—¶å‰</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <!-- 8. æ”¶è— -->\r\n                <div class=\"qs-section\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-section-title\"><span class=\"qs-section-num\">8</span> æ”¶è—ä¸æœç´¢</div>\r\n                  <div class=\"qs-section-desc\">å¯¹è¯ä¸­ç‚¹å‡» â­ æ”¶è—é‡è¦å›å¤ã€‚æ”¶è—é¢æ¿æ±‡èšæ‰€æœ‰å¯¹è¯ä¸­çš„æ”¶è—å†…å®¹ï¼Œç‚¹å‡»å¯è·³è½¬åˆ°å¯¹åº”å¯¹è¯ã€‚è¿˜å¯ä½¿ç”¨æœç´¢åŠŸèƒ½ï¼ˆCtrl+Fï¼‰åœ¨å½“å‰å¯¹è¯ä¸­æŸ¥æ‰¾æ¶ˆæ¯ã€‚</div>\r\n                  <div class=\"guide-illust\">\r\n                    <div class=\"guide-illust-bar\"><span style=\"width:8px;height:8px;border-radius:50%;background:#f59e0b;\"></span> æ”¶è—å¤¹</div>\r\n                    <div class=\"guide-illust-body\">\r\n                      <div class=\"guide-fav-item\">\r\n                        <span class=\"guide-fav-star\">â­</span>\r\n                        <div class=\"guide-fav-text\">å¢å€¼ç¨è¿›é¡¹ç¨é¢è½¬å‡ºçš„ 5 ç§å¸¸è§æƒ…å½¢åŠå¤„ç†æ–¹æ³•...</div>\r\n                      </div>\r\n                      <div class=\"guide-fav-item\">\r\n                        <span class=\"guide-fav-star\">â­</span>\r\n                        <div style=\"flex:1;\">\r\n                          <div class=\"guide-fav-text\">ä¼ä¸šæ‰€å¾—ç¨æ±‡ç®—æ¸…ç¼´ A105000 è¡¨å¡«æŠ¥è¦ç‚¹...</div>\r\n                          <span class=\"guide-fav-tag\">ä¼ä¸šæ‰€å¾—ç¨ç­¹åˆ’æ–¹æ¡ˆ</span>\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"guide-fav-item\">\r\n                        <span class=\"guide-fav-star\">â­</span>\r\n                        <div class=\"guide-fav-text\">ä¸ªç¨å¹´ç»ˆå¥–å•ç‹¬è®¡ç¨ vs å¹¶å…¥ç»¼åˆæ‰€å¾—å¯¹æ¯”åˆ†æ...</div>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div class=\"qs-tips-grid\" style=\"padding:0 0 20px;\">\r\n                  <div class=\"qs-tip-card\" style=\"background:#f0f9ff;\"><b style=\"color:#1B3A5C;\">Skill è‡ªè¿›åŒ–</b>ä»å¸‚åœºå®‰è£…æŠ€èƒ½ï¼Œæˆ–è‡ªå·±åˆ›å»ºå¹¶åˆ†äº«ç»™ç¤¾åŒºã€‚</div>\r\n                  <div class=\"qs-tip-card\" style=\"background:#fefce8;\"><b style=\"color:#a16207;\">Agent è‡ªè¿›åŒ–</b>æ™ºèƒ½ä½“åœ¨å®Œæˆä»»åŠ¡ä¸­ç§¯ç´¯è®°å¿†ï¼Œèƒ½åŠ›æŒç»­æˆé•¿ã€‚</div>\r\n                  <div class=\"qs-tip-card\" style=\"background:#f0fdf4;\"><b style=\"color:#15803d;\">å‡ºç§Ÿèµšç§¯åˆ†</b>å‘å¸ƒæ™ºèƒ½ä½“åˆ°å¹¿åœºï¼Œè¢«ä½¿ç”¨æ—¶è‡ªåŠ¨èµšå–ç§¯åˆ†æ”¶ç›Šã€‚</div>\r\n                  <div class=\"qs-tip-card\" style=\"background:#fdf2f8;\"><b style=\"color:#be185d;\">çŸ¥è¯†åº“è‡ªå­¦ä¹ </b>æˆæƒæ–‡ä»¶å¤¹åæ–°æ–‡ä»¶è‡ªåŠ¨å­¦ä¹ ï¼Œè¶Šç”¨è¶Šæ‡‚ä½ ã€‚</div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        ${state.sidePanel === \"consult\" ? html`\r\n          <div class=\"side-panel-view consult-view\" style=\"display:flex;flex-direction:column;overflow:hidden;\">\r\n            <div class=\"side-panel-header\">\r\n              <span class=\"panel-title\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" style=\"vertical-align:-2px;margin-right:4px;\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg> ${state.consultView === \"list\" ? \"AIä¸“å®¶å’¨è¯¢ï¼ˆä¸“ä¸šæ™ºèƒ½ä½“ï¼‰\" : state.consultView === \"detail\" ? \"æ™ºèƒ½ä½“è¯¦æƒ…\" : state.consultView === \"my-tasks\" ? \"æˆ‘çš„å’¨è¯¢\" : \"å’¨è¯¢è¯¦æƒ…\"}</span>\r\n              <div style=\"display:flex;gap:6px;align-items:center;\">\r\n                ${state.consultView === \"list\" ? html`\r\n                  <button class=\"consult-mytasks-btn\" @click=${() => { openConsultMyTasks(); }} title=\"æˆ‘çš„å’¨è¯¢\">\r\n                    ğŸ“‹ æˆ‘çš„å’¨è¯¢${state.consultUnreadCount > 0 ? html`<span class=\"consult-unread-badge\" style=\"margin-left:4px;\">${state.consultUnreadCount}</span>` : \"\"}\r\n                  </button>\r\n                ` : \"\"}\r\n                <button class=\"side-panel-close\" @click=${() => { state.sidePanel = null; renderApp(); }} title=\"å…³é—­\">âœ•</button>\r\n              </div>\r\n            </div>\r\n            <div style=\"flex:1;overflow-y:auto;padding:16px;\">\r\n              ${state.consultView === \"list\" ? html`\r\n                <!-- Flow introduction -->\r\n                <div class=\"consult-flow\">\r\n                  <div class=\"consult-flow-step\">\r\n                    <div class=\"consult-flow-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"11\" cy=\"11\" r=\"8\"/><line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\"/></svg></div>\r\n                    <div class=\"consult-flow-label\">é€‰æ‹©æ™ºèƒ½ä½“</div>\r\n                  </div>\r\n                  <div class=\"consult-flow-arrow\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#9ca3af\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"/></svg></div>\r\n                  <div class=\"consult-flow-step\">\r\n                    <div class=\"consult-flow-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"/><polygon points=\"22 2 15 22 11 13 2 9 22 2\"/></svg></div>\r\n                    <div class=\"consult-flow-label\">å‘å¸ƒä»»åŠ¡</div>\r\n                  </div>\r\n                  <div class=\"consult-flow-arrow\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#9ca3af\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"/></svg></div>\r\n                  <div class=\"consult-flow-step\">\r\n                    <div class=\"consult-flow-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"11\" width=\"18\" height=\"10\" rx=\"2\"/><circle cx=\"12\" cy=\"5\" r=\"3\"/></svg></div>\r\n                    <div class=\"consult-flow-label\">æ™ºèƒ½ä½“å¤„ç†</div>\r\n                  </div>\r\n                  <div class=\"consult-flow-arrow\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#9ca3af\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"/></svg></div>\r\n                  <div class=\"consult-flow-step\">\r\n                    <div class=\"consult-flow-icon\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"8.5\" cy=\"7\" r=\"4\"/><polyline points=\"17 11 19 13 23 9\"/></svg></div>\r\n                    <div class=\"consult-flow-label\">ä¸»äººå®¡æ ¸ç¡®è®¤</div>\r\n                  </div>\r\n                  <div class=\"consult-flow-arrow\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#9ca3af\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"9 18 15 12 9 6\"/></svg></div>\r\n                  <div class=\"consult-flow-step\">\r\n                    <div class=\"consult-flow-icon consult-flow-icon--done\"><svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#059669\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M22 11.08V12a10 10 0 1 1-5.93-9.14\"/><polyline points=\"22 4 12 14.01 9 11.01\"/></svg></div>\r\n                    <div class=\"consult-flow-label\">è·å¾—ç»“æœ</div>\r\n                  </div>\r\n                </div>\r\n                <div class=\"consult-info-row\">\r\n                  <div class=\"consult-info-box\">\r\n                    <div class=\"consult-info-icon\"><svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z\"/><polyline points=\"9 12 11 14 15 10\"/></svg></div>\r\n                    <div>\r\n                      <div class=\"consult-info-title\">ä¸ºä»€ä¹ˆéœ€è¦æ™ºèƒ½ä½“ä¸»äººå®¡æ ¸ï¼Ÿ</div>\r\n                      <div class=\"consult-info-desc\">è´¢ç¨é¢†åŸŸä¸“ä¸šæ€§å¼ºï¼ŒAI ç”Ÿæˆçš„ç»“æœä»éœ€ä¸“ä¸šäººå‘˜æŠŠå…³ç¡®è®¤ï¼Œç¡®ä¿æ¯ä¸€ä»½äº¤ä»˜éƒ½å‡†ç¡®å¯é ã€‚</div>\r\n                    </div>\r\n                  </div>\r\n                  <div class=\"consult-info-box consult-info-box--stats\">\r\n                    <div class=\"consult-info-icon\"><svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#0284c7\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><polyline points=\"12 6 12 12 16 14\"/></svg></div>\r\n                    <div>\r\n                      <div class=\"consult-info-title\">å¹³å‡å®Œæˆæ—¶é—´</div>\r\n                      <div class=\"consult-info-desc\">${state.consultAvgTime || \"åŠ è½½ä¸­...\"}</div>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n                <!-- Search bar -->\r\n                <div class=\"consult-search-bar\">\r\n                  <input type=\"text\" placeholder=\"æœç´¢æ™ºèƒ½ä½“...\" .value=${state.consultSearch}\r\n                    @input=${(e: Event) => { state.consultSearch = (e.target as HTMLInputElement).value; }}\r\n                    @keydown=${(e: KeyboardEvent) => { if (e.key === \"Enter\") loadConsultAgents(); }}\r\n                  />\r\n                  <button @click=${() => loadConsultAgents()}>æœç´¢</button>\r\n                </div>\r\n                ${state.consultLoading ? html`<div class=\"consult-loading\">åŠ è½½ä¸­...</div>` : \"\"}\r\n                ${!state.consultLoading && state.consultAgents.length === 0 ? html`<div class=\"consult-empty\">æš‚æ— åœ¨çº¿æ™ºèƒ½ä½“</div>` : \"\"}\r\n                <div class=\"consult-agent-grid\">\r\n                  ${state.consultAgents.map(a => html`\r\n                    <div class=\"consult-agent-card\" @click=${() => openConsultDetail(a)}>\r\n                      <div class=\"consult-agent-card-top\">\r\n                        <div class=\"consult-agent-avatar\">\r\n                          ${agentAvatarSrc(a.avatarUrl) ? html`<img src=\"${agentAvatarSrc(a.avatarUrl)}\" alt=\"\" @error=${(e: Event) => { (e.target as HTMLImageElement).style.display = \"none\"; (e.target as HTMLImageElement).parentElement!.insertAdjacentHTML(\"beforeend\", `<span>${a.emoji || \"ğŸ¤–\"}</span>`); }} />` : html`<span>${a.emoji || \"ğŸ¤–\"}</span>`}\r\n                        </div>\r\n                        <div class=\"consult-agent-header\">\r\n                          <div class=\"consult-agent-name\">${a.name}</div>\r\n                          <div class=\"consult-agent-owner\">by ${a.owner?.name || \"åŒ¿å\"}</div>\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"consult-agent-desc\">${a.description}</div>\r\n                      <div class=\"consult-agent-footer\">\r\n                        <div class=\"consult-agent-stats\">\r\n                          ${a.avgRating > 0 ? html`<span class=\"consult-agent-rating\">â˜… ${a.avgRating.toFixed(1)}</span>` : \"\"}\r\n                          ${a.completedTasks > 0 ? html`<span class=\"consult-agent-tasks\">${a.completedTasks} å®Œæˆ</span>` : \"\"}\r\n                        </div>\r\n                        <div class=\"consult-agent-price\">ğŸ’° ${a.price} ç§¯åˆ†</div>\r\n                      </div>\r\n                    </div>\r\n                  `)}\r\n                </div>\r\n              ` : state.consultView === \"detail\" && state.consultSelectedAgent ? html`\r\n                <!-- Agent detail + task form -->\r\n                <button class=\"consult-back-btn\" @click=${() => backToConsultList()}>â† è¿”å›åˆ—è¡¨</button>\r\n                <div class=\"consult-detail-header\">\r\n                  <div class=\"consult-detail-avatar\">\r\n                    ${agentAvatarSrc(state.consultSelectedAgent.avatarUrl) ? html`<img src=\"${agentAvatarSrc(state.consultSelectedAgent.avatarUrl)}\" alt=\"\" @error=${(e: Event) => { (e.target as HTMLImageElement).style.display = \"none\"; (e.target as HTMLImageElement).parentElement!.insertAdjacentHTML(\"beforeend\", `<span>${state.consultSelectedAgent!.emoji || \"ğŸ¤–\"}</span>`); }} />` : html`<span>${state.consultSelectedAgent.emoji || \"ğŸ¤–\"}</span>`}\r\n                  </div>\r\n                  <div>\r\n                    <div class=\"consult-detail-name\">${state.consultSelectedAgent.name}</div>\r\n                    <div class=\"consult-detail-owner\">by ${state.consultSelectedAgent.owner.name}</div>\r\n                  </div>\r\n                </div>\r\n                <div class=\"consult-detail-desc\">${state.consultSelectedAgent.description}</div>\r\n                <div class=\"consult-detail-stats\">\r\n                  <span>ğŸ’° ${state.consultSelectedAgent.price} ç§¯åˆ†/æ¬¡</span>\r\n                  ${state.consultSelectedAgent.avgRating > 0 ? html`<span>â­ ${state.consultSelectedAgent.avgRating.toFixed(1)}</span>` : \"\"}\r\n                  <span>âœ… å·²å®Œæˆ ${state.consultSelectedAgent.completedTasks} å•</span>\r\n                </div>\r\n                ${!state.taxstoreToken ? html`\r\n                  <div class=\"consult-login-hint\">è¯·å…ˆåœ¨è®¾ç½®ä¸­ç™»å½• TaxStore è´¦æˆ·åå†æäº¤ä»»åŠ¡</div>\r\n                ` : html`\r\n                  <div class=\"consult-form\">\r\n                    <h4>æäº¤å’¨è¯¢ä»»åŠ¡</h4>\r\n                    <div class=\"consult-field\">\r\n                      <label>ä»»åŠ¡æ ‡é¢˜</label>\r\n                      <input type=\"text\" placeholder=\"è¯·ç®€è¦æè¿°æ‚¨çš„éœ€æ±‚\" .value=${state.consultTaskTitle}\r\n                        @input=${(e: Event) => { state.consultTaskTitle = (e.target as HTMLInputElement).value; scheduleRender(); }} />\r\n                    </div>\r\n                    <div class=\"consult-field\">\r\n                      <label>è¯¦ç»†æè¿°</label>\r\n                      <textarea placeholder=\"è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚ï¼Œè¶Šè¯¦ç»†è¶Šå¥½...\" .value=${state.consultTaskContent}\r\n                        @input=${(e: Event) => { state.consultTaskContent = (e.target as HTMLTextAreaElement).value; scheduleRender(); }}></textarea>\r\n                    </div>\r\n                    <div class=\"consult-field\">\r\n                      <label>é™„ä»¶ï¼ˆå¯é€‰ï¼‰</label>\r\n                      <div class=\"consult-attachments\">\r\n                        ${state.consultAttachments.map((att, i) => html`\r\n                          <div class=\"consult-att-item\">\r\n                            <span class=\"consult-att-icon\">${att.type?.startsWith(\"image/\") ? \"ğŸ–¼ï¸\" : \"ğŸ“\"}</span>\r\n                            <span class=\"consult-att-name\" title=${att.name}>${att.name}</span>\r\n                            <span class=\"consult-att-size\">${fmtSize(att.size)}</span>\r\n                            <button class=\"consult-att-remove\" @click=${() => removeConsultAttachment(i)} title=\"ç§»é™¤\">âœ•</button>\r\n                          </div>\r\n                        `)}\r\n                        ${state.consultUploading ? html`<div class=\"consult-att-uploading\">â³ ä¸Šä¼ ä¸­...</div>` : \"\"}\r\n                        <label class=\"consult-att-add-btn\">\r\n                          ğŸ“ æ·»åŠ é™„ä»¶\r\n                          <input type=\"file\" style=\"display:none\" @change=${(e: Event) => {\r\n                            const f = (e.target as HTMLInputElement).files?.[0];\r\n                            if (f) uploadConsultAttachment(f);\r\n                            (e.target as HTMLInputElement).value = \"\";\r\n                          }} />\r\n                        </label>\r\n                      </div>\r\n                    </div>\r\n                    <div class=\"consult-form-footer\">\r\n                      <span class=\"consult-form-price\">éœ€æ”¯ä»˜ ${state.consultSelectedAgent.price} ç§¯åˆ†</span>\r\n                      <button class=\"consult-submit-btn\" @click=${() => submitConsultTask()} ?disabled=${state.consultSubmitting || !state.consultTaskTitle.trim() || !state.consultTaskContent.trim()}>\r\n                        ${state.consultSubmitting ? \"æäº¤ä¸­...\" : \"æäº¤ä»»åŠ¡\"}\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n                `}\r\n              ` : state.consultView === \"my-tasks\" ? html`\r\n                <!-- My tasks list -->\r\n                <button class=\"consult-back-btn\" @click=${() => { state.consultView = \"list\"; scheduleRender(); }}>â† è¿”å›å¹¿åœº</button>\r\n                ${state.consultMyTasks.length === 0 ? html`<div class=\"consult-empty\">æš‚æ— å’¨è¯¢è®°å½•</div>` : \"\"}\r\n                <div class=\"consult-tasks-list\">\r\n                  ${state.consultMyTasks.map(t => html`\r\n                    <div class=\"consult-task-item consult-task-item--${t.status}\" @click=${() => openConsultTaskDetail(t)}>\r\n                      <div class=\"consult-task-item-icon\">\r\n                        ${agentAvatarSrc(t.listing?.avatarUrl) ? html`<img src=\"${agentAvatarSrc(t.listing?.avatarUrl)}\" alt=\"\" @error=${(e: Event) => { (e.target as HTMLImageElement).style.display = \"none\"; (e.target as HTMLImageElement).parentElement!.insertAdjacentHTML(\"beforeend\", `<span>${t.listing?.emoji || \"ğŸ¤–\"}</span>`); }} />` : html`<span>${t.listing?.emoji || \"ğŸ¤–\"}</span>`}\r\n                      </div>\r\n                      <div class=\"consult-task-item-body\">\r\n                        <div class=\"consult-task-item-title\">${t.title}</div>\r\n                        <div class=\"consult-task-item-meta\">\r\n                          ${t.listing?.name || \"æ™ºèƒ½ä½“\"} Â· ${t.status === \"pending\" ? \"ç­‰å¾…å¤„ç†\" : t.status === \"processing\" ? \"å¤„ç†ä¸­\" : t.status === \"completed\" ? \"å·²å®Œæˆ\" : t.status === \"revision_requested\" ? \"ä¿®è®¢ä¸­\" : t.status}\r\n                          Â· ${new Date(t.createdAt).toLocaleDateString(\"zh-CN\")}\r\n                        </div>\r\n                      </div>\r\n                      <div class=\"consult-task-item-right\">\r\n                        ${(t.unreadMessageCount || 0) > 0 ? html`<span class=\"consult-task-msg-badge\">ğŸ’¬ ${t.unreadMessageCount}</span>` : \"\"}\r\n                        <div class=\"consult-task-item-price\">ğŸ’° ${t.price}</div>\r\n                        ${t.status === \"completed\" ? html`<div class=\"consult-task-item-status consult-task-item-status--done\">å·²å®Œæˆ</div>` : t.status === \"pending\" ? html`<div class=\"consult-task-item-status consult-task-item-status--pending\">ç­‰å¾…ä¸­</div>` : html`<div class=\"consult-task-item-status consult-task-item-status--processing\">å¤„ç†ä¸­</div>`}\r\n                      </div>\r\n                    </div>\r\n                  `)}\r\n                </div>\r\n              ` : state.consultView === \"task-detail\" && state.consultSelectedTask ? html`\r\n                <!-- Task detail -->\r\n                <button class=\"consult-back-btn\" @click=${() => backFromConsultTaskDetail()}>â† è¿”å›åˆ—è¡¨</button>\r\n                <div class=\"consult-task-detail\">\r\n                  <div class=\"consult-task-detail-header\">\r\n                    <span class=\"consult-task-detail-emoji\">${agentAvatarSrc(state.consultSelectedTask.listing?.avatarUrl) ? html`<img src=\"${agentAvatarSrc(state.consultSelectedTask.listing?.avatarUrl)}\" alt=\"\" style=\"width:32px;height:32px;border-radius:8px;object-fit:cover;\" @error=${(e: Event) => { (e.target as HTMLImageElement).replaceWith(document.createTextNode(state.consultSelectedTask!.listing?.emoji || \"ğŸ¤–\")); }} />` : (state.consultSelectedTask.listing?.emoji || \"ğŸ¤–\")}</span>\r\n                    <div>\r\n                      <div class=\"consult-task-detail-title\">${state.consultSelectedTask.title}</div>\r\n                      <div class=\"consult-task-detail-meta\">\r\n                        ${state.consultSelectedTask.listing?.name || \"æ™ºèƒ½ä½“\"} Â· æäº¤äº ${new Date(state.consultSelectedTask.createdAt).toLocaleString(\"zh-CN\")}\r\n                        ${state.consultSelectedTask.completedAt ? html` Â· å®Œæˆäº ${new Date(state.consultSelectedTask.completedAt).toLocaleString(\"zh-CN\")}` : \"\"}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <div class=\"consult-task-detail-section\">\r\n                    <div class=\"consult-task-detail-label\">æˆ‘çš„æè¿°</div>\r\n                    <div class=\"consult-task-detail-content\">${state.consultSelectedTask.content}</div>\r\n                  </div>\r\n                  ${parseAtts(state.consultSelectedTask.attachments).length > 0 ? html`\r\n                    <div class=\"consult-task-detail-section\">\r\n                      <div class=\"consult-task-detail-label\">æˆ‘çš„é™„ä»¶</div>\r\n                      <div class=\"consult-att-list\">\r\n                        ${parseAtts(state.consultSelectedTask.attachments).map(att => html`\r\n                          <a class=\"consult-att-link\" href=${attUrl(att.url)} target=\"_blank\">\r\n                            ${att.type?.startsWith(\"image/\") ? html`<img class=\"consult-att-thumb\" src=${attUrl(att.url)} alt=${att.name} />` : html`<span class=\"consult-att-file-icon\">ğŸ“</span>`}\r\n                            <span class=\"consult-att-link-name\">${att.name}</span>\r\n                            <span class=\"consult-att-link-size\">${fmtSize(att.size)}</span>\r\n                          </a>\r\n                        `)}\r\n                      </div>\r\n                    </div>\r\n                  ` : \"\"}\r\n                  ${state.consultSelectedTask.result ? html`\r\n                    <div class=\"consult-task-detail-section\">\r\n                      <div class=\"consult-task-detail-label\">å¤„ç†ç»“æœ</div>\r\n                      <div class=\"consult-task-detail-result\">${state.consultSelectedTask.result}</div>\r\n                    </div>\r\n                    ${parseAtts(state.consultSelectedTask.resultAttachments).length > 0 ? html`\r\n                      <div class=\"consult-task-detail-section\">\r\n                        <div class=\"consult-task-detail-label\">ç»“æœé™„ä»¶</div>\r\n                        <div class=\"consult-att-list\">\r\n                          ${parseAtts(state.consultSelectedTask.resultAttachments).map(att => html`\r\n                            <a class=\"consult-att-link\" href=${attUrl(att.url)} target=\"_blank\">\r\n                              ${att.type?.startsWith(\"image/\") ? html`<img class=\"consult-att-thumb\" src=${attUrl(att.url)} alt=${att.name} />` : html`<span class=\"consult-att-file-icon\">ğŸ“</span>`}\r\n                              <span class=\"consult-att-link-name\">${att.name}</span>\r\n                              <span class=\"consult-att-link-size\">${fmtSize(att.size)}</span>\r\n                            </a>\r\n                          `)}\r\n                        </div>\r\n                      </div>\r\n                    ` : \"\"}\r\n                  ` : html`\r\n                    <div class=\"consult-task-detail-section\">\r\n                      <div class=\"consult-task-detail-waiting\">\r\n                        ${state.consultSelectedTask.status === \"pending\" ? \"â³ ç­‰å¾…æ™ºèƒ½ä½“ä¸»äººæ¥å•å¤„ç†...\" : state.consultSelectedTask.status === \"processing\" ? \"ğŸ”„ æ™ºèƒ½ä½“æ­£åœ¨å¤„ç†ä¸­...\" : state.consultSelectedTask.status === \"revision_requested\" ? \"ğŸ“ å·²è¯·æ±‚ä¿®è®¢ï¼Œç­‰å¾…å¤„ç†...\" : \"ç­‰å¾…å¤„ç†...\"}\r\n                      </div>\r\n                    </div>\r\n                  `}\r\n\r\n                  <!-- Action buttons row -->\r\n                  <div class=\"consult-td-actions\">\r\n                    <button class=\"consult-td-action-btn\" @click=${() => toggleConsultMessages()}>\r\n                      ğŸ’¬ ç•™è¨€æ²Ÿé€š${(state.consultSelectedTask.unreadMessageCount || 0) > 0 ? html`<span class=\"consult-unread-badge\" style=\"margin-left:4px;\">${state.consultSelectedTask.unreadMessageCount}</span>` : \"\"}\r\n                    </button>\r\n                    ${state.consultSelectedTask.status === \"completed\" && !state.consultSelectedTask.rating && (state.consultSelectedTask.revisionCount || 0) < 3 ? html`\r\n                      <button class=\"consult-td-action-btn consult-td-action-btn--revision\" @click=${() => toggleConsultRevision()}>\r\n                        ğŸ”„ è¯·æ±‚ä¿®è®¢${state.consultSelectedTask.revisionCount ? html` (${state.consultSelectedTask.revisionCount}/3)` : \"\"}\r\n                      </button>\r\n                    ` : \"\"}\r\n                    ${state.consultSelectedTask.status === \"completed\" && !state.consultSelectedTask.rating ? html`\r\n                      <button class=\"consult-td-action-btn consult-td-action-btn--rating\" @click=${() => toggleConsultRating()}>\r\n                        â­ ç»™ä¸ªè¯„ä»·\r\n                      </button>\r\n                    ` : \"\"}\r\n                  </div>\r\n\r\n                  <!-- Rating display (if already rated) -->\r\n                  ${state.consultSelectedTask.rating ? html`\r\n                    <div class=\"consult-td-rated\">\r\n                      <div class=\"consult-td-rated-stars\">${\"â˜…\".repeat(state.consultSelectedTask.rating)}${\"â˜†\".repeat(5 - state.consultSelectedTask.rating)}</div>\r\n                      ${state.consultSelectedTask.ratingComment ? html`<div class=\"consult-td-rated-comment\">${state.consultSelectedTask.ratingComment}</div>` : \"\"}\r\n                    </div>\r\n                  ` : \"\"}\r\n\r\n                  <!-- Rating panel -->\r\n                  ${state.consultRatingOpen ? html`\r\n                    <div class=\"consult-td-panel\">\r\n                      <div class=\"consult-td-panel-title\">è¯„ä»·æœåŠ¡</div>\r\n                      <div class=\"consult-td-stars\">\r\n                        ${[1,2,3,4,5].map(v => html`\r\n                          <span class=\"consult-td-star ${v <= (state.consultRatingHover || state.consultRatingValue) ? \"consult-td-star--active\" : \"\"}\"\r\n                            @click=${() => { state.consultRatingValue = v; scheduleRender(); }}\r\n                            @mouseenter=${() => { state.consultRatingHover = v; scheduleRender(); }}\r\n                            @mouseleave=${() => { state.consultRatingHover = 0; scheduleRender(); }}>â˜…</span>\r\n                        `)}\r\n                        <span class=\"consult-td-star-label\">${state.consultRatingValue === 1 ? \"å¾ˆå·®\" : state.consultRatingValue === 2 ? \"è¾ƒå·®\" : state.consultRatingValue === 3 ? \"ä¸€èˆ¬\" : state.consultRatingValue === 4 ? \"æ»¡æ„\" : state.consultRatingValue === 5 ? \"éå¸¸æ»¡æ„\" : \"\"}</span>\r\n                      </div>\r\n                      <textarea class=\"consult-td-input\" placeholder=\"å†™ç‚¹è¯„ä»·å§ï¼ˆå¯é€‰ï¼‰\" rows=\"2\"\r\n                        .value=${state.consultRatingComment}\r\n                        @input=${(e: Event) => { state.consultRatingComment = (e.target as HTMLTextAreaElement).value; scheduleRender(); }}></textarea>\r\n                      <div class=\"consult-td-panel-actions\">\r\n                        <button class=\"consult-td-btn-cancel\" @click=${() => toggleConsultRating()}>å–æ¶ˆ</button>\r\n                        <button class=\"consult-td-btn-submit\" @click=${() => submitConsultRating()} ?disabled=${state.consultRatingSubmitting || state.consultRatingValue < 1}>\r\n                          ${state.consultRatingSubmitting ? \"æäº¤ä¸­...\" : \"æäº¤è¯„ä»·\"}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ` : \"\"}\r\n\r\n                  <!-- Revision panel -->\r\n                  ${state.consultRevisionOpen ? html`\r\n                    <div class=\"consult-td-panel\">\r\n                      <div class=\"consult-td-panel-title\">è¯·æ±‚ä¿®è®¢</div>\r\n                      <div class=\"consult-td-panel-hint\">è¯·æè¿°éœ€è¦ä¿®æ”¹çš„å†…å®¹ï¼Œæ™ºèƒ½ä½“ä¸»äººä¼šé‡æ–°å¤„ç†ï¼ˆæœ€å¤š 3 æ¬¡ä¿®è®¢ï¼‰</div>\r\n                      <textarea class=\"consult-td-input\" placeholder=\"è¯·è¯´æ˜éœ€è¦ä¿®æ”¹çš„åœ°æ–¹...\" rows=\"3\"\r\n                        .value=${state.consultRevisionText}\r\n                        @input=${(e: Event) => { state.consultRevisionText = (e.target as HTMLTextAreaElement).value; scheduleRender(); }}></textarea>\r\n                      <div class=\"consult-td-panel-actions\">\r\n                        <button class=\"consult-td-btn-cancel\" @click=${() => toggleConsultRevision()}>å–æ¶ˆ</button>\r\n                        <button class=\"consult-td-btn-submit\" @click=${() => submitConsultRevision()} ?disabled=${state.consultRevisionSubmitting || !state.consultRevisionText.trim()}>\r\n                          ${state.consultRevisionSubmitting ? \"æäº¤ä¸­...\" : \"å‘é€ä¿®è®¢è¯·æ±‚\"}\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  ` : \"\"}\r\n\r\n                  <!-- Messages panel -->\r\n                  ${state.consultMessagesOpen ? html`\r\n                    <div class=\"consult-td-messages\">\r\n                      <div class=\"consult-td-panel-title\">ç•™è¨€æ²Ÿé€š</div>\r\n                      <div class=\"consult-td-msg-list\">\r\n                        ${state.consultMessages.length === 0 ? html`<div class=\"consult-td-msg-empty\">${state.consultSelectedTask.status === \"completed\" ? \"æš‚æ— ç•™è¨€è®°å½•\" : \"æš‚æ— ç•™è¨€ï¼Œå‘ä¸€æ¡å§\"}</div>` : \"\"}\r\n                        ${state.consultMessages.map(msg => html`\r\n                          <div class=\"consult-td-msg ${msg.sender.id === state.taxstoreUser?.id ? \"consult-td-msg--mine\" : \"consult-td-msg--theirs\"}\">\r\n                            <div class=\"consult-td-msg-sender\">${msg.sender.name}</div>\r\n                            <div class=\"consult-td-msg-bubble\">${msg.content}</div>\r\n                            <div class=\"consult-td-msg-time\">${new Date(msg.createdAt).toLocaleString(\"zh-CN\")}</div>\r\n                          </div>\r\n                        `)}\r\n                      </div>\r\n                      ${state.consultSelectedTask.status !== \"completed\" ? html`\r\n                        <div class=\"consult-td-msg-input-row\">\r\n                          <input type=\"text\" class=\"consult-td-msg-input\" placeholder=\"è¾“å…¥ç•™è¨€...\"\r\n                            .value=${state.consultMessageInput}\r\n                            @input=${(e: Event) => { state.consultMessageInput = (e.target as HTMLInputElement).value; scheduleRender(); }}\r\n                            @keydown=${(e: KeyboardEvent) => { if (e.key === \"Enter\" && !e.shiftKey) { e.preventDefault(); sendConsultMessage(); } }} />\r\n                          <button class=\"consult-td-msg-send\" @click=${() => sendConsultMessage()} ?disabled=${state.consultMessagesSending || !state.consultMessageInput.trim()}>\r\n                            ${state.consultMessagesSending ? \"...\" : \"å‘é€\"}\r\n                          </button>\r\n                        </div>\r\n                      ` : html`<div class=\"consult-td-msg-closed\">ä»»åŠ¡å·²å®Œæˆï¼Œç•™è¨€å·²å…³é—­</div>`}\r\n                    </div>\r\n                  ` : \"\"}\r\n\r\n                  <div class=\"consult-task-detail-footer\">\r\n                    <span>ğŸ’° ${state.consultSelectedTask.price} ç§¯åˆ†</span>\r\n                    <span class=\"consult-task-detail-status consult-task-detail-status--${state.consultSelectedTask.status}\">\r\n                      ${state.consultSelectedTask.status === \"completed\" ? \"âœ… å·²å®Œæˆ\" : state.consultSelectedTask.status === \"pending\" ? \"â³ ç­‰å¾…ä¸­\" : state.consultSelectedTask.status === \"revision_requested\" ? \"ğŸ“ ä¿®è®¢ä¸­\" : \"ğŸ”„ å¤„ç†ä¸­\"}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n          </div>\r\n        ` : \"\"}\r\n        </div><!-- /side-panel -->\r\n\r\n        <div class=\"taxchat-main\">\r\n          ${state.searchOpen ? html`\r\n            <div class=\"search-bar\">\r\n              <input\r\n                id=\"taxchat-search-input\"\r\n                type=\"text\"\r\n                placeholder=\"æœç´¢æ¶ˆæ¯...\"\r\n                .value=${state.searchQuery}\r\n                @input=${(e: Event) => performSearch((e.target as HTMLInputElement).value)}\r\n                @keydown=${(e: KeyboardEvent) => {\r\n                  if (e.key === \"Escape\") closeSearch();\r\n                  else if (e.key === \"Enter\") { e.shiftKey ? prevResult() : nextResult(); }\r\n                }}\r\n              />\r\n              <span class=\"search-count\">\r\n                ${state.searchResults.length > 0\r\n                  ? `${state.searchIndex + 1}/${state.searchResults.length}`\r\n                  : state.searchQuery ? \"æ— ç»“æœ\" : \"\"}\r\n              </span>\r\n              <button class=\"search-nav-btn\" @click=${prevResult} title=\"ä¸Šä¸€ä¸ª\">â–²</button>\r\n              <button class=\"search-nav-btn\" @click=${nextResult} title=\"ä¸‹ä¸€ä¸ª\">â–¼</button>\r\n              <button class=\"search-close-btn\" @click=${closeSearch} title=\"å…³é—­\">âœ•</button>\r\n            </div>\r\n          ` : \"\"}\r\n          <div class=\"taxchat-messages\" id=\"messages-container\">\r\n            ${renderMessages()}\r\n          </div>\r\n\r\n      <div class=\"taxchat-input-area\">\r\n        <div class=\"taxchat-quick-actions\">\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => handleQuickSkill(\"tax-risk\", \"è¯·æŒ‰ç…§ç¨åŠ¡é£é™©æ²»ç†æµç¨‹ï¼Œåˆ†ææˆ‘ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ï¼Œè¯†åˆ«ç¨åŠ¡é£é™©ç‚¹ï¼Œç»™å‡ºé£é™©åˆ†æã€è¯´æ˜å‡½ã€åº”å¯¹è¯æœ¯å’Œæ“ä½œå»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\", \"ç¨åŠ¡é£é™©æ²»ç†\")}\r\n            title=\"ä¸Šä¼ ç¨åŠ¡é£é™©æ–‡ä»¶ï¼Œè‡ªåŠ¨åˆ†æå¹¶ç”Ÿæˆè¯´æ˜å‡½\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ§¾</span>\r\n            <span>ç¨åŠ¡é£é™©æ²»ç†</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => handleQuickSkill(\"tax-review\", \"è¯·æŒ‰ç…§çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡æµç¨‹ï¼Œåˆ†ææˆ‘ä¸Šä¼ çš„çº³ç¨ç”³æŠ¥è¡¨å’Œè´¢åŠ¡æŠ¥è¡¨ï¼Œæ¯”å¯¹ä¸¤ä¸ªè¡¨æ ¼çš„æ•°æ®å·®å¼‚ï¼Œä»¥è¡¨æ ¼å½¢å¼è¾“å‡ºæ¯”å¯¹ç»“æœï¼Œå¹¶åˆ†æç¨åŠ¡é£é™©ç»™å‡ºå¤„ç†å»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\", \"çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡\")}\r\n            title=\"ä¸Šä¼ çº³ç¨ç”³æŠ¥è¡¨å’Œè´¢åŠ¡æŠ¥è¡¨ï¼Œè‡ªåŠ¨æ¯”å¯¹åˆ†æ\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ“Š</span>\r\n            <span>ç”³æŠ¥è¡¨é¢„å®¡</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => handleQuickSkill(\"contract-tax\", \"è¯·æŒ‰ç…§ç¥¨æ®åˆåŒç¨åŠ¡å®¡æ ¸æµç¨‹ï¼Œä»ç¨åŠ¡è§’åº¦åˆ†ææˆ‘ä¸Šä¼ çš„åˆåŒæˆ–ç¥¨æ®ï¼Œåˆ—æ”¯æ¶‰åŠçš„ç¨ç›®å¹¶è®¡ç®—ç›¸å…³ç¨é¢ï¼Œç»™å‡ºé£é™©æç¤ºå’Œä¿®æ”¹å»ºè®®ã€‚è¯·ç›´æ¥åˆ†ææ–‡ä»¶å†…å®¹ï¼Œä¸è¦è°ƒç”¨ä»»ä½•å·¥å…·æˆ–å‘½ä»¤ã€‚\", \"åˆåŒç¨åŠ¡å®¡æ ¸\")}\r\n            title=\"ä¸Šä¼ åˆåŒæˆ–ç¥¨æ®ï¼Œä»ç¨åŠ¡è§’åº¦å®¡æ ¸åˆ†æ\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ“</span>\r\n            <span>åˆåŒåŠç¥¨æ®ç¨å®¡</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => handleQuickSkill(\"invoice-check\", BUILTIN_SKILLS[3].prompt, \"å‘ç¥¨æŸ¥éªŒ\")}\r\n            title=\"ä¸Šä¼ å‘ç¥¨å›¾ç‰‡/PDF/XMLï¼ŒæŸ¥éªŒå‘ç¥¨çœŸä¼ªå¹¶åˆ†æé£é™©\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ”</span>\r\n            <span>å‘ç¥¨æŸ¥éªŒ</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => handleQuickSkill(\"receipt-organizer\", BUILTIN_SKILLS[4].prompt, \"ç¥¨æ®æ•´ç†\", true)}\r\n            title=\"æ‰«ææ–‡ä»¶å¤¹ä¸­çš„ç¥¨æ®ï¼ŒæŒ‰ç±»å‹åˆ†ç±»æ•´ç†ï¼Œç”ŸæˆæŠ¥é”€å•\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ§¾</span>\r\n            <span>ç¥¨æ®æ•´ç†</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => {\r\n              if (!state.authorizedFolder) {\r\n                showToast(\"è¯·å…ˆåœ¨çŸ¥è¯†åº“é¢æ¿ä¸­é€‰æ‹©æ–‡ä»¶å¤¹\");\r\n                state.sidePanel = \"knowledge\";\r\n                renderApp();\r\n                return;\r\n              }\r\n              handleCustomSkillClick(BUILTIN_SKILLS[5]);\r\n            }}\r\n            title=\"åœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­æ£€ç´¢æ–‡ä»¶ã€æå–æ‘˜è¦ã€æœç´¢å†…å®¹\"\r\n          >\r\n            <span class=\"qa-icon\">ğŸ“š</span>\r\n            <span>çŸ¥è¯†åº“</span>\r\n          </button>\r\n          <button\r\n            class=\"quick-action-btn\"\r\n            ?disabled=${false}\r\n            @click=${() => {\r\n              const fileInput = document.createElement(\"input\");\r\n              fileInput.type = \"file\";\r\n              fileInput.accept = \"image/*,.pdf,.doc,.docx,.xls,.xlsx\";\r\n              fileInput.multiple = true;\r\n              fileInput.onchange = () => {\r\n                if (fileInput.files && fileInput.files.length > 0) {\r\n                  handleFiles(fileInput.files);\r\n                }\r\n              };\r\n              fileInput.click();\r\n            }}\r\n            title=\"ä¸Šä¼ å›¾ç‰‡æˆ–æ–‡ä»¶\"\r\n          >\r\n            <span class=\"qa-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48\"/></svg></span>\r\n            <span>ä¸Šä¼ æ–‡ä»¶</span>\r\n          </button>\r\n          ${state.customSkills.filter(s => s.pinned).sort((a, b) => a.createdAt - b.createdAt).map(sk => html`\r\n            <button\r\n              class=\"quick-action-btn custom\"\r\n              ?disabled=${false}\r\n              @click=${() => handleCustomSkillClick(sk)}\r\n              title=${sk.description || sk.name}\r\n            >\r\n              <span class=\"qa-icon\">${sk.emoji}</span>\r\n              <span>${sk.name}</span>\r\n            </button>\r\n          `)}\r\n        </div>\r\n\r\n        <div class=\"taxchat-input-container\"\r\n          @dragover=${(e: DragEvent) => {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            state.dragOver = true;\r\n            renderApp();\r\n          }}\r\n          @dragleave=${(e: DragEvent) => {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            state.dragOver = false;\r\n            renderApp();\r\n          }}\r\n          @drop=${(e: DragEvent) => {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            state.dragOver = false;\r\n            console.log(\"Drop event, files:\", e.dataTransfer?.files?.length);\r\n            if (e.dataTransfer?.files) {\r\n              handleFiles(e.dataTransfer.files);\r\n            }\r\n          }}\r\n          class=${state.dragOver ? \"taxchat-input-container drag-over\" : \"taxchat-input-container\"}\r\n        >\r\n          ${state.activeCustomSkill ? html`\r\n            <div class=\"skill-prompt-bubble\">\r\n              <span class=\"skill-prompt-bubble__emoji\">${state.activeCustomSkill.emoji}</span>\r\n              <span class=\"skill-prompt-bubble__text\">${state.activeCustomSkill.name}${state.activeCustomSkill.description ? ` Â· ${state.activeCustomSkill.description}` : \"\"}</span>\r\n              <button class=\"skill-prompt-bubble__close\" @click=${() => clearActiveCustomSkill()} title=\"å–æ¶ˆæŠ€èƒ½\">âœ•</button>\r\n            </div>\r\n          ` : \"\"}\r\n          ${state.mentionDropdownVisible ? html`\r\n            <div class=\"agent-mention-dropdown\">\r\n              ${getMentionCandidates().map((a, i) => html`\r\n                  <div class=\"agent-mention-item ${i === state.mentionIndex ? \"agent-mention-item--active\" : \"\"}\" @mousedown=${(e: Event) => { e.preventDefault(); insertAgentMention(a); }} @mouseenter=${() => { state.mentionIndex = i; renderApp(); }}>\r\n                    <span class=\"agent-mention-emoji\">${a.avatarUrl ? html`<img src=\"${a.avatarUrl}\" class=\"agent-avatar-img-sm\" />` : a.emoji}</span>\r\n                    <span class=\"agent-mention-name\">${a.name}</span>\r\n                    ${a.description ? html`<span class=\"agent-mention-desc\">${a.description}</span>` : \"\"}\r\n                  </div>\r\n                `)}\r\n              ${getMentionCandidates().length === 0 ? html`<div class=\"agent-mention-empty\">æœªæ‰¾åˆ°åŒ¹é…çš„æ™ºèƒ½ä½“</div>` : \"\"}\r\n            </div>\r\n          ` : \"\"}\r\n          ${state.commandPaletteVisible ? html`\r\n            <div class=\"command-palette\">\r\n              ${getFilteredCommands().map((cmd, i) => html`\r\n                <div class=\"command-item ${i === state.commandIndex ? \"active\" : \"\"}\"\r\n                  @mousedown=${(e: Event) => { e.preventDefault(); closeCommandPalette(); state.draft = \"\"; cmd.action(); scheduleRender(); }}\r\n                  @mouseenter=${() => { state.commandIndex = i; scheduleRender(); }}>\r\n                  <span class=\"command-emoji\">${cmd.emoji}</span>\r\n                  <div class=\"command-info\">\r\n                    <div class=\"command-name\">${cmd.name}</div>\r\n                    <div class=\"command-desc\">${cmd.description}</div>\r\n                  </div>\r\n                </div>\r\n              `)}\r\n              ${getFilteredCommands().length === 0 ? html`<div class=\"command-item\"><span class=\"command-desc\">æ— åŒ¹é…æŒ‡ä»¤</span></div>` : \"\"}\r\n            </div>\r\n          ` : \"\"}\r\n          ${state.replyingTo ? html`\r\n            <div class=\"reply-bar\">\r\n              <div class=\"reply-bar__content\">\r\n                <div class=\"reply-bar__label\">å›å¤ ${state.replyingTo.type === \"user\" ? \"æˆ‘\" : ((state.replyingTo as AssistantMessage).agentName || \"Taxbot\")}</div>\r\n                <div class=\"reply-bar__text\">${state.replyingTo.text.length > 60 ? state.replyingTo.text.slice(0, 60) + \"...\" : state.replyingTo.text}</div>\r\n              </div>\r\n              <button class=\"reply-bar__close\" @click=${() => { state.replyingTo = null; renderApp(); }}>âœ•</button>\r\n            </div>\r\n          ` : \"\"}\r\n          <textarea\r\n            id=\"message-input\"\r\n            class=\"taxchat-input\"\r\n            rows=\"1\"\r\n            placeholder=${state.activeCustomSkill ? `è¯·è¾“å…¥å†…å®¹ï¼Œå°†æŒ‰ã€Œ${state.activeCustomSkill.name}ã€æµç¨‹å¤„ç†...` : \"è¾“å…¥æ‚¨çš„ç¨åŠ¡é—®é¢˜...æˆ–æ‹–å…¥/ç²˜è´´æ–‡ä»¶\"}\r\n            .value=${state.draft}\r\n            @input=${(e: Event) => {\r\n              const ta = e.target as HTMLTextAreaElement;\r\n              state.draft = ta.value;\r\n              // Auto-resize: reset height then set to scrollHeight (capped by CSS max-height)\r\n              ta.style.height = \"auto\";\r\n              ta.style.height = ta.scrollHeight + \"px\";\r\n              // Quick command detection: draft starts with / and no spaces\r\n              if (checkCommandTrigger()) {\r\n                return; // command palette handles rendering\r\n              }\r\n              // @mention dropdown: detect the last @token being typed (anywhere in text)\r\n              const mentionMatch = state.draft.match(/@(\\S*)$/);\r\n              if (mentionMatch && state.agentsList.length > 0) {\r\n                const prevFilter = state.mentionFilter;\r\n                state.mentionDropdownVisible = true;\r\n                state.mentionFilter = mentionMatch[1].toLowerCase();\r\n                if (state.mentionFilter !== prevFilter) {\r\n                  state.mentionIndex = 0;\r\n                }\r\n              } else {\r\n                state.mentionDropdownVisible = false;\r\n                state.mentionFilter = \"\";\r\n                state.mentionIndex = 0;\r\n              }\r\n              renderApp();\r\n            }}\r\n            @keydown=${(e: KeyboardEvent) => {\r\n              if (state.commandPaletteVisible) {\r\n                if (e.key === \"ArrowDown\") { e.preventDefault(); commandNavigate(\"down\"); return; }\r\n                if (e.key === \"ArrowUp\") { e.preventDefault(); commandNavigate(\"up\"); return; }\r\n                if (e.key === \"Enter\" && !e.isComposing) { e.preventDefault(); commandExecuteSelected(); return; }\r\n                if (e.key === \"Escape\") { e.preventDefault(); closeCommandPalette(); return; }\r\n              }\r\n              if (state.mentionDropdownVisible) {\r\n                const candidates = getMentionCandidates();\r\n                if (e.key === \"ArrowDown\") {\r\n                  e.preventDefault();\r\n                  state.mentionIndex = candidates.length ? (state.mentionIndex + 1) % candidates.length : 0;\r\n                  renderApp();\r\n                  requestAnimationFrame(() => {\r\n                    document.querySelector('.agent-mention-item--active')?.scrollIntoView({ block: 'nearest' });\r\n                  });\r\n                  return;\r\n                }\r\n                if (e.key === \"ArrowUp\") {\r\n                  e.preventDefault();\r\n                  state.mentionIndex = candidates.length ? (state.mentionIndex - 1 + candidates.length) % candidates.length : 0;\r\n                  renderApp();\r\n                  requestAnimationFrame(() => {\r\n                    document.querySelector('.agent-mention-item--active')?.scrollIntoView({ block: 'nearest' });\r\n                  });\r\n                  return;\r\n                }\r\n                if (e.key === \"Enter\" && !e.isComposing) {\r\n                  e.preventDefault();\r\n                  if (candidates.length > 0 && state.mentionIndex < candidates.length) {\r\n                    insertAgentMention(candidates[state.mentionIndex]);\r\n                  }\r\n                  return;\r\n                }\r\n                if (e.key === \"Escape\") {\r\n                  e.preventDefault();\r\n                  state.mentionDropdownVisible = false;\r\n                  state.mentionIndex = 0;\r\n                  renderApp();\r\n                  return;\r\n                }\r\n              }\r\n              if (e.key === \"Enter\" && !e.ctrlKey && !e.shiftKey && !e.isComposing) {\r\n                e.preventDefault();\r\n                handleSend();\r\n              }\r\n            }}\r\n            @paste=${(e: ClipboardEvent) => {\r\n              console.log(\"Paste event, files:\", e.clipboardData?.files?.length);\r\n              if (e.clipboardData?.files && e.clipboardData.files.length > 0) {\r\n                e.preventDefault();\r\n                handleFiles(e.clipboardData.files);\r\n              }\r\n            }}\r\n            ?disabled=${false}\r\n            rows=\"1\"\r\n          ></textarea>\r\n          <button\r\n            class=\"taxchat-button primary send-inline\"\r\n            ?disabled=${state.draft.trim().length === 0 && state.attachments.length === 0 && state.knowledgeRefs.length === 0}\r\n            @click=${handleSend}\r\n            title=\"å‘é€æ¶ˆæ¯ (Enter)\"\r\n          >\r\n            <span class=\"button-icon\">â¤</span>\r\n          </button>\r\n\r\n          ${state.dragOver ? html`\r\n            <div class=\"drag-overlay\">\r\n              <div class=\"drag-text\">ğŸ“ æ‹–å…¥æ–‡ä»¶å³å¯ä¸Šä¼ </div>\r\n            </div>\r\n          ` : \"\"}\r\n        </div>\r\n\r\n        ${state.attachments.length > 0 ? html`\r\n          <div class=\"attachments-list\">\r\n            ${state.attachments.map((att, idx) => html`\r\n              <div class=\"attachment-item\">\r\n                <span class=\"attachment-icon\"><svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48\"/></svg></span>\r\n                <span class=\"attachment-name\" title=${att.name}>${att.name}</span>\r\n                <span class=\"attachment-size\">${formatFileSize(att.size)}</span>\r\n                <button\r\n                  class=\"attachment-remove\"\r\n                  @click=${() => removeAttachment(idx)}\r\n                  title=\"ç§»é™¤\"\r\n                >\r\n                  âœ•\r\n                </button>\r\n              </div>\r\n            `)}\r\n          </div>\r\n        ` : \"\"}\r\n\r\n        ${state.knowledgeRefs.length > 0 ? html`\r\n          <div class=\"knowledge-refs-list\">\r\n            ${state.knowledgeRefs.map((ref, idx) => html`\r\n              <div class=\"knowledge-ref-item\">\r\n                <span class=\"kr-icon\">ğŸ“š</span>\r\n                <span class=\"kr-name\" title=${ref.name}>${ref.name}</span>\r\n                <button class=\"kr-remove\" @click=${() => removeKnowledgeRef(idx)} title=\"ç§»é™¤å¼•ç”¨\">âœ•</button>\r\n              </div>\r\n            `)}\r\n          </div>\r\n        ` : \"\"}\r\n      </div>\r\n\r\n        </div><!-- /taxchat-main -->\r\n      </div><!-- /taxchat-body -->\r\n\r\n\r\n      ${state.showQuickStart ? renderQuickStart() : \"\"}\r\n\r\n      ${state.editingSkill ? html`\r\n        <div class=\"skill-editor-overlay\" @click=${() => { state.editingSkill = null; renderApp(); }}>\r\n          <div class=\"skill-editor\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <h3>${state.customSkills.some(s => s.id === state.editingSkill!.id) ? \"ç¼–è¾‘ Skill\" : \"æ–°å»º Skill\"}</h3>\r\n            <label>åç§° *</label>\r\n            <input type=\"text\" .value=${live(state.editingSkill.name)} @input=${(e: Event) => { state.editingSkill!.name = (e.target as HTMLInputElement).value; }} placeholder=\"ä¾‹ï¼šå¢å€¼ç¨è®¡ç®—åŠ©æ‰‹\" />\r\n            <label>å›¾æ ‡</label>\r\n            <input type=\"text\" .value=${live(state.editingSkill.emoji)} @input=${(e: Event) => { state.editingSkill!.emoji = (e.target as HTMLInputElement).value; }} placeholder=\"ğŸ¤–\" style=\"width: 60px;\" />\r\n            <label>æè¿°</label>\r\n            <textarea .value=${live(state.editingSkill.description)} @input=${(e: Event) => { state.editingSkill!.description = (e.target as HTMLTextAreaElement).value; }} placeholder=\"æè¿°è¿™ä¸ªæŠ€èƒ½çš„ç”¨é€”å’Œä½¿ç”¨åœºæ™¯ï¼Œä¾‹å¦‚ï¼šå½“ç”¨æˆ·æåˆ°å¢å€¼ç¨è®¡ç®—ã€ç¨ç‡æŸ¥è¯¢æ—¶ä½¿ç”¨æ­¤æŠ€èƒ½\" style=\"min-height: 60px;\"></textarea>\r\n            <label>æ“ä½œæµç¨‹ *</label>\r\n            <textarea .value=${live(state.editingSkill.prompt)} @input=${(e: Event) => { state.editingSkill!.prompt = (e.target as HTMLTextAreaElement).value; }} placeholder=\"è¯·è¯¦ç»†æè¿°æŠ€èƒ½çš„æ“ä½œæµç¨‹ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰ã€‚ä¾‹å¦‚ï¼šåˆ†æç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œä»å¢å€¼ç¨è§’åº¦åˆ—å‡ºæ‰€æœ‰æ¶‰ç¨é¡¹ç›®ï¼Œè®¡ç®—åº”çº³ç¨é¢...\"></textarea>\r\n            <div class=\"skill-editor__actions\">\r\n              <button class=\"skill-editor__cancel\" @click=${() => { state.editingSkill = null; renderApp(); }}>å–æ¶ˆ</button>\r\n              <button class=\"skill-editor__save\" @click=${() => {\r\n                if (!state.editingSkill?.name.trim()) { alert(\"è¯·å¡«å†™åç§°\"); return; }\r\n                if (!state.editingSkill?.prompt.trim()) { alert(\"è¯·å¡«å†™æ“ä½œæµç¨‹\"); return; }\r\n                saveSkillFromEditor();\r\n              }}>ä¿å­˜æŠ€èƒ½</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.creatingAgent ? html`\r\n        <div class=\"agent-editor-overlay\" @click=${() => { state.creatingAgent = false; state.editingAgentId = null; renderApp(); }}>\r\n          <div class=\"agent-editor\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <h3>${state.editingAgentId ? \"ç¼–è¾‘æ™ºèƒ½ä½“\" : \"æ–°å»ºæ™ºèƒ½ä½“\"}</h3>\r\n            <div class=\"agent-editor-avatar-row\">\r\n              <div class=\"agent-editor-avatar-preview\" @click=${() => {\r\n                const fi = document.createElement(\"input\");\r\n                fi.type = \"file\";\r\n                fi.accept = \"image/*\";\r\n                fi.onchange = () => {\r\n                  if (!fi.files?.[0]) return;\r\n                  const file = fi.files[0];\r\n                  if (file.size > 512 * 1024) { showToast(\"å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 512KB\"); return; }\r\n                  const reader = new FileReader();\r\n                  reader.onload = () => {\r\n                    state.agentCreateDraft.avatarDataUrl = reader.result as string;\r\n                    renderApp();\r\n                  };\r\n                  reader.readAsDataURL(file);\r\n                };\r\n                fi.click();\r\n              }} title=\"ç‚¹å‡»ä¸Šä¼ å¤´åƒå›¾ç‰‡\">\r\n                ${state.agentCreateDraft.avatarDataUrl\r\n                  ? html`<img src=\"${state.agentCreateDraft.avatarDataUrl}\" class=\"agent-avatar-preview-img\" />`\r\n                  : html`<span>${state.agentCreateDraft.emoji || \"ğŸ¤–\"}</span>`}\r\n                <div class=\"agent-avatar-upload-hint\">ä¸Šä¼ </div>\r\n              </div>\r\n              <div class=\"agent-editor-avatar-input\">\r\n                <label>Emojiï¼ˆæ— å›¾ç‰‡æ—¶æ˜¾ç¤ºï¼‰</label>\r\n                <input type=\"text\" maxlength=\"4\" .value=${live(state.agentCreateDraft.emoji)} @input=${(e: Event) => { state.agentCreateDraft.emoji = (e.target as HTMLInputElement).value; renderApp(); }} placeholder=\"ğŸ¤–\" style=\"width: 60px; font-size: 20px; text-align: center;\" />\r\n                ${state.agentCreateDraft.avatarDataUrl ? html`<button class=\"agent-avatar-remove\" @click=${() => { state.agentCreateDraft.avatarDataUrl = \"\"; renderApp(); }}>ç§»é™¤å›¾ç‰‡</button>` : \"\"}\r\n              </div>\r\n            </div>\r\n            <label>åç§° *</label>\r\n            <input type=\"text\" maxlength=\"30\" .value=${live(state.agentCreateDraft.name)} @input=${(e: Event) => { state.agentCreateDraft.name = (e.target as HTMLInputElement).value; renderApp(); }} placeholder=\"å¦‚ï¼šè´¢åŠ¡åŠ©æ‰‹ã€åˆåŒå®¡æŸ¥å‘˜\" />\r\n            <label>æè¿° <span class=\"agent-field-hint\">å¯¹åº” SOUL.md â€” æ™ºèƒ½ä½“çš„æ€§æ ¼ä¸è¡Œä¸ºæ–¹å¼</span></label>\r\n            <textarea .value=${live(state.agentCreateDraft.description)} @input=${(e: Event) => { state.agentCreateDraft.description = (e.target as HTMLTextAreaElement).value; }} placeholder=\"æè¿°æ™ºèƒ½ä½“çš„å®šä½å’Œè¡Œä¸ºé£æ ¼ã€‚ä¾‹å¦‚ï¼š&#10;ä½ æ˜¯ä¸€ä½èµ„æ·±ç¨åŠ¡é¡¾é—®ï¼Œè¯´è¯ä¸¥è°¨ä¸“ä¸šï¼Œå›ç­”é—®é¢˜æ—¶ä¼šå¼•ç”¨å…·ä½“æ³•è§„æ¡æ–‡ã€‚\"></textarea>\r\n            <label>èº«ä»½ <span class=\"agent-field-hint\">å¯¹åº” IDENTITY.md â€” æ™ºèƒ½ä½“çš„è§’è‰²å®šä¹‰</span></label>\r\n            <textarea .value=${live(state.agentCreateDraft.identityDesc)} @input=${(e: Event) => { state.agentCreateDraft.identityDesc = (e.target as HTMLTextAreaElement).value; }} placeholder=\"å®šä¹‰æ™ºèƒ½ä½“çš„èº«ä»½è§’è‰²ã€‚ä¾‹å¦‚ï¼š&#10;ç¨åŠ¡éƒ¨é—¨é«˜çº§é¡¾é—®ï¼Œä¸“æ³¨å¢å€¼ç¨å’Œä¼ä¸šæ‰€å¾—ç¨é¢†åŸŸï¼Œæ‹¥æœ‰10å¹´ä»ä¸šç»éªŒã€‚\" style=\"min-height:80px;\"></textarea>\r\n            <label>æ“…é•¿ <span class=\"agent-field-hint\">å¯¹åº” AGENTS.md â€” æ™ºèƒ½ä½“çš„æŠ€èƒ½ä¸å·¥ä½œæŒ‡å—</span></label>\r\n            <textarea .value=${live(state.agentCreateDraft.expertise)} @input=${(e: Event) => { state.agentCreateDraft.expertise = (e.target as HTMLTextAreaElement).value; }} placeholder=\"åˆ—å‡ºæ™ºèƒ½ä½“æ“…é•¿çš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼š&#10;- åˆåŒæ¶‰ç¨æ¡æ¬¾å®¡æ ¸&#10;- å¢å€¼ç¨ç¨ç‡é€‚ç”¨åˆ†æ&#10;- è·¨å¢ƒç¨åŠ¡åˆè§„å’¨è¯¢\" style=\"min-height:80px;\"></textarea>\r\n            <label>å¯ç”¨æŠ€èƒ½ <span class=\"agent-field-hint\">å¯¹åº” TOOLS.md â€” å‹¾é€‰æ™ºèƒ½ä½“å¯ä½¿ç”¨çš„æŠ€èƒ½</span></label>\r\n            <div class=\"agent-skills-selector\">\r\n              ${[...BUILTIN_SKILLS, ...state.customSkills.filter(s => !s.id.startsWith(\"__builtin_\"))].map(sk => {\r\n                const selected = (state.agentCreateDraft.selectedSkills || []).includes(sk.id);\r\n                return html`\r\n                  <label class=\"agent-skill-option ${selected ? \"selected\" : \"\"}\" @click=${(e: Event) => {\r\n                    e.preventDefault();\r\n                    const cur: string[] = state.agentCreateDraft.selectedSkills || [];\r\n                    state.agentCreateDraft.selectedSkills = selected ? cur.filter((id: string) => id !== sk.id) : [...cur, sk.id];\r\n                    renderApp();\r\n                  }}>\r\n                    <span class=\"agent-skill-check\">${selected ? \"â˜‘\" : \"â˜\"}</span>\r\n                    <span class=\"agent-skill-emoji\">${sk.emoji}</span>\r\n                    <span class=\"agent-skill-name\">${sk.name}</span>\r\n                    ${sk.description ? html`<span class=\"agent-skill-desc\">${sk.description}</span>` : \"\"}\r\n                  </label>`;\r\n              })}\r\n              ${BUILTIN_SKILLS.length === 0 && state.customSkills.length === 0 ? html`<div style=\"color:#9ca3af;font-size:12px;padding:8px;\">æš‚æ— å¯ç”¨æŠ€èƒ½</div>` : \"\"}\r\n            </div>\r\n            <div class=\"agent-editor__actions\">\r\n              ${state.editingAgentId ? html`\r\n                <button class=\"agent-editor__memory-btn\" @click=${async () => {\r\n                  const mem = await loadAgentMemory(state.editingAgentId!);\r\n                  state.viewingAgentMemory = { agentId: state.editingAgentId!, agentName: state.agentCreateDraft.name, content: mem };\r\n                  renderApp();\r\n                }} title=\"æŸ¥çœ‹/ç¼–è¾‘è¯¥æ™ºèƒ½ä½“çš„è®°å¿†\">æŸ¥çœ‹è®°å¿†</button>\r\n              ` : \"\"}\r\n              <button class=\"agent-editor__cancel\" @click=${() => { state.creatingAgent = false; state.editingAgentId = null; state.agentCreateDraft = { name: \"\", emoji: \"ğŸ¤–\", description: \"\", identityDesc: \"\", expertise: \"\", avatarDataUrl: \"\", selectedSkills: [] }; renderApp(); }}>å–æ¶ˆ</button>\r\n              <button class=\"agent-editor__save\" ?disabled=${state.agentSaving || !state.agentCreateDraft.name.trim()} @click=${() => { state.editingAgentId ? updateAgent() : createAgent(); }}>${state.agentSaving ? \"ä¿å­˜ä¸­...\" : state.editingAgentId ? \"ä¿å­˜ä¿®æ”¹\" : \"åˆ›å»ºæ™ºèƒ½ä½“\"}</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.viewingAgentMemory ? html`\r\n        <div class=\"agent-editor-overlay\" @click=${() => { state.viewingAgentMemory = null; state.confirmingMemoryClear = false; renderApp(); }}>\r\n          <div class=\"agent-editor agent-memory-editor\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <h3>${state.viewingAgentMemory.agentName} â€” è®°å¿†</h3>\r\n            <p style=\"font-size:12px;color:#999;margin:0 0 8px;\">æ™ºèƒ½ä½“å¯¹è¯æ—¶ä¼šå‚è€ƒè¿™äº›è®°å¿†ã€‚å¯æ‰‹åŠ¨ç¼–è¾‘æˆ–æ¸…ç©ºã€‚</p>\r\n            <textarea class=\"agent-memory-textarea\" .value=${state.viewingAgentMemory.content}\r\n              @input=${(e: Event) => { if (state.viewingAgentMemory) state.viewingAgentMemory.content = (e.target as HTMLTextAreaElement).value; }}\r\n              placeholder=\"æš‚æ— è®°å¿†ã€‚æ™ºèƒ½ä½“å¯¹è¯ä¸­ç‚¹å‡»ã€Œè®°ä½ã€æŒ‰é’®å¯ä¿å­˜å›å¤åˆ°æ­¤å¤„ã€‚\"\r\n            ></textarea>\r\n            ${state.confirmingMemoryClear ? html`\r\n              <div class=\"memory-clear-confirm\">\r\n                <div class=\"memory-clear-warn\">\r\n                  <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#f59e0b\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\"/><line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\"/><line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\"/></svg>\r\n                  <span>æ¸…ç©ºåï¼Œæ™ºèƒ½ä½“å°†ä¸¢å¤±æ‰€æœ‰ç§¯ç´¯çš„ç»éªŒå’Œå¯¹è¯è®°å¿†ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šæ¸…ç©ºå—ï¼Ÿ</span>\r\n                </div>\r\n                <div class=\"memory-clear-btns\">\r\n                  <button class=\"memory-clear-yes\" @click=${() => {\r\n                    if (state.viewingAgentMemory) {\r\n                      saveAgentMemory(state.viewingAgentMemory.agentId, \"\");\r\n                      state.viewingAgentMemory.content = \"\";\r\n                      state.confirmingMemoryClear = false;\r\n                      showToast(\"è®°å¿†å·²æ¸…ç©º\");\r\n                      renderApp();\r\n                    }\r\n                  }}>ç¡®å®šæ¸…ç©º</button>\r\n                  <button class=\"memory-clear-no\" @click=${() => { state.confirmingMemoryClear = false; renderApp(); }}>å–æ¶ˆ</button>\r\n                </div>\r\n              </div>\r\n            ` : \"\"}\r\n            <div class=\"agent-editor__actions\">\r\n              <button class=\"agent-editor__cancel\" @click=${() => {\r\n                state.confirmingMemoryClear = true;\r\n                renderApp();\r\n              }} ?disabled=${!state.viewingAgentMemory.content}>æ¸…ç©ºè®°å¿†</button>\r\n              <button class=\"agent-editor__save\" @click=${() => {\r\n                if (state.viewingAgentMemory) {\r\n                  saveAgentMemory(state.viewingAgentMemory.agentId, state.viewingAgentMemory.content);\r\n                  showToast(\"è®°å¿†å·²ä¿å­˜\");\r\n                  state.viewingAgentMemory = null;\r\n                  state.confirmingMemoryClear = false;\r\n                  renderApp();\r\n                }\r\n              }}>ä¿å­˜</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.rentalPublishDialog && state.rentalPublishAgent ? html`\r\n        <div class=\"rental-publish-overlay\" @click=${closePublishDialog}>\r\n          <div class=\"rental-publish-dialog\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <h3>ğŸª å‘å¸ƒåˆ°æ™ºèƒ½ä½“å¸‚åœº</h3>\r\n            <div class=\"rental-publish-agent-preview\">\r\n              <div class=\"rental-publish-agent-emoji\">\r\n                ${state.rentalPublishAgent.avatarUrl ? html`<img src=\"${state.rentalPublishAgent.avatarUrl}\" />` : state.rentalPublishAgent.emoji}\r\n              </div>\r\n              <div class=\"rental-publish-agent-info\">\r\n                <div class=\"rental-publish-agent-name\">${state.rentalPublishAgent.isDefault ? `Taxbot Agent by ${state.taxstoreUser?.name || \"\"}` : state.rentalPublishAgent.name}</div>\r\n                <div class=\"rental-publish-agent-desc\">${state.rentalPublishAgent.description}</div>\r\n              </div>\r\n            </div>\r\n            <div class=\"rental-field\">\r\n              <label>å•æ¬¡ä»»åŠ¡ä»·æ ¼ï¼ˆç§¯åˆ†ï¼‰</label>\r\n              <input type=\"number\" min=\"1\" max=\"9999\" .value=${String(state.rentalPublishDraft.price)}\r\n                @input=${(e: Event) => { state.rentalPublishDraft.price = parseInt((e.target as HTMLInputElement).value) || 0; }} />\r\n              <div class=\"rental-field-hint\">ç”¨æˆ·ä¸‹å•æ—¶å°†æ”¯ä»˜æ­¤ç§¯åˆ†ï¼Œä»»åŠ¡å®Œæˆåç§¯åˆ†è½¬ç»™ä½ </div>\r\n            </div>\r\n            <div class=\"rental-field\">\r\n              <label>å¸‚åœºæè¿°</label>\r\n              <textarea .value=${state.rentalPublishDraft.description}\r\n                @input=${(e: Event) => { state.rentalPublishDraft.description = (e.target as HTMLTextAreaElement).value; }}\r\n                placeholder=\"æè¿°è¿™ä¸ªæ™ºèƒ½ä½“èƒ½åšä»€ä¹ˆã€æ“…é•¿ä»€ä¹ˆ...\"></textarea>\r\n              <div class=\"rental-field-hint\">å°†å±•ç¤ºç»™å¸‚åœºä¸Šçš„å…¶ä»–ç”¨æˆ·</div>\r\n            </div>\r\n            <div class=\"rental-field\">\r\n              <label>ä¸“ä¸šæ ‡ç­¾ <span style=\"color:#9ca3af;font-weight:normal;\">(æœ€å¤š5ä¸ª)</span></label>\r\n              <div class=\"rental-tags-grid\">\r\n                ${[\"ä¸ªç¨\", \"å¢å€¼ç¨\", \"ä¼ä¸šæ‰€å¾—ç¨\", \"å°èŠ±ç¨\", \"åœŸåœ°å¢å€¼ç¨\",\r\n                  \"çº³ç¨ç”³æŠ¥\", \"ç¨åŠ¡ç­¹åˆ’\", \"å‘ç¥¨ç®¡ç†\", \"ç¨åŠ¡ç™»è®°\",\r\n                  \"è´¢åŠ¡æŠ¥è¡¨\", \"å®¡è®¡\", \"ä¼šè®¡æ ¸ç®—\", \"æˆæœ¬ç®¡ç†\",\r\n                  \"ç¤¾ä¿å…¬ç§¯é‡‘\", \"å·¥å•†æ³¨å†Œ\", \"æ”¿ç­–å’¨è¯¢\"].map(tag => {\r\n                  const isSelected = state.rentalPublishDraft.tags.includes(tag);\r\n                  return html`<button type=\"button\" class=\"rental-tag-chip ${isSelected ? \"rental-tag-chip--active\" : \"\"}\"\r\n                    @click=${() => {\r\n                      if (isSelected) {\r\n                        state.rentalPublishDraft.tags = state.rentalPublishDraft.tags.filter(t => t !== tag);\r\n                      } else if (state.rentalPublishDraft.tags.length < 5) {\r\n                        state.rentalPublishDraft.tags = [...state.rentalPublishDraft.tags, tag];\r\n                      }\r\n                      scheduleRender();\r\n                    }}>${tag}</button>`;\r\n                })}\r\n              </div>\r\n            </div>\r\n            <div class=\"rental-publish-actions\">\r\n              <button class=\"rental-btn-cancel\" @click=${closePublishDialog}>å–æ¶ˆ</button>\r\n              <button class=\"rental-btn-publish\"\r\n                ?disabled=${!state.rentalPublishDraft.description.trim() || state.rentalPublishDraft.price < 1}\r\n                @click=${publishAgent}>å‘å¸ƒ (${state.rentalPublishDraft.price} ç§¯åˆ†/æ¬¡)</button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.rentalTaskPanel && state.rentalActiveTask ? html`\r\n        <div class=\"rental-task-overlay\" @click=${closeTaskPanel}>\r\n          <div class=\"rental-task-panel\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <h3>${state.rentalActiveTask.status === \"revision_requested\" ? \"âœï¸ å¤„ç†ä¿®è®¢è¯·æ±‚\" : \"ğŸ“‹ å¤„ç†ä»»åŠ¡\"}</h3>\r\n            <div class=\"rental-task-info\">\r\n              <div class=\"rental-task-title\">${state.rentalActiveTask.title}</div>\r\n              <div class=\"rental-task-meta\">\r\n                æ¥è‡ª: ${state.rentalActiveTask.client.name} Â· æ™ºèƒ½ä½“: ${state.rentalActiveTask.listing.emoji} ${state.rentalActiveTask.listing.name}\r\n                ${state.rentalActiveTask.revisionCount ? html` Â· <span style=\"color:#9333ea;\">ç¬¬ ${state.rentalActiveTask.revisionCount + 1} æ¬¡ä¿®è®¢</span>` : \"\"}\r\n              </div>\r\n              ${state.rentalActiveTask.status === \"revision_requested\" && state.rentalActiveTask.revisionRequest ? html`\r\n                <div style=\"margin-top:8px;padding:8px 12px;border-radius:8px;background:rgba(147,51,234,0.1);border:1px solid rgba(147,51,234,0.2);\">\r\n                  <div style=\"font-size:12px;color:#9333ea;font-weight:600;margin-bottom:4px;\">ğŸ“ å®¢æˆ·ä¿®è®¢è¦æ±‚</div>\r\n                  <div style=\"font-size:13px;color:#e2e8f0;white-space:pre-wrap;\">${state.rentalActiveTask.revisionRequest}</div>\r\n                </div>\r\n              ` : \"\"}\r\n              <div class=\"rental-task-content\">${state.rentalActiveTask.content}</div>\r\n              ${(() => {\r\n                if (!state.rentalActiveTask?.attachments) return \"\";\r\n                try {\r\n                  const atts = JSON.parse(state.rentalActiveTask.attachments) as Array<{name: string; url: string; type: string; size: number}>;\r\n                  if (atts.length === 0) return \"\";\r\n                  const images = atts.filter(a => a.type?.startsWith(\"image/\"));\r\n                  const files = atts.filter(a => !a.type?.startsWith(\"image/\"));\r\n                  return html`\r\n                    <div class=\"rental-task-client-attachments\">\r\n                      <div class=\"rental-task-attachments-label\">ğŸ“ å®¢æˆ·é™„ä»¶ (${atts.length})</div>\r\n                      ${images.length > 0 ? html`\r\n                        <div class=\"rental-att-images\">\r\n                          ${images.map(att => html`\r\n                            <a class=\"rental-att-img-wrap\" href=\"https://taxbot.cc:8443${att.url}\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"${att.name}\">\r\n                              <img class=\"rental-att-img\" src=\"https://taxbot.cc:8443${att.url}\" alt=\"${att.name}\" />\r\n                              <span class=\"rental-att-img-name\">${att.name}</span>\r\n                            </a>\r\n                          `)}\r\n                        </div>\r\n                      ` : \"\"}\r\n                      ${files.length > 0 ? html`\r\n                        <div class=\"rental-task-attachments-list\">\r\n                          ${files.map(att => html`\r\n                            <a class=\"rental-task-attachment-item\" href=\"https://taxbot.cc:8443${att.url}\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"text-decoration:none;cursor:pointer;\">\r\n                              <span class=\"rental-att-file-icon\">ğŸ“„</span>\r\n                              <span class=\"rental-task-attachment-name\">${att.name}</span>\r\n                              <span class=\"rental-task-attachment-size\">(${(att.size / 1024).toFixed(0)}KB)</span>\r\n                            </a>\r\n                          `)}\r\n                        </div>\r\n                      ` : \"\"}\r\n                    </div>`;\r\n                } catch { return \"\"; }\r\n              })()}\r\n            </div>\r\n            <div class=\"rental-task-agent-action\">\r\n              ${state.rentalAgentProcessing ? (() => {\r\n                const _agentId = state.rentalActiveTask?.listing.agentId;\r\n                const _agent = _agentId ? state.agentsList.find(a => a.id === _agentId) : null;\r\n                return html`\r\n                <div class=\"rental-agent-processing\">\r\n                  <div class=\"rental-agent-spinner\"></div>\r\n                  ${_agent ? html`\r\n                    <span class=\"rental-processing-agent\">\r\n                      ${_agent.avatarUrl\r\n                        ? html`<img src=\"${_agent.avatarUrl}\" class=\"rental-processing-avatar\" />`\r\n                        : html`<span class=\"rental-processing-emoji\">${_agent.emoji}</span>`}\r\n                      <strong>${_agent.name}</strong> æ­£åœ¨å¤„ç†ä»»åŠ¡...\r\n                    </span>\r\n                  ` : html`<span>æ™ºèƒ½ä½“æ­£åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¯·ç¨å€™...</span>`}\r\n                </div>`;\r\n              })() : html`\r\n                <button class=\"rental-btn-agent\"\r\n                  @click=${processTaskWithAgent}>\r\n                  ğŸ¤– è®©æ™ºèƒ½ä½“å¤„ç†\r\n                </button>\r\n              `}\r\n            </div>\r\n            <div class=\"rental-task-result-label\">\r\n              ${state.rentalAgentProcessing ? \"æ™ºèƒ½ä½“å›ç­”ä¸­...\" : \"æ™ºèƒ½ä½“å›ç­” / ä»»åŠ¡ç»“æœ\"}\r\n            </div>\r\n            <textarea class=\"rental-task-result-area\"\r\n              .value=${state.rentalTaskResult}\r\n              @input=${(e: Event) => { state.rentalTaskResult = (e.target as HTMLTextAreaElement).value; }}\r\n              ?readonly=${state.rentalAgentProcessing}\r\n              placeholder=\"æ™ºèƒ½ä½“å¤„ç†åç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‰‹åŠ¨å¡«å†™...\"></textarea>\r\n            ${state.rentalTaskResult.trim() ? html`\r\n            <div class=\"rental-task-instruction\">\r\n              <div class=\"rental-task-instruction-label\">âœï¸ ä¿®æ”¹æŒ‡ä»¤ <span style=\"color:#9ca3af;font-weight:normal;\">ï¼ˆè¾“å…¥æŒ‡ä»¤è®©æ™ºèƒ½ä½“ä¿®æ”¹ä¸Šæ–¹ç»“æœï¼‰</span></div>\r\n              <div class=\"rental-task-instruction-row\">\r\n                <input class=\"rental-task-instruction-input\"\r\n                  type=\"text\"\r\n                  .value=${state.rentalTaskInstruction}\r\n                  @input=${(e: Event) => { state.rentalTaskInstruction = (e.target as HTMLInputElement).value; scheduleRender(); }}\r\n                  @keydown=${(e: KeyboardEvent) => {\r\n                    if (e.key === \"Enter\" && !e.shiftKey && state.rentalTaskInstruction.trim() && !state.rentalAgentProcessing) {\r\n                      e.preventDefault();\r\n                      reviseTaskWithInstruction();\r\n                    }\r\n                  }}\r\n                  ?disabled=${state.rentalAgentProcessing}\r\n                  placeholder=\"ä¾‹å¦‚ï¼šæŠŠç»“è®ºéƒ¨åˆ†å†™å¾—æ›´è¯¦ç»†ä¸€äº›...\" />\r\n                <button class=\"rental-btn-revise\"\r\n                  ?disabled=${!state.rentalTaskInstruction.trim() || state.rentalAgentProcessing}\r\n                  @click=${reviseTaskWithInstruction}>\r\n                  ${state.rentalAgentProcessing ? \"ä¿®æ”¹ä¸­...\" : \"å‘é€\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n            ` : \"\"}\r\n            <div class=\"rental-task-attachments\">\r\n              <div class=\"rental-task-attachments-label\">ğŸ“ é™„ä»¶ <span style=\"color:#9ca3af;font-weight:normal;\">(å¯é€‰ï¼Œæœ€å¤š5ä¸ª)</span></div>\r\n              <div class=\"rental-task-attachments-list\">\r\n                ${state.rentalTaskAttachments.map((f, i) => html`\r\n                  <div class=\"rental-task-attachment-item\">\r\n                    <span class=\"rental-task-attachment-name\">${f.name}</span>\r\n                    <span class=\"rental-task-attachment-size\">(${(f.size / 1024).toFixed(0)}KB)</span>\r\n                    <button class=\"rental-task-attachment-remove\" @click=${() => {\r\n                      state.rentalTaskAttachments = state.rentalTaskAttachments.filter((_, j) => j !== i);\r\n                      scheduleRender();\r\n                    }}>âœ•</button>\r\n                  </div>\r\n                `)}\r\n                ${state.rentalTaskAttachments.length < 5 ? html`\r\n                  <label class=\"rental-task-attachment-add\">\r\n                    ğŸ“ æ·»åŠ é™„ä»¶\r\n                    <input type=\"file\" multiple style=\"display:none;\" @change=${(e: Event) => {\r\n                      const input = e.target as HTMLInputElement;\r\n                      const newFiles = Array.from(input.files || []);\r\n                      const valid = newFiles.filter(f => f.size <= 10 * 1024 * 1024);\r\n                      if (valid.length < newFiles.length) showToast(\"éƒ¨åˆ†æ–‡ä»¶è¶…è¿‡10MBé™åˆ¶ï¼Œå·²è·³è¿‡\");\r\n                      state.rentalTaskAttachments = [...state.rentalTaskAttachments, ...valid].slice(0, 5);\r\n                      input.value = \"\";\r\n                      scheduleRender();\r\n                    }} />\r\n                  </label>\r\n                ` : \"\"}\r\n              </div>\r\n            </div>\r\n            <!-- Messages -->\r\n            <div class=\"rental-messages-section\">\r\n              <button class=\"rental-messages-toggle\" @click=${toggleMessages}>\r\n                ğŸ’¬ ç•™è¨€æ²Ÿé€š ${(state.rentalActiveTask?.unreadMessageCount || 0) > 0 ? html`<span class=\"rental-messages-badge rental-messages-badge--unread\">${state.rentalActiveTask!.unreadMessageCount}</span>` : state.rentalMessages.length > 0 ? html`<span class=\"rental-messages-badge\">${state.rentalMessages.length}</span>` : \"\"}\r\n              </button>\r\n              ${state.rentalMessagesOpen ? html`\r\n                <div class=\"rental-messages-container\">\r\n                  <div class=\"rental-messages-list\">\r\n                    ${state.rentalMessages.length === 0\r\n                      ? html`<div class=\"rental-messages-empty\">æš‚æ— ç•™è¨€</div>`\r\n                      : state.rentalMessages.map(msg => html`\r\n                        <div class=\"rental-message-row ${msg.sender.id === state.taxstoreUser?.id ? \"rental-message-row--mine\" : \"\"}\">\r\n                          <div class=\"rental-message-bubble ${msg.sender.id === state.taxstoreUser?.id ? \"rental-message-bubble--mine\" : \"rental-message-bubble--other\"}\">\r\n                            <div class=\"rental-message-sender\">${msg.sender.name}</div>\r\n                            <div class=\"rental-message-content\">${msg.content}</div>\r\n                            <div class=\"rental-message-time\">${new Date(msg.createdAt).toLocaleTimeString()}</div>\r\n                          </div>\r\n                        </div>\r\n                      `)\r\n                    }\r\n                  </div>\r\n                  <div class=\"rental-messages-input-row\">\r\n                    <input type=\"text\" class=\"rental-messages-input\" .value=${state.rentalMessageInput}\r\n                      @input=${(e: Event) => { state.rentalMessageInput = (e.target as HTMLInputElement).value; scheduleRender(); }}\r\n                      @keydown=${(e: KeyboardEvent) => { if (e.key === \"Enter\") { e.preventDefault(); sendTaskMessage(); } }}\r\n                      placeholder=\"è¾“å…¥ç•™è¨€...\" />\r\n                    <button class=\"rental-messages-send\" @click=${sendTaskMessage}\r\n                      ?disabled=${!state.rentalMessageInput.trim()}>å‘é€</button>\r\n                  </div>\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n            <div class=\"rental-task-actions\">\r\n              <span class=\"rental-task-price\">ğŸ’° å®Œæˆå¯è·å¾— ${state.rentalActiveTask.price} ç§¯åˆ†</span>\r\n              <div style=\"display:flex;gap:8px;\">\r\n                <button class=\"rental-btn-cancel\" @click=${closeTaskPanel}>å–æ¶ˆ</button>\r\n                <button class=\"rental-btn-submit\"\r\n                  ?disabled=${!state.rentalTaskResult.trim() || state.rentalAgentProcessing}\r\n                  @click=${submitTaskResult}>æäº¤ç»“æœ</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      <!-- ä»»åŠ¡åˆ—è¡¨å¼¹çª— -->\r\n      ${state.rentalTaskListType ? (() => {\r\n        const isPending = state.rentalTaskListType === \"pending\";\r\n        const tasks = isPending ? state.rentalPendingTasks : state.rentalCompletedTasks;\r\n        return html`\r\n        <div class=\"rental-task-overlay\" @click=${() => { state.rentalTaskListType = null; scheduleRender(); }}>\r\n          <div class=\"rental-tasklist-dialog\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <div class=\"rental-tasklist-header\">\r\n              <h3>${isPending ? \"ğŸ“‹ å¾…å¤„ç†ä»»åŠ¡\" : \"âœ… å·²å®Œæˆä»»åŠ¡\"} <span class=\"rental-tasklist-badge ${isPending ? \"rental-tasklist-badge--pending\" : \"rental-tasklist-badge--done\"}\">${tasks.length}</span></h3>\r\n              <button class=\"rental-tasklist-close\" @click=${() => { state.rentalTaskListType = null; scheduleRender(); }}>âœ•</button>\r\n            </div>\r\n            <div class=\"rental-tasklist-body\">\r\n              ${tasks.length === 0 ? html`<div class=\"rental-tasklist-empty\">æš‚æ— ä»»åŠ¡</div>` : \"\"}\r\n              ${tasks.map(task => html`\r\n                <div class=\"rental-tasklist-item ${isPending ? \"rental-tasklist-item--pending\" : \"rental-tasklist-item--done\"}\"\r\n                  @click=${() => {\r\n                    if (isPending) { state.rentalTaskListType = null; openTaskPanel(task); }\r\n                    else { state.rentalTaskDetailView = task; scheduleRender(); }\r\n                  }}>\r\n                  <div class=\"rental-tasklist-item-emoji\">${task.listing.emoji}</div>\r\n                  <div class=\"rental-tasklist-item-body\">\r\n                    <div class=\"rental-tasklist-item-title\">${task.title}</div>\r\n                    <div class=\"rental-tasklist-item-meta\">\r\n                      ${task.listing.name} Â· ${task.client.name}\r\n                      ${task.completedAt ? html` Â· ${new Date(task.completedAt).toLocaleDateString()}` : \"\"}\r\n                    </div>\r\n                    ${!isPending && task.rating ? html`\r\n                      <div class=\"rental-tasklist-item-rating\">${\"â­\".repeat(task.rating)}${task.ratingComment ? html` <span class=\"rental-task-card-comment\">${task.ratingComment}</span>` : \"\"}</div>\r\n                    ` : \"\"}\r\n                  </div>\r\n                  <div class=\"rental-tasklist-item-right\">\r\n                    <div class=\"rental-tasklist-item-price ${isPending ? \"\" : \"rental-task-card-price--earned\"}\">${isPending ? \"\" : \"+\"}${task.price} ç§¯åˆ†</div>\r\n                    ${isPending ? html`<div class=\"rental-tasklist-item-action\">å¤„ç† â†’</div>` : html`<div class=\"rental-tasklist-item-action\">è¯¦æƒ… â†’</div>`}\r\n                  </div>\r\n                </div>\r\n              `)}\r\n            </div>\r\n          </div>\r\n        </div>`;\r\n      })() : \"\"}\r\n\r\n      <!-- å·²å®Œæˆä»»åŠ¡è¯¦æƒ…å¼¹çª— -->\r\n      ${state.rentalTaskDetailView ? html`\r\n        <div class=\"rental-task-overlay\" @click=${() => { state.rentalTaskDetailView = null; scheduleRender(); }}>\r\n          <div class=\"rental-task-panel\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <div style=\"display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;\">\r\n              <h3 style=\"margin:0;\">âœ… ä»»åŠ¡è¯¦æƒ…</h3>\r\n              <button class=\"rental-tasklist-close\" @click=${() => { state.rentalTaskDetailView = null; scheduleRender(); }}>âœ•</button>\r\n            </div>\r\n            <div class=\"rental-task-info\">\r\n              <div class=\"rental-task-title\">${state.rentalTaskDetailView.title}</div>\r\n              <div class=\"rental-task-meta\">\r\n                æ¥è‡ª: ${state.rentalTaskDetailView.client.name} Â· æ™ºèƒ½ä½“: ${state.rentalTaskDetailView.listing.emoji} ${state.rentalTaskDetailView.listing.name}\r\n              </div>\r\n              <div class=\"rental-task-content\">${state.rentalTaskDetailView.content}</div>\r\n            </div>\r\n            ${state.rentalTaskDetailView.result ? html`\r\n              <div class=\"rental-task-result-label\">æ™ºèƒ½ä½“å›å¤</div>\r\n              <div class=\"rental-task-detail-result\">${state.rentalTaskDetailView.result}</div>\r\n            ` : \"\"}\r\n            <div class=\"rental-task-detail-footer\">\r\n              <div class=\"rental-task-detail-stats\">\r\n                <span class=\"rental-task-card-price--earned\">+${state.rentalTaskDetailView.price} ç§¯åˆ†</span>\r\n                ${state.rentalTaskDetailView.completedAt ? html`<span style=\"color:#9ca3af;font-size:12px;\">å®Œæˆäº ${new Date(state.rentalTaskDetailView.completedAt).toLocaleString()}</span>` : \"\"}\r\n              </div>\r\n              ${state.rentalTaskDetailView.rating ? html`\r\n                <div class=\"rental-task-detail-rating\">\r\n                  ${\"â­\".repeat(state.rentalTaskDetailView.rating)}\r\n                  ${state.rentalTaskDetailView.ratingComment ? html`<span style=\"color:#9ca3af;font-size:12px;margin-left:8px;\">${state.rentalTaskDetailView.ratingComment}</span>` : \"\"}\r\n                </div>\r\n              ` : \"\"}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.previewAttachment ? html`\r\n        <div class=\"preview-modal\" @click=${() => {\r\n          state.previewAttachment = null;\r\n          renderApp();\r\n        }}>\r\n          <div class=\"preview-content\" @click=${(e: Event) => e.stopPropagation()}>\r\n            <button class=\"preview-close\" @click=${() => {\r\n              state.previewAttachment = null;\r\n              renderApp();\r\n            }}>âœ•</button>\r\n            ${state.previewAttachment.type.startsWith(\"image/\") ? html`\r\n              <img src=${state.previewAttachment.dataUrl} alt=${state.previewAttachment.name} class=\"preview-image\" />\r\n            ` : html`\r\n              <div class=\"preview-file-info\">\r\n                <div class=\"preview-file-icon\">ğŸ“„</div>\r\n                <div class=\"preview-file-name\">${state.previewAttachment.name}</div>\r\n                <div class=\"preview-file-size\">${formatFileSize(state.previewAttachment.size)}</div>\r\n                <div class=\"preview-file-type\">${state.previewAttachment.type}</div>\r\n              </div>\r\n            `}\r\n          </div>\r\n        </div>\r\n      ` : \"\"}\r\n\r\n      ${state.toastMessage ? html`\r\n        <div class=\"taxchat-toast\">\r\n          <div class=\"taxchat-toast__icon\">ğŸ“š</div>\r\n          <div class=\"taxchat-toast__text\">${state.toastMessage}</div>\r\n          <button class=\"taxchat-toast__close\" @click=${() => {\r\n            if (state.toastTimer) clearTimeout(state.toastTimer);\r\n            state.toastMessage = null;\r\n            state.toastTimer = null;\r\n            renderApp();\r\n          }}>âœ•</button>\r\n        </div>\r\n      ` : \"\"}\r\n    </div>\r\n  `;\r\n\r\n  render(content, app);\r\n\r\n  // Auto-scroll + virtual scroll measurement\r\n  requestAnimationFrame(() => {\r\n    const container = document.getElementById(\"messages-container\");\r\n    if (container) {\r\n      // Measure rendered heights for virtual scroll accuracy\r\n      measureRenderedHeights();\r\n\r\n      // Auto scroll â€” only force when explicitly requested (send, switch conv)\r\n      if (_forceScrollBottom) {\r\n        container.scrollTop = container.scrollHeight;\r\n        setForceScrollBottom(false);\r\n      } else {\r\n        // Respects wasAtBottom: scrolls only if user was already at bottom\r\n        autoScrollToBottom(container);\r\n      }\r\n\r\n      // Attach scroll listener for virtual scroll recalculation (once)\r\n      if (!(container as any).__vsListenerAttached) {\r\n        (container as any).__vsListenerAttached = true;\r\n        let vsRafPending = false;\r\n        container.addEventListener(\"scroll\", () => {\r\n          checkAtBottom(container);\r\n          // Only re-render for virtual scroll when message count warrants it\r\n          if (state.messages.length >= 40 && !vsRafPending) {\r\n            vsRafPending = true;\r\n            requestAnimationFrame(() => {\r\n              vsRafPending = false;\r\n              scheduleRender();\r\n            });\r\n          }\r\n        }, { passive: true });\r\n      }\r\n    }\r\n  });\r\n\r\n  // Focus input (skip when side panel is open to avoid stealing focus from panel inputs)\r\n  const input = document.getElementById(\"message-input\") as HTMLTextAreaElement;\r\n  if (input && !state.sidePanel && !state.searchOpen) {\r\n    input.focus();\r\n    state.inputRef = input;\r\n  }\r\n}\r\n\r\n// â”€â”€â”€ Event Listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\n// Intercept link clicks in messages to open file paths and URLs via Electron\r\n// Close status menu on outside click\r\ndocument.addEventListener(\"click\", () => {\r\n  let changed = false;\r\n  if (state.showStatusMenu) { state.showStatusMenu = false; changed = true; }\r\n  if (state.showNotifications) { state.showNotifications = false; changed = true; }\r\n  if (changed) renderApp();\r\n});\r\n\r\ndocument.addEventListener(\"click\", (e: MouseEvent) => {\r\n  const target = e.target as HTMLElement;\r\n  const anchor = target.closest(\"a\") as HTMLAnchorElement | null;\r\n  if (!anchor) return;\r\n  const href = anchor.getAttribute(\"href\");\r\n  if (!href) return;\r\n  // Only handle links inside message bubbles\r\n  if (!anchor.closest(\".message-bubble\")) return;\r\n  e.preventDefault();\r\n  e.stopPropagation();\r\n  const api = (window as any).electronAPI;\r\n  if (href.startsWith(\"#localpath=\")) {\r\n    const localPath = decodeURIComponent(href.replace(\"#localpath=\", \"\"));\r\n    if (api?.openPath) {\r\n      api.openPath(localPath);\r\n    }\r\n  } else if (/^https?:\\/\\//i.test(href)) {\r\n    if (api?.openPath) {\r\n      api.openPath(href);\r\n    } else {\r\n      window.open(href, \"_blank\");\r\n    }\r\n  }\r\n});\r\n\r\n// Ctrl+F to open search\r\ndocument.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n  if ((e.ctrlKey || e.metaKey) && e.key === \"f\") {\r\n    e.preventDefault();\r\n    openSearch();\r\n  }\r\n});\r\n\r\n// Auto-connect on load\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  // Apply saved font size\r\n  document.documentElement.setAttribute(\"data-font-size\", state.fontSize);\r\n\r\n  connectGateway();\r\n  loadFolderKnowledge();\r\n  registerWatcherListener();\r\n  registerManagedSkillsListener();\r\n  startWatcher();\r\n  syncManagedSkills();\r\n\r\n  // Listen for gateway port changes (port conflict auto-switch)\r\n  const api = (window as any).electronAPI;\r\n  if (api?.onGatewayPortChanged) {\r\n    api.onGatewayPortChanged((port: number) => {\r\n      console.log(`[Gateway] Port changed to ${port}, reconnecting...`);\r\n      state.gatewayUrl = `ws://127.0.0.1:${port}`;\r\n      connectGateway();\r\n    });\r\n  }\r\n});\r\n\r\n// â”€â”€â”€ Register Quick Commands â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nregisterCommands([\r\n  { id: \"risk\",     name: \"/risk\",     emoji: \"ğŸ§¾\", description: \"ç¨åŠ¡é£é™©æ²»ç†\",     action: () => handleQuickSkill(\"risk-governance\", \"è¯·å¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œç¨åŠ¡é£é™©åˆ†æ\", \"ç¨åŠ¡é£é™©æ²»ç†\") },\r\n  { id: \"invoice\",  name: \"/invoice\",  emoji: \"ğŸ”\", description: \"å‘ç¥¨æŸ¥éªŒ\",         action: () => handleQuickSkill(\"invoice-check\", \"è¯·æŸ¥éªŒè¿™äº›å‘ç¥¨\", \"å‘ç¥¨æŸ¥éªŒ\") },\r\n  { id: \"compare\",  name: \"/compare\",  emoji: \"ğŸ“Š\", description: \"çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡\",   action: () => handleQuickSkill(\"declaration-review\", \"è¯·å®¡æ ¸çº³ç¨ç”³æŠ¥è¡¨\", \"çº³ç¨ç”³æŠ¥è¡¨é¢„å®¡\") },\r\n  { id: \"contract\", name: \"/contract\", emoji: \"ğŸ“\", description: \"åˆåŒåŠç¥¨æ®ç¨å®¡\",   action: () => handleQuickSkill(\"contract-review\", \"è¯·è¿›è¡ŒåˆåŒç¨å®¡\", \"åˆåŒåŠç¥¨æ®ç¨å®¡\") },\r\n  { id: \"receipt\",  name: \"/receipt\",  emoji: \"ğŸ“‚\", description: \"ç¥¨æ®æ•´ç†\",         action: () => handleQuickSkill(\"receipt-organize\", \"è¯·æ‰§è¡Œç¥¨æ®æ•´ç†æµç¨‹\", \"ç¥¨æ®æ•´ç†\", true) },\r\n  { id: \"clear\",    name: \"/clear\",    emoji: \"ğŸ—‘ï¸\", description: \"æ¸…ç©ºå½“å‰å¯¹è¯\",      action: () => { state.confirmingClear = true; scheduleRender(); } },\r\n  { id: \"new\",      name: \"/new\",      emoji: \"ğŸ’¬\", description: \"æ–°å»ºå¯¹è¯\",         action: () => createConversation() },\r\n  { id: \"export\",   name: \"/export\",   emoji: \"ğŸ“¤\", description: \"å¯¼å‡ºå¯¹è¯ (Markdown)\", action: () => exportAsMarkdown() },\r\n  { id: \"exporthtml\", name: \"/exporthtml\", emoji: \"ğŸŒ\", description: \"å¯¼å‡ºå¯¹è¯ (HTML)\", action: () => exportAsHTML() },\r\n  { id: \"search\",   name: \"/search\",   emoji: \"ğŸ”\", description: \"æœç´¢æ¶ˆæ¯\",         action: () => openSearch() },\r\n]);\r\n\r\n// â”€â”€â”€ Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\ninitPersistence();\r\ninitConversations();\r\nsetRenderer(renderApp);\r\nscheduleRender();\r\n\r\n// TaxStore â€” restore session & sync (non-blocking)\r\ninitTaxStore().then(() => {\r\n  if (state.taxstoreConnected) {\r\n    syncInstalled();\r\n    initRental();\r\n  }\r\n});\r\n"],"names":["TAXBOT_VERSION","l","i","t","r","n","o","e","s","FAVORITES_STORAGE_KEY","MESSAGES_STORAGE_KEY","NOTIFICATIONS_STORAGE_KEY","CUSTOM_SKILLS_STORAGE_KEY","CONVERSATIONS_STORAGE_KEY","CURRENT_CONV_KEY","CONTEXT_MAX_CHARS","AGENT_TEMPLATES","BUILTIN_SKILLS","TOOL_LABEL_MAP","generateUUID","c","rendererFn","renderPending","setRenderer","fn","scheduleRender","_forceScrollBottom","setForceScrollBottom","val","state","isAnySending","isSessionBusy","sessionKey","findRunForEvent","evtSessionKey","run","getMessagesForSession","convId","isCurrentSession","DB_NAME","DB_VERSION","MESSAGES_STORE","META_STORE","dbInstance","dbFailed","openDB","resolve","reject","request","db","saveMessagesToIDB","messages","toSave","tx","loadMessagesFromIDB","req","result","deleteConversationFromIDB","migrateToIDB","conversationIds","key","raw","isIDBAvailable","idbReady","loadConversations","parsed","saveConversations","loadMessagesForConversation","loadMessagesAsync","idbMessages","saveMessagesForConversation","loadFavoritesForConversation","saveFavoritesForConversation","favorites","loadMessages","loadFavorites","saveMessages","conv","saveTimer","debouncedSaveMessages","flushPendingSave","saveFavorites","syncFavoritesToMemory","api","favMsgs","msgId","idx","m","msg","question","j","deleteConversationData","loadNotifications","saveNotifications","loadCustomSkills","saveCustomSkills","migrateOldMessages","oldMessages","oldFavorites","now","firstUserMsg","title","initPersistence","convIds","loaded","ok","DEFAULT_USER_HEIGHT","DEFAULT_ASSISTANT_HEIGHT","OVERSCAN","measuredHeights","estimateHeight","calculateVirtualRange","scrollTop","containerHeight","sum","totalHeight","offsets","startIndex","endIndex","topPadding","bottomPadding","measureRenderedHeights","container","elements","el","id","height","wasAtBottom","checkAtBottom","autoScrollToBottom","clearHeightCache","pruneOrphanedFavorites","msgIds","changed","favId","createConversation","switchConversation","oldConvId","oldSessionKey","hasActiveRunsForOld","sk","targetConv","msgs","deleteConversation","renameConversation","newTitle","autoTitleConversation","text","initConversations","convs","currentId","migrated","formatTime","timestamp","formatFileSize","bytes","k","sizes","generateTimestamp","sortedFiles","files","a","b","sortedSkills","skills","readFileAsDataUrl","file","reader","removeAttachment","index","toggleFavorite","scrollToMessage","copyMessageText","toSanitizedMarkdownHtml","plain","btn","label","generateWordDoc","saveMessageAsWord","wordDoc","blob","url","showToast","message","durationMs","addNotification","icon","taskId","source","dismissQuickStart","toolLabelMap","toolName","stripThinkingTags","cleaned","extractMessageText","role","content","parts","p","item","v","joined","isSystemMessage","stripped","pattern","sanitizeDisplayText","autoLinkText","urlChars","pathChars","re","match","codeBlock","mdLink","inlineCode","filePath","extractAttachmentTexts","attachments","electronAPI","att","mimeType","base64Data","err","escapeRegex","formatImportResult","buildSkillsForTools","selectedIds","allSkills","agentMemoryCache","loadAgentMemory","agentId","res","saveAgentMemory","appendAgentMemory","newEntry","existing","updated","loadAgents","defaultId","nameless","recoverAgentNames","syncAgentsToMainWorkspace","recovered","rec","agent","configRes","baseHash","currentConfig","existingList","newList","identityObj","agents","createAgentFromTemplate","tpl","createAgent","d","name","fullList","patch","wsResult","deleteAgent","filteredList","finalList","openAgentEditor","ws","updateAgent","updatedList","parseAgentMentions","mentions","seen","cleanText","regex","getMentionCandidates","filter","insertAgentMention","cursorReplace","syncManagedSkills","builtinFolders","ms","newPrompt","newDesc","openSkillEditor","skill","saveSkillFromEditor","deleteCustomSkill","exportSkillAsZip","handleInstallSkillPackage","fileInput","toggleSkillPin","handleCustomSkillClick","tag","clearActiveCustomSkill","handleQuickSkill","skillName","prompt","displayLabel","noFilePicker","sendFn","filesFn","builtinSkill","knowledgeDragCounter","setKnowledgeDragCounter","knowledgeIndex","indexKnowledge","part","trimmed","headerMatch","fileName","keywords","cnMatches","freq","w","sorted","enMatches","selectRelevantKnowledge","query","maxChars","queryLower","scored","chunk","score","kw","selected","charCount","entry","loadFolderKnowledge","loadKnowledgeFiles","handleKnowledgeDrop","base64","addKnowledgeRef","removeKnowledgeRef","deleteKnowledgeFileAction","doImportFolder","folderPath","startWatcher","handleAuthorizeFolder","handleRefreshFolder","saveMessageToKnowledge","_watcherListenerRegistered","registerWatcherListener","data","_skillsListenerRegistered","registerManagedSkillsListener","buildConversationContext","excludeSessionKeys","forAgentName","recent","lines","totalChars","line","isRelevant","um","aMsg","emoji","isBadResponse","updateCollabTaskStatus","status","task","finishSendingForRun","isBg","filtered","dispatchPendingAgents","checkReactiveMentions","lastMsg","lastText","isNoResponse","isFailResponse","idempotencyKey","POLL_INTERVAL","STALE_TIMEOUT","MAX_TOTAL_TIME","pollingControllers","extractHistoryAssistantText","lastUserIdx","startIdx","assistantTexts","block","rc","sub","upsertAssistantText","runId","existingIdx","fetchCompleteResponse","controller","signal","startTime","lastChangeTime","prevText","poll","historyText","cancelPolling","ctrl","getLastAssistantText","extractAgentTask","response","agentName","patterns","pending","mainResponse","collabTasks","assignedTask","agentMessage","memory","conversationContext","requestPayload","detectExplicitMention","bp","finishedRun","responseText","mentionedAgents","srcName","handleFiles","fileArray","dataUrl","handleSend","userText","textWithoutMentions","nonDefaultTargets","hasDefaultMention","mention","useOrchestration","directTargets","busyNames","freeTargets","activeSkill","contentText","detectedSkill","textLower","messageToSend","skillSuffix","hasAttachments","hasImages","hasDocuments","displayText","replyToMsg","quoteSender","quoteText","messageAttachments","apiAttachments","attachmentType","attachment","documentText","refParts","ref","relevantKnowledge","finalMessage","orchestrationPrompt","freeAgentTargets","mainMessage","perAgentContext","abortRun","doClearAll","doClearSession","doExitApp","queue","processing","enqueueStateUpdate","processQueue","reconnectTimer","reconnectAttempt","isReconnecting","cancelReconnect","scheduleReconnect","delay","connectGateway","gatewayToken","port","GatewayBrowserClient","hello","code","evt","agentPayload","evtSK","matchedRun","phase","runSK","payload","inlineText","errorText","getProviderNames","getModelsForProvider","provider","selectProvider","providerName","providers","models","selectModel","modelId","populateModelDraft","config","keys","baseUrl","apiKey","loadModelConfig","modelsRes","saveModelConfig","registeredCommands","registerCommands","cmds","getFilteredCommands","openCommandPalette","closeCommandPalette","executeCommand","cmd","checkCommandTrigger","draft","commandNavigate","direction","commandExecuteSelected","downloadBlob","filename","exportAsMarkdown","am","md","exportAsHTML","messagesHtml","escaped","escapeHtml","html","openSearch","closeSearch","performSearch","q","results","scrollToSearchResult","nextResult","prevResult","TAXSTORE_BASE","tsLogin","email","password","tsGetMe","token","tsListSkills","opts","params","headers","tsGetSkillDetail","tsDownloadSkill","alreadyPurchased","tsPublishAgent","tsUnpublishAgent","tsGetMyAgents","tsHeartbeat","listingIds","tsGetPendingTasks","tsCompleteTask","resultAttachments","tsUploadTaskAttachment","formData","tsGetAgentStats","tsListAgents","qs","tsCreateTask","listingId","tsGetMyTasks","tsMarkTaskRead","tsRateTask","tsRequestRevision","tsGetTaskMessages","tsSendTaskMessage","tsGetInstalled","tsRecordInstall","skillId","version","TOKEN_KEY","initTaxStore","saved","user","loginTaxStore","fetchSkills","logoutTaxStore","page","searchSkills","filterByCategory","cat","changeSortOrder","sort","installFromTaxStore","header","arrayBuffer","blobToBase64","customSkill","refreshUserInfo","syncInstalled","remote","updates","local","detail","isInstalledLocally","avgRating","reviews","arrayBufferToBase64","buf","CHUNK","fetchTaskAttachments","attachmentsJson","imageAtts","textSuffix","atts","otherAtts","openPublishDialog","existingListing","existingTags","closePublishDialog","publishAgent","publishName","listing","loadMyListings","getListingForAgent","unpublishAgent","pollPendingTasks","tasks","oldMap","newTasks","old","activeIds","checkAutoCompleteTasks","startTaskPolling","pollConsultTasks","oldTaskMap","prevCount","unread","startConsultPolling","loadConsultAgents","loadConsultStats","stats","mins","timeStr","h","openConsultDetail","backToConsultList","openConsultMyTasks","openConsultTaskDetail","backFromConsultTaskDetail","toggleConsultMessages","loadConsultMessages","sendConsultMessage","toggleConsultRevision","submitConsultRevision","toggleConsultRating","submitConsultRating","uploadConsultAttachment","meta","removeConsultAttachment","submitConsultTask","rentalPollController","openTaskPanel","closeTaskPanel","extractRentalAssistantText","texts","processTaskWithAgent","imageAttachments","sendPayload","reviseTaskWithInstruction","instruction","currentResult","reviseMessage","submitTaskResult","memoryEntry","loadCompletedTasks","AUTO_COMPLETE_THRESHOLD","autoCompletingTasks","autoCompleteTask","autoImageAtts","autoPayload","finalText","getCompletedTasksForListing","loadTaskMessages","sendTaskMessage","toggleMessages","initRental","agentAvatarSrc","attUrl","parseAtts","json","fmtSize","refreshAll","u","_handleQuickSkill","renderQuickStart","renderMessages","groups","vRange","visibleMessages","renderQuoteCard","replyToId","quoted","sender","preview","renderApp","isFav","unsafeHTML","statusIcon","tgtAgent","handleSidePanelResizeStart","panel","handle","startX","startW","onMove","ev","newW","onUp","finalW","app","statusText","statusClass","_unread","rTask","cTask","x","isActive","isRenaming","isConfirmingDelete","hasUnread","convSK","isReplying","inp","allFavItems","isCurrentConv","favIds","f","dateKey","items","today","todayKey","yesterday","yesterdayKey","isCurrent","mid","targetConvId","favs","installed","completedTasks","totalEarned","exists","cnt","size","px","ta","mentionMatch","prevFilter","candidates","live","fi","cur","mem","isSelected","images","_agentId","_agent","_","input","newFiles","valid","render","vsRafPending","anchor","href","localPath"],"mappings":"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","x_google_ignoreList":[1]}