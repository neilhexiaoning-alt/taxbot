# 用 Claude Code 开发 Taxbot & TaxStore 的编程心得

> 记录 2026 年 2-3 月期间，使用 Claude Code（CLI）进行 AI 辅助编程的真实体验与思考。

---

## 一、项目背景

### Taxbot（智税宝）

一款面向财税从业者的 AI 桌面助手，基于 Electron + OpenClaw Gateway + Lit.js 构建。核心功能包括：

- 多 Agent 协作的税务咨询对话
- 本地知识库管理（文件夹导入、PDF/DOCX/XLSX 提取、关键词索引、相关性检索）
- 技能市场（内置技能 + 自定义技能 + 在线市场安装）
- Agent 租赁市场（发布服务、接单、评价）
- 对话管理（多会话、收藏、引用、导出 Word）
- 授权许可系统（试用期 + 激活码）

技术栈：Electron 40 / Lit 3 / Vite 7 / TypeScript / pdfjs-dist / mammoth / SheetJS

### TaxStore（技能商店平台）

配套的 Web 端市场平台，基于 Next.js 16 + Prisma + SQLite 构建。核心功能包括：

- 技能发布、审核、下载、评分
- Agent 服务市场（发布、任务提交、消息、评价、修订）
- 需求看板（悬赏、认领、完成）
- 积分体系（注册送分、操作加减分）
- 管理后台（用户、技能、评论、授权管理）
- 许可证申请与激活
- Wiki 知识库

---

## 二、Claude Code 的使用方式

### 2.1 对话式迭代开发

最典型的工作流程是：

1. **描述需求** → "taxbot知识库预览中可以选取文字引用到对话"
2. **Claude 给方案** → 分析现有架构，给出具体的文件改动方案
3. **确认后执行** → Claude 逐文件修改，构建，同步
4. **发现 Bug** → 描述现象，Claude 定位根因并修复

这个循环非常高效。一个完整的功能从构思到可用，通常在 1-2 轮对话内完成。

### 2.2 Plan Mode 的价值

Claude Code 的 Plan Mode 在处理有多种实现路径的需求时特别有用。比如"PDF 预览如何支持文字选中引用"这个问题：

- PDF 渲染在 iframe 中，存在跨域限制无法获取选中文本
- Claude 在 Plan Mode 下分析了这个约束，提出了 **PDF/文本切换** 的方案
- 用 pdfjs 提取文本，切换到文本模式时展示可选中的纯文本
- 方案确认后一次性完成所有改动

**经验：对于涉及技术约束的需求，先 Plan 再动手，避免走弯路。**

### 2.3 多文件协同修改

Taxbot 的一个功能改动往往涉及 5-8 个文件：

| 层级 | 文件 | 职责 |
|------|------|------|
| 类型 | `types.ts` | 新增状态字段定义 |
| 状态 | `state.ts` | 初始值 |
| 逻辑 | `knowledge.ts` | 业务函数 |
| UI | `taxchat-app.ts` | 模板渲染 |
| 样式 | `styles/knowledge.css` | 视觉表现 |
| 后端 | `electron/main.cjs` | IPC Handler |
| 桥接 | `electron/preload.cjs` | API 暴露 |
| 构建 | Vite build + 文件同步 | 部署到 taxbot-setup |

Claude Code 在这种多文件改动中表现出色——它能追踪所有文件之间的依赖关系，确保类型一致、接口对齐。手动做这些容易遗漏，而 Claude 几乎不会。

---

## 三、具体案例复盘

### 案例1：知识库文件预览

**需求**：知识面板文件列表支持点击预览内容

**实现过程**：
1. Electron 端新增 `preview-knowledge-file` IPC handler，支持文本/图片/PDF/DOCX/XLSX/PPTX
2. preload 暴露 API
3. UI 增加预览子视图（替换文件列表）
4. 引入 mammoth（DOCX→HTML）、xlsx（电子表格→HTML表格）、jszip（PPTX文本提取）

**关键决策**：预览不是新开窗口，而是在知识面板内替换显示，保持上下文连贯。

### 案例2：选中文字浮动引用按钮

**需求**：预览中选中文字后，出现"引用选中"按钮，点击将引文插入对话输入框

**遇到的坑**：
- `getBoundingClientRect()` 返回的是相对视口的坐标，而浮动按钮用 `position: absolute`，需要加上容器的 `scrollTop/scrollLeft`
- Lit 的数据绑定更新 `state.draft` 后不会触发 textarea 的 `@input` 事件，导致 auto-resize 不执行
- 解决：在 `quoteSelectedText()` 的 setTimeout 里手动执行高度重算

**收获**：Claude 在定位这类 DOM 坐标计算和框架行为差异的 Bug 时非常精准，能快速给出根因分析。

### 案例3：PDF 文本提取的曲折

**第一次尝试失败**：试图从 `authorized-*.md` 文件读取 PDF 的提取文本。但实际上 `importFolderToMemorySync` 对文档文件只存储了路径引用（`[文档文件] 路径: xxx`），没有实际内容。

**根因定位**：Claude 追踪了整个导入链路，发现了数据流的断点。

**最终方案**：找到项目中已有的 `loadPdfJs()` 函数，在 preview handler 中直接用 pdfjs 从原始 PDF 提取文本。

**教训：当一条路走不通时，Claude 能及时调整策略，而不是在错误路径上挣扎。**

### 案例4：TaxStore Agent 市场

**需求**：从零搭建 Agent 服务市场——列表展示、发布、任务提交、消息通信、评分修订，同时 Taxbot 客户端要对接 API。

**过程**：
- 数据库模型设计（AgentListing / AgentTask / TaskMessage）
- 14+ 个 API 端点（CRUD + 业务流转）
- 3 个前端页面（列表、详情、任务管理）
- Taxbot 客户端集成（rental.ts 36KB 逻辑）

这种大功能的开发，Claude Code 的优势是**不会遗忘需求细节**。在第一轮对话中列出的功能点，到最后一个文件修改时依然被完整覆盖。

---

## 四、效率感受

### 4.1 什么场景 Claude Code 特别快？

- **CRUD + API 端点**：定义好模型后，路由、参数校验、数据库操作一气呵成
- **CSS 样式**：描述想要的效果，Claude 直接输出精确的 CSS
- **Bug 修复**：描述现象，Claude 能在多个文件中快速定位根因
- **多文件重构**：改类型定义后自动追踪所有引用处
- **构建部署脚本**：理解项目结构后能正确处理文件同步

### 4.2 什么场景需要人工判断？

- **产品决策**："预览是新窗口还是面板内替换？" → 需要人来定
- **交互细节**："引用按钮在哪个位置体验最好？" → 需要实际试用后反馈
- **业务逻辑边界**："积分扣减规则是什么？" → 需要明确业务规则
- **性能优先级**："先优化哪个？" → 需要结合实际使用数据

### 4.3 大致效率提升

保守估计，使用 Claude Code 后：
- 功能开发速度提升 **3-5 倍**（尤其是涉及多文件的功能）
- Bug 定位速度提升 **5-10 倍**（Claude 不需要"回忆"代码，它直接读）
- 减少了大量查文档的时间（CSS 属性、API 用法、库的调用方式）

---

## 五、最佳实践总结

### 5.1 给 Claude 的指令要精确

| 效果差 | 效果好 |
|--------|--------|
| "优化输入框" | "输入框 max-height 只有 63px，引用文字后只能看到2行，改成150px" |
| "PDF 预览有问题" | "PDF 文本模式下选中文字，引用按钮不出现" |
| "做个市场" | "Agent 市场需要：列表页（搜索+筛选+分页）、详情页、任务提交、消息、评分" |

### 5.2 "先方案，确认后执行"模式

对于非平凡的需求，要求 Claude 先给方案再动手：
- 避免改了一半发现方向不对
- 可以在方案阶段补充约束条件
- 方案本身就是很好的技术文档

### 5.3 及时反馈 Bug 现象

Claude 的 Bug 修复能力取决于信息质量：
- "不工作" → Claude 只能猜
- "PDF 文本模式下，滚动到下方选中文字，浮动按钮出现在页面顶部看不到" → 一次定位到滚动偏移问题

### 5.4 利用 Claude 的代码记忆

在同一个对话中，Claude 记得之前读过的所有文件。可以充分利用这一点：
- 先让它读关键文件建立上下文
- 后续需求可以简短描述
- 它会自动对齐已有的代码风格和架构模式

### 5.5 构建和同步不要省

每次改动后都让 Claude 执行：`vite build` → 复制到 taxbot-setup → 验证

看起来啰嗦，但能避免"改了但没生效"的困惑。

---

## 六、不足与局限

### 6.1 上下文长度限制

长对话后 Claude 会压缩历史上下文。这意味着：
- 早期的改动细节可能被遗忘
- 需要在新对话中重新建立上下文
- 复杂的多阶段工作最好在 CLAUDE.md 或 memory 中记录关键信息

### 6.2 无法实际运行和验证

Claude 不能启动 Electron 应用查看效果。所有的 UI 改动都需要人工验证：
- 布局是否正确？
- 交互是否流畅？
- 边界情况是否处理？

### 6.3 对项目特殊约定需要反复提醒

比如 Taxbot 的构建流程（Vite build → 复制到 taxbot-setup → 同步 electron 文件），每次新对话都要重新说明或让 Claude 读 memory。

### 6.4 复杂的 CSS 布局偶尔不准

Claude 对常见 CSS 模式处理得很好，但对于复杂的滚动容器嵌套、浮动元素定位等，有时需要 2-3 轮调整。

---

## 七、写在最后

Claude Code 不是"自动写代码的工具"，更像是一个**极其高效的编程搭档**。它的最大价值不在于替代思考，而在于：

1. **降低执行成本**：想法到代码的距离大幅缩短
2. **提升一致性**：多文件改动时不会遗漏
3. **加速问题定位**：能快速在大量代码中找到关键点
4. **减少认知负荷**：不用记住每个 API 的参数顺序

两个项目加起来，核心代码量约 **50万字符**（taxchat-app.ts 238KB + main.cjs 2469行 + TaxStore 85个API端点），在大约两周内从原型到可用状态。如果没有 Claude Code，这个工作量至少需要一个月以上。

最重要的心得：**把 Claude 当作高级工程师来沟通，而不是当作代码生成器来使用。** 给它足够的上下文，让它理解"为什么"，而不只是告诉它"做什么"。

---

*写于 2026 年 3 月 1 日*
*Taxbot v20260301.4 / TaxStore v0.1.0*
